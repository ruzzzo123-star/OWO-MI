<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owo Mi - Invoice Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        /* Auth Screen */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .auth-box { background: white; padding: 32px; border-radius: 16px; width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .auth-title { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: #666; margin-bottom: 24px; font-size: 14px; }
        
        .tabs { display: flex; background: #f0f0f0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; border-radius: 6px; font-weight: 500; }
        .tab.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .error-msg { background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .success-msg { background: #dcfce7; color: #166534; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        
        .header { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px 20px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto; }
        .header h1 { font-size: 20px; }
        .header p { font-size: 14px; opacity: 0.8; }
        .btn-logout { background: transparent; border: none; color: white; opacity: 0.8; cursor: pointer; font-size: 14px; }
        .btn-logout:hover { opacity: 1; }
        .btn-ai { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 14px; border-radius: 20px; cursor: pointer; font-size: 13px; margin-right: 12px; }
        .btn-ai:hover { background: rgba(255,255,255,0.3); }
        
        /* AI Chat */
        .ai-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 200; }
        .ai-box { background: white; border-radius: 16px; width: 100%; max-width: 450px; height: 550px; display: flex; flex-direction: column; overflow: hidden; }
        .ai-header { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
        .ai-header-title { font-weight: 600; }
        .ai-header-sub { font-size: 12px; opacity: 0.8; }
        .ai-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .ai-messages { flex: 1; overflow-y: auto; padding: 16px; }
        .ai-msg { margin-bottom: 12px; display: flex; }
        .ai-msg.user { justify-content: flex-end; }
        .ai-bubble { max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
        .ai-msg.assistant .ai-bubble { background: #f0f0f0; color: #333; border-bottom-left-radius: 4px; }
        .ai-msg.user .ai-bubble { background: #6366f1; color: white; border-bottom-right-radius: 4px; }
        .ai-input-area { padding: 12px; border-top: 1px solid #eee; display: flex; gap: 8px; }
        .ai-input { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 14px; outline: none; }
        .ai-input:focus { border-color: #8b5cf6; }
        .ai-send { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 10px 18px; border-radius: 20px; cursor: pointer; font-weight: 500; }
        .ai-send:disabled { opacity: 0.5; }
        .typing { display: flex; gap: 4px; padding: 10px 14px; background: #f0f0f0; border-radius: 16px; width: fit-content; }
        .typing span { width: 8px; height: 8px; background: #999; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
        
        .main { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-label { font-size: 13px; color: #666; }
        .stat-value { font-size: 22px; font-weight: bold; color: #333; }
        .stat-value.green { color: #16a34a; }
        .stat-value.red { color: #dc2626; }
        
        .btn { padding: 14px 20px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: white; color: #6366f1; border: 2px solid #6366f1; }
        .btn-success { background: #dcfce7; color: #166534; padding: 10px; font-size: 14px; margin-top: 12px; }
        .btn-pdf { background: #fee2e2; color: #dc2626; padding: 10px; font-size: 14px; margin-top: 8px; }
        .btn-whatsapp { background: #dcfce7; color: #166534; padding: 10px; font-size: 14px; margin-top: 8px; }
        .card-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .card-actions .btn { flex: 1; min-width: 120px; }
        
        /* Reports */
        .report-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .report-title { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .report-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .report-row:last-child { border-bottom: none; }
        .report-label { color: #666; font-size: 14px; }
        .report-value { font-weight: 600; color: #333; }
        .report-value.green { color: #16a34a; }
        .report-value.red { color: #dc2626; }
        .customer-rank { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .customer-rank:last-child { border-bottom: none; }
        .rank-number { width: 24px; height: 24px; background: #6366f1; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; color: #333; }
        .rank-detail { font-size: 12px; color: #999; }
        .rank-amount { font-weight: 600; }
        .period-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .period-tab { padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .period-tab.active { background: #6366f1; color: white; border-color: #6366f1; }
        
        .actions { display: flex; gap: 12px; margin-bottom: 24px; }
        .actions .btn { flex: 1; }
        
        .section-title { font-size: 17px; font-weight: 600; margin-bottom: 12px; color: #333; }
        
        .card { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .card-header { display: flex; justify-content: space-between; }
        .card-name { font-weight: 600; color: #333; }
        .card-desc { font-size: 14px; color: #666; margin-top: 2px; }
        .card-date { font-size: 12px; color: #999; margin-top: 4px; }
        .card-amount { font-weight: bold; text-align: right; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; margin-top: 4px; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-pending { background: #fef3c7; color: #854d0e; }
        .badge-overdue { background: #fee2e2; color: #dc2626; }
        
        .empty { text-align: center; padding: 40px; color: #999; }
        
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #eee; }
        .nav-item { flex: 1; padding: 12px; text-align: center; color: #999; background: none; border: none; cursor: pointer; }
        .nav-item.active { color: #6366f1; }
        .nav-icon { font-size: 20px; }
        .nav-label { font-size: 11px; margin-top: 4px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 100; }
        .modal-box { background: white; border-radius: 16px; width: 100%; max-width: 400px; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; font-size: 18px; font-weight: bold; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 12px; }
        .modal-footer .btn { flex: 1; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #333; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #8b5cf6; }
        
        .loading { text-align: center; padding: 60px; color: #666; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ========== SUPABASE CONFIG ==========
        const SUPABASE_URL = 'https://djqmtzqnwklwnvlqlejj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcW10enFud2tsd252bHFsZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzk4OTMsImV4cCI6MjA3OTY1NTg5M30.7zCs844TQdocVDeB7fXc1uIziiGxoiGNLYFyxXf7ZJ8';

        // ========== STATE ==========
        let state = {
            user: null,
            customers: [],
            invoices: [],
            activeTab: 'dashboard',
            loading: true
        };

        // ========== AUTH HELPERS ==========
        function getSession() {
            const data = localStorage.getItem('owomi_session');
            return data ? JSON.parse(data) : null;
        }

        function saveSession(session) {
            localStorage.setItem('owomi_session', JSON.stringify(session));
        }

        function clearSession() {
            localStorage.removeItem('owomi_session');
        }

        // ========== API HELPERS ==========
        async function supabaseAuth(endpoint, body) {
            const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message || data.msg || 'Auth error');
            return data;
        }

        async function supabaseQuery(table, options = {}) {
            const session = getSession();
            if (!session) throw new Error('Not logged in');

            let url = `${SUPABASE_URL}/rest/v1/${table}`;
            if (options.query) url += `?${options.query}`;

            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${session.access_token}`,
                'Content-Type': 'application/json',
                'Prefer': options.prefer || 'return=representation'
            };

            const res = await fetch(url, {
                method: options.method || 'GET',
                headers,
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            const text = await res.text();
            if (!res.ok) throw new Error(text || 'API error');
            return text ? JSON.parse(text) : null;
        }

        // ========== DATA FUNCTIONS ==========
        async function loadData() {
            const session = getSession();
            if (!session) return;

            try {
                const [customers, invoices] = await Promise.all([
                    supabaseQuery('customers', { query: `user_id=eq.${session.user.id}&order=created_at.desc` }),
                    supabaseQuery('invoices', { query: `user_id=eq.${session.user.id}&order=created_at.desc` })
                ]);
                state.customers = customers || [];
                state.invoices = invoices || [];
            } catch (err) {
                console.error('Load error:', err);
            }
        }

        async function addCustomer(name, phone) {
            const session = getSession();
            const data = await supabaseQuery('customers', {
                method: 'POST',
                body: { user_id: session.user.id, name, phone }
            });
            state.customers.unshift(data[0]);
        }

        async function addInvoice(customerId, description, amount, dueDate) {
            const session = getSession();
            const data = await supabaseQuery('invoices', {
                method: 'POST',
                body: {
                    user_id: session.user.id,
                    customer_id: customerId,
                    description,
                    amount,
                    amount_paid: 0,
                    due_date: dueDate
                }
            });
            state.invoices.unshift(data[0]);
        }

        async function recordPayment(invoiceId, amount) {
            const invoice = state.invoices.find(i => i.id === invoiceId);
            const newPaid = Math.min(invoice.amount_paid + amount, invoice.amount);
            
            await supabaseQuery('invoices', {
                method: 'PATCH',
                query: `id=eq.${invoiceId}`,
                body: { amount_paid: newPaid }
            });
            
            invoice.amount_paid = newPaid;
        }

        // ========== HELPERS ==========
        function formatNaira(amount) {
            return '‚Ç¶' + Number(amount).toLocaleString();
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-NG', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function getStatus(invoice) {
            if (invoice.amount_paid >= invoice.amount) return 'paid';
            if (new Date(invoice.due_date) < new Date()) return 'overdue';
            return 'pending';
        }

        // ========== RENDER ==========
        function render() {
            const app = document.getElementById('app');

            if (state.loading) {
                app.innerHTML = '<div class="loading">Loading...</div>';
                return;
            }

            if (!state.user) {
                app.innerHTML = renderAuthScreen();
                attachAuthEvents();
                return;
            }

            app.innerHTML = renderMainApp();
            attachMainEvents();
        }

        function renderAuthScreen() {
            return `
                <div class="auth-container">
                    <div class="auth-box">
                        <div class="auth-title">Owo Mi üí∞</div>
                        <div class="auth-subtitle">Smart Invoice Manager for Nigerian Businesses</div>
                        
                        <div class="tabs">
                            <button class="tab active" data-tab="login">Login</button>
                            <button class="tab" data-tab="signup">Sign Up</button>
                        </div>
                        
                        <div id="auth-error" class="error-msg hidden"></div>
                        <div id="auth-success" class="success-msg hidden"></div>
                        
                        <form id="auth-form">
                            <div class="form-group hidden" id="name-group">
                                <label class="form-label">Business Name</label>
                                <input type="text" class="form-input" id="auth-name" placeholder="Your business name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="auth-email" placeholder="you@example.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary" id="auth-btn">Login</button>
                        </form>
                        
                        <p style="text-align: center; margin-top: 20px; color: #999; font-size: 13px;">
                            Track invoices ‚Ä¢ Get paid faster ‚Ä¢ Grow your business
                        </p>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);
            const collected = state.invoices.reduce((sum, i) => sum + Number(i.amount_paid), 0);
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmt = overdue.reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);

            return `
                <header class="header">
                    <div class="header-top">
                        <div>
                            <h1>Owo Mi üí∞</h1>
                            <p>${state.user.email}</p>
                        </div>
                        <div>
                            <button class="btn-ai" id="btn-ai">ü§ñ AI</button>
                            <button class="btn-logout" id="btn-logout">Logout</button>
                        </div>
                    </div>
                </header>

                <main class="main" id="main-content">
                    ${state.activeTab === 'dashboard' ? renderDashboard(outstanding, collected, overdueAmt, overdue) : ''}
                    ${state.activeTab === 'invoices' ? renderInvoices() : ''}
                    ${state.activeTab === 'customers' ? renderCustomers() : ''}
                    ${state.activeTab === 'reports' ? renderReports() : ''}
                </main>

                <nav class="nav">
                    <button class="nav-item ${state.activeTab === 'dashboard' ? 'active' : ''}" data-tab="dashboard">
                        <div class="nav-icon">üìä</div>
                        <div class="nav-label">Dashboard</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'invoices' ? 'active' : ''}" data-tab="invoices">
                        <div class="nav-icon">üìÑ</div>
                        <div class="nav-label">Invoices</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'customers' ? 'active' : ''}" data-tab="customers">
                        <div class="nav-icon">üë•</div>
                        <div class="nav-label">Customers</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'reports' ? 'active' : ''}" data-tab="reports">
                        <div class="nav-icon">üìà</div>
                        <div class="nav-label">Reports</div>
                    </button>
                </nav>

                <div id="modal-container"></div>
            `;
        }

        function renderDashboard(outstanding, collected, overdueAmt, overdue) {
            return `
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value">${formatNaira(outstanding)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Collected</div>
                        <div class="stat-value green">${formatNaira(collected)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Overdue</div>
                        <div class="stat-value red">${formatNaira(overdueAmt)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Customers</div>
                        <div class="stat-value">${state.customers.length}</div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-primary" id="btn-new-invoice">+ New Invoice</button>
                    <button class="btn btn-secondary" id="btn-new-customer">+ Customer</button>
                </div>

                <div class="section-title">Recent Invoices</div>
                ${state.invoices.length === 0 ? '<div class="empty">No invoices yet. Create your first one!</div>' : 
                    state.invoices.slice(0, 5).map(inv => renderInvoiceCard(inv)).join('')}
            `;
        }

        function renderInvoices() {
            return `
                <button class="btn btn-primary" id="btn-new-invoice" style="margin-bottom: 20px;">+ New Invoice</button>
                ${state.invoices.length === 0 ? '<div class="empty">No invoices yet.</div>' : 
                    state.invoices.map(inv => renderInvoiceCard(inv)).join('')}
            `;
        }

        function renderCustomers() {
            return `
                <button class="btn btn-primary" id="btn-new-customer" style="margin-bottom: 20px;">+ Add Customer</button>
                ${state.customers.length === 0 ? '<div class="empty">No customers yet.</div>' : 
                    state.customers.map(cust => {
                        const custInvoices = state.invoices.filter(i => i.customer_id === cust.id);
                        const owed = custInvoices.reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);
                        return `
                            <div class="card">
                                <div class="card-header">
                                    <div>
                                        <div class="card-name">${cust.name}</div>
                                        <div class="card-desc">${cust.phone}</div>
                                    </div>
                                    <div class="card-amount" style="color: ${owed > 0 ? '#dc2626' : '#16a34a'}">
                                        ${owed > 0 ? 'Owes ' + formatNaira(owed) : 'Clear ‚úì'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderReports() {
            // Calculate all-time stats
            const totalInvoiced = state.invoices.reduce((sum, i) => sum + Number(i.amount), 0);
            const totalCollected = state.invoices.reduce((sum, i) => sum + Number(i.amount_paid), 0);
            const totalOutstanding = totalInvoiced - totalCollected;
            const collectionRate = totalInvoiced > 0 ? ((totalCollected / totalInvoiced) * 100).toFixed(1) : 0;

            // This month stats
            const now = new Date();
            const thisMonth = state.invoices.filter(i => {
                const d = new Date(i.created_at);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            });
            const thisMonthInvoiced = thisMonth.reduce((sum, i) => sum + Number(i.amount), 0);
            const thisMonthCollected = thisMonth.reduce((sum, i) => sum + Number(i.amount_paid), 0);

            // Last month stats
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonth = state.invoices.filter(i => {
                const d = new Date(i.created_at);
                return d.getMonth() === lastMonthDate.getMonth() && d.getFullYear() === lastMonthDate.getFullYear();
            });
            const lastMonthInvoiced = lastMonth.reduce((sum, i) => sum + Number(i.amount), 0);
            const lastMonthCollected = lastMonth.reduce((sum, i) => sum + Number(i.amount_paid), 0);

            // Customer rankings - who owes the most
            const customerDebts = state.customers.map(c => {
                const custInvoices = state.invoices.filter(i => i.customer_id === c.id);
                const totalOwed = custInvoices.reduce((sum, i) => sum + (Number(i.amount) - Number(i.amount_paid)), 0);
                const totalPaid = custInvoices.reduce((sum, i) => sum + Number(i.amount_paid), 0);
                return { ...c, totalOwed, totalPaid, invoiceCount: custInvoices.length };
            });

            const topDebtors = [...customerDebts].sort((a, b) => b.totalOwed - a.totalOwed).filter(c => c.totalOwed > 0).slice(0, 5);
            const topPayers = [...customerDebts].sort((a, b) => b.totalPaid - a.totalPaid).filter(c => c.totalPaid > 0).slice(0, 5);

            // Overdue analysis
            const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmount = overdueInvoices.reduce((sum, i) => sum + (Number(i.amount) - Number(i.amount_paid)), 0);
            const avgDaysOverdue = overdueInvoices.length > 0 
                ? Math.round(overdueInvoices.reduce((sum, i) => {
                    const dueDate = new Date(i.due_date);
                    const today = new Date();
                    return sum + Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                }, 0) / overdueInvoices.length)
                : 0;

            return `
                <div class="section-title">üìà Business Reports</div>

                <!-- Summary Stats -->
                <div class="report-section">
                    <div class="report-title">üí∞ All-Time Summary</div>
                    <div class="report-row">
                        <span class="report-label">Total Invoiced</span>
                        <span class="report-value">${formatNaira(totalInvoiced)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Total Collected</span>
                        <span class="report-value green">${formatNaira(totalCollected)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Total Outstanding</span>
                        <span class="report-value red">${formatNaira(totalOutstanding)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Collection Rate</span>
                        <span class="report-value" style="color: ${collectionRate >= 70 ? '#16a34a' : collectionRate >= 40 ? '#854d0e' : '#dc2626'}">${collectionRate}%</span>
                    </div>
                </div>

                <!-- Monthly Comparison -->
                <div class="report-section">
                    <div class="report-title">üìÖ Monthly Comparison</div>
                    <div class="report-row">
                        <span class="report-label">This Month Invoiced</span>
                        <span class="report-value">${formatNaira(thisMonthInvoiced)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">This Month Collected</span>
                        <span class="report-value green">${formatNaira(thisMonthCollected)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Last Month Invoiced</span>
                        <span class="report-value">${formatNaira(lastMonthInvoiced)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Last Month Collected</span>
                        <span class="report-value green">${formatNaira(lastMonthCollected)}</span>
                    </div>
                </div>

                <!-- Overdue Analysis -->
                <div class="report-section">
                    <div class="report-title">‚ö†Ô∏è Overdue Analysis</div>
                    <div class="report-row">
                        <span class="report-label">Overdue Invoices</span>
                        <span class="report-value red">${overdueInvoices.length}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Overdue Amount</span>
                        <span class="report-value red">${formatNaira(overdueAmount)}</span>
                    </div>
                    <div class="report-row">
                        <span class="report-label">Avg Days Overdue</span>
                        <span class="report-value">${avgDaysOverdue} days</span>
                    </div>
                </div>

                <!-- Top Debtors -->
                <div class="report-section">
                    <div class="report-title">üî¥ Top Debtors (Who Owes You)</div>
                    ${topDebtors.length === 0 ? '<div style="color: #999; font-size: 14px; padding: 10px 0;">No outstanding debts! üéâ</div>' :
                        topDebtors.map((c, i) => `
                            <div class="customer-rank">
                                <div class="rank-number">${i + 1}</div>
                                <div class="rank-info">
                                    <div class="rank-name">${c.name}</div>
                                    <div class="rank-detail">${c.invoiceCount} invoices</div>
                                </div>
                                <div class="rank-amount red">${formatNaira(c.totalOwed)}</div>
                            </div>
                        `).join('')}
                </div>

                <!-- Top Payers -->
                <div class="report-section">
                    <div class="report-title">üü¢ Best Customers (Most Paid)</div>
                    ${topPayers.length === 0 ? '<div style="color: #999; font-size: 14px; padding: 10px 0;">No payments yet.</div>' :
                        topPayers.map((c, i) => `
                            <div class="customer-rank">
                                <div class="rank-number" style="background: #16a34a;">${i + 1}</div>
                                <div class="rank-info">
                                    <div class="rank-name">${c.name}</div>
                                    <div class="rank-detail">${c.invoiceCount} invoices</div>
                                </div>
                                <div class="rank-amount green">${formatNaira(c.totalPaid)}</div>
                            </div>
                        `).join('')}
                </div>
            `;
        }

        function renderInvoiceCard(inv) {
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const owed = inv.amount - inv.amount_paid;
            return `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-name">${cust ? cust.name : 'Unknown'}</div>
                            <div class="card-desc">${inv.description}</div>
                            <div class="card-date">Due: ${formatDate(inv.due_date)}</div>
                        </div>
                        <div class="card-amount">
                            ${formatNaira(inv.amount)}
                            <div class="badge badge-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-pdf" data-pdf="${inv.id}">üìÑ PDF</button>
                        ${status !== 'paid' ? `<button class="btn btn-whatsapp" data-whatsapp="${inv.id}">üí¨ WhatsApp</button>` : ''}
                        ${status !== 'paid' ? `<button class="btn btn-success" data-pay="${inv.id}">üí∞ Payment</button>` : ''}
                    </div>
                </div>
            `;
        }

        // ========== AUTH EVENTS ==========
        function attachAuthEvents() {
            let isLogin = true;

            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    isLogin = tab.dataset.tab === 'login';
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('name-group').classList.toggle('hidden', isLogin);
                    document.getElementById('auth-btn').textContent = isLogin ? 'Login' : 'Sign Up';
                    document.getElementById('auth-error').classList.add('hidden');
                    document.getElementById('auth-success').classList.add('hidden');
                };
            });

            document.getElementById('auth-form').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('auth-btn');
                const errorEl = document.getElementById('auth-error');
                const successEl = document.getElementById('auth-success');
                
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const name = document.getElementById('auth-name').value;

                btn.disabled = true;
                btn.textContent = 'Please wait...';
                errorEl.classList.add('hidden');
                successEl.classList.add('hidden');

                try {
                    if (isLogin) {
                        const data = await supabaseAuth('token?grant_type=password', { email, password });
                        saveSession(data);
                        state.user = data.user;
                        await loadData();
                        render();
                    } else {
                        await supabaseAuth('signup', { email, password, data: { business_name: name } });
                        successEl.textContent = 'Account created! Check your email to confirm, then log in.';
                        successEl.classList.remove('hidden');
                        btn.disabled = false;
                        btn.textContent = 'Sign Up';
                    }
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = isLogin ? 'Login' : 'Sign Up';
                }
            };
        }

        // ========== MAIN EVENTS ==========
        function attachMainEvents() {
            // Logout
            document.getElementById('btn-logout').onclick = () => {
                clearSession();
                state.user = null;
                state.customers = [];
                state.invoices = [];
                render();
            };

            // Navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => {
                    state.activeTab = btn.dataset.tab;
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    render();
                };
            });

            // New Customer
            document.getElementById('btn-new-customer')?.addEventListener('click', showCustomerModal);

            // New Invoice
            document.getElementById('btn-new-invoice')?.addEventListener('click', showInvoiceModal);

            // Record Payment
            document.querySelectorAll('[data-pay]').forEach(btn => {
                btn.onclick = async () => {
                    const inv = state.invoices.find(i => i.id === btn.dataset.pay);
                    const owed = inv.amount - inv.amount_paid;
                    const amount = prompt(`Amount owed: ${formatNaira(owed)}\n\nEnter payment amount:`);
                    if (amount && !isNaN(amount)) {
                        try {
                            await recordPayment(inv.id, parseFloat(amount));
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    }
                };
            });

            // AI Assistant
            document.getElementById('btn-ai')?.addEventListener('click', showAIModal);

            // PDF Generation
            document.querySelectorAll('[data-pdf]').forEach(btn => {
                btn.onclick = () => generatePDF(btn.dataset.pdf);
            });

            // WhatsApp Reminder
            document.querySelectorAll('[data-whatsapp]').forEach(btn => {
                btn.onclick = () => sendWhatsAppReminder(btn.dataset.whatsapp);
            });
        }

        // ========== MODALS ==========
        function showCustomerModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Customer</div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-input" id="cust-name" placeholder="Customer name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-input" id="cust-phone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('cust-name').value.trim();
                const phone = document.getElementById('cust-phone').value.trim();
                if (!name || !phone) return alert('Please fill all fields');
                
                try {
                    await addCustomer(name, phone);
                    closeModal();
                    render();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
        }

        function showInvoiceModal() {
            if (state.customers.length === 0) {
                alert('Add a customer first!');
                showCustomerModal();
                return;
            }

            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">New Invoice</div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select class="form-input" id="inv-customer">
                                    ${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-input" id="inv-desc" placeholder="What is this for?">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount (‚Ç¶)</label>
                                <input type="number" class="form-input" id="inv-amount" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-input" id="inv-due">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Create</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const customerId = document.getElementById('inv-customer').value;
                const description = document.getElementById('inv-desc').value.trim();
                const amount = parseFloat(document.getElementById('inv-amount').value);
                const dueDate = document.getElementById('inv-due').value;

                if (!description || !amount || !dueDate) return alert('Please fill all fields');

                try {
                    await addInvoice(customerId, description, amount, dueDate);
                    closeModal();
                    render();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // ========== PDF GENERATION ==========
        function generatePDF(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const owed = inv.amount - inv.amount_paid;

            // Create PDF content as HTML
            const pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice - ${cust?.name || 'Customer'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; border-bottom: 3px solid #6366f1; padding-bottom: 20px; margin-bottom: 30px; }
                        .header h1 { color: #6366f1; margin: 0; font-size: 32px; }
                        .header p { color: #666; margin: 5px 0 0; }
                        .invoice-title { font-size: 24px; color: #333; margin-bottom: 20px; }
                        .details { display: flex; justify-content: space-between; margin-bottom: 30px; }
                        .details-box { background: #f9f9f9; padding: 15px; border-radius: 8px; width: 48%; }
                        .details-box h3 { margin: 0 0 10px; color: #6366f1; font-size: 14px; text-transform: uppercase; }
                        .details-box p { margin: 5px 0; color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th { background: #6366f1; color: white; padding: 12px; text-align: left; }
                        td { padding: 12px; border-bottom: 1px solid #eee; }
                        .total-row { background: #f9f9f9; font-weight: bold; }
                        .status { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                        .status-paid { background: #dcfce7; color: #166534; }
                        .status-pending { background: #fef3c7; color: #854d0e; }
                        .status-overdue { background: #fee2e2; color: #dc2626; }
                        .footer { text-align: center; color: #999; font-size: 12px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Owo Mi üí∞</h1>
                        <p>Smart Invoice Manager</p>
                    </div>
                    
                    <div class="invoice-title">
                        INVOICE <span class="status status-${status}">${status.toUpperCase()}</span>
                    </div>
                    
                    <div class="details">
                        <div class="details-box">
                            <h3>Bill To</h3>
                            <p><strong>${cust?.name || 'Customer'}</strong></p>
                            <p>${cust?.phone || ''}</p>
                        </div>
                        <div class="details-box">
                            <h3>Invoice Details</h3>
                            <p><strong>Invoice ID:</strong> ${inv.id.slice(0, 8).toUpperCase()}</p>
                            <p><strong>Due Date:</strong> ${formatDate(inv.due_date)}</p>
                            <p><strong>Created:</strong> ${formatDate(inv.created_at)}</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${inv.description}</td>
                                <td style="text-align: right;">${formatNaira(inv.amount)}</td>
                            </tr>
                            <tr>
                                <td>Amount Paid</td>
                                <td style="text-align: right; color: #16a34a;">- ${formatNaira(inv.amount_paid)}</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Balance Due</strong></td>
                                <td style="text-align: right; color: ${owed > 0 ? '#dc2626' : '#16a34a'};">
                                    <strong>${formatNaira(owed)}</strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Thank you for your business!</p>
                        <p>Generated by Owo Mi - Smart Invoice Manager for Nigerian Businesses</p>
                    </div>
                </body>
                </html>
            `;

            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
            };
        }

        // ========== WHATSAPP REMINDER ==========
        function sendWhatsAppReminder(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;
            const status = getStatus(inv);

            // Format phone number (remove spaces, add country code if needed)
            let phone = cust?.phone?.replace(/\s/g, '') || '';
            if (phone.startsWith('0')) {
                phone = '234' + phone.slice(1); // Nigerian country code
            }

            // Generate message based on status
            let message = '';
            if (status === 'overdue') {
                message = `Hello ${cust?.name},\n\nThis is a friendly reminder that your invoice of ${formatNaira(inv.amount)} for "${inv.description}" is now overdue.\n\nOutstanding balance: ${formatNaira(owed)}\nDue date: ${formatDate(inv.due_date)}\n\nPlease kindly make payment at your earliest convenience.\n\nThank you for your business!\n\n- Sent via Owo Mi`;
            } else {
                message = `Hello ${cust?.name},\n\nThis is a friendly reminder about your invoice of ${formatNaira(inv.amount)} for "${inv.description}".\n\nOutstanding balance: ${formatNaira(owed)}\nDue date: ${formatDate(inv.due_date)}\n\nThank you for your business!\n\n- Sent via Owo Mi`;
            }

            // Open WhatsApp with pre-filled message
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // ========== AI ASSISTANT ==========
        function showAIModal() {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div class="ai-modal" id="ai-modal">
                    <div class="ai-box">
                        <div class="ai-header">
                            <div>
                                <div class="ai-header-title">ü§ñ AI Assistant</div>
                                <div class="ai-header-sub">Ask me about your business</div>
                            </div>
                            <button class="ai-close" id="ai-close">&times;</button>
                        </div>
                        <div class="ai-messages" id="ai-messages">
                            <div class="ai-msg assistant">
                                <div class="ai-bubble">Hello! I'm your Owo Mi assistant. Ask me anything about your business - "Who owes me money?", "Wetin be my total outstanding?", or "Give me business insights". I understand English and Pidgin! üá≥üá¨</div>
                            </div>
                        </div>
                        <div class="ai-input-area">
                            <input type="text" class="ai-input" id="ai-input" placeholder="Ask about your business...">
                            <button class="ai-send" id="ai-send">Send</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('ai-close').onclick = () => container.innerHTML = '';
            document.getElementById('ai-send').onclick = sendAIMessage;
            document.getElementById('ai-input').onkeypress = (e) => { if (e.key === 'Enter') sendAIMessage(); };
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const messages = document.getElementById('ai-messages');
            const sendBtn = document.getElementById('ai-send');
            const userText = input.value.trim();

            if (!userText) return;

            // Add user message
            messages.innerHTML += `<div class="ai-msg user"><div class="ai-bubble">${userText}</div></div>`;
            input.value = '';
            sendBtn.disabled = true;

            // Add typing indicator
            messages.innerHTML += `<div class="ai-msg assistant" id="typing"><div class="typing"><span></span><span></span><span></span></div></div>`;
            messages.scrollTop = messages.scrollHeight;

            // Build context
            const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);
            const collected = state.invoices.reduce((sum, i) => sum + Number(i.amount_paid), 0);
            const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmt = overdueInvoices.reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);

            const context = `
BUSINESS DATA:
- Total Customers: ${state.customers.length}
- Total Invoices: ${state.invoices.length}
- Total Outstanding: ‚Ç¶${outstanding.toLocaleString()}
- Total Collected: ‚Ç¶${collected.toLocaleString()}
- Overdue Amount: ‚Ç¶${overdueAmt.toLocaleString()} (${overdueInvoices.length} invoices)

CUSTOMERS & BALANCES:
${state.customers.map(c => {
    const custInvoices = state.invoices.filter(i => i.customer_id === c.id);
    const owed = custInvoices.reduce((sum, i) => sum + (i.amount - i.amount_paid), 0);
    return `- ${c.name} (${c.phone}): owes ‚Ç¶${owed.toLocaleString()}, ${custInvoices.length} invoices`;
}).join('\n')}

INVOICES:
${state.invoices.slice(0, 10).map(inv => {
    const cust = state.customers.find(c => c.id === inv.customer_id);
    return `- ${cust?.name || 'Unknown'}: ‚Ç¶${inv.amount.toLocaleString()}, paid ‚Ç¶${inv.amount_paid.toLocaleString()}, status: ${getStatus(inv)}, due: ${inv.due_date}`;
}).join('\n')}
            `;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1024,
                        messages: [{
                            role: 'user',
                            content: `You are the AI assistant for "Owo Mi", a Nigerian invoice management app. Help business owners understand their finances. Be friendly, helpful, and concise. Always use Naira (‚Ç¶) for amounts. You understand both English and Nigerian Pidgin - respond in whichever language the user uses.

${context}

User question: ${userText}`
                        }]
                    })
                });

                const data = await response.json();
                const reply = data.content?.[0]?.text || "Sorry, I couldn't process that. Please try again.";

                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">${reply}</div></div>`;
            } catch (err) {
                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">Sorry, there was an error connecting to the AI. Please try again.</div></div>`;
            }

            sendBtn.disabled = false;
            messages.scrollTop = messages.scrollHeight;
        }

        // ========== INIT ==========
        async function init() {
            const session = getSession();
            if (session?.access_token) {
                state.user = session.user;
                await loadData();
            }
            state.loading = false;
            render();
        }

        init();
    </script>
</body>
</html>
