<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Owo Mi - Invoice Manager for Nigerian Businesses</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Create professional invoices, send WhatsApp reminders, track payments, and get paid faster. Free invoice app built for Nigerian small businesses.">
    <meta name="keywords" content="invoice app Nigeria, invoice generator, payment reminder, small business Nigeria, billing software, Paystack invoice, WhatsApp reminder">
    <meta name="author" content="Owo Mi">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://owomi.ng">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://owomi.ng">
    <meta property="og:title" content="Owo Mi - Get Paid Faster ðŸ’°">
    <meta property="og:description" content="Free invoice app for Nigerian businesses. Create invoices, send reminders via WhatsApp, accept Paystack payments.">
    <meta property="og:image" content="https://owomi.ng/og-image.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Owo Mi - Get Paid Faster ðŸ’°">
    <meta name="twitter:description" content="Free invoice app for Nigerian businesses. WhatsApp reminders, Paystack payments.">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Owo Mi">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Owo Mi">
    <meta name="msapplication-TileColor" content="#6366f1">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Owo Mi - Invoice Manager&quot;,
        &quot;short_name&quot;: &quot;Owo Mi&quot;,
        &quot;description&quot;: &quot;Smart Invoice Manager for Nigerian Businesses&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#6366f1&quot;,
        &quot;theme_color&quot;: &quot;#6366f1&quot;,
        &quot;orientation&quot;: &quot;portrait&quot;,
        &quot;icons&quot;: [{
            &quot;src&quot;: &quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>ðŸ’°</text></svg>&quot;,
            &quot;sizes&quot;: &quot;512x512&quot;,
            &quot;type&quot;: &quot;image/svg+xml&quot;,
            &quot;purpose&quot;: &quot;any maskable&quot;
        }]
    }">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>ðŸ’°</text></svg>">

    <!-- Paystack Payment Script -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <!-- Google Analytics (replace UA-XXXXX with your ID) -->
    <!-- 
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>
    -->

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .install-prompt-icon { font-size: 32px; }
        .install-prompt-text { flex: 1; }
        .install-prompt-title { font-weight: 600; font-size: 15px; }
        .install-prompt-desc { font-size: 13px; color: #666; }
        .install-prompt-btn { background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .install-prompt-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 8px; }
        body.dark .install-prompt { background: #1a1a2e; }
        body.dark .install-prompt-title { color: #eee; }
        
        /* ========== LANDING PAGE ========== */
        .landing-section {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        }
        
        .landing-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .landing-logo {
            font-size: 28px;
            font-weight: 800;
            color: #6366f1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .landing-nav-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }
        
        .landing-hero {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 24px 80px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }
        
        .landing-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            color: #6366f1;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .landing-title {
            font-size: clamp(36px, 5vw, 56px);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 20px;
            color: #1a1a2e;
        }
        
        .landing-title span {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .landing-subtitle {
            font-size: 18px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 32px;
            max-width: 480px;
        }
        
        .landing-ctas {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .landing-cta-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99,102,241,0.4);
        }
        
        .landing-cta-secondary {
            background: white;
            color: #6366f1;
            border: 2px solid #6366f1;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }
        
        .landing-stats {
            display: flex;
            gap: 40px;
            margin-top: 48px;
            padding-top: 32px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .landing-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #6366f1;
        }
        
        .landing-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .landing-phone {
            width: 280px;
            height: 560px;
            background: #1a1a2e;
            border-radius: 40px;
            padding: 12px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.25);
            margin: 0 auto;
        }
        
        .landing-phone-screen {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 30px;
            padding: 40px 16px 16px;
            overflow: hidden;
        }
        
        .landing-phone-header {
            color: white;
            margin-bottom: 16px;
        }
        
        .landing-phone-greeting {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .landing-phone-title {
            font-size: 22px;
            font-weight: 700;
        }
        
        .landing-phone-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .landing-phone-stat {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 12px;
            color: white;
        }
        
        .landing-phone-stat-label {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .landing-phone-stat-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .landing-phone-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .landing-phone-card-top {
            display: flex;
            justify-content: space-between;
        }
        
        .landing-phone-card-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a2e;
        }
        
        .landing-phone-card-desc {
            font-size: 12px;
            color: #888;
        }
        
        .landing-phone-card-amount {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a2e;
        }
        
        .landing-phone-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }
        
        .landing-phone-badge.paid {
            background: #dcfce7;
            color: #166534;
        }
        
        .landing-phone-badge.pending {
            background: #fef3c7;
            color: #854d0e;
        }
        
        .landing-features {
            background: white;
            padding: 80px 24px;
        }
        
        .landing-features-inner {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .landing-section-title {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 48px;
            color: #1a1a2e;
        }
        
        .landing-features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }
        
        .landing-feature-card {
            background: #f8fafc;
            padding: 28px 24px;
            border-radius: 16px;
            text-align: center;
        }
        
        .landing-feature-icon {
            font-size: 40px;
            margin-bottom: 16px;
        }
        
        .landing-feature-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .landing-feature-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .landing-cta-section {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 80px 24px;
            text-align: center;
        }
        
        .landing-cta-section h2 {
            font-size: 32px;
            color: white;
            margin-bottom: 16px;
        }
        
        .landing-cta-section p {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 32px;
        }
        
        .landing-cta-section button {
            background: white;
            color: #6366f1;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 17px;
            cursor: pointer;
        }
        
        .landing-footer {
            background: #1a1a2e;
            color: white;
            padding: 40px 24px;
            text-align: center;
        }
        
        .landing-footer-logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .landing-footer p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        @media (max-width: 900px) {
            .landing-hero {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 40px 24px 60px;
            }
            .landing-subtitle {
                margin-left: auto;
                margin-right: auto;
            }
            .landing-ctas {
                justify-content: center;
            }
            .landing-stats {
                justify-content: center;
            }
            .landing-hero > div:last-child {
                order: -1;
            }
            .landing-phone {
                width: 240px;
                height: 480px;
            }
            .landing-features-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .landing-features-grid {
                grid-template-columns: 1fr;
            }
            .landing-stats {
                gap: 24px;
            }
            .landing-stat-value {
                font-size: 26px;
            }
        }
        
        /* ========== ONBOARDING ========== */
        .onboarding-section {
            min-height: 100vh;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
        }
        
        .onboarding-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 24px;
            width: 100%;
        }
        
        .onboarding-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 40px;
        }
        
        .onboarding-progress-step {
            flex: 1;
            height: 6px;
            background: rgba(99,102,241,0.2);
            border-radius: 3px;
            transition: all 0.4s ease;
        }
        
        .onboarding-progress-step.completed {
            background: #6366f1;
        }
        
        .onboarding-progress-step.active {
            background: #f59e0b;
        }
        
        .onboarding-step {
            display: none;
            flex-direction: column;
            animation: fadeInUp 0.4s ease;
        }
        
        .onboarding-step.active {
            display: flex;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .onboarding-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .onboarding-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a1a2e;
        }
        
        .onboarding-desc {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 28px;
        }
        
        .onboarding-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .onboarding-actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }
        
        .onboarding-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: none;
        }
        
        .onboarding-btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }
        
        .onboarding-btn-secondary {
            background: white;
            color: #666;
            border: 2px solid #e5e7eb;
        }
        
        .onboarding-skip {
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
            padding: 8px;
        }
        
        .onboarding-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 28px;
        }
        
        .onboarding-feature {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .onboarding-feature-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }
        
        .onboarding-feature-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }
        
        .onboarding-feature-desc {
            font-size: 11px;
            color: #888;
        }
        
        /* Auth Screen */
        .auth-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 24px; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
        }
        .auth-box { 
            background: white; 
            padding: 32px 24px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 360px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .auth-title { text-align: center; font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: #666; margin-bottom: 28px; font-size: 15px; }
        
        .tabs { display: flex; background: #f0f0f0; border-radius: 12px; padding: 4px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 10px; font-weight: 600; font-size: 15px; }
        .tab.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .error-msg { background: #fee2e2; color: #dc2626; padding: 14px; border-radius: 12px; margin-bottom: 16px; font-size: 14px; }
        .success-msg { background: #dcfce7; color: #166534; padding: 14px; border-radius: 12px; margin-bottom: 16px; font-size: 14px; }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%); 
            color: white; 
            padding: 24px 20px; 
            padding-top: max(24px, calc(env(safe-area-inset-top) + 8px));
            position: relative;
            overflow: hidden;
        }
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; }
        .header h1 { font-size: 22px; font-weight: 600; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        .header-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .header-btn:active { transform: scale(0.95); }
        
        /* Main Content */
        .main { 
            padding: 20px; 
            padding-bottom: 100px; 
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Stats Grid */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat { 
            background: white; 
            padding: 18px 16px; 
            border-radius: 16px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.08); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .stat:active { transform: scale(0.98); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1a1a2e; }
        .stat-value.green { color: #16a34a; }
        .stat-value.red { color: #dc2626; }
        
        /* Quick Actions */
        .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; }
        .quick-btn { 
            flex: 1; 
            padding: 16px; 
            border: none; 
            border-radius: 14px; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        .quick-btn.primary { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: white; 
        }
        .quick-btn.primary:hover { 
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
            transform: translateY(-2px);
        }
        .quick-btn.secondary { 
            background: white; 
            color: #6366f1; 
            border: 2px solid #e0e7ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .quick-btn.secondary:hover {
            border-color: #6366f1;
            background: #f5f3ff;
        }
        .quick-btn:active { transform: scale(0.98) !important; }
        
        /* Section */
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .section-title { font-size: 18px; font-weight: 700; color: #333; }
        .section-link { color: #6366f1; font-size: 14px; font-weight: 600; background: none; border: none; cursor: pointer; }
        
        /* Cards */
        .card { 
            background: white; 
            padding: 18px; 
            border-radius: 18px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
            margin-bottom: 12px;
            transition: all 0.2s ease;
            border: 1px solid #f0f0f5;
        }
        .card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-color: #e0e7ff;
        }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-weight: 700; font-size: 16px; color: #1a1a2e; }
        .card-desc { font-size: 14px; color: #64748b; margin-top: 3px; }
        .card-date { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        .card-amount { font-weight: 800; font-size: 20px; text-align: right; color: #1a1a2e; }
        
        .badge { 
            display: inline-block; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge-paid { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
        .badge-pending { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #854d0e; }
        .badge-overdue { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; }
        
        .card-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
        .card-btn { 
            flex: 1; 
            min-width: 70px;
            padding: 11px 8px; 
            border: none; 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: 700; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.15s ease;
        }
        .card-btn:hover { transform: translateY(-1px); filter: brightness(0.95); }
        .card-btn:active { transform: scale(0.97); }
        .btn-pdf { background: #f3e8ff; color: #7c3aed; }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }
        .btn-sms { background: #fff7ed; color: #ea580c; }
        .btn-paylink { background: #dbeafe; color: #1d4ed8; }
        .btn-pay { background: #e0e7ff; color: #4f46e5; }
        .btn-edit { background: #f1f5f9; color: #475569; }
        
        /* Search & Filter */
        .search-box { 
            background: white; 
            border-radius: 14px; 
            padding: 4px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .search-input { 
            width: 100%; 
            padding: 14px 16px; 
            border: none; 
            font-size: 16px; 
            background: transparent;
            outline: none;
        }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .filter-tab { 
            padding: 10px 18px; 
            border: 2px solid #e5e7eb; 
            border-radius: 25px; 
            background: white; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            white-space: nowrap;
            color: #666;
        }
        .filter-tab.active { background: #6366f1; color: white; border-color: #6366f1; }
        
        /* Menu Page */
        .menu-grid { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { 
            background: white; 
            padding: 18px 20px; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            gap: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f5;
            width: 100%;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .menu-item:hover { 
            border-color: #e0e7ff; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }
        .menu-item:active { transform: scale(0.99); }
        .menu-icon { 
            font-size: 24px; 
            width: 44px; 
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f3ff, #ede9fe);
            border-radius: 12px;
        }
        .menu-text { flex: 1; font-weight: 600; color: #1a1a2e; }
        .menu-arrow { color: #c7d2fe; font-size: 20px; font-weight: 700; }
        .menu-toggle { 
            width: 52px; 
            height: 30px; 
            border-radius: 15px; 
            background: #e5e7eb; 
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .menu-toggle.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .menu-toggle::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .menu-toggle.active::after { left: 24px; }
        
        .menu-section { 
            font-size: 12px; 
            color: #94a3b8; 
            padding: 24px 8px 12px; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Sub-pages */
        .subpage { display: none; }
        .subpage.active { display: block; }
        .back-btn { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: none; 
            border: none; 
            color: #6366f1; 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 20px;
            cursor: pointer;
            padding: 8px 0;
        }
        
        /* Reports */
        .report-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .report-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .report-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .report-row:last-child { border-bottom: none; }
        .report-label { color: #666; }
        .report-value { font-weight: 700; }
        .report-value.green { color: #16a34a; }
        .report-value.red { color: #dc2626; }
        
        /* Chart */
        .chart-container { 
            background: white; 
            border-radius: 18px; 
            padding: 20px; 
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f5;
        }
        .chart-title { font-weight: 700; margin-bottom: 16px; font-size: 15px; color: #1a1a2e; }
        .bar-chart { display: flex; align-items: flex-end; gap: 10px; height: 100px; padding: 0 4px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .bar { 
            width: 100%; 
            border-radius: 8px 8px 4px 4px; 
            min-height: 4px; 
            background: linear-gradient(to top, #6366f1, #8b5cf6);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .bar:hover { 
            filter: brightness(1.1);
            transform: scaleY(1.05);
            transform-origin: bottom;
        }
        .bar-label { font-size: 11px; color: #94a3b8; margin-top: 10px; font-weight: 600; }
        
        /* Bottom Navigation */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            display: flex; 
            border-top: 1px solid #f0f0f5;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .nav-item { 
            flex: 1; 
            padding: 12px 8px; 
            padding-bottom: 8px;
            text-align: center; 
            color: #94a3b8; 
            background: none; 
            border: none; 
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 0 0 4px 4px;
            transition: width 0.2s ease;
        }
        .nav-item.active::before { width: 40px; }
        .nav-item.active { color: #6366f1; }
        .nav-item:active { transform: scale(0.95); }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
        
        /* Modal */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px);
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            z-index: 100;
            padding: 0;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-box { 
            background: white; 
            border-radius: 28px 28px 0 0; 
            width: 100%; 
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        .modal-header { 
            padding: 24px 24px 16px; 
            border-bottom: 1px solid #f0f0f5; 
            font-size: 20px; 
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            z-index: 1;
        }
        .modal-close { background: none; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; line-height: 1; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; gap: 12px; }
        .modal-footer .btn { flex: 1; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #1a1a2e; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.2s ease;
            background: #fafafa;
        }
        .form-input:focus { 
            outline: none; 
            border-color: #6366f1; 
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        .form-input::placeholder { color: #94a3b8; }
        
        .btn { 
            padding: 16px 24px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%;
            transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(99, 102, 241, 0.35); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        
        .empty { 
            text-align: center; 
            padding: 48px 24px; 
            color: #94a3b8;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 20px;
            border: 2px dashed #e2e8f0;
        }
        .empty-icon { font-size: 56px; margin-bottom: 16px; filter: grayscale(0.3); }
        
        .loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            font-size: 18px; 
            color: #666; 
        }
        .hidden { display: none !important; }
        
        /* Dark Mode */
        body.dark { background: #0f0f1a; }
        body.dark .header { background: linear-gradient(135deg, #4338ca, #6d28d9); }
        body.dark .stat, body.dark .card, body.dark .chart-container, body.dark .report-card, body.dark .menu-item, body.dark .search-box { 
            background: #1a1a2e; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
        }
        body.dark .stat-label, body.dark .card-desc, body.dark .card-date, body.dark .report-label, body.dark .bar-label { color: #666; }
        body.dark .stat-value, body.dark .card-name, body.dark .section-title, body.dark .chart-title, body.dark .report-title, body.dark .report-value, body.dark .menu-text { color: #eee; }
        body.dark .form-input, body.dark .search-input { background: #1a1a2e; border-color: #333; color: #eee; }
        body.dark .modal-box, body.dark .modal-header { background: #1a1a2e; }
        body.dark .modal-header, body.dark .modal-footer { border-color: #333; }
        body.dark .nav { background: #1a1a2e; border-color: #333; }
        body.dark .filter-tab { background: #1a1a2e; border-color: #333; color: #888; }
        body.dark .filter-tab.active { background: #6366f1; border-color: #6366f1; color: white; }
        body.dark .quick-btn.secondary { background: #1a1a2e; border-color: #6366f1; }
        body.dark .card-amount, body.dark .form-label { color: #eee; }
        body.dark .auth-box { background: #1a1a2e; }
        body.dark .auth-title, body.dark .tab { color: #eee; }
        body.dark .tabs { background: #0f0f1a; }
        body.dark .tab.active { background: #1a1a2e; }
        body.dark .menu-toggle { background: #333; }
        body.dark .btn-secondary { background: #333; color: #eee; }

        /* AI Chat */
        .ai-modal .modal-box { 
            height: 85vh; 
            display: flex; 
            flex-direction: column; 
            background: linear-gradient(180deg, #faf5ff 0%, #f5f3ff 50%, white 100%);
        }
        .ai-modal .modal-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 28px 28px 0 0;
        }
        .ai-modal .modal-close { color: white; }
        .ai-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-msg { margin-bottom: 16px; display: flex; animation: msgFadeIn 0.3s ease; }
        @keyframes msgFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ai-msg.user { justify-content: flex-end; }
        .ai-bubble { 
            max-width: 85%; 
            padding: 14px 18px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .ai-msg.assistant .ai-bubble { 
            background: white; 
            color: #1a1a2e; 
            border-bottom-left-radius: 6px;
            border: 1px solid #f0f0f5;
        }
        .ai-msg.user .ai-bubble { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: white; 
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        body.dark .ai-modal .modal-box { background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%); }
        body.dark .ai-msg.assistant .ai-bubble { background: #2a2a3e; color: #eee; border-color: #3a3a4e; }
        .ai-input-area { 
            padding: 16px; 
            border-top: 1px solid #e0e7ff; 
            display: flex; 
            gap: 10px;
            background: white;
        }
        body.dark .ai-input-area { border-color: #333; background: #1a1a2e; }
        .ai-input { 
            flex: 1; 
            padding: 14px 18px; 
            border: 2px solid #e0e7ff; 
            border-radius: 25px; 
            font-size: 16px; 
            outline: none;
            background: #fafafa;
            transition: all 0.2s ease;
        }
        .ai-input:focus { border-color: #6366f1; background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .ai-send { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: white; 
            border: none; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        .ai-send:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
        .ai-send:active { transform: scale(0.95); }
        .typing { display: flex; gap: 5px; padding: 14px 18px; }
        .typing span { width: 10px; height: 10px; background: #c7d2fe; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }

        /* Customer Card */
        .customer-card { 
            background: white; 
            padding: 18px; 
            border-radius: 18px; 
            margin-bottom: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f5;
            transition: all 0.2s ease;
        }
        .customer-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-color: #e0e7ff;
        }
        body.dark .customer-card { background: #1a1a2e; border-color: #2a2a3e; }
        .customer-info { display: flex; justify-content: space-between; align-items: center; }
        .customer-name { font-weight: 700; font-size: 16px; color: #1a1a2e; }
        .customer-phone { font-size: 13px; color: #64748b; margin-top: 3px; }
        .customer-balance { font-weight: 800; font-size: 16px; }
        .customer-actions { display: flex; gap: 8px; margin-top: 14px; }

        /* Recurring Badge */
        .recurring-badge { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            color: #1d4ed8; 
            font-size: 10px; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Payment History */
        .payment-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 14px 0; 
            border-bottom: 1px solid #f0f0f5; 
        }
        .payment-item:last-child { border-bottom: none; }
        .payment-date { color: #64748b; font-size: 14px; }
        .payment-amount { font-weight: 800; color: #16a34a; }

        /* ========== ANIMATIONS & POLISH ========== */
        
        /* Smooth page transitions */
        .main {
            animation: fadeInUp 0.3s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card entrance animation */
        .card, .stat, .menu-item, .customer-card {
            animation: cardFadeIn 0.4s ease backwards;
        }
        .card:nth-child(1), .stat:nth-child(1), .menu-item:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2), .stat:nth-child(2), .menu-item:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3), .stat:nth-child(3), .menu-item:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4), .stat:nth-child(4), .menu-item:nth-child(4) { animation-delay: 0.2s; }
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Page Transitions */
        .main { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Stagger Animation */
        .card, .customer-card, .menu-item, .stat, .report-card {
            animation: cardSlideIn 0.4s ease-out backwards;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:nth-child(1), .stat:nth-child(1), .menu-item:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2), .stat:nth-child(2), .menu-item:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3), .stat:nth-child(3), .menu-item:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4), .stat:nth-child(4), .menu-item:nth-child(4) { animation-delay: 0.2s; }
        .card:nth-child(5), .menu-item:nth-child(5) { animation-delay: 0.25s; }
        .card:nth-child(6), .menu-item:nth-child(6) { animation-delay: 0.3s; }
        @keyframes cardSlideIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Card Hover/Press Effects */
        .card:hover, .customer-card:hover, .menu-item:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15); 
        }
        .card:active, .customer-card:active { 
            transform: scale(0.98); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        }
        
        /* Button Micro-interactions */
        .btn, .quick-btn, .card-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn:hover, .quick-btn:hover { transform: translateY(-1px); }
        .btn:active, .quick-btn:active { 
            transform: scale(0.96); 
            transition: transform 0.1s;
        }
        .card-btn:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card-btn:active { 
            transform: scale(0.94); 
            transition: transform 0.1s;
        }
        
        /* Ripple Effect */
        .btn::after, .quick-btn::after, .card-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn:active::after, .quick-btn:active::after, .card-btn:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }
        
        /* Header Animation */
        .header {
            animation: headerSlide 0.5s ease-out;
        }
        @keyframes headerSlide {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        .header h1 {
            animation: logoPopIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s backwards;
        }
        @keyframes logoPopIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Bottom Nav Animation */
        .nav {
            animation: navSlideUp 0.4s ease-out 0.3s backwards;
        }
        @keyframes navSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .nav-item {
            transition: all 0.2s ease;
        }
        .nav-item:active {
            transform: scale(0.9);
        }
        .nav-item.active .nav-icon {
            animation: navIconBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes navIconBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Modal Animation */
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { background: rgba(0,0,0,0); }
            to { background: rgba(0,0,0,0.5); }
        }
        .modal-box {
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Input Focus Animation */
        .form-input, .search-input, .ai-input {
            transition: all 0.2s ease;
        }
        .form-input:focus, .search-input:focus, .ai-input:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Badge Pulse for Overdue */
        .badge-overdue {
            animation: pulseBadge 2s infinite;
        }
        @keyframes pulseBadge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Stats Counter Animation */
        .stat-value {
            animation: countUp 0.6s ease-out;
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Filter Tab Animation */
        .filter-tab {
            transition: all 0.2s ease;
        }
        .filter-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .filter-tab.active {
            animation: filterPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes filterPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        body.dark .skeleton {
            background: linear-gradient(90deg, #1a1a2e 25%, #252540 50%, #1a1a2e 75%);
            background-size: 200% 100%;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .toast.info { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        
        /* Auto Reminder Prompt */
        .auto-reminder-prompt {
            position: fixed;
            bottom: 90px;
            left: 16px;
            right: 16px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }
        body.dark .auto-reminder-prompt {
            background: #1a1a2e;
        }
        body.dark .auto-reminder-prompt div {
            color: #eee;
        }
        
        /* Customer Portal Styles */
        .portal-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            padding: 0;
        }
        .portal-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 32px 20px;
            text-align: center;
        }
        .portal-business {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .portal-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .portal-customer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: white;
            margin: -20px 16px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .portal-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
        }
        .portal-name {
            font-size: 18px;
            font-weight: 700;
        }
        .portal-phone {
            font-size: 14px;
            color: #666;
        }
        .portal-balance {
            margin: 0 16px 16px;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
        }
        .portal-balance.has-balance {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
        }
        .portal-balance.clear {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
        }
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        .balance-amount {
            font-size: 36px;
            font-weight: 700;
        }
        .balance-detail {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }
        .portal-pay-all {
            display: block;
            width: calc(100% - 32px);
            margin: 0 16px 20px;
            padding: 16px;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }
        .portal-section {
            padding: 0 16px 16px;
        }
        .portal-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        .portal-invoice {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .portal-invoice.paid {
            opacity: 0.8;
        }
        .portal-inv-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .portal-inv-number {
            font-weight: 700;
            color: #6366f1;
            font-size: 14px;
        }
        .portal-inv-desc {
            font-size: 15px;
            color: #333;
            margin-top: 4px;
        }
        .portal-inv-due {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .portal-inv-due.overdue {
            color: #dc2626;
            font-weight: 600;
        }
        .portal-inv-paid-date {
            font-size: 12px;
            color: #16a34a;
            margin-top: 4px;
        }
        .portal-inv-amount {
            font-size: 20px;
            font-weight: 700;
            color: #dc2626;
        }
        .portal-inv-amount.paid {
            color: #16a34a;
        }
        .portal-inv-actions {
            display: flex;
            gap: 8px;
        }
        .portal-btn-view, .portal-btn-receipt {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .portal-btn-pay {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .portal-payments {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        .portal-payment {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .portal-payment:last-child {
            border-bottom: none;
        }
        .portal-pay-date {
            font-weight: 600;
            font-size: 14px;
        }
        .portal-pay-ref {
            font-size: 12px;
            color: #888;
        }
        .portal-pay-amount {
            font-weight: 700;
            color: #16a34a;
        }
        .portal-contact {
            padding: 20px 16px;
            text-align: center;
        }
        .portal-contact-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
        }
        .portal-contact-btn {
            display: inline-block;
            padding: 12px 20px;
            margin: 4px;
            background: white;
            border-radius: 25px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .portal-contact-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        .portal-footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
        }
        .portal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .portal-modal-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
        }
        .portal-modal-box {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        .portal-modal-btn {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            color: #333;
        }
        .portal-modal-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        .portal-modal-btn.close {
            background: #f0f0f0;
            color: #666;
        }
        
        /* Empty State Animation */
        .empty {
            animation: emptyFadeIn 0.5s ease-out;
        }
        .empty-icon {
            animation: emptyBounce 2s ease-in-out infinite;
        }
        @keyframes emptyFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes emptyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Auth Box Animation */
        .auth-box {
            animation: authPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes authPopIn {
            from { opacity: 0; transform: scale(0.8) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }
        
        /* Selection color */
        ::selection { background: #6366f1; color: white; }
        
        /* Focus ring for accessibility */
        *:focus-visible {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ========== CONFIG ==========
        // ========== APP CONFIG ==========
        const APP_VERSION = '1.0.0';
        const APP_NAME = 'Owo Mi';
        const DEV_MODE = true; // Set to false for production with real Supabase auth
        const SUPABASE_URL = 'https://djqmtzqnwklwnvlqlejj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcW10enFud2tsd252bHFsZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzk4OTMsImV4cCI6MjA3OTY1NTg5M30.7zCs844TQdocVDeB7fXc1uIziiGxoiGNLYFyxXf7ZJ8';

        // ========== STATE ==========
        let state = {
            user: null,
            customers: [],
            invoices: [],
            products: JSON.parse(localStorage.getItem('owomi_products') || '[]'),
            expenses: JSON.parse(localStorage.getItem('owomi_expenses') || '[]'),
            activeTab: 'home',
            menuPage: null,
            loading: true,
            searchQuery: '',
            filterStatus: 'all',
            businessProfile: JSON.parse(localStorage.getItem('owomi_business') || '{}'),
            paymentHistory: JSON.parse(localStorage.getItem('owomi_payments') || '[]'),
            recurringTemplates: JSON.parse(localStorage.getItem('owomi_recurring') || '[]'),
            reminderSettings: null,
            currentSection: 'landing', // 'landing', 'auth', 'onboarding', 'app'
            onboardingStep: 1
        };

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type = 'info', duration = 3000) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Add icon based on type
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                info: 'â„¹'
            };
            toast.innerHTML = `<span style="font-size:18px;">${icons[type] || icons.info}</span> ${message}`;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // ========== AUTH ==========
        function getSession() {
            const data = localStorage.getItem('owomi_session');
            return data ? JSON.parse(data) : null;
        }

        function saveSession(session) {
            localStorage.setItem('owomi_session', JSON.stringify(session));
        }

        function clearSession() {
            localStorage.removeItem('owomi_session');
        }

        async function supabaseAuth(endpoint, body) {
            const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message || data.msg || 'Auth error');
            return data;
        }

        async function supabaseQuery(table, options = {}) {
            const session = getSession();
            if (!session) throw new Error('Not logged in');

            let url = `${SUPABASE_URL}/rest/v1/${table}`;
            if (options.query) url += `?${options.query}`;

            const res = await fetch(url, {
                method: options.method || 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json',
                    'Prefer': options.prefer || 'return=representation'
                },
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            const text = await res.text();
            if (!res.ok) throw new Error(text || 'API error');
            return text ? JSON.parse(text) : null;
        }

        // ========== DATA ==========
        async function loadData() {
            const session = getSession();
            if (!session) return;
            try {
                const [customers, invoices, reminderSettings] = await Promise.all([
                    supabaseQuery('customers', { query: `user_id=eq.${session.user.id}&order=created_at.desc` }),
                    supabaseQuery('invoices', { query: `user_id=eq.${session.user.id}&order=created_at.desc` }),
                    supabaseQuery('reminder_settings', { query: `user_id=eq.${session.user.id}` })
                ]);
                state.customers = customers || [];
                state.invoices = invoices || [];
                state.reminderSettings = reminderSettings?.[0] || null;
            } catch (err) {
                console.error('Load error:', err);
            }
        }

        async function addCustomer(name, phone) {
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                const newCustomer = { id: 'cust-' + Date.now(), name, phone };
                state.customers.unshift(newCustomer);
                return;
            }
            
            const session = getSession();
            const data = await supabaseQuery('customers', {
                method: 'POST',
                body: { user_id: session.user.id, name, phone }
            });
            state.customers.unshift(data[0]);
        }

        async function addInvoice(customerId, description, amount, dueDate, items = []) {
            const invoice_number = generateInvoiceNumber();
            
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                // Mock add for dev mode
                const newInvoice = {
                    id: 'inv-' + Date.now(),
                    invoice_number,
                    customer_id: customerId,
                    description,
                    items: items.length > 0 ? items : [{name: description, qty: 1, price: amount}],
                    amount,
                    amount_paid: 0,
                    due_date: dueDate,
                    created_at: new Date().toISOString()
                };
                state.invoices.unshift(newInvoice);
                return;
            }
            
            const session = getSession();
            const data = await supabaseQuery('invoices', {
                method: 'POST',
                body: { user_id: session.user.id, customer_id: customerId, description, amount, amount_paid: 0, due_date: dueDate, invoice_number, items: items.length > 0 ? items : [{name: description, qty: 1, price: amount}] }
            });
            state.invoices.unshift(data[0]);
        }

        async function recordPayment(invoiceId, amount, method = 'transfer', note = '') {
            const invoice = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === invoice.customer_id);
            const newPaid = Math.min(invoice.amount_paid + amount, invoice.amount);
            const isFullyPaid = newPaid >= invoice.amount;
            
            // Create payment record
            const paymentRecord = { 
                id: 'pay-' + Date.now().toString(), 
                invoiceId, 
                customerId: invoice.customer_id,
                customerName: cust?.name || 'Unknown',
                invoiceNumber: invoice.invoice_number,
                amount, 
                method,
                note,
                date: new Date().toISOString(),
                isFullPayment: isFullyPaid
            };
            
            // DEV_MODE: Just update local state
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                invoice.amount_paid = newPaid;
                if (isFullyPaid) {
                    invoice.paid_date = new Date().toISOString();
                }
                state.paymentHistory.push(paymentRecord);
                localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
                localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                return;
            }
            
            await supabaseQuery('invoices', {
                method: 'PATCH',
                query: `id=eq.${invoiceId}`,
                body: { amount_paid: newPaid, paid_date: isFullyPaid ? new Date().toISOString() : null }
            });
            invoice.amount_paid = newPaid;
            if (isFullyPaid) {
                invoice.paid_date = new Date().toISOString();
            }
            state.paymentHistory.push(paymentRecord);
            localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
        }

        // ========== HELPERS ==========
        const formatNaira = (amt) => 'â‚¦' + Number(amt).toLocaleString();
        const formatDate = (d) => new Date(d).toLocaleDateString('en-NG', { day: 'numeric', month: 'short', year: 'numeric' });
        const getStatus = (inv) => {
            if (inv.amount_paid >= inv.amount) return 'paid';
            if (new Date(inv.due_date) < new Date()) return 'overdue';
            return 'pending';
        };
        
        function generateInvoiceNumber() {
            const existing = state.invoices.map(inv => {
                const match = inv.invoice_number?.match(/INV-(\d+)/);
                return match ? parseInt(match[1]) : 0;
            });
            const maxNum = existing.length > 0 ? Math.max(...existing) : 0;
            const nextNum = maxNum + 1;
            return `INV-${String(nextNum).padStart(3, '0')}`;
        }

        // ========== RENDER ==========
        function render() {
            const app = document.getElementById('app');
            
            // Handle different sections
            if (state.currentSection === 'landing') {
                app.innerHTML = renderLanding();
                attachLandingEvents();
                return;
            }
            
            if (state.currentSection === 'onboarding') {
                app.innerHTML = renderOnboarding();
                attachOnboardingEvents();
                return;
            }
            
            if (state.loading) { 
                app.innerHTML = `
                    <header class="header">
                        <div class="header-content">
                            <h1>Owo Mi ðŸ’°</h1>
                        </div>
                    </header>
                    <main class="main">
                        <div class="stats">
                            <div class="stat"><div class="skeleton" style="height:16px;width:60%;margin-bottom:8px;"></div><div class="skeleton" style="height:28px;width:80%;"></div></div>
                            <div class="stat"><div class="skeleton" style="height:16px;width:60%;margin-bottom:8px;"></div><div class="skeleton" style="height:28px;width:80%;"></div></div>
                        </div>
                        <div class="quick-actions">
                            <div class="skeleton" style="height:52px;border-radius:14px;"></div>
                            <div class="skeleton" style="height:52px;border-radius:14px;"></div>
                        </div>
                        <div class="skeleton" style="height:24px;width:40%;margin-bottom:16px;"></div>
                        <div class="card"><div class="skeleton" style="height:20px;width:50%;margin-bottom:12px;"></div><div class="skeleton" style="height:16px;width:70%;margin-bottom:8px;"></div><div class="skeleton" style="height:40px;margin-top:12px;border-radius:10px;"></div></div>
                        <div class="card"><div class="skeleton" style="height:20px;width:50%;margin-bottom:12px;"></div><div class="skeleton" style="height:16px;width:70%;margin-bottom:8px;"></div><div class="skeleton" style="height:40px;margin-top:12px;border-radius:10px;"></div></div>
                    </main>
                    <nav class="nav">
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                    </nav>
                `; 
                return; 
            }
            if (!state.user) { app.innerHTML = renderAuth(); attachAuthEvents(); return; }
            app.innerHTML = renderApp();
            attachAppEvents();
        }
        
        // ========== LANDING PAGE ==========
        function renderLanding() {
            return `
                <div class="landing-section">
                    <nav class="landing-nav">
                        <div class="landing-logo">ðŸ’° Owo Mi</div>
                        <button class="landing-nav-btn" id="landing-get-started">Get Started â†’</button>
                    </nav>
                    
                    <div class="landing-hero">
                        <div>
                            <div class="landing-badge">ðŸ‡³ðŸ‡¬ Made for Nigerian Businesses</div>
                            <h1 class="landing-title">Stop Chasing <span>Payments.</span> Start Growing.</h1>
                            <p class="landing-subtitle">Create invoices in seconds, send reminders via WhatsApp & SMS, and track every kobo your customers owe you.</p>
                            <div class="landing-ctas">
                                <button class="landing-cta-primary" id="landing-start-free">Start Free Today â†’</button>
                                <button class="landing-cta-secondary" id="landing-see-features">See Features â†“</button>
                            </div>
                            <div class="landing-stats">
                                <div>
                                    <div class="landing-stat-value">5,000+</div>
                                    <div class="landing-stat-label">Invoices Sent</div>
                                </div>
                                <div>
                                    <div class="landing-stat-value">â‚¦50M+</div>
                                    <div class="landing-stat-label">Collected</div>
                                </div>
                                <div>
                                    <div class="landing-stat-value">98%</div>
                                    <div class="landing-stat-label">Payment Rate</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="landing-phone">
                                <div class="landing-phone-screen">
                                    <div class="landing-phone-header">
                                        <div class="landing-phone-greeting">Good morning ðŸ‘‹</div>
                                        <div class="landing-phone-title">Owo Mi ðŸ’°</div>
                                    </div>
                                    <div class="landing-phone-stats">
                                        <div class="landing-phone-stat">
                                            <div class="landing-phone-stat-label">Outstanding</div>
                                            <div class="landing-phone-stat-value">â‚¦350K</div>
                                        </div>
                                        <div class="landing-phone-stat">
                                            <div class="landing-phone-stat-label">Collected</div>
                                            <div class="landing-phone-stat-value">â‚¦1.2M</div>
                                        </div>
                                    </div>
                                    <div class="landing-phone-card">
                                        <div class="landing-phone-card-top">
                                            <div>
                                                <div class="landing-phone-card-name">Chidi Okonkwo</div>
                                                <div class="landing-phone-card-desc">Website Design</div>
                                            </div>
                                            <div class="landing-phone-card-amount">â‚¦150K</div>
                                        </div>
                                        <span class="landing-phone-badge paid">Paid âœ“</span>
                                    </div>
                                    <div class="landing-phone-card">
                                        <div class="landing-phone-card-top">
                                            <div>
                                                <div class="landing-phone-card-name">Amaka Johnson</div>
                                                <div class="landing-phone-card-desc">Logo Design</div>
                                            </div>
                                            <div class="landing-phone-card-amount">â‚¦75K</div>
                                        </div>
                                        <span class="landing-phone-badge pending">Pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="landing-features" id="features">
                        <div class="landing-features-inner">
                            <h2 class="landing-section-title">Everything You Need to Get Paid</h2>
                            <div class="landing-features-grid">
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“„</div>
                                    <h3 class="landing-feature-title">Professional Invoices</h3>
                                    <p class="landing-feature-desc">Create beautiful PDF invoices with your logo and bank details.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“±</div>
                                    <h3 class="landing-feature-title">WhatsApp & SMS</h3>
                                    <p class="landing-feature-desc">Send payment reminders in one tap via WhatsApp or SMS.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ’³</div>
                                    <h3 class="landing-feature-title">Paystack Payments</h3>
                                    <p class="landing-feature-desc">Generate payment links so customers can pay online.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“Š</div>
                                    <h3 class="landing-feature-title">Real-time Dashboard</h3>
                                    <p class="landing-feature-desc">See outstanding, collected, and overdue at a glance.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ¤–</div>
                                    <h3 class="landing-feature-title">AI Assistant</h3>
                                    <p class="landing-feature-desc">"Invoice Chidi â‚¦50k" - understands English and Pidgin!</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">â°</div>
                                    <h3 class="landing-feature-title">Auto Reminders</h3>
                                    <p class="landing-feature-desc">Set it and forget it. Automatic reminders on due dates.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="landing-cta-section">
                        <h2>Ready to Get Paid Faster?</h2>
                        <p>Join thousands of Nigerian businesses using Owo Mi.</p>
                        <button id="landing-cta-btn">Start Free - No Card Needed â†’</button>
                    </div>
                    
                    <footer class="landing-footer">
                        <div class="landing-footer-logo">ðŸ’° Owo Mi</div>
                        <p>Â© 2025 Owo Mi. Made with ðŸ’š in Nigeria ðŸ‡³ðŸ‡¬</p>
                    </footer>
                </div>
            `;
        }
        
        function attachLandingEvents() {
            document.getElementById('landing-get-started')?.addEventListener('click', goToAuth);
            document.getElementById('landing-start-free')?.addEventListener('click', goToAuth);
            document.getElementById('landing-cta-btn')?.addEventListener('click', goToAuth);
            document.getElementById('landing-see-features')?.addEventListener('click', () => {
                document.getElementById('features')?.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        function goToAuth() {
            state.currentSection = 'auth';
            state.loading = false;
            render();
        }
        
        // ========== ONBOARDING ==========
        function renderOnboarding() {
            const steps = [
                { icon: 'ðŸŽ‰', title: 'Welcome to Owo Mi!', desc: "Let's set up your business in just a few steps. This helps create professional invoices and get paid faster." },
                { icon: 'ðŸª', title: 'Your Business Info', desc: 'This information will appear on your invoices.' },
                { icon: 'ðŸ¦', title: 'Bank Details', desc: 'Customers will see this on invoices so they know where to pay.' },
                { icon: 'âœ¨', title: "You're All Set!", desc: "Here's what you can do with Owo Mi:" }
            ];
            
            const step = steps[state.onboardingStep - 1];
            
            let content = '';
            if (state.onboardingStep === 1) {
                content = `
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Let's Go! â†’</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip">Skip setup, I'll do it later</button>
                `;
            } else if (state.onboardingStep === 2) {
                content = `
                    <div class="onboarding-form">
                        <div class="form-group">
                            <label class="form-label">Business Name</label>
                            <input type="text" class="form-input" id="onboard-business" placeholder="e.g. Chidi's Design Studio" value="${state.businessProfile.name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="onboard-phone" placeholder="08012345678" value="${state.businessProfile.phone || ''}">
                        </div>
                    </div>
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â† Back</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Continue â†’</button>
                    </div>
                `;
            } else if (state.onboardingStep === 3) {
                content = `
                    <div class="onboarding-form">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="onboard-bank" placeholder="e.g. GTBank" value="${state.businessProfile.bank || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-input" id="onboard-account" placeholder="0123456789" maxlength="10" value="${state.businessProfile.accountNumber || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" class="form-input" id="onboard-account-name" placeholder="Chidi Okonkwo" value="${state.businessProfile.accountName || ''}">
                        </div>
                    </div>
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â† Back</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Continue â†’</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip">Skip for now</button>
                `;
            } else if (state.onboardingStep === 4) {
                content = `
                    <div class="onboarding-features">
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ“„</div>
                            <div class="onboarding-feature-title">Create Invoices</div>
                            <div class="onboarding-feature-desc">Tap + to create</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ“±</div>
                            <div class="onboarding-feature-title">Send Reminders</div>
                            <div class="onboarding-feature-desc">WhatsApp & SMS</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ¤–</div>
                            <div class="onboarding-feature-title">AI Assistant</div>
                            <div class="onboarding-feature-desc">Speaks Pidgin!</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ“Š</div>
                            <div class="onboarding-feature-title">Track Payments</div>
                            <div class="onboarding-feature-desc">See who owes you</div>
                        </div>
                    </div>
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-complete" style="width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);">ðŸš€ Start Using Owo Mi</button>
                    </div>
                `;
            }
            
            return `
                <div class="onboarding-section">
                    <div class="onboarding-container">
                        <div class="onboarding-progress">
                            ${[1,2,3,4].map(n => `<div class="onboarding-progress-step ${n < state.onboardingStep ? 'completed' : ''} ${n === state.onboardingStep ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <div class="onboarding-step active">
                            <div class="onboarding-icon">${step.icon}</div>
                            <h2 class="onboarding-title">${step.title}</h2>
                            <p class="onboarding-desc">${step.desc}</p>
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function attachOnboardingEvents() {
            document.getElementById('onboard-next')?.addEventListener('click', nextOnboardingStep);
            document.getElementById('onboard-prev')?.addEventListener('click', prevOnboardingStep);
            document.getElementById('onboard-skip')?.addEventListener('click', completeOnboarding);
            document.getElementById('onboard-complete')?.addEventListener('click', completeOnboarding);
        }
        
        function nextOnboardingStep() {
            // Save current step data
            if (state.onboardingStep === 2) {
                state.businessProfile.name = document.getElementById('onboard-business')?.value?.trim() || '';
                state.businessProfile.phone = document.getElementById('onboard-phone')?.value?.trim() || '';
            } else if (state.onboardingStep === 3) {
                state.businessProfile.bank = document.getElementById('onboard-bank')?.value?.trim() || '';
                state.businessProfile.accountNumber = document.getElementById('onboard-account')?.value?.trim() || '';
                state.businessProfile.accountName = document.getElementById('onboard-account-name')?.value?.trim() || '';
            }
            
            if (state.onboardingStep < 4) {
                state.onboardingStep++;
                render();
            }
        }
        
        function prevOnboardingStep() {
            if (state.onboardingStep > 1) {
                state.onboardingStep--;
                render();
            }
        }
        
        function completeOnboarding() {
            // Save business profile
            localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
            localStorage.setItem('owomi_onboarded', 'true');
            
            state.currentSection = 'app';
            showToast('Welcome to Owo Mi! ðŸŽ‰', 'success');
            render();
        }

        function renderAuth() {
            return `
                <div class="auth-container">
                    <div class="auth-box">
                        <div class="auth-title">Owo Mi ðŸ’°</div>
                        <div class="auth-subtitle">Smart Invoice Manager for Nigerian Businesses</div>
                        <div class="tabs">
                            <button class="tab active" data-tab="login">Login</button>
                            <button class="tab" data-tab="signup">Sign Up</button>
                        </div>
                        <div id="auth-error" class="error-msg hidden"></div>
                        <div id="auth-success" class="success-msg hidden"></div>
                        <form id="auth-form">
                            <div class="form-group hidden" id="name-group">
                                <label class="form-label">Business Name</label>
                                <input type="text" class="form-input" id="auth-name" placeholder="Your business name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="auth-email" placeholder="you@example.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary" id="auth-btn">Login</button>
                        </form>
                        <button id="auth-back-btn" style="display:block;width:100%;text-align:center;margin-top:20px;background:none;border:none;color:#888;font-size:14px;cursor:pointer;">â† Back to Home</button>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            
            // Time-based greeting
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            const businessName = state.businessProfile.name ? `, ${state.businessProfile.name.split(' ')[0]}` : '';

            return `
                <header class="header">
                    <div class="header-content">
                        <div>
                            <h1 style="font-size:20px;opacity:0.9;font-weight:500;">${greeting}${businessName} ðŸ‘‹</h1>
                            <div style="font-size:14px;opacity:0.8;margin-top:2px;">Owo Mi ðŸ’°</div>
                        </div>
                        <div class="header-actions">
                            <button class="header-btn" id="btn-ai" title="AI Assistant">ðŸ¤–</button>
                        </div>
                    </div>
                </header>
                <main class="main">
                    ${state.activeTab === 'home' ? renderHome(outstanding, collected) : ''}
                    ${state.activeTab === 'invoices' ? renderInvoices() : ''}
                    ${state.activeTab === 'menu' ? renderMenu() : ''}
                </main>
                <nav class="nav">
                    <button class="nav-item ${state.activeTab === 'home' ? 'active' : ''}" data-tab="home">
                        <div class="nav-icon">ðŸ </div>
                        <div class="nav-label">Home</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'invoices' ? 'active' : ''}" data-tab="invoices">
                        <div class="nav-icon">ðŸ“„</div>
                        <div class="nav-label">Invoices</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'menu' ? 'active' : ''}" data-tab="menu">
                        <div class="nav-icon">â˜°</div>
                        <div class="nav-label">Menu</div>
                    </button>
                </nav>
                <div id="modal-container"></div>
            `;
        }

        function renderHome(outstanding, collected) {
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmt = overdue.reduce((s, i) => s + (i.amount - i.amount_paid), 0);

            return `
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value">${formatNaira(outstanding)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Collected</div>
                        <div class="stat-value green">${formatNaira(collected)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Overdue</div>
                        <div class="stat-value red">${formatNaira(overdueAmt)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Customers</div>
                        <div class="stat-value">${state.customers.length}</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-btn primary" id="btn-new-invoice">ðŸ“„ New Invoice</button>
                    <button class="quick-btn secondary" id="btn-new-customer">ðŸ‘¤ Customer</button>
                </div>

                ${renderChart()}

                <div class="section-header">
                    <div class="section-title">Recent Invoices</div>
                    <button class="section-link" data-goto="invoices">See All</button>
                </div>
                ${state.invoices.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“„</div>No invoices yet.<br>Create your first one!</div>' : 
                    state.invoices.slice(0, 3).map(renderInvoiceCard).join('')}
            `;
        }

        function renderChart() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({ label: d.toLocaleDateString('en-US', { month: 'short' }), year: d.getFullYear(), month: d.getMonth(), collected: 0 });
            }
            state.invoices.forEach(inv => {
                const d = new Date(inv.created_at);
                months.forEach(m => { if (d.getFullYear() === m.year && d.getMonth() === m.month) m.collected += Number(inv.amount_paid); });
            });
            const max = Math.max(...months.map(m => m.collected), 1);

            return `
                <div class="chart-container">
                    <div class="chart-title">ðŸ“Š Collections (6 Months)</div>
                    <div class="bar-chart">
                        ${months.map(m => `
                            <div class="bar-group">
                                <div class="bar" style="height: ${(m.collected / max) * 80}px;" title="${formatNaira(m.collected)}"></div>
                                <div class="bar-label">${m.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderInvoices() {
            let filtered = state.invoices;
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(inv => {
                    const cust = state.customers.find(c => c.id === inv.customer_id);
                    return inv.description.toLowerCase().includes(q) || (cust && cust.name.toLowerCase().includes(q));
                });
            }
            if (state.filterStatus !== 'all') filtered = filtered.filter(inv => getStatus(inv) === state.filterStatus);

            return `
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="ðŸ” Search invoices..." value="${state.searchQuery}">
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab ${state.filterStatus === 'all' ? 'active' : ''}" data-filter="all">All</button>
                    <button class="filter-tab ${state.filterStatus === 'pending' ? 'active' : ''}" data-filter="pending">Pending</button>
                    <button class="filter-tab ${state.filterStatus === 'overdue' ? 'active' : ''}" data-filter="overdue">Overdue</button>
                    <button class="filter-tab ${state.filterStatus === 'paid' ? 'active' : ''}" data-filter="paid">Paid</button>
                </div>
                ${filtered.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“„</div>No invoices found</div>' : 
                    filtered.map(renderInvoiceCard).join('')}
            `;
        }

        function renderInvoiceCard(inv) {
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 3).toUpperCase()}`;
            const itemCount = inv.items?.length || 1;
            return `
                <div class="card">
                    <div class="card-top">
                        <div>
                            <div class="card-name">${cust?.name || 'Unknown'} <span style="color:#6366f1;font-size:12px;font-weight:600;">${invNumber}</span></div>
                            <div class="card-desc">${inv.description} ${itemCount > 1 ? `<span style="color:#999;">(${itemCount} items)</span>` : ''}</div>
                            <div class="card-date">Due: ${formatDate(inv.due_date)}</div>
                        </div>
                        <div class="card-amount">
                            ${formatNaira(inv.amount)}
                            <div class="badge badge-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn btn-pdf" data-pdf="${inv.id}" title="Download Invoice PDF">ðŸ“„ PDF</button>
                        ${status === 'paid' ? `<button class="card-btn btn-pay" data-receipt="${inv.id}" title="Generate Receipt">ðŸ§¾ Receipt</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-whatsapp" data-whatsapp="${inv.id}" title="Send WhatsApp Reminder">ðŸ’¬ WhatsApp</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-sms" data-sms="${inv.id}" title="Send SMS Reminder">ðŸ“± SMS</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-paylink" data-paylink="${inv.id}" title="Create Paystack Payment Link">ðŸ’³ Pay Link</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-pay" data-pay="${inv.id}" title="Record Manual Payment">ðŸ’° Record</button>` : ''}
                        <button class="card-btn btn-edit" data-edit-inv="${inv.id}" title="Edit Invoice">âœï¸</button>
                    </div>
                </div>
            `;
        }

        function renderMenu() {
            if (state.menuPage === 'customers') return renderCustomersPage();
            if (state.menuPage === 'reports') return renderReportsPage();
            if (state.menuPage === 'recurring') return renderRecurringPage();
            if (state.menuPage === 'products') return renderProductsPage();
            if (state.menuPage === 'expenses') return renderExpensesPage();
            if (state.menuPage === 'settings') return renderSettingsPage();
            if (state.menuPage === 'reminders') return renderRemindersPage();
            if (state.menuPage === 'payments') return renderPaymentsPage();

            const isDark = document.body.classList.contains('dark');
            const remindersEnabled = state.reminderSettings?.enabled;
            const recentPaymentsCount = state.paymentHistory.filter(p => {
                const date = new Date(p.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return date > weekAgo;
            }).length;
            
            return `
                <div class="menu-section">Business</div>
                <div class="menu-grid">
                    <button class="menu-item" data-menu="customers">
                        <div class="menu-icon">ðŸ‘¥</div>
                        <div class="menu-text">Customers</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="payments">
                        <div class="menu-icon">ðŸ’°</div>
                        <div class="menu-text">Payment History</div>
                        ${recentPaymentsCount > 0 ? `<div style="font-size:11px;padding:3px 8px;border-radius:10px;background:#dcfce7;color:#166534;">${recentPaymentsCount} this week</div>` : '<div class="menu-arrow">â€º</div>'}
                    </button>
                    <button class="menu-item" data-menu="products">
                        <div class="menu-icon">ðŸ“¦</div>
                        <div class="menu-text">Products & Services</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="expenses">
                        <div class="menu-icon">ðŸ’¸</div>
                        <div class="menu-text">Expenses</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="reports">
                        <div class="menu-icon">ðŸ“ˆ</div>
                        <div class="menu-text">Reports</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="recurring">
                        <div class="menu-icon">ðŸ”„</div>
                        <div class="menu-text">Recurring Invoices</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" id="btn-export">
                        <div class="menu-icon">ðŸ“¥</div>
                        <div class="menu-text">Export to CSV</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                </div>

                <div class="menu-section">Settings</div>
                <div class="menu-grid">
                    <button class="menu-item" data-menu="reminders">
                        <div class="menu-icon">â°</div>
                        <div class="menu-text">Auto Reminders</div>
                        <div style="font-size:11px;padding:3px 8px;border-radius:10px;background:${remindersEnabled ? '#dcfce7' : '#fee2e2'};color:${remindersEnabled ? '#166534' : '#dc2626'};">${remindersEnabled ? 'ON' : 'OFF'}</div>
                    </button>
                    <button class="menu-item" data-menu="settings">
                        <div class="menu-icon">âš™ï¸</div>
                        <div class="menu-text">Business Profile</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <div class="menu-item" id="dark-toggle">
                        <div class="menu-icon">ðŸŒ™</div>
                        <div class="menu-text">Dark Mode</div>
                        <div class="menu-toggle ${isDark ? 'active' : ''}"></div>
                    </div>
                    <button class="menu-item" id="btn-logout" style="color: #dc2626;">
                        <div class="menu-icon">ðŸšª</div>
                        <div class="menu-text" style="color: #dc2626;">Logout</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                </div>
                
                <div class="menu-section">About</div>
                <div class="menu-grid">
                    <a href="https://owomi.ng" class="menu-item" style="text-decoration:none;color:inherit;" target="_blank">
                        <div class="menu-icon">ðŸ </div>
                        <div class="menu-text">Visit Website</div>
                        <div class="menu-arrow">â€º</div>
                    </a>
                    <a href="https://wa.me/2348000000000" class="menu-item" style="text-decoration:none;color:inherit;" target="_blank">
                        <div class="menu-icon">ðŸ’¬</div>
                        <div class="menu-text">WhatsApp Support</div>
                        <div class="menu-arrow">â€º</div>
                    </a>
                    <div class="menu-item" style="opacity:0.7;">
                        <div class="menu-icon">ðŸ“±</div>
                        <div class="menu-text">Owo Mi v${APP_VERSION}</div>
                        <div class="menu-arrow"></div>
                    </div>
                </div>
                
                <div style="text-align:center;padding:30px 20px;color:#94a3b8;font-size:12px;">
                    Made with ðŸ’œ for Nigerian businesses<br>
                    Â© ${new Date().getFullYear()} Owo Mi
                </div>
            `;
        }

        function renderCustomersPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">Customers</div>
                    <button class="section-link" id="btn-add-customer">+ Add</button>
                </div>
                ${state.customers.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ‘¥</div>No customers yet</div>' :
                    state.customers.map(cust => {
                        const owed = state.invoices.filter(i => i.customer_id === cust.id).reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                        const invoiceCount = state.invoices.filter(i => i.customer_id === cust.id).length;
                        return `
                            <div class="customer-card">
                                <div class="customer-info">
                                    <div>
                                        <div class="customer-name">${cust.name}</div>
                                        <div class="customer-phone">${cust.phone} â€¢ ${invoiceCount} invoice(s)</div>
                                    </div>
                                    <div class="customer-balance" style="color: ${owed > 0 ? '#dc2626' : '#16a34a'}">
                                        ${owed > 0 ? 'Owes ' + formatNaira(owed) : 'Clear âœ“'}
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <button class="card-btn btn-whatsapp" data-share-portal="${cust.id}" title="Share payment portal link">ðŸ”— Portal</button>
                                    <button class="card-btn btn-pdf" data-statement="${cust.id}">ðŸ“‹ Statement</button>
                                    <button class="card-btn btn-edit" data-edit-cust="${cust.id}">âœï¸ Edit</button>
                                    <button class="card-btn btn-sms" data-delete-cust="${cust.id}">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderReportsPage() {
            const totalInvoiced = state.invoices.reduce((s, i) => s + Number(i.amount), 0);
            const totalCollected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            const collectionRate = totalInvoiced > 0 ? ((totalCollected / totalInvoiced) * 100).toFixed(1) : 0;
            const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmount = overdueInvoices.reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);
            
            const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
            const profit = totalCollected - totalExpenses;

            const customerDebts = state.customers.map(c => {
                const custInv = state.invoices.filter(i => i.customer_id === c.id);
                return { name: c.name, owed: custInv.reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0) };
            }).filter(c => c.owed > 0).sort((a, b) => b.owed - a.owed).slice(0, 5);

            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 16px;">ðŸ“ˆ Reports</div>

                <div class="report-card">
                    <div class="report-title">ðŸ’° Revenue Summary</div>
                    <div class="report-row"><span class="report-label">Total Invoiced</span><span class="report-value">${formatNaira(totalInvoiced)}</span></div>
                    <div class="report-row"><span class="report-label">Total Collected</span><span class="report-value green">${formatNaira(totalCollected)}</span></div>
                    <div class="report-row"><span class="report-label">Outstanding</span><span class="report-value red">${formatNaira(totalInvoiced - totalCollected)}</span></div>
                    <div class="report-row"><span class="report-label">Collection Rate</span><span class="report-value">${collectionRate}%</span></div>
                </div>

                <div class="report-card">
                    <div class="report-title">ðŸ“Š Profit & Loss</div>
                    <div class="report-row"><span class="report-label">Revenue (Collected)</span><span class="report-value green">${formatNaira(totalCollected)}</span></div>
                    <div class="report-row"><span class="report-label">Total Expenses</span><span class="report-value red">-${formatNaira(totalExpenses)}</span></div>
                    <div class="report-row" style="border-top:2px solid #6366f1;margin-top:8px;padding-top:12px;">
                        <span class="report-label" style="font-weight:700;">Net Profit</span>
                        <span class="report-value" style="color:${profit >= 0 ? '#16a34a' : '#dc2626'};font-size:18px;">${profit >= 0 ? '' : '-'}${formatNaira(Math.abs(profit))}</span>
                    </div>
                </div>

                <div class="report-card">
                    <div class="report-title">âš ï¸ Overdue</div>
                    <div class="report-row"><span class="report-label">Overdue Invoices</span><span class="report-value red">${overdueInvoices.length}</span></div>
                    <div class="report-row"><span class="report-label">Overdue Amount</span><span class="report-value red">${formatNaira(overdueAmount)}</span></div>
                </div>

                <div class="report-card">
                    <div class="report-title">ðŸ”´ Top Debtors</div>
                    ${customerDebts.length === 0 ? '<div style="color:#999;padding:10px 0;">No outstanding debts! ðŸŽ‰</div>' :
                        customerDebts.map((c, i) => `
                            <div class="report-row">
                                <span class="report-label">${i + 1}. ${c.name}</span>
                                <span class="report-value red">${formatNaira(c.owed)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
        }

        function renderRecurringPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ”„ Recurring</div>
                    <button class="section-link" id="btn-add-recurring">+ Add</button>
                </div>
                ${state.recurringTemplates.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ”„</div>No recurring invoices yet.<br>Auto-generate invoices monthly!</div>' :
                    state.recurringTemplates.map(tmpl => {
                        const cust = state.customers.find(c => c.id === tmpl.customerId);
                        return `
                            <div class="card">
                                <div class="card-top">
                                    <div>
                                        <div class="card-name">${cust?.name || 'Unknown'}<span class="recurring-badge">${tmpl.frequency}</span></div>
                                        <div class="card-desc">${tmpl.description}</div>
                                    </div>
                                    <div class="card-amount">
                                        ${formatNaira(tmpl.amount)}
                                        <div class="badge ${tmpl.active ? 'badge-paid' : 'badge-pending'}">${tmpl.active ? 'Active' : 'Paused'}</div>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="card-btn btn-pay" data-generate="${tmpl.id}">âš¡ Generate</button>
                                    <button class="card-btn btn-edit" data-toggle-rec="${tmpl.id}">${tmpl.active ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                                    <button class="card-btn btn-pdf" data-delete-rec="${tmpl.id}">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderProductsPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ“¦ Products & Services</div>
                    <button class="section-link" id="btn-add-product">+ Add</button>
                </div>
                <p style="color:#666;font-size:14px;margin-bottom:16px;">Save your common products/services for quick invoicing</p>
                ${state.products.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“¦</div>No products yet.<br>Add products to speed up invoicing!</div>' :
                    state.products.map(prod => `
                        <div class="card">
                            <div class="card-top">
                                <div>
                                    <div class="card-name">${prod.name}</div>
                                    <div class="card-desc">${prod.description || 'No description'}</div>
                                </div>
                                <div class="card-amount">
                                    ${formatNaira(prod.price)}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn btn-edit" data-edit-prod="${prod.id}">âœï¸ Edit</button>
                                <button class="card-btn btn-pdf" data-delete-prod="${prod.id}">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `).join('')}
            `;
        }

        function renderExpensesPage() {
            const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
            const categories = [...new Set(state.expenses.map(e => e.category))];
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ’¸ Expenses</div>
                    <button class="section-link" id="btn-add-expense">+ Add</button>
                </div>
                
                <div class="stat" style="margin-bottom:16px;">
                    <div class="stat-label">Total Expenses (This Month)</div>
                    <div class="stat-value red">${formatNaira(totalExpenses)}</div>
                </div>
                
                ${categories.length > 0 ? `
                <div class="report-card" style="margin-bottom:16px;">
                    <div class="report-title">ðŸ“Š By Category</div>
                    ${categories.map(cat => {
                        const catTotal = state.expenses.filter(e => e.category === cat).reduce((s, e) => s + Number(e.amount), 0);
                        return `<div class="report-row"><span class="report-label">${cat}</span><span class="report-value red">${formatNaira(catTotal)}</span></div>`;
                    }).join('')}
                </div>
                ` : ''}
                
                ${state.expenses.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ’¸</div>No expenses recorded.<br>Track your costs to see real profit!</div>' :
                    state.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => `
                        <div class="card">
                            <div class="card-top">
                                <div>
                                    <div class="card-name">${exp.description}</div>
                                    <div class="card-desc">${exp.category || 'Uncategorized'}</div>
                                    <div class="card-date">${formatDate(exp.date)}</div>
                                </div>
                                <div class="card-amount" style="color:#dc2626;">
                                    -${formatNaira(exp.amount)}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn btn-edit" data-edit-exp="${exp.id}">âœï¸ Edit</button>
                                <button class="card-btn btn-pdf" data-delete-exp="${exp.id}">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `).join('')}
            `;
        }

        function renderSettingsPage() {
            const p = state.businessProfile;
            const r = state.reminderSettings || { before_due_days: 3, on_due_date: true, after_due_days: [3, 7], enabled: false };
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 16px;">âš™ï¸ Business Profile</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">This info appears on your PDF invoices</p>
                <div class="form-group">
                    <label class="form-label">Business Name</label>
                    <input type="text" class="form-input" id="set-name" value="${p.name || ''}" placeholder="Your Business Name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-input" id="set-phone" value="${p.phone || ''}" placeholder="08012345678">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="set-address" value="${p.address || ''}" placeholder="Business Address">
                </div>
                <div class="form-group">
                    <label class="form-label">Bank Details</label>
                    <textarea class="form-input" id="set-bank" rows="3" placeholder="Bank Name&#10;Account Number&#10;Account Name">${p.bank || ''}</textarea>
                </div>

                <div class="report-card" style="margin-top:24px;">
                    <div class="report-title">ðŸ”’ Secure Integrations</div>
                    <p style="color:#666;font-size:13px;">SMS and Payment features are securely configured. Your API keys are safely stored on the server.</p>
                    <div style="margin-top:12px;">
                        <span class="badge badge-paid">âœ“ SMS (Termii)</span>
                        <span class="badge badge-paid" style="margin-left:8px;">âœ“ Payments (Paystack)</span>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-settings" style="margin-top:16px;">Save Settings</button>

                <div class="section-title" style="margin: 32px 0 16px;">ðŸ”” Auto Reminders</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">Automatically remind customers about unpaid invoices</p>
                
                <div class="card" style="padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <div>
                            <div style="font-weight:600;">Enable Auto Reminders</div>
                            <div style="font-size:13px;color:#666;">Send SMS reminders automatically</div>
                        </div>
                        <div class="menu-toggle ${r.enabled ? 'active' : ''}" id="toggle-reminders"></div>
                    </div>

                    <div id="reminder-options" class="${r.enabled ? '' : 'hidden'}">
                        <div class="form-group">
                            <label class="form-label">Days before due date</label>
                            <select class="form-input" id="rem-before">
                                <option value="1" ${r.before_due_days === 1 ? 'selected' : ''}>1 day before</option>
                                <option value="2" ${r.before_due_days === 2 ? 'selected' : ''}>2 days before</option>
                                <option value="3" ${r.before_due_days === 3 ? 'selected' : ''}>3 days before</option>
                                <option value="5" ${r.before_due_days === 5 ? 'selected' : ''}>5 days before</option>
                                <option value="7" ${r.before_due_days === 7 ? 'selected' : ''}>7 days before</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="rem-due" ${r.on_due_date ? 'checked' : ''} style="width:20px;height:20px;">
                                Remind on due date
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Overdue reminders</label>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-3" ${r.after_due_days?.includes(3) ? 'checked' : ''}> 3 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-7" ${r.after_due_days?.includes(7) ? 'checked' : ''}> 7 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-14" ${r.after_due_days?.includes(14) ? 'checked' : ''}> 14 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-30" ${r.after_due_days?.includes(30) ? 'checked' : ''}> 30 days
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-reminders" style="margin-top:16px;">Save Reminder Settings</button>

                <button class="btn btn-secondary" id="btn-send-all-overdue" style="margin-top:12px;">ðŸ“¢ Send All Overdue Reminders Now</button>
            `;
        }

        function renderPaymentsPage() {
            const payments = [...state.paymentHistory].reverse();
            const totalReceived = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Group by month
            const grouped = {};
            payments.forEach(p => {
                const month = new Date(p.date).toLocaleDateString('en-NG', { month: 'long', year: 'numeric' });
                if (!grouped[month]) grouped[month] = [];
                grouped[month].push(p);
            });
            
            const methodIcons = {
                transfer: 'ðŸ¦',
                cash: 'ðŸ’µ',
                card: 'ðŸ’³',
                paystack: 'ðŸ”—'
            };
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 8px;">ðŸ’° Payment History</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">All recorded payments</p>
                
                <!-- Summary Card -->
                <div class="card" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white;margin-bottom:20px;">
                    <div style="text-align:center;">
                        <div style="font-size:13px;opacity:0.9;">Total Received</div>
                        <div style="font-size:32px;font-weight:700;">${formatNaira(totalReceived)}</div>
                        <div style="font-size:13px;opacity:0.9;margin-top:4px;">${payments.length} payment${payments.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                
                ${payments.length === 0 ? 
                    '<div class="card" style="padding:40px;text-align:center;color:#888;"><div style="font-size:48px;margin-bottom:12px;">ðŸ’°</div>No payments recorded yet<br><span style="font-size:13px;">Payments will appear here when you record them</span></div>' :
                    Object.entries(grouped).map(([month, monthPayments]) => `
                        <div class="menu-section">${month}</div>
                        ${monthPayments.map(p => {
                            const inv = state.invoices.find(i => i.id === p.invoiceId);
                            return `
                                <div class="card" style="margin-bottom:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                        <div style="flex:1;">
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span style="font-size:20px;">${methodIcons[p.method] || 'ðŸ’°'}</span>
                                                <div>
                                                    <div style="font-weight:600;">${p.customerName || 'Customer'}</div>
                                                    <div style="font-size:12px;color:#666;">${p.invoiceNumber || 'Invoice'}</div>
                                                </div>
                                            </div>
                                            ${p.note ? `<div style="font-size:12px;color:#888;margin-top:6px;font-style:italic;">"${p.note}"</div>` : ''}
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-weight:700;color:#16a34a;">${formatNaira(p.amount)}</div>
                                            <div style="font-size:11px;color:#888;">${formatDate(p.date)}</div>
                                            ${p.isFullPayment ? '<span style="font-size:10px;background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;">FULL</span>' : ''}
                                        </div>
                                    </div>
                                    ${inv && getStatus(inv) === 'paid' ? `
                                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                                            <button class="btn btn-secondary" style="width:100%;padding:10px;" data-receipt="${p.invoiceId}">ðŸ§¾ Generate Receipt</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    `).join('')
                }
            `;
        }

        // ========== CUSTOMER PAYMENT PORTAL ==========
        function renderCustomerPortal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            if (!cust) {
                return `
                    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:#f8fafc;">
                        <div style="text-align:center;">
                            <div style="font-size:64px;margin-bottom:16px;">ðŸ”—</div>
                            <h2 style="margin-bottom:8px;">Portal Not Found</h2>
                            <p style="color:#666;">This payment portal link is invalid or has expired.</p>
                        </div>
                    </div>
                `;
            }
            
            const p = state.businessProfile;
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId);
            const unpaidInvoices = custInvoices.filter(i => getStatus(i) !== 'paid');
            const paidInvoices = custInvoices.filter(i => getStatus(i) === 'paid');
            const totalOwed = unpaidInvoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            const totalPaid = custInvoices.reduce((s, i) => s + i.amount_paid, 0);
            
            // Get payment history for this customer
            const custPayments = state.paymentHistory.filter(pay => pay.customerId === customerId);
            
            return `
                <div class="portal-container">
                    <!-- Header -->
                    <div class="portal-header">
                        <div class="portal-business">${p.name || 'Owo Mi ðŸ’°'}</div>
                        <div class="portal-subtitle">Customer Payment Portal</div>
                    </div>
                    
                    <!-- Customer Info -->
                    <div class="portal-customer">
                        <div class="portal-avatar">${cust.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="portal-name">${cust.name}</div>
                            <div class="portal-phone">${cust.phone}</div>
                        </div>
                    </div>
                    
                    <!-- Balance Card -->
                    <div class="portal-balance ${totalOwed > 0 ? 'has-balance' : 'clear'}">
                        <div class="balance-label">${totalOwed > 0 ? 'Total Outstanding' : 'Account Status'}</div>
                        <div class="balance-amount">${totalOwed > 0 ? formatNaira(totalOwed) : 'âœ“ All Clear!'}</div>
                        <div class="balance-detail">${unpaidInvoices.length} unpaid invoice${unpaidInvoices.length !== 1 ? 's' : ''}</div>
                    </div>
                    
                    ${totalOwed > 0 ? `
                        <button class="portal-pay-all" id="portal-pay-all" data-amount="${totalOwed}">
                            ðŸ’³ Pay All ${formatNaira(totalOwed)}
                        </button>
                    ` : ''}
                    
                    <!-- Unpaid Invoices -->
                    ${unpaidInvoices.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">ðŸ“‹ Unpaid Invoices</div>
                            ${unpaidInvoices.map(inv => {
                                const owed = inv.amount - inv.amount_paid;
                                const status = getStatus(inv);
                                return `
                                    <div class="portal-invoice">
                                        <div class="portal-inv-top">
                                            <div>
                                                <div class="portal-inv-number">${inv.invoice_number || 'Invoice'}</div>
                                                <div class="portal-inv-desc">${inv.description}</div>
                                                <div class="portal-inv-due ${status === 'overdue' ? 'overdue' : ''}">
                                                    ${status === 'overdue' ? 'âš ï¸ Overdue' : 'Due: ' + formatDate(inv.due_date)}
                                                </div>
                                            </div>
                                            <div class="portal-inv-amount">${formatNaira(owed)}</div>
                                        </div>
                                        <div class="portal-inv-actions">
                                            <button class="portal-btn-view" data-portal-view="${inv.id}">ðŸ“„ View</button>
                                            <button class="portal-btn-pay" data-portal-pay="${inv.id}" data-amount="${owed}">ðŸ’³ Pay Now</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Paid Invoices -->
                    ${paidInvoices.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">âœ… Paid Invoices</div>
                            ${paidInvoices.map(inv => `
                                <div class="portal-invoice paid">
                                    <div class="portal-inv-top">
                                        <div>
                                            <div class="portal-inv-number">${inv.invoice_number || 'Invoice'}</div>
                                            <div class="portal-inv-desc">${inv.description}</div>
                                            <div class="portal-inv-paid-date">Paid ${inv.paid_date ? formatDate(inv.paid_date) : ''}</div>
                                        </div>
                                        <div class="portal-inv-amount paid">${formatNaira(inv.amount)}</div>
                                    </div>
                                    <div class="portal-inv-actions">
                                        <button class="portal-btn-view" data-portal-view="${inv.id}">ðŸ“„ Invoice</button>
                                        <button class="portal-btn-receipt" data-portal-receipt="${inv.id}">ðŸ§¾ Receipt</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Payment History -->
                    ${custPayments.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">ðŸ’° Payment History</div>
                            <div class="portal-payments">
                                ${custPayments.slice(-5).reverse().map(pay => `
                                    <div class="portal-payment">
                                        <div>
                                            <div class="portal-pay-date">${formatDate(pay.date)}</div>
                                            <div class="portal-pay-ref">${pay.invoiceNumber || 'Invoice'}</div>
                                        </div>
                                        <div class="portal-pay-amount">${formatNaira(pay.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Contact -->
                    <div class="portal-contact">
                        <div class="portal-contact-title">Need Help?</div>
                        ${p.phone ? `<a href="tel:${p.phone}" class="portal-contact-btn">ðŸ“ž Call ${p.phone}</a>` : ''}
                        ${p.phone ? `<a href="https://wa.me/234${p.phone.replace(/^0/, '')}" class="portal-contact-btn whatsapp" target="_blank">ðŸ’¬ WhatsApp</a>` : ''}
                    </div>
                    
                    <div class="portal-footer">
                        Powered by <strong>Owo Mi</strong> ðŸ’°
                    </div>
                </div>
            `;
        }

        function renderRemindersPage() {
            const r = state.reminderSettings || { 
                enabled: false, 
                before_due_days: 3, 
                on_due_date: true, 
                after_due_days: [3, 7],
                channel: 'whatsapp' // 'whatsapp', 'sms', or 'both'
            };
            
            // Get reminder history
            const reminderHistory = JSON.parse(localStorage.getItem('owomi_reminder_history') || '[]');
            const recentReminders = reminderHistory.slice(-20).reverse();
            
            // Calculate upcoming reminders
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingReminders = [];
            state.invoices.forEach(inv => {
                if (getStatus(inv) === 'paid') return;
                
                const cust = state.customers.find(c => c.id === inv.customer_id);
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                // Before due date
                if (diffDays === r.before_due_days) {
                    upcomingReminders.push({
                        invoice: inv,
                        customer: cust,
                        type: 'before',
                        label: `${r.before_due_days} days before due`,
                        daysUntil: diffDays
                    });
                }
                // On due date
                if (diffDays === 0 && r.on_due_date) {
                    upcomingReminders.push({
                        invoice: inv,
                        customer: cust,
                        type: 'due',
                        label: 'Due today',
                        daysUntil: 0
                    });
                }
                // Overdue
                if (diffDays < 0) {
                    const overdueDays = Math.abs(diffDays);
                    if (r.after_due_days?.includes(overdueDays)) {
                        upcomingReminders.push({
                            invoice: inv,
                            customer: cust,
                            type: 'overdue',
                            label: `${overdueDays} days overdue`,
                            daysUntil: diffDays
                        });
                    }
                }
            });
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 8px;">â° Auto Reminders</div>
                <p style="color:#666;margin-bottom:24px;font-size:14px;">Automatically remind customers about unpaid invoices</p>
                
                <!-- Master Toggle -->
                <div class="card" style="padding:20px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:700;font-size:17px;">Auto Reminders</div>
                            <div style="font-size:13px;color:#666;margin-top:4px;">${r.enabled ? 'Reminders will send automatically' : 'Turn on to send automatic reminders'}</div>
                        </div>
                        <div class="menu-toggle ${r.enabled ? 'active' : ''}" id="toggle-reminders-master" style="transform:scale(1.2);"></div>
                    </div>
                </div>
                
                <!-- Settings -->
                <div class="card" style="padding:20px;margin-bottom:16px;${r.enabled ? '' : 'opacity:0.5;pointer-events:none;'}">
                    <div style="font-weight:600;margin-bottom:16px;">ðŸ“… When to Remind</div>
                    
                    <div class="form-group" style="margin-bottom:16px;">
                        <label class="form-label">Before due date</label>
                        <select class="form-input" id="rem-before">
                            <option value="0" ${r.before_due_days === 0 ? 'selected' : ''}>Don't remind before</option>
                            <option value="1" ${r.before_due_days === 1 ? 'selected' : ''}>1 day before</option>
                            <option value="2" ${r.before_due_days === 2 ? 'selected' : ''}>2 days before</option>
                            <option value="3" ${r.before_due_days === 3 ? 'selected' : ''}>3 days before</option>
                            <option value="5" ${r.before_due_days === 5 ? 'selected' : ''}>5 days before</option>
                            <option value="7" ${r.before_due_days === 7 ? 'selected' : ''}>7 days before</option>
                        </select>
                    </div>

                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:10px;">
                        <input type="checkbox" id="rem-due" ${r.on_due_date ? 'checked' : ''} style="width:20px;height:20px;">
                        <label for="rem-due" style="font-size:15px;">Remind on due date</label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">After overdue (select all that apply)</label>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;">
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-3" ${r.after_due_days?.includes(3) ? 'checked' : ''}> 3 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-7" ${r.after_due_days?.includes(7) ? 'checked' : ''}> 7 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-14" ${r.after_due_days?.includes(14) ? 'checked' : ''}> 14 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-30" ${r.after_due_days?.includes(30) ? 'checked' : ''}> 30 days
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Channel Selection -->
                <div class="card" style="padding:20px;margin-bottom:16px;${r.enabled ? '' : 'opacity:0.5;pointer-events:none;'}">
                    <div style="font-weight:600;margin-bottom:16px;">ðŸ“± How to Remind</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'whatsapp' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="whatsapp" ${r.channel === 'whatsapp' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ’¬</span>
                            <div>
                                <div style="font-weight:600;">WhatsApp</div>
                                <div style="font-size:12px;color:#666;">Opens WhatsApp with pre-filled message</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'sms' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="sms" ${r.channel === 'sms' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ“±</span>
                            <div>
                                <div style="font-weight:600;">SMS (Termii)</div>
                                <div style="font-size:12px;color:#666;">Sends SMS automatically via Termii API</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'both' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="both" ${r.channel === 'both' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ””</span>
                            <div>
                                <div style="font-weight:600;">Both</div>
                                <div style="font-size:12px;color:#666;">Send via both WhatsApp and SMS</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="btn-save-reminder-settings" style="width:100%;">ðŸ’¾ Save Settings</button>
                
                <!-- Upcoming Reminders -->
                <div class="section-title" style="margin: 28px 0 12px;">ðŸ“‹ Due for Reminder Today</div>
                ${upcomingReminders.length === 0 ? 
                    '<div class="card" style="padding:24px;text-align:center;color:#888;"><div style="font-size:32px;margin-bottom:8px;">âœ…</div>No reminders due today</div>' :
                    upcomingReminders.map(r => `
                        <div class="card" style="margin-bottom:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div>
                                    <div style="font-weight:600;">${r.customer?.name || 'Unknown'}</div>
                                    <div style="font-size:13px;color:#666;">${r.invoice.description} â€¢ ${formatNaira(r.invoice.amount - r.invoice.amount_paid)}</div>
                                    <span class="badge ${r.type === 'overdue' ? 'badge-overdue' : r.type === 'due' ? 'badge-pending' : 'badge-paid'}" style="margin-top:6px;">${r.label}</span>
                                </div>
                                <button class="btn btn-primary" style="padding:8px 14px;font-size:13px;" data-send-reminder="${r.invoice.id}">
                                    Send Now
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
                
                <!-- Quick Actions -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
                    <button class="btn btn-secondary" id="btn-send-all-due" style="padding:14px;">
                        ðŸ“¤ Send All Due
                    </button>
                    <button class="btn btn-secondary" id="btn-send-all-overdue-now" style="padding:14px;background:#fee2e2;color:#dc2626;border-color:#dc2626;">
                        ðŸš¨ All Overdue
                    </button>
                </div>
                
                <!-- Reminder History -->
                <div class="section-title" style="margin: 28px 0 12px;">ðŸ“œ Reminder History</div>
                ${recentReminders.length === 0 ? 
                    '<div class="card" style="padding:24px;text-align:center;color:#888;">No reminders sent yet</div>' :
                    `<div class="card" style="padding:0;overflow:hidden;">
                        ${recentReminders.map((h, i) => `
                            <div style="padding:12px 16px;border-bottom:1px solid #f0f0f0;${i === 0 ? 'background:#f8fafc;' : ''}">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-weight:500;font-size:14px;">${h.customerName}</div>
                                        <div style="font-size:12px;color:#888;">${h.channel === 'sms' ? 'ðŸ“± SMS' : 'ðŸ’¬ WhatsApp'} â€¢ ${formatNaira(h.amount)}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:12px;color:#666;">${formatDate(h.sentAt)}</div>
                                        <span style="font-size:11px;color:${h.status === 'sent' ? '#16a34a' : '#dc2626'};">${h.status === 'sent' ? 'âœ“ Sent' : 'âœ— Failed'}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`
                }
                
                <button class="btn" id="btn-clear-history" style="margin-top:12px;background:#f8fafc;color:#666;width:100%;">Clear History</button>
            `;
        }

        // ========== EVENTS ==========
        function attachAuthEvents() {
            let isLogin = true;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.onclick = () => {
                    isLogin = tab.dataset.tab === 'login';
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('name-group').classList.toggle('hidden', isLogin);
                    document.getElementById('auth-btn').textContent = isLogin ? 'Login' : 'Sign Up';
                    document.getElementById('auth-error').classList.add('hidden');
                    document.getElementById('auth-success').classList.add('hidden');
                };
            });
            
            // Back to landing button
            document.getElementById('auth-back-btn')?.addEventListener('click', () => {
                state.currentSection = 'landing';
                render();
            });

            const authForm = document.getElementById('auth-form');
            if (!authForm) {
                console.error('Auth form not found!');
                return;
            }
            
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                
                const btn = document.getElementById('auth-btn');
                const emailInput = document.getElementById('auth-email');
                const passwordInput = document.getElementById('auth-password');
                const nameInput = document.getElementById('auth-name');
                
                if (!btn || !emailInput || !passwordInput) {
                    console.error('Form elements not found');
                    return;
                }
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const name = nameInput?.value?.trim() || '';

                btn.disabled = true;
                btn.textContent = 'Please wait...';

                try {
                    // Check if we're in dev mode
                    const devMode = (typeof DEV_MODE !== 'undefined' && DEV_MODE);
                    
                    if (devMode) {
                        // Dev mode: simulate auth
                        await new Promise(r => setTimeout(r, 600));
                        state.user = { id: 'dev-user', email, name: name || email.split('@')[0] };
                        localStorage.setItem('owomi_user', JSON.stringify(state.user));
                        state.businessProfile.name = name || '';
                        
                        // Load default data for new users
                        if (!localStorage.getItem('owomi_customers')) {
                            state.customers = [
                                { id: 'cust-1', name: 'Chidi Okonkwo', phone: '08012345678' },
                                { id: 'cust-2', name: 'Amaka Johnson', phone: '08098765432' },
                                { id: 'cust-3', name: 'Emeka Nwosu', phone: '07011223344' }
                            ];
                            localStorage.setItem('owomi_customers', JSON.stringify(state.customers));
                        }
                        if (!localStorage.getItem('owomi_invoices')) {
                            state.invoices = [
                                { id: 'inv-1', invoice_number: 'INV-001', customer_id: 'cust-1', description: 'Website Project', items: [{name: 'Website Design', qty: 1, price: 100000}], amount: 150000, amount_paid: 50000, due_date: '2025-12-20', created_at: '2025-11-01' },
                                { id: 'inv-2', invoice_number: 'INV-002', customer_id: 'cust-2', description: 'Logo Design', items: [{name: 'Logo Design', qty: 1, price: 75000}], amount: 75000, amount_paid: 75000, due_date: '2025-11-15', created_at: '2025-10-28' }
                            ];
                            localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                        }
                        
                        if (isLogin) {
                            // Login - check if onboarded
                            const onboarded = localStorage.getItem('owomi_onboarded');
                            state.currentSection = onboarded ? 'app' : 'onboarding';
                        } else {
                            // Signup - go to onboarding
                            state.currentSection = 'onboarding';
                        }
                        state.loading = false;
                        render();
                        return;
                    }
                    
                    if (isLogin) {
                        const data = await supabaseAuth('token?grant_type=password', { email, password });
                        saveSession(data);
                        state.user = data.user;
                        await loadData();
                        const onboarded = localStorage.getItem('owomi_onboarded');
                        state.currentSection = onboarded ? 'app' : 'onboarding';
                        render();
                    } else {
                        await supabaseAuth('signup', { email, password, data: { business_name: name } });
                        document.getElementById('auth-success').textContent = 'Account created! Check email to confirm.';
                        document.getElementById('auth-success').classList.remove('hidden');
                        btn.disabled = false;
                        btn.textContent = 'Sign Up';
                    }
                } catch (err) {
                    console.error('Auth error:', err);
                    document.getElementById('auth-error').textContent = err.message || 'Something went wrong. Please try again.';
                    document.getElementById('auth-error').classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = isLogin ? 'Login' : 'Sign Up';
                }
            };
            
            // Backup: Also add click handler to button
            document.getElementById('auth-btn')?.addEventListener('click', (e) => {
                // The form onsubmit will handle it, but this ensures the form submits
                const form = document.getElementById('auth-form');
                if (form && !form.checkValidity()) {
                    form.reportValidity();
                }
            });
        }

        function attachAppEvents() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => { state.activeTab = btn.dataset.tab; state.menuPage = null; state.searchQuery = ''; render(); };
            });

            // Quick Actions
            document.getElementById('btn-new-invoice')?.addEventListener('click', showInvoiceModal);
            document.getElementById('btn-new-customer')?.addEventListener('click', showCustomerModal);
            document.querySelector('[data-goto="invoices"]')?.addEventListener('click', () => { state.activeTab = 'invoices'; render(); });

            // AI
            document.getElementById('btn-ai')?.addEventListener('click', showAIModal);

            // Search & Filter
            document.getElementById('search-input')?.addEventListener('input', (e) => { state.searchQuery = e.target.value; render(); });
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.onclick = () => { state.filterStatus = btn.dataset.filter; render(); };
            });

            // Invoice Actions
            document.querySelectorAll('[data-pdf]').forEach(btn => { btn.onclick = () => generatePDF(btn.dataset.pdf); });
            document.querySelectorAll('[data-receipt]').forEach(btn => { btn.onclick = () => generateReceipt(btn.dataset.receipt); });
            document.querySelectorAll('[data-whatsapp]').forEach(btn => { btn.onclick = () => sendWhatsApp(btn.dataset.whatsapp); });
            document.querySelectorAll('[data-sms]').forEach(btn => { btn.onclick = () => sendSMS(btn.dataset.sms); });
            document.querySelectorAll('[data-paylink]').forEach(btn => { btn.onclick = () => generatePaymentLink(btn.dataset.paylink); });
            document.querySelectorAll('[data-pay]').forEach(btn => { btn.onclick = () => showPaymentModal(btn.dataset.pay); });
            document.querySelectorAll('[data-edit-inv]').forEach(btn => { btn.onclick = () => showEditInvoiceModal(btn.dataset.editInv); });

            // Menu Navigation
            document.querySelectorAll('[data-menu]').forEach(btn => {
                btn.onclick = () => { state.menuPage = btn.dataset.menu; render(); };
            });
            document.querySelector('[data-back]')?.addEventListener('click', () => { state.menuPage = null; render(); });

            // Menu Actions
            document.getElementById('btn-export')?.addEventListener('click', exportCSV);
            document.getElementById('dark-toggle')?.addEventListener('click', toggleDarkMode);
            document.getElementById('btn-logout')?.addEventListener('click', () => { 
                clearSession(); 
                localStorage.removeItem('owomi_user');
                localStorage.removeItem('owomi_onboarded');
                state.user = null; 
                state.currentSection = 'landing';
                render(); 
            });

            // Customers Page
            document.getElementById('btn-add-customer')?.addEventListener('click', showCustomerModal);
            document.querySelectorAll('[data-edit-cust]').forEach(btn => { btn.onclick = () => showEditCustomerModal(btn.dataset.editCust); });
            document.querySelectorAll('[data-delete-cust]').forEach(btn => { btn.onclick = () => deleteCustomer(btn.dataset.deleteCust); });

            // Settings Page
            document.getElementById('btn-save-settings')?.addEventListener('click', saveSettings);

            // Recurring Page
            document.getElementById('btn-add-recurring')?.addEventListener('click', showRecurringModal);
            document.querySelectorAll('[data-generate]').forEach(btn => { btn.onclick = () => generateRecurring(btn.dataset.generate); });
            document.querySelectorAll('[data-toggle-rec]').forEach(btn => {
                btn.onclick = () => {
                    const tmpl = state.recurringTemplates.find(t => t.id === btn.dataset.toggleRec);
                    if (tmpl) { tmpl.active = !tmpl.active; localStorage.setItem('owomi_recurring', JSON.stringify(state.recurringTemplates)); render(); }
                };
            });
            document.querySelectorAll('[data-delete-rec]').forEach(btn => {
                btn.onclick = () => {
                    if (confirm('Delete this recurring template?')) {
                        state.recurringTemplates = state.recurringTemplates.filter(t => t.id !== btn.dataset.deleteRec);
                        localStorage.setItem('owomi_recurring', JSON.stringify(state.recurringTemplates));
                        render();
                    }
                };
            });

            // Products Page
            document.getElementById('btn-add-product')?.addEventListener('click', showProductModal);
            document.querySelectorAll('[data-edit-prod]').forEach(btn => { btn.onclick = () => showEditProductModal(btn.dataset.editProd); });
            document.querySelectorAll('[data-delete-prod]').forEach(btn => {
                btn.onclick = () => {
                    if (confirm('Delete this product?')) {
                        state.products = state.products.filter(p => p.id !== btn.dataset.deleteProd);
                        localStorage.setItem('owomi_products', JSON.stringify(state.products));
                        render();
                    }
                };
            });

            // Expenses Page
            document.getElementById('btn-add-expense')?.addEventListener('click', showExpenseModal);
            document.querySelectorAll('[data-edit-exp]').forEach(btn => { btn.onclick = () => showEditExpenseModal(btn.dataset.editExp); });
            document.querySelectorAll('[data-delete-exp]').forEach(btn => {
                btn.onclick = () => {
                    if (confirm('Delete this expense?')) {
                        state.expenses = state.expenses.filter(e => e.id !== btn.dataset.deleteExp);
                        localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                        render();
                    }
                };
            });

            // Customer Statement
            document.querySelectorAll('[data-statement]').forEach(btn => { btn.onclick = () => generateStatement(btn.dataset.statement); });

            // Reminder settings (old settings page)
            document.getElementById('toggle-reminders')?.addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('reminder-options')?.classList.toggle('hidden');
            });

            document.getElementById('btn-save-reminders')?.addEventListener('click', saveReminderSettings);
            document.getElementById('btn-send-all-overdue')?.addEventListener('click', sendAllOverdueReminders);
            
            // New Reminders Page events
            document.getElementById('toggle-reminders-master')?.addEventListener('click', function() {
                this.classList.toggle('active');
                const enabled = this.classList.contains('active');
                state.reminderSettings = state.reminderSettings || {};
                state.reminderSettings.enabled = enabled;
                localStorage.setItem('owomi_reminders', JSON.stringify(state.reminderSettings));
                showToast(enabled ? 'Auto reminders enabled! â°' : 'Auto reminders disabled', enabled ? 'success' : 'info');
                render();
            });
            
            document.getElementById('btn-save-reminder-settings')?.addEventListener('click', saveReminderSettingsNew);
            document.getElementById('btn-send-all-due')?.addEventListener('click', sendAllDueReminders);
            document.getElementById('btn-send-all-overdue-now')?.addEventListener('click', sendAllOverdueReminders);
            document.getElementById('btn-clear-history')?.addEventListener('click', () => {
                if (confirm('Clear all reminder history?')) {
                    localStorage.removeItem('owomi_reminder_history');
                    showToast('History cleared', 'info');
                    render();
                }
            });
            
            // Individual send reminder buttons
            document.querySelectorAll('[data-send-reminder]').forEach(btn => {
                btn.onclick = () => sendSingleReminder(btn.dataset.sendReminder);
            });
            
            // Channel selection
            document.querySelectorAll('input[name="rem-channel"]').forEach(radio => {
                radio.onchange = () => {
                    state.reminderSettings = state.reminderSettings || {};
                    state.reminderSettings.channel = radio.value;
                    render();
                };
            });
            
            // Share Portal buttons
            document.querySelectorAll('[data-share-portal]').forEach(btn => {
                btn.onclick = () => showSharePortalModal(btn.dataset.sharePortal);
            });
        }

        // ========== REMINDER FUNCTIONS ==========
        async function saveReminderSettings() {
            const session = getSession();
            const enabled = document.getElementById('toggle-reminders')?.classList.contains('active');
            const before_due_days = parseInt(document.getElementById('rem-before')?.value) || 3;
            const on_due_date = document.getElementById('rem-due')?.checked || false;
            
            const after_due_days = [];
            if (document.getElementById('rem-over-3')?.checked) after_due_days.push(3);
            if (document.getElementById('rem-over-7')?.checked) after_due_days.push(7);
            if (document.getElementById('rem-over-14')?.checked) after_due_days.push(14);
            if (document.getElementById('rem-over-30')?.checked) after_due_days.push(30);

            const data = {
                user_id: session.user.id,
                enabled,
                before_due_days,
                on_due_date,
                after_due_days,
                reminder_channel: 'sms'
            };

            try {
                if (state.reminderSettings?.id) {
                    await supabaseQuery('reminder_settings', {
                        method: 'PATCH',
                        query: `id=eq.${state.reminderSettings.id}`,
                        body: data
                    });
                } else {
                    const result = await supabaseQuery('reminder_settings', {
                        method: 'POST',
                        body: data
                    });
                    state.reminderSettings = result[0];
                }
                state.reminderSettings = { ...state.reminderSettings, ...data };
                showToast('Reminder settings saved!', 'success');
            } catch (err) {
                alert('âŒ Error: ' + err.message);
            }
        }

        async function sendAllOverdueReminders() {
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            if (overdue.length === 0) {
                showToast('No overdue invoices! ðŸŽ‰', 'success');
                return;
            }

            if (!confirm(`Send SMS reminders to ${overdue.length} overdue customers?`)) return;

            let sent = 0, failed = 0;

            for (const inv of overdue) {
                const cust = state.customers.find(c => c.id === inv.customer_id);
                if (!cust?.phone) { failed++; continue; }

                const owed = inv.amount - inv.amount_paid;
                const daysOverdue = Math.floor((new Date() - new Date(inv.due_date)) / (1000 * 60 * 60 * 24));
                const message = `Hi ${cust.name}, OVERDUE: â‚¦${owed.toLocaleString()} for "${inv.description}" is ${daysOverdue} days late. Please pay immediately. - ${state.businessProfile.name || 'Owo Mi'}`;

                try {
                    let phone = cust.phone.replace(/\s/g, '');
                    if (phone.startsWith('0')) phone = '234' + phone.slice(1);
                    if (!phone.startsWith('234')) phone = '234' + phone;

                    const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({ phone, message })
                    });

                    const data = await res.json();
                    if (data.code === 'ok' || data.message_id) sent++;
                    else failed++;
                } catch (err) {
                    failed++;
                }
            }

            alert(`âœ… Sent: ${sent}\nâŒ Failed: ${failed}`);
        }
        
        // New reminder settings save function
        function saveReminderSettingsNew() {
            const before_due_days = parseInt(document.getElementById('rem-before')?.value) || 3;
            const on_due_date = document.getElementById('rem-due')?.checked || false;
            const channel = document.querySelector('input[name="rem-channel"]:checked')?.value || 'whatsapp';
            
            const after_due_days = [];
            if (document.getElementById('rem-over-3')?.checked) after_due_days.push(3);
            if (document.getElementById('rem-over-7')?.checked) after_due_days.push(7);
            if (document.getElementById('rem-over-14')?.checked) after_due_days.push(14);
            if (document.getElementById('rem-over-30')?.checked) after_due_days.push(30);

            state.reminderSettings = {
                ...state.reminderSettings,
                before_due_days,
                on_due_date,
                after_due_days,
                channel
            };
            
            localStorage.setItem('owomi_reminders', JSON.stringify(state.reminderSettings));
            showToast('Reminder settings saved! â°', 'success');
        }
        
        // Send reminder for a single invoice
        async function sendSingleReminder(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv?.customer_id);
            
            if (!inv || !cust) {
                showToast('Invoice or customer not found', 'error');
                return;
            }
            
            const channel = state.reminderSettings?.channel || 'whatsapp';
            const owed = inv.amount - inv.amount_paid;
            
            // Log the reminder
            const historyEntry = {
                id: Date.now(),
                invoiceId: inv.id,
                customerId: cust.id,
                customerName: cust.name,
                amount: owed,
                channel: channel,
                sentAt: new Date().toISOString(),
                status: 'sent'
            };
            
            try {
                if (channel === 'whatsapp' || channel === 'both') {
                    sendWhatsApp(invoiceId);
                }
                
                if (channel === 'sms' || channel === 'both') {
                    await sendSMS(invoiceId);
                }
                
                // Save to history
                const history = JSON.parse(localStorage.getItem('owomi_reminder_history') || '[]');
                history.push(historyEntry);
                localStorage.setItem('owomi_reminder_history', JSON.stringify(history));
                
                showToast(`Reminder sent to ${cust.name}! ðŸ“¤`, 'success');
                render();
            } catch (err) {
                historyEntry.status = 'failed';
                const history = JSON.parse(localStorage.getItem('owomi_reminder_history') || '[]');
                history.push(historyEntry);
                localStorage.setItem('owomi_reminder_history', JSON.stringify(history));
                
                showToast('Failed to send reminder', 'error');
            }
        }
        
        // Send reminders to all invoices due today
        async function sendAllDueReminders() {
            const r = state.reminderSettings || {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find invoices due for reminder today
            const dueForReminder = state.invoices.filter(inv => {
                if (getStatus(inv) === 'paid') return false;
                
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                // Check if this invoice is due for a reminder
                if (diffDays === r.before_due_days) return true;
                if (diffDays === 0 && r.on_due_date) return true;
                if (diffDays < 0 && r.after_due_days?.includes(Math.abs(diffDays))) return true;
                
                return false;
            });
            
            if (dueForReminder.length === 0) {
                showToast('No reminders due today! âœ…', 'success');
                return;
            }
            
            if (!confirm(`Send reminders to ${dueForReminder.length} customers?`)) return;
            
            let sent = 0, failed = 0;
            
            for (const inv of dueForReminder) {
                try {
                    await sendSingleReminder(inv.id);
                    sent++;
                } catch (err) {
                    failed++;
                }
                // Small delay between sends
                await new Promise(r => setTimeout(r, 500));
            }
            
            showToast(`Sent: ${sent}, Failed: ${failed}`, sent > 0 ? 'success' : 'error');
        }
        
        // Check for auto reminders on app load
        function checkAutoReminders() {
            const r = state.reminderSettings;
            if (!r?.enabled) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = today.toISOString().split('T')[0];
            
            // Check if we already ran today
            const lastRun = localStorage.getItem('owomi_last_reminder_check');
            if (lastRun === todayKey) return;
            
            // Find invoices due for reminder today
            const dueForReminder = [];
            
            state.invoices.forEach(inv => {
                if (getStatus(inv) === 'paid') return;
                
                const cust = state.customers.find(c => c.id === inv.customer_id);
                if (!cust?.phone) return;
                
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let reminderType = null;
                
                if (diffDays === r.before_due_days && r.before_due_days > 0) {
                    reminderType = 'before';
                } else if (diffDays === 0 && r.on_due_date) {
                    reminderType = 'due';
                } else if (diffDays < 0 && r.after_due_days?.includes(Math.abs(diffDays))) {
                    reminderType = 'overdue';
                }
                
                if (reminderType) {
                    dueForReminder.push({ inv, cust, type: reminderType, days: diffDays });
                }
            });
            
            if (dueForReminder.length > 0) {
                // Show notification
                setTimeout(() => {
                    const names = dueForReminder.slice(0, 3).map(d => d.cust.name).join(', ');
                    const more = dueForReminder.length > 3 ? ` +${dueForReminder.length - 3} more` : '';
                    
                    showAutoReminderPrompt(dueForReminder.length, names + more);
                }, 2000);
            }
            
            // Mark today as checked
            localStorage.setItem('owomi_last_reminder_check', todayKey);
        }
        
        // Show auto reminder prompt
        function showAutoReminderPrompt(count, names) {
            const prompt = document.createElement('div');
            prompt.className = 'auto-reminder-prompt';
            prompt.innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:12px;">
                    <div style="font-size:32px;">â°</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${count} Reminder${count > 1 ? 's' : ''} Due Today</div>
                        <div style="font-size:13px;color:#666;margin-bottom:12px;">${names}</div>
                        <div style="display:flex;gap:8px;">
                            <button id="auto-send-all" style="background:#6366f1;color:white;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Send All</button>
                            <button id="auto-view" style="background:#f3f4f6;color:#333;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">View</button>
                            <button id="auto-dismiss" style="background:none;border:none;color:#888;padding:10px;cursor:pointer;">Later</button>
                        </div>
                    </div>
                </div>
            `;
            prompt.style.cssText = `
                position: fixed;
                bottom: 90px;
                left: 16px;
                right: 16px;
                background: white;
                padding: 16px;
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 1001;
                animation: slideUp 0.3s ease;
            `;
            document.body.appendChild(prompt);
            
            document.getElementById('auto-send-all').onclick = async () => {
                prompt.remove();
                await sendAllDueReminders();
            };
            
            document.getElementById('auto-view').onclick = () => {
                prompt.remove();
                state.activeTab = 'menu';
                state.menuPage = 'reminders';
                render();
            };
            
            document.getElementById('auto-dismiss').onclick = () => {
                prompt.remove();
            };
        }

        // ========== MODALS ==========
        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }

        function showCustomerModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Customer<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="cust-name" placeholder="Customer name"></div>
                            <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="cust-phone" placeholder="08012345678"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Customer</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('cust-name').value.trim();
                const phone = document.getElementById('cust-phone').value.trim();
                if (!name || !phone) return alert('Please fill all fields');
                try { await addCustomer(name, phone); closeModal(); render(); } catch (err) { alert('Error: ' + err.message); }
            };
        }

        function showInvoiceModal() {
            if (state.customers.length === 0) { alert('Add a customer first!'); showCustomerModal(); return; }
            
            const productOptions = state.products.length > 0 
                ? `<option value="">-- Select product --</option>` + state.products.map(p => `<option value="${p.id}">${p.name} - ${formatNaira(p.price)}</option>`).join('')
                : `<option value="">No products saved</option>`;
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">New Invoice<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Customer</label><select class="form-input" id="inv-cust">${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                            <div class="form-group"><label class="form-label">Invoice Title</label><input type="text" class="form-input" id="inv-desc" placeholder="e.g. Website Project"></div>
                            
                            <div class="form-group">
                                <label class="form-label">Line Items</label>
                                <div id="line-items-container">
                                    <div class="line-item" style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                                        <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                                        <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                                    </div>
                                </div>
                                <button type="button" id="btn-add-item" style="background:#f0f0f0;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;width:100%;margin-top:8px;">+ Add Item</button>
                                
                                ${state.products.length > 0 ? `
                                <div style="margin-top:12px;">
                                    <label class="form-label" style="font-size:12px;color:#666;">Quick add from products:</label>
                                    <select class="form-input" id="inv-product-quick" style="font-size:13px;">${productOptions}</select>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="form-group" style="background:#f9f9f9;padding:12px;border-radius:8px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;">
                                    <span>Total:</span>
                                    <span id="inv-total">â‚¦0</span>
                                </div>
                            </div>
                            
                            <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="inv-due"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Create Invoice</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Add item button
            document.getElementById('btn-add-item').onclick = () => {
                const container = document.getElementById('line-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                newItem.innerHTML = `
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                    <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                `;
                container.appendChild(newItem);
                attachItemListeners();
            };
            
            // Quick add from products
            document.getElementById('inv-product-quick')?.addEventListener('change', (e) => {
                const prod = state.products.find(p => p.id === e.target.value);
                if (prod) {
                    const container = document.getElementById('line-items-container');
                    const newItem = document.createElement('div');
                    newItem.className = 'line-item';
                    newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                    newItem.innerHTML = `
                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;" value="${prod.name}">
                        <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;" value="${prod.price}">
                        <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                    `;
                    container.appendChild(newItem);
                    e.target.value = '';
                    attachItemListeners();
                    updateTotal();
                }
            });
            
            function attachItemListeners() {
                document.querySelectorAll('.btn-remove-item').forEach(btn => {
                    btn.onclick = (e) => {
                        const items = document.querySelectorAll('.line-item');
                        if (items.length > 1) {
                            e.target.closest('.line-item').remove();
                            updateTotal();
                        } else {
                            alert('At least one item required');
                        }
                    };
                });
                document.querySelectorAll('.item-qty, .item-price').forEach(input => {
                    input.oninput = updateTotal;
                });
            }
            
            function updateTotal() {
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    total += qty * price;
                });
                document.getElementById('inv-total').textContent = formatNaira(total);
            }
            
            attachItemListeners();
            
            document.getElementById('modal-save').onclick = async () => {
                const cust = document.getElementById('inv-cust').value;
                const desc = document.getElementById('inv-desc').value.trim();
                const due = document.getElementById('inv-due').value;
                
                // Collect line items
                const items = [];
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    if (name && price > 0) {
                        items.push({ name, qty, price });
                        total += qty * price;
                    }
                });
                
                if (!desc || items.length === 0 || !due) return alert('Please fill invoice title, at least one item, and due date');
                
                try { 
                    await addInvoice(cust, desc, total, due, items); 
                    const newInvNumber = state.invoices[0].invoice_number;
                    closeModal(); 
                    render(); 
                    showToast(`Invoice ${newInvNumber} created!`, 'success');
                } catch (err) { alert('Error: ' + err.message); }
            };
        }

        function showPaymentModal(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Record Payment<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div style="background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:20px;">
                                <div style="font-weight:600;margin-bottom:4px;">${cust?.name || 'Customer'}</div>
                                <div style="font-size:13px;color:#666;">${inv.description}</div>
                                <div style="margin-top:12px;display:flex;justify-content:space-between;">
                                    <span style="color:#666;">Outstanding:</span>
                                    <span style="font-weight:700;color:#dc2626;">${formatNaira(owed)}</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Amount (â‚¦)</label>
                                <input type="number" class="form-input" id="pay-amount" placeholder="0" max="${owed}" style="font-size:18px;font-weight:600;">
                                <button type="button" id="pay-full-btn" style="background:#dcfce7;color:#166534;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px;cursor:pointer;">Pay Full: ${formatNaira(owed)}</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="transfer">
                                        <input type="radio" name="pay-method" value="transfer" checked style="display:none;">
                                        <span style="font-size:20px;">ðŸ¦</span>
                                        <span style="font-size:13px;font-weight:500;">Transfer</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="cash">
                                        <input type="radio" name="pay-method" value="cash" style="display:none;">
                                        <span style="font-size:20px;">ðŸ’µ</span>
                                        <span style="font-size:13px;font-weight:500;">Cash</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="card">
                                        <input type="radio" name="pay-method" value="card" style="display:none;">
                                        <span style="font-size:20px;">ðŸ’³</span>
                                        <span style="font-size:13px;font-weight:500;">Card/POS</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="paystack">
                                        <input type="radio" name="pay-method" value="paystack" style="display:none;">
                                        <span style="font-size:20px;">ðŸ”—</span>
                                        <span style="font-size:13px;font-weight:500;">Paystack</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Note (Optional)</label>
                                <input type="text" class="form-input" id="pay-note" placeholder="e.g. Bank transfer ref: 12345">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">ðŸ’° Record Payment</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Pay full button
            document.getElementById('pay-full-btn').onclick = () => {
                document.getElementById('pay-amount').value = owed;
            };
            
            // Payment method selection styling
            document.querySelectorAll('.pay-method-option').forEach(option => {
                option.onclick = () => {
                    document.querySelectorAll('.pay-method-option').forEach(o => o.style.borderColor = 'transparent');
                    option.style.borderColor = '#6366f1';
                    option.querySelector('input').checked = true;
                };
            });
            // Select first option by default
            document.querySelector('.pay-method-option').style.borderColor = '#6366f1';
            
            document.getElementById('modal-save').onclick = async () => {
                const amt = parseFloat(document.getElementById('pay-amount').value);
                const method = document.querySelector('input[name="pay-method"]:checked')?.value || 'transfer';
                const note = document.getElementById('pay-note').value.trim();
                
                if (!amt || amt <= 0) return alert('Enter a valid amount');
                if (amt > owed) return alert('Amount cannot exceed outstanding balance');
                
                try { 
                    await recordPayment(invoiceId, amt, method, note); 
                    closeModal(); 
                    
                    // Check if fully paid and show receipt option
                    const updatedInv = state.invoices.find(i => i.id === invoiceId);
                    if (updatedInv.amount_paid >= updatedInv.amount) {
                        showPaymentSuccessModal(invoiceId, amt, true);
                    } else {
                        showPaymentSuccessModal(invoiceId, amt, false);
                    }
                } catch (err) { 
                    alert('Error: ' + err.message); 
                }
            };
        }
        
        function showPaymentSuccessModal(invoiceId, amount, isFullyPaid) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="text-align:center;padding:32px;">
                        <div style="font-size:64px;margin-bottom:16px;">${isFullyPaid ? 'ðŸŽ‰' : 'âœ…'}</div>
                        <h2 style="margin-bottom:8px;">${isFullyPaid ? 'Invoice Fully Paid!' : 'Payment Recorded!'}</h2>
                        <p style="color:#666;margin-bottom:24px;">
                            ${formatNaira(amount)} received from ${cust?.name}
                            ${isFullyPaid ? '<br><span style="color:#16a34a;font-weight:600;">Balance: â‚¦0</span>' : `<br>Remaining: ${formatNaira(inv.amount - inv.amount_paid)}`}
                        </p>
                        
                        ${isFullyPaid ? `
                            <button class="btn btn-primary" id="success-receipt" style="width:100%;margin-bottom:12px;">
                                ðŸ§¾ Generate Receipt
                            </button>
                        ` : ''}
                        
                        <button class="btn ${isFullyPaid ? 'btn-secondary' : 'btn-primary'}" id="success-close" style="width:100%;">
                            ${isFullyPaid ? 'Done' : 'OK'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('success-close').onclick = () => {
                closeModal();
                render();
            };
            
            document.getElementById('success-receipt')?.addEventListener('click', () => {
                closeModal();
                generateReceipt(invoiceId);
                render();
            });
        }

        // ========== CUSTOMER PORTAL ==========
        function showSharePortalModal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            const portalUrl = `${window.location.origin}${window.location.pathname}#portal/${customerId}`;
            
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId);
            const totalOwed = custInvoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Share Payment Portal<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div style="text-align:center;margin-bottom:20px;">
                                <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;margin:0 auto 12px;">
                                    ${cust.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="font-weight:700;font-size:18px;">${cust.name}</div>
                                <div style="color:#666;">${cust.phone}</div>
                                ${totalOwed > 0 ? `<div style="margin-top:8px;color:#dc2626;font-weight:600;">Owes ${formatNaira(totalOwed)}</div>` : '<div style="margin-top:8px;color:#16a34a;">âœ“ All paid up</div>'}
                            </div>
                            
                            <div style="background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:16px;">
                                <div style="font-size:12px;color:#666;margin-bottom:8px;">Portal Link</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="portal-link" value="${portalUrl}" readonly style="flex:1;font-size:12px;">
                                    <button class="btn btn-primary" id="copy-portal-link" style="padding:10px 16px;">ðŸ“‹ Copy</button>
                                </div>
                            </div>
                            
                            <div style="font-size:13px;color:#666;margin-bottom:16px;">
                                <strong>What your customer can do:</strong>
                                <ul style="margin:8px 0 0 16px;padding:0;">
                                    <li>View all their invoices</li>
                                    <li>See payment history</li>
                                    <li>Pay directly via Paystack</li>
                                    <li>Download receipts</li>
                                </ul>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                <button class="btn btn-secondary" id="share-whatsapp" style="padding:14px;">
                                    ðŸ’¬ WhatsApp
                                </button>
                                <button class="btn btn-secondary" id="share-sms" style="padding:14px;">
                                    ðŸ“± SMS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            
            document.getElementById('copy-portal-link').onclick = () => {
                const input = document.getElementById('portal-link');
                input.select();
                document.execCommand('copy');
                showToast('Link copied! ðŸ“‹', 'success');
            };
            
            document.getElementById('share-whatsapp').onclick = () => {
                const message = `Hi ${cust.name},\n\nHere's your payment portal to view invoices and make payments:\n${portalUrl}\n\n- ${state.businessProfile.name || 'Owo Mi'}`;
                let phone = cust.phone.replace(/\s/g, '');
                if (phone.startsWith('0')) phone = '234' + phone.slice(1);
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
                closeModal();
            };
            
            document.getElementById('share-sms').onclick = () => {
                const message = `Hi ${cust.name}, view your invoices & pay online: ${portalUrl}`;
                window.open(`sms:${cust.phone}?body=${encodeURIComponent(message)}`, '_blank');
                closeModal();
            };
        }
        
        function renderPortal() {
            const app = document.getElementById('app');
            app.innerHTML = renderCustomerPortal(state.portalCustomerId);
            attachPortalEvents();
        }
        
        function attachPortalEvents() {
            // Pay All button
            document.getElementById('portal-pay-all')?.addEventListener('click', function() {
                const amount = parseFloat(this.dataset.amount);
                initiatePortalPayment(null, amount, true);
            });
            
            // Individual pay buttons
            document.querySelectorAll('[data-portal-pay]').forEach(btn => {
                btn.onclick = () => {
                    const invoiceId = btn.dataset.portalPay;
                    const amount = parseFloat(btn.dataset.amount);
                    initiatePortalPayment(invoiceId, amount, false);
                };
            });
            
            // View invoice buttons
            document.querySelectorAll('[data-portal-view]').forEach(btn => {
                btn.onclick = () => generatePDF(btn.dataset.portalView);
            });
            
            // Receipt buttons
            document.querySelectorAll('[data-portal-receipt]').forEach(btn => {
                btn.onclick = () => generateReceipt(btn.dataset.portalReceipt);
            });
        }
        
        function initiatePortalPayment(invoiceId, amount, isPayAll) {
            const cust = state.customers.find(c => c.id === state.portalCustomerId);
            const p = state.businessProfile;
            
            // Check if Paystack is available
            if (!p.paystackKey) {
                // Show bank details modal instead
                showPortalPaymentInfo(amount, isPayAll ? 'all invoices' : invoiceId);
                return;
            }
            
            const ref = 'PORTAL-' + Date.now();
            
            // Initialize Paystack
            const handler = PaystackPop.setup({
                key: p.paystackKey,
                email: cust.email || `${cust.phone}@owomi.portal`,
                amount: amount * 100, // Paystack uses kobo
                currency: 'NGN',
                ref: ref,
                metadata: {
                    custom_fields: [
                        { display_name: 'Customer', variable_name: 'customer', value: cust.name },
                        { display_name: 'Phone', variable_name: 'phone', value: cust.phone },
                        { display_name: 'Invoice', variable_name: 'invoice', value: invoiceId || 'Multiple' }
                    ]
                },
                callback: function(response) {
                    // Payment successful
                    if (isPayAll) {
                        // Mark all unpaid invoices as paid
                        const unpaid = state.invoices.filter(i => i.customer_id === state.portalCustomerId && getStatus(i) !== 'paid');
                        unpaid.forEach(inv => {
                            inv.amount_paid = inv.amount;
                            inv.paid_date = new Date().toISOString();
                            state.paymentHistory.push({
                                id: 'pay-' + Date.now(),
                                invoiceId: inv.id,
                                customerId: cust.id,
                                customerName: cust.name,
                                invoiceNumber: inv.invoice_number,
                                amount: inv.amount - inv.amount_paid,
                                method: 'paystack',
                                note: 'Portal payment - ' + response.reference,
                                date: new Date().toISOString(),
                                isFullPayment: true
                            });
                        });
                    } else {
                        // Mark single invoice as paid
                        const inv = state.invoices.find(i => i.id === invoiceId);
                        if (inv) {
                            inv.amount_paid = inv.amount;
                            inv.paid_date = new Date().toISOString();
                            state.paymentHistory.push({
                                id: 'pay-' + Date.now(),
                                invoiceId: inv.id,
                                customerId: cust.id,
                                customerName: cust.name,
                                invoiceNumber: inv.invoice_number,
                                amount: amount,
                                method: 'paystack',
                                note: 'Portal payment - ' + response.reference,
                                date: new Date().toISOString(),
                                isFullPayment: true
                            });
                        }
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                    localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
                    
                    // Show success and refresh
                    alert('ðŸŽ‰ Payment successful!\n\nReference: ' + response.reference + '\n\nThank you for your payment!');
                    renderPortal();
                },
                onClose: function() {
                    // User closed popup
                }
            });
            
            handler.openIframe();
        }
        
        function showPortalPaymentInfo(amount, invoiceRef) {
            const p = state.businessProfile;
            const cust = state.customers.find(c => c.id === state.portalCustomerId);
            
            const modal = document.createElement('div');
            modal.className = 'portal-modal';
            modal.innerHTML = `
                <div class="portal-modal-bg"></div>
                <div class="portal-modal-box">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:48px;margin-bottom:12px;">ðŸ’³</div>
                        <h2 style="margin-bottom:8px;">Payment Details</h2>
                        <p style="color:#666;">Amount to pay: <strong style="color:#16a34a;">${formatNaira(amount)}</strong></p>
                    </div>
                    
                    ${p.bank ? `
                        <div style="background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:16px;">
                            <div style="font-weight:600;margin-bottom:8px;color:#6366f1;">ðŸ¦ Bank Transfer Details</div>
                            <div style="white-space:pre-line;font-size:14px;line-height:1.6;">${p.bank}</div>
                        </div>
                    ` : ''}
                    
                    <div style="background:#fef3c7;padding:16px;border-radius:12px;margin-bottom:16px;">
                        <div style="font-weight:600;margin-bottom:8px;color:#92400e;">ðŸ“ Important</div>
                        <ul style="font-size:13px;color:#78350f;margin-left:16px;">
                            <li>Use your name "${cust.name}" as payment reference</li>
                            <li>Send proof of payment via WhatsApp</li>
                        </ul>
                    </div>
                    
                    <div style="display:grid;gap:8px;">
                        ${p.phone ? `<a href="https://wa.me/234${p.phone.replace(/^0/, '')}" class="portal-modal-btn whatsapp" target="_blank">ðŸ’¬ Send Proof via WhatsApp</a>` : ''}
                        ${p.phone ? `<a href="tel:${p.phone}" class="portal-modal-btn">ðŸ“ž Call ${p.name || 'Business'}</a>` : ''}
                        <button class="portal-modal-btn close" onclick="this.closest('.portal-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showEditInvoiceModal(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            
            const itemsHtml = items.map(item => `
                <div class="line-item" style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;" value="${item.name}">
                    <input type="number" class="form-input item-qty" placeholder="Qty" min="1" style="flex:0.5;text-align:center;" value="${item.qty}">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;" value="${item.price}">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                </div>
            `).join('');
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">Edit Invoice<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Invoice Title</label><input type="text" class="form-input" id="edit-desc" value="${inv.description}"></div>
                            
                            <div class="form-group">
                                <label class="form-label">Line Items</label>
                                <div id="line-items-container">
                                    ${itemsHtml}
                                </div>
                                <button type="button" id="btn-add-item" style="background:#f0f0f0;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;width:100%;margin-top:8px;">+ Add Item</button>
                            </div>
                            
                            <div class="form-group" style="background:#f9f9f9;padding:12px;border-radius:8px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;">
                                    <span>Total:</span>
                                    <span id="edit-total">${formatNaira(inv.amount)}</span>
                                </div>
                            </div>
                            
                            <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="edit-due" value="${inv.due_date}"></div>
                            <button class="btn btn-danger" id="btn-delete-inv" style="margin-top:12px;">ðŸ—‘ï¸ Delete Invoice</button>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Add item button
            document.getElementById('btn-add-item').onclick = () => {
                const container = document.getElementById('line-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                newItem.innerHTML = `
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                    <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                `;
                container.appendChild(newItem);
                attachEditItemListeners();
            };
            
            function attachEditItemListeners() {
                document.querySelectorAll('.btn-remove-item').forEach(btn => {
                    btn.onclick = (e) => {
                        const items = document.querySelectorAll('.line-item');
                        if (items.length > 1) {
                            e.target.closest('.line-item').remove();
                            updateEditTotal();
                        } else {
                            alert('At least one item required');
                        }
                    };
                });
                document.querySelectorAll('.item-qty, .item-price').forEach(input => {
                    input.oninput = updateEditTotal;
                });
            }
            
            function updateEditTotal() {
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    total += qty * price;
                });
                document.getElementById('edit-total').textContent = formatNaira(total);
            }
            
            attachEditItemListeners();
            
            document.getElementById('btn-delete-inv').onclick = async () => {
                if (confirm('Delete this invoice?')) {
                    if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                        await supabaseQuery('invoices', { method: 'DELETE', query: `id=eq.${invoiceId}` });
                    }
                    state.invoices = state.invoices.filter(i => i.id !== invoiceId);
                    closeModal(); render();
                }
            };
            
            document.getElementById('modal-save').onclick = async () => {
                const desc = document.getElementById('edit-desc').value.trim();
                const due = document.getElementById('edit-due').value;
                
                // Collect line items
                const newItems = [];
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    if (name && price > 0) {
                        newItems.push({ name, qty, price });
                        total += qty * price;
                    }
                });
                
                if (!desc || newItems.length === 0 || !due) return alert('Please fill all fields');
                
                if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                    await supabaseQuery('invoices', { method: 'PATCH', query: `id=eq.${invoiceId}`, body: { description: desc, amount: total, due_date: due, items: newItems } });
                }
                const idx = state.invoices.findIndex(i => i.id === invoiceId);
                state.invoices[idx] = { ...state.invoices[idx], description: desc, amount: total, due_date: due, items: newItems };
                closeModal(); render();
            };
        }

        function showEditCustomerModal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Customer<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="edit-name" value="${cust.name}"></div>
                            <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="edit-phone" value="${cust.phone}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('edit-name').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                if (!name || !phone) return alert('Please fill all fields');
                if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                    await supabaseQuery('customers', { method: 'PATCH', query: `id=eq.${customerId}`, body: { name, phone } });
                }
                const idx = state.customers.findIndex(c => c.id === customerId);
                state.customers[idx] = { ...state.customers[idx], name, phone };
                closeModal(); render();
            };
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Delete customer and all their invoices?')) return;
            if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                await supabaseQuery('invoices', { method: 'DELETE', query: `customer_id=eq.${customerId}` });
                await supabaseQuery('customers', { method: 'DELETE', query: `id=eq.${customerId}` });
            }
            state.customers = state.customers.filter(c => c.id !== customerId);
            state.invoices = state.invoices.filter(i => i.customer_id !== customerId);
            render();
        }

        function showRecurringModal() {
            if (state.customers.length === 0) { alert('Add a customer first!'); return; }
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">New Recurring<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Customer</label><select class="form-input" id="rec-cust">${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="rec-desc" placeholder="e.g. Monthly Retainer"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="rec-amt" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Frequency</label><select class="form-input" id="rec-freq"><option value="weekly">Weekly</option><option value="monthly" selected>Monthly</option><option value="quarterly">Quarterly</option></select></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Create</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = () => {
                const cust = document.getElementById('rec-cust').value;
                const desc = document.getElementById('rec-desc').value.trim();
                const amt = parseFloat(document.getElementById('rec-amt').value);
                const freq = document.getElementById('rec-freq').value;
                if (!desc || !amt) return alert('Please fill all fields');
                state.recurringTemplates.push({ id: Date.now().toString(), customerId: cust, description: desc, amount: amt, frequency: freq, active: true });
                localStorage.setItem('owomi_recurring', JSON.stringify(state.recurringTemplates));
                closeModal(); render();
            };
        }

        function showProductModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Product/Service<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="prod-name" placeholder="e.g. Website Design"></div>
                            <div class="form-group"><label class="form-label">Price (â‚¦)</label><input type="number" class="form-input" id="prod-price" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Description (optional)</label><input type="text" class="form-input" id="prod-desc" placeholder="Brief description"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Product</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = () => {
                const name = document.getElementById('prod-name').value.trim();
                const price = parseFloat(document.getElementById('prod-price').value);
                const description = document.getElementById('prod-desc').value.trim();
                if (!name || !price) return alert('Please enter name and price');
                state.products.push({ id: 'prod-' + Date.now(), name, price, description });
                localStorage.setItem('owomi_products', JSON.stringify(state.products));
                closeModal(); render();
                showToast('Product added!', 'success');
            };
        }

        function showEditProductModal(productId) {
            const prod = state.products.find(p => p.id === productId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Product<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="prod-name" value="${prod.name}"></div>
                            <div class="form-group"><label class="form-label">Price (â‚¦)</label><input type="number" class="form-input" id="prod-price" value="${prod.price}"></div>
                            <div class="form-group"><label class="form-label">Description (optional)</label><input type="text" class="form-input" id="prod-desc" value="${prod.description || ''}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = () => {
                const name = document.getElementById('prod-name').value.trim();
                const price = parseFloat(document.getElementById('prod-price').value);
                const description = document.getElementById('prod-desc').value.trim();
                if (!name || !price) return alert('Please enter name and price');
                const idx = state.products.findIndex(p => p.id === productId);
                state.products[idx] = { ...state.products[idx], name, price, description };
                localStorage.setItem('owomi_products', JSON.stringify(state.products));
                closeModal(); render();
            };
        }

        function showExpenseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Expense<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="exp-desc" placeholder="What was this expense for?"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="exp-amount" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Category</label>
                                <select class="form-input" id="exp-cat">
                                    <option value="Software">Software & Tools</option>
                                    <option value="Utilities">Utilities (Internet, Power)</option>
                                    <option value="Labor">Labor & Freelancers</option>
                                    <option value="Supplies">Office Supplies</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Marketing">Marketing & Ads</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="exp-date" value="${today}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Expense</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = () => {
                const description = document.getElementById('exp-desc').value.trim();
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-cat').value;
                const date = document.getElementById('exp-date').value;
                if (!description || !amount) return alert('Please enter description and amount');
                state.expenses.push({ id: 'exp-' + Date.now(), description, amount, category, date });
                localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                closeModal(); render();
                showToast('Expense added!', 'success');
            };
        }

        function showEditExpenseModal(expenseId) {
            const exp = state.expenses.find(e => e.id === expenseId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Expense<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="exp-desc" value="${exp.description}"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="exp-amount" value="${exp.amount}"></div>
                            <div class="form-group"><label class="form-label">Category</label>
                                <select class="form-input" id="exp-cat">
                                    <option value="Software" ${exp.category === 'Software' ? 'selected' : ''}>Software & Tools</option>
                                    <option value="Utilities" ${exp.category === 'Utilities' ? 'selected' : ''}>Utilities (Internet, Power)</option>
                                    <option value="Labor" ${exp.category === 'Labor' ? 'selected' : ''}>Labor & Freelancers</option>
                                    <option value="Supplies" ${exp.category === 'Supplies' ? 'selected' : ''}>Office Supplies</option>
                                    <option value="Transport" ${exp.category === 'Transport' ? 'selected' : ''}>Transport</option>
                                    <option value="Marketing" ${exp.category === 'Marketing' ? 'selected' : ''}>Marketing & Ads</option>
                                    <option value="Other" ${exp.category === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="exp-date" value="${exp.date}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = () => {
                const description = document.getElementById('exp-desc').value.trim();
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-cat').value;
                const date = document.getElementById('exp-date').value;
                if (!description || !amount) return alert('Please enter description and amount');
                const idx = state.expenses.findIndex(e => e.id === expenseId);
                state.expenses[idx] = { ...state.expenses[idx], description, amount, category, date };
                localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                closeModal(); render();
            };
        }

        async function generateRecurring(templateId) {
            const tmpl = state.recurringTemplates.find(t => t.id === templateId);
            if (!tmpl) return;
            const due = new Date();
            due.setDate(due.getDate() + 30);
            try {
                await addInvoice(tmpl.customerId, tmpl.description + ' (Auto)', tmpl.amount, due.toISOString().split('T')[0]);
                alert('Invoice generated! Number: ' + state.invoices[0].invoice_number);
                render();
            } catch (err) { alert('Error: ' + err.message); }
        }

        function showAIModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal ai-modal">
                    <div class="modal-box">
                        <div class="modal-header">ðŸ¤– AI Assistant<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="ai-messages" id="ai-messages">
                            <div class="ai-msg assistant"><div class="ai-bubble">How far! ðŸ‘‹ I be your business assistant. I fit help you with:<br><br>
                            ðŸ“„ <b>Invoice</b> - "Invoice Chidi â‚¦50k for website"<br>
                            ðŸ‘¤ <b>Customer</b> - "Add customer Bola 08012345678"<br>
                            ðŸ’° <b>Payment</b> - "Record â‚¦20k for INV-001"<br>
                            ðŸ“± <b>Reminder</b> - "Remind Amaka" or "Send all reminders"<br>
                            ðŸ“Š <b>Report</b> - "Who owes me?" or "Wetin be my total?"<br><br>
                            You fit talk English or Pidgin - I go understand! ðŸ‡³ðŸ‡¬</div></div>
                        </div>
                        <div class="ai-input-area">
                            <input type="text" class="ai-input" id="ai-input" placeholder="Try: Who dey owe me? ...">
                            <button class="ai-send" id="ai-send">âž¤</button>
                            <button class="ai-stop hidden" id="ai-stop" style="background:#ef4444;color:white;border:none;width:48px;height:48px;border-radius:50%;cursor:pointer;font-size:16px;">â¹</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('ai-send').onclick = sendAIMessage;
            document.getElementById('ai-stop').onclick = stopAIMessage;
            document.getElementById('ai-input').onkeypress = (e) => { if (e.key === 'Enter') sendAIMessage(); };
        }

        // Track last suggestion for context
        let lastAISuggestion = null;
        let aiProcessing = false;
        let aiAborted = false;

        function stopAIMessage() {
            aiAborted = true;
            aiProcessing = false;
            document.getElementById('typing')?.remove();
            document.getElementById('ai-send')?.classList.remove('hidden');
            document.getElementById('ai-stop')?.classList.add('hidden');
            
            const messages = document.getElementById('ai-messages');
            if (messages) {
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">â¹ Stopped. What else can I help with?</div></div>`;
                messages.scrollTop = messages.scrollHeight;
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const messages = document.getElementById('ai-messages');
            const userText = input.value.trim();
            if (!userText || aiProcessing) return;

            aiProcessing = true;
            aiAborted = false;
            
            // Show stop button, hide send
            document.getElementById('ai-send')?.classList.add('hidden');
            document.getElementById('ai-stop')?.classList.remove('hidden');

            messages.innerHTML += `<div class="ai-msg user"><div class="ai-bubble">${userText}</div></div>`;
            input.value = '';
            messages.innerHTML += `<div class="ai-msg assistant" id="typing"><div class="ai-bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`;
            messages.scrollTop = messages.scrollHeight;

            try {
                // Process the command
                await new Promise(r => setTimeout(r, 300));
                
                if (aiAborted) return;
                
                const result = await processAICommand(userText);
                
                if (aiAborted) return;
                
                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">${result.replace(/\n/g, '<br>')}</div></div>`;
                messages.scrollTop = messages.scrollHeight;
                
                // Re-render if data changed
                if (result.includes('âœ…') || result.includes('Created') || result.includes('Recorded') || result.includes('Added') || result.includes('Sent')) {
                    render();
                }
            } catch (err) {
                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">âŒ Error: ${err.message}</div></div>`;
                messages.scrollTop = messages.scrollHeight;
            } finally {
                aiProcessing = false;
                document.getElementById('ai-send')?.classList.remove('hidden');
                document.getElementById('ai-stop')?.classList.add('hidden');
            }
        }

        async function processAICommand(text) {
            const qLower = text.toLowerCase();
            
            // ============ HANDLE YES/NO/CONFIRMATION ============
            if (qLower.match(/^(yes|yeah|yep|sure|ok|okay|do it|go ahead|please|send it|confirm)$/i)) {
                if (lastAISuggestion) {
                    const suggestion = lastAISuggestion;
                    lastAISuggestion = null; // Clear it
                    return await processAICommand(suggestion);
                }
                return "What would you like me to do? Try: \"Who owes me?\" or \"Show summary\"";
            }
            
            if (qLower.match(/^(no|nope|nah|cancel|never mind|forget it)$/i)) {
                lastAISuggestion = null;
                return "No problem! What else can I help with?";
            }
            
            // ============ FIX COMMON TYPOS ============
            let fixedText = text
                .replace(/\bown\b/gi, 'owe')      // own â†’ owe
                .replace(/\bowns\b/gi, 'owes')    // owns â†’ owes
                .replace(/\bthey\b/gi, '')        // remove "they" 
                .replace(/\bweting\b/gi, 'wetin') // weting â†’ wetin
                .replace(/\bremid\b/gi, 'remind') // remid â†’ remind
                .replace(/\binvoic\b/gi, 'invoice'); // invoic â†’ invoice
            
            const qFixed = fixedText.toLowerCase().trim();
            
            // Check if user is speaking Pidgin
            const isPidgin = qFixed.match(/\b(wetin|abi|shey|abeg|dey|na|oga|madam|wahala|chop|japa|sabi|no be|e be like|how far|i wan|make i)\b/i);
            
            // Pidgin phrases helper
            const pidgin = {
                success: isPidgin ? 'E don work!' : 'âœ…',
                nobody: isPidgin ? 'Nobody dey owe you o! Na clean sheet! ðŸŽ‰' : 'Nobody owes you money! ðŸŽ‰ All invoices are paid.',
                remind: isPidgin ? 'Make I remind am?' : 'Want me to remind them?',
                error: isPidgin ? 'Wahala dey o!' : 'âŒ Error',
                noProblem: isPidgin ? 'No wahala! Wetin else?' : 'No problem! What else can I help with?',
                whatDo: isPidgin ? 'Wetin you wan make I do?' : 'What would you like me to do?',
                created: isPidgin ? 'E don create!' : 'Created!',
                sent: isPidgin ? 'E don send!' : 'Sent!',
                recorded: isPidgin ? 'E don enter book!' : 'Recorded!',
                looking: isPidgin ? 'E dey look fine!' : 'Looking good!',
                payLink: isPidgin ? 'You wan make I send payment link? Talk "yes"' : 'Want me to send a payment link? Say "yes"',
                receipt: isPidgin ? 'You wan receipt? Talk "yes"' : 'Want me to generate a receipt? Say "yes"',
                thanks: isPidgin ? 'Oya na! ' : '',
                greeting: isPidgin ? 'How far! ' : 'Hey! '
            };
            
            // Helper to check time filters
            const getTimeFilter = () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);
                const monthAgo = new Date(today); monthAgo.setDate(monthAgo.getDate() - 30);
                
                if (qFixed.includes('today')) return { start: today, label: 'today' };
                if (qFixed.includes('this week') || qFixed.includes('week')) return { start: weekAgo, label: 'this week' };
                if (qFixed.includes('this month') || qFixed.includes('month')) return { start: monthAgo, label: 'this month' };
                return null;
            };
            
            // Helper to find customer by name (fuzzy)
            const findCustomer = (name) => {
                const n = name.toLowerCase().trim();
                return state.customers.find(c => 
                    c.name.toLowerCase().includes(n) || 
                    c.name.toLowerCase().split(' ').some(part => part.startsWith(n))
                );
            };
            
            // Helper to find invoice by number
            const findInvoice = (num) => {
                const n = num.toUpperCase().replace(/[^0-9A-Z]/g, '');
                return state.invoices.find(i => 
                    i.invoice_number?.toUpperCase().includes(n) ||
                    i.id.toUpperCase().includes(n)
                );
            };
            
            // Helper to parse amount
            const parseAmount = (text) => {
                const match = text.match(/â‚¦?\s*([\d,]+)\s*k?/i);
                if (match) {
                    let num = parseFloat(match[1].replace(/,/g, ''));
                    if (text.toLowerCase().includes('k')) num *= 1000;
                    return num;
                }
                return null;
            };

            // ============ CREATE INVOICE ============
            if (qFixed.includes('invoice') && (qFixed.includes('create') || qFixed.includes('new') || qFixed.includes('make') || qFixed.match(/invoice\s+\w+/))) {
                // Parse: "Invoice Chidi 50k for website design"
                // or: "Create invoice for Amaka â‚¦100,000 website"
                
                // Extract customer name (first capitalized word after invoice/for)
                const nameMatch = text.match(/(?:invoice|for)\s+([A-Z][a-z]+)/i);
                const customerName = nameMatch ? nameMatch[1] : null;
                
                if (!customerName) {
                    return "Who should I invoice? Try: \"Invoice Chidi â‚¦50k for website\"";
                }
                
                const customer = findCustomer(customerName);
                if (!customer) {
                    return `I don't know "${customerName}". Add them first:\n"Add customer ${customerName} 08012345678"`;
                }
                
                // Extract amount
                const amount = parseAmount(text);
                if (!amount) {
                    return `What's the amount? Try: "Invoice ${customer.name} â‚¦50k for website"`;
                }
                
                // Extract description (after "for")
                const descMatch = text.match(/for\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i) || text.match(/for\s+(.+)$/i);
                let description = descMatch ? descMatch[1].trim() : 'Services';
                description = description.charAt(0).toUpperCase() + description.slice(1);
                
                // Create invoice
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 14); // 2 weeks from now
                const dueDateStr = dueDate.toISOString().split('T')[0];
                
                try {
                    await addInvoice(customer.id, description, amount, dueDateStr, [{name: description, qty: 1, price: amount}]);
                    const invNumber = state.invoices[0].invoice_number;
                    // Set suggestion for follow-up
                    lastAISuggestion = `Payment link for ${customer.name}`;
                    
                    if (isPidgin) {
                        return `âœ… Invoice don create!\n\nðŸ“„ ${invNumber}\nðŸ‘¤ ${customer.name}\nðŸ’° â‚¦${amount.toLocaleString()}\nðŸ“ ${description}\nðŸ“… Due date: ${formatDate(dueDateStr)}\n\nMake I send payment link? Talk "yes" ðŸ“±`;
                    }
                    return `âœ… Invoice created!\n\nðŸ“„ ${invNumber}\nðŸ‘¤ ${customer.name}\nðŸ’° â‚¦${amount.toLocaleString()}\nðŸ“ ${description}\nðŸ“… Due: ${formatDate(dueDateStr)}\n\nWant me to send a payment link? Say "yes" ðŸ“±`;
                } catch (err) {
                    return isPidgin ? `âŒ Wahala dey: ${err.message}` : `âŒ Error creating invoice: ${err.message}`;
                }
            }
            
            // ============ ADD CUSTOMER ============
            if (qFixed.includes('add') && qFixed.includes('customer') || qFixed.includes('new customer')) {
                // Parse: "Add customer Bola 08012345678"
                const match = text.match(/customer\s+([A-Za-z]+(?:\s+[A-Za-z]+)?)\s*(0\d{10})?/i);
                
                if (!match || !match[1]) {
                    return "Please specify name and phone:\n\"Add customer Bola Ogunlade 08012345678\"";
                }
                
                const name = match[1].trim();
                const phone = match[2] || '';
                
                if (!phone) {
                    return `What's ${name}'s phone number?\n"Add customer ${name} 08012345678"`;
                }
                
                // Check if exists
                if (findCustomer(name)) {
                    return `${name} is already a customer!`;
                }
                
                try {
                    await addCustomer(name, phone);
                    lastAISuggestion = `Invoice ${name} â‚¦50000 for services`;
                    return `âœ… Customer added!\n\nðŸ‘¤ ${name}\nðŸ“± ${phone}\n\nWant to create an invoice for them? Say "yes" or tell me the amount ðŸ“„`;
                } catch (err) {
                    return `âŒ Error: ${err.message}`;
                }
            }
            
            // ============ RECORD PAYMENT ============
            if (qFixed.includes('record') && (qFixed.includes('payment') || qFixed.includes('â‚¦') || qFixed.match(/\d+k?\s/))) {
                // Parse: "Record â‚¦20k for INV-001" or "Record payment 50000 Chidi"
                const amount = parseAmount(text);
                
                if (!amount) {
                    return "What amount? Try: \"Record â‚¦20k for INV-001\"";
                }
                
                // Find invoice by number or customer name
                let invoice = null;
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    invoice = findInvoice(invMatch[0]);
                }
                
                if (!invoice) {
                    // Try to find by customer name
                    const nameMatch = text.match(/(?:for|from)\s+([A-Z][a-z]+)/i);
                    if (nameMatch) {
                        const customer = findCustomer(nameMatch[1]);
                        if (customer) {
                            // Find their unpaid invoice
                            invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                        }
                    }
                }
                
                if (!invoice) {
                    const unpaid = state.invoices.filter(i => getStatus(i) !== 'paid');
                    if (unpaid.length === 0) {
                        return "No unpaid invoices! ðŸŽ‰";
                    }
                    return `Which invoice? Unpaid ones:\n${unpaid.map(i => {
                        const c = state.customers.find(c => c.id === i.customer_id);
                        return `â€¢ ${i.invoice_number} - ${c?.name} (â‚¦${(i.amount - i.amount_paid).toLocaleString()})`;
                    }).join('\n')}\n\nTry: "Record â‚¦20k for ${unpaid[0].invoice_number}"`;
                }
                
                const cust = state.customers.find(c => c.id === invoice.customer_id);
                const owed = invoice.amount - invoice.amount_paid;
                const actualAmount = Math.min(amount, owed);
                
                try {
                    await recordPayment(invoice.id, actualAmount);
                    const newOwed = owed - actualAmount;
                    
                    if (newOwed <= 0) {
                        lastAISuggestion = `Receipt for ${invoice.invoice_number}`;
                        return `âœ… Payment recorded!\n\nðŸ’° â‚¦${actualAmount.toLocaleString()} from ${cust?.name}\nðŸ“„ ${invoice.invoice_number}\n\nðŸŽ‰ Invoice FULLY PAID!\n\nWant me to generate a receipt? Say "yes" ðŸ§¾`;
                    } else {
                        lastAISuggestion = `Remind ${cust?.name}`;
                        return `âœ… Payment recorded!\n\nðŸ’° â‚¦${actualAmount.toLocaleString()} from ${cust?.name}\nðŸ“„ ${invoice.invoice_number}\nðŸ’³ Balance: â‚¦${newOwed.toLocaleString()}\n\nWant me to send a reminder for the balance? Say "yes" ðŸ“±`;
                    }
                } catch (err) {
                    return `âŒ Error: ${err.message}`;
                }
            }
            
            // ============ SEND REMINDER TO SPECIFIC CUSTOMER ============
            if ((qFixed.includes('remind') || qFixed.includes('send') || qFixed.includes('message') || qFixed.includes('sms')) && !qFixed.includes('all')) {
                // Parse: "Remind Chidi" or "Send SMS to Amaka"
                const nameMatch = text.match(/(?:remind|to|sms)\s+([A-Z][a-z]+)/i);
                
                if (!nameMatch) {
                    return "Who should I remind? Try: \"Remind Chidi\" or \"Send all reminders\"";
                }
                
                const customer = findCustomer(nameMatch[1]);
                if (!customer) {
                    return `I don't know "${nameMatch[1]}". Check your customers in the Menu.`;
                }
                
                // Find their unpaid invoice
                const invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                if (!invoice) {
                    return `${customer.name} has no unpaid invoices! ðŸŽ‰`;
                }
                
                // Send SMS
                const owed = invoice.amount - invoice.amount_paid;
                const message = `Hi ${customer.name}, reminder: Your invoice of â‚¦${owed.toLocaleString()} for "${invoice.description}" is due ${formatDate(invoice.due_date)}. Please pay promptly. - ${state.businessProfile.name || 'Owo Mi'}`;
                
                if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                    await new Promise(r => setTimeout(r, 800));
                    lastAISuggestion = `Payment link for ${customer.name}`;
                    if (isPidgin) {
                        return `âœ… SMS don send to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’¬ "${message.slice(0, 60)}..."\n\nYou wan make I send payment link too? Talk "yes" ðŸ’³`;
                    }
                    return `âœ… SMS sent to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’¬ "${message.slice(0, 60)}..."\n\nWant to send a payment link too? Say "yes" ðŸ’³`;
                }
                
                try {
                    const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                        body: JSON.stringify({ phone: customer.phone, message })
                    });
                    const data = await res.json();
                    
                    if (data.code === 'ok' || data.message_id) {
                        lastAISuggestion = `Payment link for ${customer.name}`;
                        if (isPidgin) {
                            return `âœ… SMS don send to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’° E dey owe: â‚¦${owed.toLocaleString()}\n\nYou wan payment link too? Talk "yes" ðŸ’³`;
                        }
                        return `âœ… SMS sent to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’° Owes: â‚¦${owed.toLocaleString()}\n\nWant to send a payment link too? Say "yes" ðŸ’³`;
                    } else {
                        throw new Error(data.message || 'Failed');
                    }
                } catch (err) {
                    return isPidgin ? `âŒ SMS no go through: ${err.message}\n\nMake we try WhatsApp?` : `âŒ SMS failed: ${err.message}\n\nTry WhatsApp instead? I'll open it for you.`;
                }
            }
            
            // ============ SEND ALL REMINDERS ============
            if (qFixed.includes('all') && (qFixed.includes('remind') || qFixed.includes('send') || qFixed.includes('overdue'))) {
                const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
                
                if (overdueInvoices.length === 0) {
                    return "No overdue invoices! Everyone is paying on time ðŸŽ‰";
                }
                
                let sent = 0, failed = 0;
                const results = [];
                
                for (const inv of overdueInvoices) {
                    const cust = state.customers.find(c => c.id === inv.customer_id);
                    if (!cust?.phone) { failed++; continue; }
                    
                    const owed = inv.amount - inv.amount_paid;
                    const message = `Hi ${cust.name}, reminder: Your invoice of â‚¦${owed.toLocaleString()} for "${inv.description}" is overdue. Please pay ASAP. - ${state.businessProfile.name || 'Owo Mi'}`;
                    
                    if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                        await new Promise(r => setTimeout(r, 300));
                        sent++;
                        results.push(`âœ“ ${cust.name}`);
                        continue;
                    }
                    
                    try {
                        const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                            body: JSON.stringify({ phone: cust.phone, message })
                        });
                        const data = await res.json();
                        if (data.code === 'ok' || data.message_id) {
                            sent++;
                            results.push(`âœ“ ${cust.name}`);
                        } else {
                            failed++;
                            results.push(`âœ— ${cust.name}`);
                        }
                    } catch {
                        failed++;
                        results.push(`âœ— ${cust.name}`);
                    }
                }
                
                return `âœ… Bulk reminders sent!\n\nðŸ“± Sent: ${sent}\nâŒ Failed: ${failed}\n\n${results.join('\n')}`;
            }
            
            // ============ PAYMENT LINK ============
            if (qFixed.includes('payment link') || qFixed.includes('pay link') || qFixed.includes('paystack')) {
                const nameMatch = text.match(/(?:for|to)\s+([A-Z][a-z]+)/i);
                
                if (!nameMatch) {
                    const unpaid = state.invoices.filter(i => getStatus(i) !== 'paid');
                    if (unpaid.length === 0) return "No unpaid invoices!";
                    return `Who needs a payment link?\n${unpaid.map(i => {
                        const c = state.customers.find(c => c.id === i.customer_id);
                        return `â€¢ ${c?.name} - â‚¦${(i.amount - i.amount_paid).toLocaleString()}`;
                    }).join('\n')}\n\nTry: "Payment link for ${state.customers.find(c => c.id === unpaid[0].customer_id)?.name}"`;
                }
                
                const customer = findCustomer(nameMatch[1]);
                if (!customer) return `I don't know "${nameMatch[1]}"`;
                
                const invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                if (!invoice) return `${customer.name} has no unpaid invoices!`;
                
                // Trigger the payment link function
                generatePaymentLink(invoice.id);
                return `âœ… Opening payment link for ${customer.name}...\n\nðŸ’° Amount: â‚¦${(invoice.amount - invoice.amount_paid).toLocaleString()}\n\nYou can share this with ${customer.name} via WhatsApp or SMS!`;
            }
            
            // ============ GENERATE PDF ============
            if (qFixed.includes('pdf') || qFixed.includes('download') || qFixed.includes('print')) {
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    const invoice = findInvoice(invMatch[0]);
                    if (invoice) {
                        generatePDF(invoice.id);
                        return `âœ… Opening PDF for ${invMatch[0]}...`;
                    }
                }
                
                const nameMatch = text.match(/(?:for|from)\s+([A-Z][a-z]+)/i);
                if (nameMatch) {
                    const customer = findCustomer(nameMatch[1]);
                    if (customer) {
                        const invoice = state.invoices.find(i => i.customer_id === customer.id);
                        if (invoice) {
                            generatePDF(invoice.id);
                            return `âœ… Opening PDF for ${customer.name}'s invoice...`;
                        }
                    }
                }
                
                return "Which invoice? Try: \"PDF for INV-001\" or \"PDF for Chidi\"";
            }
            
            // ============ GENERATE RECEIPT ============
            if (qFixed.includes('receipt')) {
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    const invoice = findInvoice(invMatch[0]);
                    if (invoice) {
                        if (getStatus(invoice) !== 'paid') {
                            return `${invMatch[0]} is not fully paid yet. Record the remaining payment first.`;
                        }
                        generateReceipt(invoice.id);
                        return `âœ… Opening receipt for ${invMatch[0]}...`;
                    }
                }
                
                const paidInvoices = state.invoices.filter(i => getStatus(i) === 'paid');
                if (paidInvoices.length === 0) return "No paid invoices to generate receipts for.";
                
                return `Which invoice needs a receipt?\n${paidInvoices.slice(0, 5).map(i => {
                    const c = state.customers.find(c => c.id === i.customer_id);
                    return `â€¢ ${i.invoice_number} - ${c?.name}`;
                }).join('\n')}\n\nTry: "Receipt for ${paidInvoices[0].invoice_number}"`;
            }
            
            // ============ WHO OWES / DEBTORS ============
            if (qFixed.includes('owe') || qFixed.includes('debt') || qFixed.includes('outstanding') || qFixed.includes('unpaid')) {
                const timeFilter = getTimeFilter();
                
                const debtors = state.customers.map(c => {
                    let invoices = state.invoices.filter(i => i.customer_id === c.id);
                    
                    // Apply time filter if specified
                    if (timeFilter) {
                        invoices = invoices.filter(i => new Date(i.created_at) >= timeFilter.start);
                    }
                    
                    const owed = invoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                    return { name: c.name, phone: c.phone, owed };
                }).filter(c => c.owed > 0).sort((a, b) => b.owed - a.owed);
                
                if (debtors.length === 0) {
                    return timeFilter 
                        ? (isPidgin ? `Nobody dey owe you ${timeFilter.label} o! ðŸŽ‰` : `Nobody owes you money ${timeFilter.label}! ðŸŽ‰`)
                        : pidgin.nobody;
                }
                
                const total = debtors.reduce((s, d) => s + d.owed, 0);
                const timeLabel = timeFilter ? ` (${timeFilter.label})` : '';
                
                // Set suggestion for "yes" response
                lastAISuggestion = `Remind ${debtors[0].name}`;
                
                const header = isPidgin ? `ðŸ’° Dem dey owe you${timeLabel}: â‚¦${total.toLocaleString()}` : `ðŸ’° Outstanding${timeLabel}: â‚¦${total.toLocaleString()}`;
                const listIntro = isPidgin ? 'See who dey owe you:' : 'Who owes you:';
                const footer = isPidgin 
                    ? `\n\nMake I remind ${debtors[0].name}? Talk "yes" ðŸ“±` 
                    : `\n\nWant me to remind ${debtors[0].name}? Say "yes" ðŸ“±`;
                
                return `${header}\n\n${listIntro}\n${debtors.map((d, i) => `${i + 1}. ${d.name}: â‚¦${d.owed.toLocaleString()}`).join('\n')}${footer}`;
            }
            
            // ============ SUMMARY / TOTAL ============
            if (qFixed.includes('summary') || qFixed.includes('total') || qFixed.includes('overview') || qFixed.includes('wetin') || qFixed.includes('status') || qFixed.includes('how much')) {
                const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
                const overdue = state.invoices.filter(i => getStatus(i) === 'overdue').length;
                const pending = state.invoices.filter(i => getStatus(i) === 'pending').length;
                const expenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
                const profit = collected - expenses;
                
                if (isPidgin) {
                    return `ðŸ“Š Business Summary\n\nðŸ’° Wetin dem dey owe you: â‚¦${outstanding.toLocaleString()}\nâœ… Wetin don enter: â‚¦${collected.toLocaleString()}\nðŸ’¸ Wetin you spend: â‚¦${expenses.toLocaleString()}\n${profit >= 0 ? 'ðŸ“ˆ Gain' : 'ðŸ“‰ Loss'}: â‚¦${Math.abs(profit).toLocaleString()}\n\nðŸ‘¥ Customers: ${state.customers.length}\nðŸ“„ Invoices: ${state.invoices.length}\nâ° Pending: ${pending}\nðŸš¨ Overdue: ${overdue}\n\n${overdue > 0 ? `Omo you get ${overdue} wey don pass date! Talk "Send all reminders" make I pursue dem.` : 'E dey look fine! No wahala ðŸ‘'}`;
                }
                
                return `ðŸ“Š Business Summary\n\nðŸ’° Outstanding: â‚¦${outstanding.toLocaleString()}\nâœ… Collected: â‚¦${collected.toLocaleString()}\nðŸ’¸ Expenses: â‚¦${expenses.toLocaleString()}\n${profit >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'} Net Profit: â‚¦${profit.toLocaleString()}\n\nðŸ‘¥ Customers: ${state.customers.length}\nðŸ“„ Total Invoices: ${state.invoices.length}\nâ° Pending: ${pending}\nðŸš¨ Overdue: ${overdue}\n\n${overdue > 0 ? `You have ${overdue} overdue! Say "Send all reminders" to chase them.` : 'Looking good! No overdue invoices ðŸ‘'}`;
            }
            
            // ============ OVERDUE LIST ============
            if (qFixed.includes('overdue') || qFixed.includes('late')) {
                const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
                
                if (overdueInvoices.length === 0) {
                    return "No overdue invoices! ðŸŽ‰ Everyone is paying on time.";
                }
                
                return `ðŸš¨ ${overdueInvoices.length} Overdue Invoice(s)\n\n${overdueInvoices.map(i => {
                    const c = state.customers.find(c => c.id === i.customer_id);
                    const owed = i.amount - i.amount_paid;
                    const daysLate = Math.floor((new Date() - new Date(i.due_date)) / 86400000);
                    return `â€¢ ${i.invoice_number} - ${c?.name}\n  â‚¦${owed.toLocaleString()} â€¢ ${daysLate} days late`;
                }).join('\n\n')}\n\nSay "Send all reminders" to nudge them! ðŸ“±`;
            }
            
            // ============ ADD EXPENSE ============
            if (qFixed.includes('expense') && (qFixed.includes('add') || qFixed.includes('record') || qFixed.includes('spent'))) {
                const amount = parseAmount(text);
                if (!amount) {
                    return "What's the amount? Try: \"Add expense â‚¦5k for transport\"";
                }
                
                const descMatch = text.match(/(?:for|on)\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i) || text.match(/expense\s+(?:â‚¦[\d,]+k?\s+)?(.+)/i);
                const description = descMatch ? descMatch[1].trim() : 'Business expense';
                
                // Detect category
                let category = 'Other';
                if (qFixed.includes('internet') || qFixed.includes('light') || qFixed.includes('power') || qFixed.includes('electric')) category = 'Utilities';
                else if (qFixed.includes('transport') || qFixed.includes('fuel') || qFixed.includes('uber') || qFixed.includes('bolt')) category = 'Transport';
                else if (qFixed.includes('software') || qFixed.includes('domain') || qFixed.includes('hosting') || qFixed.includes('subscription')) category = 'Software';
                else if (qFixed.includes('salary') || qFixed.includes('freelancer') || qFixed.includes('staff') || qFixed.includes('pay')) category = 'Labor';
                else if (qFixed.includes('supply') || qFixed.includes('office') || qFixed.includes('equipment')) category = 'Supplies';
                else if (qFixed.includes('ads') || qFixed.includes('marketing') || qFixed.includes('advert')) category = 'Marketing';
                
                const expense = {
                    id: 'exp-' + Date.now(),
                    description: description.charAt(0).toUpperCase() + description.slice(1),
                    amount,
                    category,
                    date: new Date().toISOString().split('T')[0]
                };
                
                state.expenses.push(expense);
                localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                
                return `âœ… Expense recorded!\n\nðŸ’¸ â‚¦${amount.toLocaleString()}\nðŸ“ ${expense.description}\nðŸ·ï¸ ${category}\n\nYour expenses this month affect your profit. Check "Show summary" to see net profit.`;
            }
            
            // ============ ADD PRODUCT ============
            if (qFixed.includes('product') && (qFixed.includes('add') || qFixed.includes('new') || qFixed.includes('create'))) {
                const amount = parseAmount(text);
                const nameMatch = text.match(/product\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i);
                
                if (!nameMatch || !amount) {
                    return "Try: \"Add product Website Design â‚¦150k\"";
                }
                
                const name = nameMatch[1].trim();
                const product = {
                    id: 'prod-' + Date.now(),
                    name: name.charAt(0).toUpperCase() + name.slice(1),
                    price: amount,
                    description: ''
                };
                
                state.products.push(product);
                localStorage.setItem('owomi_products', JSON.stringify(state.products));
                
                return `âœ… Product added!\n\nðŸ“¦ ${product.name}\nðŸ’° â‚¦${amount.toLocaleString()}\n\nNow you can quickly add this to invoices!`;
            }
            
            // ============ LIST CUSTOMERS ============
            if (qFixed.includes('customer') && (qFixed.includes('list') || qFixed.includes('show') || qFixed.includes('all'))) {
                if (state.customers.length === 0) {
                    return "No customers yet. Add one:\n\"Add customer Bola 08012345678\"";
                }
                
                return `ðŸ‘¥ Your Customers (${state.customers.length})\n\n${state.customers.map(c => {
                    const owed = state.invoices.filter(i => i.customer_id === c.id).reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                    return `â€¢ ${c.name} - ${c.phone}${owed > 0 ? ` (owes â‚¦${owed.toLocaleString()})` : ''}`;
                }).join('\n')}`;
            }
            
            // ============ INSIGHTS / TIPS ============
            if (qFixed.includes('insight') || qFixed.includes('tip') || qFixed.includes('advice') || qFixed.includes('help me')) {
                const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
                const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
                const expenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
                
                const tips = [];
                
                if (overdue.length > 0) {
                    const topDebtor = state.customers.find(c => c.id === overdue[0].customer_id);
                    tips.push(`ðŸš¨ You have ${overdue.length} overdue invoice(s). ${topDebtor?.name} is the biggest - send them a reminder!`);
                }
                
                if (outstanding > collected * 0.5) {
                    tips.push(`ðŸ’¡ Over half your money is still outstanding. Consider offering early payment discounts.`);
                }
                
                if (expenses > collected * 0.7) {
                    tips.push(`âš ï¸ Your expenses are ${Math.round(expenses/collected*100)}% of revenue. Look for ways to cut costs.`);
                }
                
                if (state.products.length === 0) {
                    tips.push(`ðŸ“¦ Add products to speed up invoicing: "Add product Website Design â‚¦150k"`);
                }
                
                if (tips.length === 0) {
                    tips.push(`ðŸ‘ Your business is looking healthy! Keep up the good work.`);
                    tips.push(`ðŸ’¡ Tip: Set up auto-reminders in Menu â†’ Settings to chase payments automatically.`);
                }
                
                return `ðŸ’¡ Business Insights\n\n${tips.join('\n\n')}`;
            }
            
            // ============ GREETING ============
            if (qFixed.match(/^(hi|hello|hey|good|morning|afternoon|evening|sup|wetin|how far|oga|madam)/)) {
                const hour = new Date().getHours();
                
                if (isPidgin || qFixed.match(/^(wetin|how far|oga|madam)/)) {
                    const greeting = hour < 12 ? 'Good morning o' : hour < 17 ? 'How you dey' : 'Good evening o';
                    return `${greeting}! ðŸ‘‹ Wetin I fit help you with today?\n\nTry:\nâ€¢ "Who dey owe me?"\nâ€¢ "Invoice Chidi â‚¦50k for design"\nâ€¢ "Wetin be my total?"`;
                }
                
                const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
                return `${greeting}! ðŸ‘‹ How can I help your business today?\n\nTry:\nâ€¢ "Who owes me money?"\nâ€¢ "Invoice Chidi â‚¦50k for design"\nâ€¢ "Show summary"`;
            }
            
            // ============ FALLBACK ============
            if (isPidgin) {
                return `I fit help you with:\n\nðŸ“„ <b>Invoice</b> - "Invoice Chidi â‚¦50k for website"\nðŸ‘¤ <b>Customer</b> - "Add customer Bola 08012345678"\nðŸ’° <b>Payment</b> - "Record â‚¦20k for INV-001"\nðŸ“± <b>Reminder</b> - "Remind Amaka" abi "Send all reminders"\nðŸ“Š <b>Report</b> - "Who dey owe me?" abi "Wetin be my total?"\nðŸ’¸ <b>Expense</b> - "Add expense â‚¦5k for transport"\n\nWetin you wan do?`;
            }
            return `I can help you with:\n\nðŸ“„ <b>Invoices</b> - "Invoice Chidi â‚¦50k for website"\nðŸ‘¤ <b>Customers</b> - "Add customer Bola 08012345678"\nðŸ’° <b>Payments</b> - "Record â‚¦20k for INV-001"\nðŸ“± <b>Reminders</b> - "Remind Amaka" or "Send all reminders"\nðŸ“Š <b>Reports</b> - "Who owes me?" or "Show summary"\nðŸ’¸ <b>Expenses</b> - "Add expense â‚¦5k for transport"\n\nWhat would you like to do?`;
        }

        // ========== UTILITIES ==========
        function generatePDF(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const p = state.businessProfile;
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 8).toUpperCase()}`;
            
            // Build items rows
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            const itemsRows = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">${formatNaira(item.price)}</td>
                    <td style="text-align:right">${formatNaira(item.qty * item.price)}</td>
                </tr>
            `).join('');

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice ${invNumber}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
                .header{text-align:center;border-bottom:3px solid #6366f1;padding-bottom:20px;margin-bottom:30px}
                .header h1{color:#6366f1;margin:0}
                .details{display:flex;justify-content:space-between;margin-bottom:30px}
                .box{background:#f9f9f9;padding:15px;border-radius:8px;width:48%}
                .box h3{margin:0 0 10px;color:#6366f1;font-size:14px}
                table{width:100%;border-collapse:collapse;margin-bottom:30px}
                th{background:#6366f1;color:white;padding:12px;text-align:left;font-size:13px}
                td{padding:12px;border-bottom:1px solid #eee;font-size:13px}
                .total-section{background:#f9f9f9;padding:15px;border-radius:8px}
                .total-row{display:flex;justify-content:space-between;padding:8px 0}
                .total-row.final{border-top:2px solid #6366f1;margin-top:8px;padding-top:12px;font-size:18px;font-weight:bold}
                .status{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold}
                .paid{background:#dcfce7;color:#166534}
                .pending{background:#fef3c7;color:#854d0e}
                .overdue{background:#fee2e2;color:#dc2626}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:40px}
                .inv-number{color:#6366f1;font-size:24px;font-weight:bold;margin-bottom:10px}
                @media print{body{padding:20px}}
            </style></head><body>
            <div class="header">
                <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                <p>${p.phone || ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
            </div>
            <div class="inv-number">${invNumber}</div>
            <h2>INVOICE <span class="status ${status}">${status.toUpperCase()}</span></h2>
            <div class="details">
                <div class="box">
                    <h3>BILL TO</h3>
                    <p><strong>${cust?.name || 'Customer'}</strong></p>
                    <p>${cust?.phone || ''}</p>
                </div>
                <div class="box">
                    <h3>DETAILS</h3>
                    <p>Invoice: ${invNumber}</p>
                    <p>Due: ${formatDate(inv.due_date)}</p>
                </div>
            </div>
            ${p.bank ? `<div class="box" style="width:100%;margin-bottom:20px"><h3>PAYMENT DETAILS</h3><p style="white-space:pre-line">${p.bank}</p></div>` : ''}
            
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th style="text-align:center">Qty</th>
                        <th style="text-align:right">Price</th>
                        <th style="text-align:right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsRows}
                </tbody>
            </table>
            
            <div class="total-section">
                <div class="total-row"><span>Subtotal</span><span>${formatNaira(inv.amount)}</span></div>
                <div class="total-row"><span>Amount Paid</span><span style="color:#16a34a">-${formatNaira(inv.amount_paid)}</span></div>
                <div class="total-row final"><span>Balance Due</span><span style="color:${inv.amount - inv.amount_paid > 0 ? '#dc2626' : '#16a34a'}">${formatNaira(inv.amount - inv.amount_paid)}</span></div>
            </div>
            
            <div class="footer">
                <p>Thank you for your business!</p>
                <p>Generated by Owo Mi</p>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate PDF. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function generateReceipt(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const p = state.businessProfile;
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 8).toUpperCase()}`;
            const receiptNumber = 'RCT-' + Date.now().toString().slice(-8);
            
            // Get payment history for this invoice
            const payments = state.paymentHistory.filter(p => p.invoiceId === invoiceId);
            const lastPayment = payments[payments.length - 1];
            const paymentMethod = lastPayment?.method || 'transfer';
            const paymentDate = inv.paid_date || lastPayment?.date || new Date().toISOString();
            
            const methodLabels = {
                transfer: 'ðŸ¦ Bank Transfer',
                cash: 'ðŸ’µ Cash',
                card: 'ðŸ’³ Card/POS',
                paystack: 'ðŸ”— Paystack'
            };
            
            // Build items list
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            const itemsList = items.map(item => `
                <div class="row"><span class="label">${item.name} ${item.qty > 1 ? 'Ã—' + item.qty : ''}</span><span class="value">${formatNaira(item.qty * item.price)}</span></div>
            `).join('');
            
            // Build payment history if multiple payments
            const paymentsList = payments.length > 1 ? `
                <div class="payments-section">
                    <div class="payments-title">Payment History</div>
                    ${payments.map((pay, i) => `
                        <div class="payment-row">
                            <span>${formatDate(pay.date)}</span>
                            <span>${formatNaira(pay.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Receipt ${receiptNumber}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:600px;margin:0 auto;background:#fff}
                .receipt{border:2px solid #16a34a;border-radius:12px;padding:30px}
                .header{text-align:center;border-bottom:2px dashed #16a34a;padding-bottom:20px;margin-bottom:20px}
                .header h1{color:#16a34a;margin:0 0 5px}
                .header p{color:#666;margin:0}
                .receipt-title{text-align:center;font-size:24px;color:#16a34a;margin-bottom:20px}
                .receipt-number{text-align:center;font-size:14px;color:#666;margin-bottom:20px}
                .details{margin-bottom:20px}
                .row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
                .row:last-child{border-bottom:none}
                .label{color:#666}
                .value{font-weight:600}
                .items-section{background:#f9f9f9;padding:15px;border-radius:8px;margin-bottom:20px}
                .items-title{font-weight:600;color:#16a34a;margin-bottom:10px;font-size:14px}
                .payments-section{background:#fff9e8;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #fbbf24}
                .payments-title{font-weight:600;color:#92400e;margin-bottom:10px;font-size:14px}
                .payment-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;color:#666}
                .total-row{background:#dcfce7;padding:15px;border-radius:8px;margin-top:20px;display:flex;justify-content:space-between}
                .total-row .label{font-weight:600;color:#166534}
                .total-row .value{font-size:20px;color:#166534}
                .payment-method{background:#e0e7ff;padding:12px;border-radius:8px;margin-top:15px;text-align:center;color:#4338ca;font-weight:500}
                .stamp{text-align:center;margin-top:30px;padding:15px;border:3px solid #16a34a;border-radius:50%;width:100px;height:100px;margin:30px auto;display:flex;align-items:center;justify-content:center}
                .stamp-text{color:#16a34a;font-weight:bold;font-size:18px}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:30px}
                @media print{body{padding:20px}.receipt{border:none}}
            </style></head><body>
            <div class="receipt">
                <div class="header">
                    <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                    <p>${p.phone || ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
                </div>
                <div class="receipt-title">âœ“ PAYMENT RECEIPT</div>
                <div class="receipt-number">Receipt: ${receiptNumber}<br>Invoice: ${invNumber}</div>
                <div class="details">
                    <div class="row"><span class="label">Received From</span><span class="value">${cust?.name || 'Customer'}</span></div>
                    <div class="row"><span class="label">Phone</span><span class="value">${cust?.phone || '-'}</span></div>
                    <div class="row"><span class="label">Payment Date</span><span class="value">${formatDate(paymentDate)}</span></div>
                    <div class="row"><span class="label">Payment Method</span><span class="value">${methodLabels[paymentMethod] || paymentMethod}</span></div>
                </div>
                <div class="items-section">
                    <div class="items-title">Items/Services</div>
                    ${itemsList}
                </div>
                ${paymentsList}
                <div class="total-row">
                    <span class="label">TOTAL PAID</span>
                    <span class="value">${formatNaira(inv.amount_paid)}</span>
                </div>
                <div class="stamp"><span class="stamp-text">PAID âœ“</span></div>
                <div class="footer">
                    <p>Thank you for your payment!</p>
                    <p style="color:#6366f1;font-weight:600;">Powered by Owo Mi ðŸ’° | owomi.ng</p>
                </div>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate Receipt. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function generateStatement(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const p = state.businessProfile;
            
            const totalInvoiced = custInvoices.reduce((s, i) => s + Number(i.amount), 0);
            const totalPaid = custInvoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            const balance = totalInvoiced - totalPaid;

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Statement - ${cust?.name}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
                .header{text-align:center;border-bottom:3px solid #6366f1;padding-bottom:20px;margin-bottom:30px}
                .header h1{color:#6366f1;margin:0}
                .title{font-size:24px;font-weight:bold;margin-bottom:20px}
                .customer-box{background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:30px}
                .customer-name{font-size:18px;font-weight:bold}
                .customer-phone{color:#666}
                table{width:100%;border-collapse:collapse;margin-bottom:30px}
                th{background:#6366f1;color:white;padding:12px;text-align:left;font-size:13px}
                td{padding:12px;border-bottom:1px solid #eee;font-size:13px}
                .status{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold}
                .paid{background:#dcfce7;color:#166534}
                .pending{background:#fef3c7;color:#854d0e}
                .overdue{background:#fee2e2;color:#dc2626}
                .summary{background:#f9f9f9;padding:20px;border-radius:8px}
                .summary-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
                .summary-row:last-child{border-bottom:none;font-weight:bold;font-size:18px}
                .summary-row.balance{color:${balance > 0 ? '#dc2626' : '#16a34a'}}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:40px}
                @media print{body{padding:20px}}
            </style></head><body>
            <div class="header">
                <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                <p>${p.phone || ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
            </div>
            <div class="title">CUSTOMER STATEMENT</div>
            <div class="customer-box">
                <div class="customer-name">${cust?.name || 'Customer'}</div>
                <div class="customer-phone">${cust?.phone || ''}</div>
                <div style="color:#666;font-size:13px;margin-top:8px;">Statement Date: ${formatDate(new Date().toISOString())}</div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Paid</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${custInvoices.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#999;">No invoices found</td></tr>' :
                    custInvoices.map(inv => {
                        const status = getStatus(inv);
                        return `
                            <tr>
                                <td>${inv.invoice_number || inv.id.slice(0, 8).toUpperCase()}</td>
                                <td>${formatDate(inv.created_at)}</td>
                                <td>${inv.description}</td>
                                <td>${formatNaira(inv.amount)}</td>
                                <td>${formatNaira(inv.amount_paid)}</td>
                                <td><span class="status ${status}">${status.toUpperCase()}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="summary">
                <div class="summary-row"><span>Total Invoiced</span><span>${formatNaira(totalInvoiced)}</span></div>
                <div class="summary-row"><span>Total Paid</span><span style="color:#16a34a">${formatNaira(totalPaid)}</span></div>
                <div class="summary-row balance"><span>Balance Due</span><span>${formatNaira(balance)}</span></div>
            </div>

            <div class="footer">
                <p>Thank you for your business!</p>
                <p>Generated by Owo Mi</p>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate Statement. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function sendWhatsApp(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;
            let phone = cust?.phone?.replace(/\s/g, '') || '';
            if (phone.startsWith('0')) phone = '234' + phone.slice(1);
            const msg = `Hello ${cust?.name},\n\nReminder: Your invoice of ${formatNaira(inv.amount)} for "${inv.description}" has ${formatNaira(owed)} outstanding.\n\nDue: ${formatDate(inv.due_date)}\n\nThank you!\n- Sent via Owo Mi`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function sendSMS(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;

            let phone = cust?.phone?.replace(/\s/g, '') || '';
            if (phone.startsWith('0')) phone = '234' + phone.slice(1);
            if (!phone.startsWith('234')) phone = '234' + phone;

            const message = `Hi ${cust?.name}, reminder: Your invoice of ${formatNaira(owed)} for "${inv.description}" is due ${formatDate(inv.due_date)}. Please pay promptly. - ${state.businessProfile.name || 'Owo Mi'}`;

            // DEV_MODE: Show mock success
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                const btn = document.querySelector(`[data-sms="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ SMS';
                await new Promise(r => setTimeout(r, 1000));
                showToast(`SMS sent to ${cust?.name}!`, 'success');
                render();
                return;
            }

            try {
                const btn = document.querySelector(`[data-sms="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ SMS';

                const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ phone, message })
                });

                const data = await res.json();
                
                if (data.code === 'ok' || data.message_id) {
                    showToast(`SMS sent to ${cust?.name}!`, 'success');
                } else {
                    throw new Error(data.message || 'SMS failed');
                }
            } catch (err) {
                alert('âŒ SMS Error: ' + err.message);
            }
            render();
        }

        async function generatePaymentLink(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;

            // DEV_MODE: Show mock payment link
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                const btn = document.querySelector(`[data-paylink="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ Pay Link';
                await new Promise(r => setTimeout(r, 1000));
                const mockUrl = `https://paystack.com/pay/demo-${inv.id.slice(0, 8)}`;
                showPaymentLinkModal(mockUrl, cust?.name, owed, cust?.phone);
                return;
            }

            try {
                const btn = document.querySelector(`[data-paylink="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ Pay Link';

                const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        email: `${cust?.phone || 'customer'}@owomi.app`,
                        amount: Math.round(owed * 100),
                        reference: `owomi_${inv.id}_${Date.now()}`,
                        metadata: {
                            invoice_id: inv.id,
                            customer_name: cust?.name,
                            description: inv.description
                        }
                    })
                });

                const data = await res.json();
                
                if (data.status && data.data?.authorization_url) {
                    showPaymentLinkModal(data.data.authorization_url, cust?.name, owed, cust?.phone);
                } else {
                    throw new Error(data.message || 'Failed to create payment link');
                }
            } catch (err) {
                alert('âŒ Payment Link Error: ' + err.message);
                render();
            }
        }

        function showPaymentLinkModal(url, customerName, amount, phone) {
            const whatsappMsg = `Hi ${customerName}! Here's your payment link for ${formatNaira(amount)}:\n\n${url}\n\nClick to pay securely with card or bank transfer. Thank you!\n- ${state.businessProfile.name || 'Owo Mi'}`;
            let formattedPhone = phone?.replace(/\s/g, '') || '';
            if (formattedPhone.startsWith('0')) formattedPhone = '234' + formattedPhone.slice(1);

            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">ðŸ’³ Payment Link Created<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <p style="margin-bottom:16px;color:#16a34a;font-weight:600;">âœ… Payment link ready for ${customerName}!</p>
                            <p style="margin-bottom:12px;color:#666;">Amount: <strong>${formatNaira(amount)}</strong></p>
                            
                            <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;word-break:break-all;font-size:13px;">
                                ${url}
                            </div>

                            <button class="btn btn-primary" id="btn-copy-link" style="margin-bottom:12px;">ðŸ“‹ Copy Link</button>
                            <button class="btn btn-whatsapp-send" id="btn-send-whatsapp" style="background:#25D366;color:white;width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;">ðŸ’¬ Send via WhatsApp</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = () => { closeModal(); render(); };
            document.getElementById('btn-copy-link').onclick = () => {
                navigator.clipboard.writeText(url).then(() => {
                    document.getElementById('btn-copy-link').textContent = 'âœ… Copied!';
                    setTimeout(() => { document.getElementById('btn-copy-link').textContent = 'ðŸ“‹ Copy Link'; }, 2000);
                });
            };
            document.getElementById('btn-send-whatsapp').onclick = () => {
                window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(whatsappMsg)}`, '_blank');
            };
        }

        function exportCSV() {
            let csv = 'Customer,Phone,Description,Amount,Paid,Outstanding,Status,Due Date\n';
            state.invoices.forEach(inv => {
                const cust = state.customers.find(c => c.id === inv.customer_id);
                csv += `"${cust?.name || ''}","${cust?.phone || ''}","${inv.description}",${inv.amount},${inv.amount_paid},${inv.amount - inv.amount_paid},${getStatus(inv)},"${inv.due_date}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'owo-mi-invoices.csv';
            a.click();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('owomi_dark', document.body.classList.contains('dark') ? '1' : '0');
            render();
        }

        function saveSettings() {
            state.businessProfile = {
                name: document.getElementById('set-name').value.trim(),
                phone: document.getElementById('set-phone').value.trim(),
                address: document.getElementById('set-address').value.trim(),
                bank: document.getElementById('set-bank').value.trim()
            };
            localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
            alert('Settings saved!');
        }

        // ========== INIT ==========
        const DEV_MODE = false; // Production mode

        async function init() {
            if (localStorage.getItem('owomi_dark') === '1') document.body.classList.add('dark');
            
            // Load reminder settings
            state.reminderSettings = JSON.parse(localStorage.getItem('owomi_reminders') || '{"enabled":false,"before_due_days":3,"on_due_date":true,"after_due_days":[3,7],"channel":"whatsapp"}');
            
            // Load payment history
            state.paymentHistory = JSON.parse(localStorage.getItem('owomi_payments') || '[]');
            
            // Check for customer portal mode via URL hash
            const hash = window.location.hash;
            if (hash.startsWith('#portal/')) {
                const customerId = hash.replace('#portal/', '');
                state.portalMode = true;
                state.portalCustomerId = customerId;
                
                // Load data for portal
                state.businessProfile = JSON.parse(localStorage.getItem('owomi_business') || '{"name":"Business Name","phone":""}');
                state.customers = JSON.parse(localStorage.getItem('owomi_customers') || '[]');
                state.invoices = JSON.parse(localStorage.getItem('owomi_invoices') || '[]');
                
                state.loading = false;
                renderPortal();
                return;
            }
            
            // Check if user has visited before or is logged in
            const savedUser = localStorage.getItem('owomi_user');
            const onboarded = localStorage.getItem('owomi_onboarded');
            const session = getSession();
            
            // Production mode
            if (session?.access_token) {
                state.user = session.user;
                await loadData();
                state.currentSection = onboarded ? 'app' : 'onboarding';
                // Check auto reminders after render
                if (onboarded) {
                    setTimeout(checkAutoReminders, 1500);
                }
            } else {
                state.currentSection = 'landing';
            }
            state.loading = false;
            render();
        }

        init();
        
        // Handle hash changes for portal navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#portal/')) {
                const customerId = hash.replace('#portal/', '');
                state.portalMode = true;
                state.portalCustomerId = customerId;
                renderPortal();
            } else if (state.portalMode) {
                // Exiting portal mode
                state.portalMode = false;
                state.portalCustomerId = null;
                window.location.reload();
            }
        });

        // ========== PWA ==========
        let deferredPrompt;
        
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'owomi-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', e => {
                    e.waitUntil(caches.keys().then(keys => 
                        Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
                    ));
                });
                
                self.addEventListener('fetch', e => {
                    e.respondWith(
                        fetch(e.request)
                            .then(res => {
                                const clone = res.clone();
                                caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
                                return res;
                            })
                            .catch(() => caches.match(e.request))
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(reg => {
                console.log('SW registered:', reg.scope);
            }).catch(err => {
                console.log('SW registration failed:', err);
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!localStorage.getItem('owomi_installed')) {
                setTimeout(showInstallPrompt, 3000);
            }
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const prompt = document.createElement('div');
            prompt.className = 'install-prompt';
            prompt.innerHTML = `
                <div class="install-prompt-icon">ðŸ’°</div>
                <div class="install-prompt-text">
                    <div class="install-prompt-title">Install Owo Mi</div>
                    <div class="install-prompt-desc">Add to home screen for quick access</div>
                </div>
                <button class="install-prompt-btn" id="install-btn">Install</button>
                <button class="install-prompt-close" id="install-close">Ã—</button>
            `;
            document.body.appendChild(prompt);

            document.getElementById('install-btn').onclick = async () => {
                prompt.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    localStorage.setItem('owomi_installed', '1');
                }
                deferredPrompt = null;
            };

            document.getElementById('install-close').onclick = () => {
                prompt.remove();
                localStorage.setItem('owomi_installed', '1');
            };
        }

        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as PWA');
        }
    </script>
</body>
</html>
