<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Owo Mi</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Smart Invoice Manager for Nigerian Businesses">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Owo Mi">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iOS Splash Screens -->
    <!-- iPhone 14 Pro Max, 15 Plus -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 430 932'><rect fill='%233b82f6' width='430' height='932'/><text x='215' y='466' text-anchor='middle' font-size='120'>ðŸ’°</text></svg>">
    <!-- iPhone 14 Pro, 15 -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 393 852'><rect fill='%233b82f6' width='393' height='852'/><text x='196' y='426' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">
    <!-- iPhone 12/13/14, 15 -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 390 844'><rect fill='%233b82f6' width='390' height='844'/><text x='195' y='422' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">
    <!-- iPhone 11/XR -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 414 896'><rect fill='%233b82f6' width='414' height='896'/><text x='207' y='448' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">
    <!-- iPhone X/XS/11 Pro -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 375 812'><rect fill='%233b82f6' width='375' height='812'/><text x='187' y='406' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">
    <!-- iPhone 8/7/6s Plus -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 414 736'><rect fill='%233b82f6' width='414' height='736'/><text x='207' y='368' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">
    <!-- iPhone SE/8/7/6s -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 375 667'><rect fill='%233b82f6' width='375' height='667'/><text x='187' y='333' text-anchor='middle' font-size='100'>ðŸ’°</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Owo Mi - Invoice Manager&quot;,
        &quot;short_name&quot;: &quot;Owo Mi&quot;,
        &quot;description&quot;: &quot;Smart Invoice Manager for Nigerian Businesses&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#3b82f6&quot;,
        &quot;theme_color&quot;: &quot;#3b82f6&quot;,
        &quot;orientation&quot;: &quot;portrait&quot;,
        &quot;icons&quot;: [{
            &quot;src&quot;: &quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>ðŸ’°</text></svg>&quot;,
            &quot;sizes&quot;: &quot;512x512&quot;,
            &quot;type&quot;: &quot;image/svg+xml&quot;,
            &quot;purpose&quot;: &quot;any maskable&quot;
        }]
    }">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='20'/><text x='50' y='65' text-anchor='middle' font-size='50'>ðŸ’°</text></svg>">

    <!-- Paystack Payment Script -->
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html {
            /* Prevent pull-to-refresh on iOS */
            overscroll-behavior-y: contain;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent pull-to-refresh */
            overscroll-behavior-y: contain;
            /* Better touch handling */
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            /* Safe area for notch devices */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* Allow text selection in inputs and textareas */
        input, textarea, [contenteditable] {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Smooth scrolling on iOS */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .install-prompt-icon { font-size: 32px; }
        .install-prompt-text { flex: 1; }
        .install-prompt-title { font-weight: 600; font-size: 15px; }
        .install-prompt-desc { font-size: 13px; color: #666; }
        .install-prompt-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .install-prompt-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 8px; }
        body.dark .install-prompt { background: #1a1a2e; }
        body.dark .install-prompt-title { color: #eee; }
        
        /* ========== LANDING PAGE ========== */
        .landing-section {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
        }
        
        .landing-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .landing-logo {
            font-size: 28px;
            font-weight: 800;
            color: #3b82f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .landing-nav-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
        }
        
        .landing-hero {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 24px 80px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: center;
        }
        
        .landing-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .landing-title {
            font-size: clamp(36px, 5vw, 56px);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 20px;
            color: #1a1a2e;
        }
        
        .landing-title span {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .landing-subtitle {
            font-size: 18px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 32px;
            max-width: 480px;
        }
        
        .landing-ctas {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .landing-cta-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99,102,241,0.4);
        }
        
        .landing-cta-secondary {
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
        }
        
        .landing-stats {
            display: flex;
            gap: 40px;
            margin-top: 48px;
            padding-top: 32px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .landing-stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #3b82f6;
        }
        
        .landing-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .landing-phone {
            width: 280px;
            height: 560px;
            background: #1a1a2e;
            border-radius: 40px;
            padding: 12px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.25);
            margin: 0 auto;
        }
        
        .landing-phone-screen {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 30px;
            padding: 40px 16px 16px;
            overflow: hidden;
        }
        
        .landing-phone-header {
            color: white;
            margin-bottom: 16px;
        }
        
        .landing-phone-greeting {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .landing-phone-title {
            font-size: 22px;
            font-weight: 700;
        }
        
        .landing-phone-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .landing-phone-stat {
            background: rgba(255,255,255,0.15);
            padding: 12px;
            border-radius: 12px;
            color: white;
        }
        
        .landing-phone-stat-label {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .landing-phone-stat-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .landing-phone-card {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .landing-phone-card-top {
            display: flex;
            justify-content: space-between;
        }
        
        .landing-phone-card-name {
            font-weight: 600;
            font-size: 14px;
            color: #1a1a2e;
        }
        
        .landing-phone-card-desc {
            font-size: 12px;
            color: #888;
        }
        
        .landing-phone-card-amount {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a2e;
        }
        
        .landing-phone-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 6px;
        }
        
        .landing-phone-badge.paid {
            background: #dcfce7;
            color: #166534;
        }
        
        .landing-phone-badge.pending {
            background: #fef3c7;
            color: #854d0e;
        }
        
        .landing-features {
            background: white;
            padding: 80px 24px;
        }
        
        .landing-features-inner {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .landing-section-title {
            text-align: center;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 48px;
            color: #1a1a2e;
        }
        
        .landing-features-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }
        
        .landing-feature-card {
            background: #f8fafc;
            padding: 28px 24px;
            border-radius: 16px;
            text-align: center;
        }
        
        .landing-feature-icon {
            font-size: 40px;
            margin-bottom: 16px;
        }
        
        .landing-feature-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .landing-feature-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .landing-cta-section {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            padding: 80px 24px;
            text-align: center;
        }
        
        .landing-cta-section h2 {
            font-size: 32px;
            color: white;
            margin-bottom: 16px;
        }
        
        .landing-cta-section p {
            font-size: 18px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 32px;
        }
        
        .landing-cta-section button {
            background: white;
            color: #3b82f6;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 17px;
            cursor: pointer;
        }
        
        .landing-footer {
            background: #1a1a2e;
            color: white;
            padding: 40px 24px;
            text-align: center;
        }
        
        .landing-footer-logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .landing-footer p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
        
        @media (max-width: 900px) {
            .landing-hero {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 40px 24px 60px;
            }
            .landing-subtitle {
                margin-left: auto;
                margin-right: auto;
            }
            .landing-ctas {
                justify-content: center;
            }
            .landing-stats {
                justify-content: center;
            }
            .landing-hero > div:last-child {
                order: -1;
            }
            .landing-phone {
                width: 240px;
                height: 480px;
            }
            .landing-features-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .landing-features-grid {
                grid-template-columns: 1fr;
            }
            .landing-stats {
                gap: 24px;
            }
            .landing-stat-value {
                font-size: 26px;
            }
        }
        
        /* ========== ONBOARDING ========== */
        .onboarding-section {
            min-height: 100vh;
            background: linear-gradient(180deg, #eff6ff 0%, #f8fafc 100%);
            display: flex;
            flex-direction: column;
        }
        
        .onboarding-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            padding: 40px 24px;
            width: 100%;
        }
        
        .onboarding-progress {
            display: flex;
            gap: 6px;
            margin-bottom: 32px;
        }
        
        .onboarding-progress-step {
            flex: 1;
            height: 4px;
            background: rgba(59,130,246,0.2);
            border-radius: 2px;
            transition: all 0.4s ease;
        }
        
        .onboarding-progress-step.completed {
            background: #3b82f6;
        }
        
        .onboarding-progress-step.active {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        
        .onboarding-step {
            display: none;
            flex-direction: column;
            flex: 1;
            animation: fadeInUp 0.4s ease;
        }
        
        .onboarding-step.active {
            display: flex;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .onboarding-illustration {
            width: 200px;
            height: 200px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 20px 60px rgba(59,130,246,0.3);
        }
        
        .onboarding-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .onboarding-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1a1a2e;
            text-align: center;
        }
        
        .onboarding-desc {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 28px;
            text-align: center;
        }
        
        .onboarding-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .onboarding-actions {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }
        
        .onboarding-btn {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .onboarding-btn:active {
            transform: scale(0.98);
        }
        
        .onboarding-btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59,130,246,0.3);
        }
        
        .onboarding-btn-secondary {
            background: white;
            color: #666;
            border: 2px solid #e5e7eb;
        }
        
        .onboarding-skip {
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
            padding: 8px;
            text-align: center;
            width: 100%;
        }
        
        .onboarding-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 28px;
        }
        
        .onboarding-feature {
            background: white;
            padding: 20px 16px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .onboarding-feature-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .onboarding-feature-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: #1a1a2e;
        }
        
        .onboarding-feature-desc {
            font-size: 12px;
            color: #888;
        }
        
        .onboarding-highlight {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }
        
        .onboarding-highlight-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .onboarding-highlight-text {
            font-size: 14px;
            color: #78350f;
        }
        
        .onboarding-success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .onboarding-success-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .onboarding-success-title {
            font-size: 20px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 8px;
        }
        
        .onboarding-success-text {
            font-size: 14px;
            color: #15803d;
        }
        
        .onboarding-tips {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .onboarding-tip {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .onboarding-tip:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .onboarding-tip-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .onboarding-tip-text {
            font-size: 14px;
            color: #444;
            line-height: 1.4;
        }
        
        .onboarding-tip-text strong {
            color: #1a1a2e;
        }
        
        /* Auth Screen */
        .auth-container { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 24px; 
            background: #f5f5f0;
        }
        .auth-box { 
            background: white; 
            padding: 40px 32px; 
            border-radius: 24px; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 4px 24px rgba(0,0,0,0.08); 
        }
        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .auth-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .auth-title { 
            font-size: 28px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: #1a1a2e;
        }
        .auth-subtitle { 
            color: #666; 
            font-size: 15px;
            line-height: 1.5;
        }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: #888;
            font-size: 13px;
        }
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }
        .auth-divider span {
            padding: 0 16px;
        }
        
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            background: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            color: #333;
        }
        .social-btn:hover {
            background: #f9f9f9;
            border-color: #ccc;
        }
        .social-btn:active {
            transform: scale(0.98);
        }
        .social-btn img,
        .social-btn svg {
            width: 20px;
            height: 20px;
        }
        .social-btn.google-btn:hover {
            border-color: #4285f4;
        }
        .social-btn.apple-btn {
            background: #000;
            color: white;
            border-color: #000;
        }
        .social-btn.apple-btn:hover {
            background: #333;
        }
        
        .email-form {
            margin-top: 8px;
        }
        .email-form .form-group {
            margin-bottom: 16px;
        }
        .email-form .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .email-form .form-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        .email-form .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .auth-submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }
        .auth-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .auth-submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: #666;
        }
        .auth-toggle a {
            color: #3b82f6;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        .auth-back {
            display: block;
            text-align: center;
            margin-top: 24px;
            color: #888;
            font-size: 14px;
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
        }
        .auth-back:hover {
            color: #666;
        }
        
        .error-msg { 
            background: #fee2e2; 
            color: #dc2626; 
            padding: 14px 16px; 
            border-radius: 12px; 
            margin-bottom: 16px; 
            font-size: 14px;
            line-height: 1.5;
        }
        .success-msg { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534; 
            padding: 24px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            font-size: 14px;
            line-height: 1.6;
            border: 2px solid #86efac;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }
        .success-msg strong {
            color: #15803d;
        }
        
        .tabs { display: flex; background: #f0f0f0; border-radius: 12px; padding: 4px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 10px; font-weight: 600; font-size: 15px; }
        .tab.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #a78bfa 100%); 
            color: white; 
            padding: 24px 20px; 
            padding-top: max(24px, calc(env(safe-area-inset-top) + 8px));
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            overflow: hidden;
        }
        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; }
        .header h1 { font-size: 22px; font-weight: 600; }
        .header p { font-size: 13px; opacity: 0.9; margin-top: 2px; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 44px; 
            height: 44px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        .header-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .header-btn:active { transform: scale(0.95); }
        
        /* Main Content */
        .main { 
            padding: 20px; 
            padding-top: 100px;
            padding-bottom: 100px; 
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Stats Grid */
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat { 
            background: white; 
            padding: 18px 16px; 
            border-radius: 16px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.08); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .stat:active { transform: scale(0.98); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 24px; font-weight: 800; color: #1a1a2e; }
        .stat-value.green { color: #16a34a; }
        .stat-value.red { color: #dc2626; }
        
        /* Quick Actions */
        .quick-actions { display: flex; gap: 12px; margin-bottom: 24px; }
        .quick-btn { 
            flex: 1; 
            padding: 16px; 
            border: none; 
            border-radius: 14px; 
            font-size: 15px; 
            font-weight: 600; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .quick-btn.primary { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
        }
        .quick-btn.primary:hover { 
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
            transform: translateY(-2px);
        }
        .quick-btn.secondary { 
            background: white; 
            color: #3b82f6; 
            border: 2px solid #e0e7ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .quick-btn.secondary:hover {
            border-color: #3b82f6;
            background: #f5f3ff;
        }
        .quick-btn:active { transform: scale(0.98) !important; }
        
        /* Section */
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .section-title { font-size: 18px; font-weight: 700; color: #333; }
        .section-link { color: #3b82f6; font-size: 14px; font-weight: 600; background: none; border: none; cursor: pointer; }
        
        /* Cards */
        .card { 
            background: white; 
            padding: 18px; 
            border-radius: 18px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.06); 
            margin-bottom: 12px;
            transition: all 0.2s ease;
            border: 1px solid #f0f0f5;
        }
        .card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-color: #e0e7ff;
        }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-weight: 700; font-size: 16px; color: #1a1a2e; }
        .card-desc { font-size: 14px; color: #64748b; margin-top: 3px; }
        .card-date { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        .card-amount { font-weight: 800; font-size: 20px; text-align: right; color: #1a1a2e; }
        
        .badge { 
            display: inline-block; 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge-paid { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
        .badge-pending { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #854d0e; }
        .badge-overdue { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; }
        
        .card-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
        .card-btn { 
            flex: 1; 
            min-width: 70px;
            padding: 11px 8px; 
            border: none; 
            border-radius: 10px; 
            font-size: 12px; 
            font-weight: 700; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.15s ease;
        }
        .card-btn:hover { transform: translateY(-1px); filter: brightness(0.95); }
        .card-btn:active { transform: scale(0.97); }
        .btn-pdf { background: #f3e8ff; color: #7c3aed; }
        .btn-whatsapp { background: #dcfce7; color: #16a34a; }
        .btn-sms { background: #fff7ed; color: #ea580c; }
        .btn-paylink { background: #dbeafe; color: #1d4ed8; }
        .btn-pay { background: #e0e7ff; color: #4f46e5; }
        .btn-edit { background: #f1f5f9; color: #475569; }
        
        /* Search & Filter */
        .search-box { 
            background: white; 
            border-radius: 14px; 
            padding: 4px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .search-input { 
            width: 100%; 
            padding: 14px 16px; 
            border: none; 
            font-size: 16px; 
            background: transparent;
            outline: none;
        }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
        .filter-tab { 
            padding: 10px 18px; 
            border: 2px solid #e5e7eb; 
            border-radius: 25px; 
            background: white; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            white-space: nowrap;
            color: #666;
        }
        .filter-tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        
        /* Menu Page */
        .menu-grid { display: flex; flex-direction: column; gap: 10px; }
        .menu-item { 
            background: white; 
            padding: 18px 20px; 
            border-radius: 16px; 
            display: flex; 
            align-items: center; 
            gap: 16px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f5;
            width: 100%;
            text-align: left;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .menu-item:hover { 
            border-color: #e0e7ff; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }
        .menu-item:active { transform: scale(0.99); }
        .menu-icon { 
            font-size: 24px; 
            width: 44px; 
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f5f3ff, #ede9fe);
            border-radius: 12px;
        }
        .menu-text { flex: 1; font-weight: 600; color: #1a1a2e; }
        .menu-arrow { color: #c7d2fe; font-size: 20px; font-weight: 700; }
        .menu-toggle { 
            width: 52px; 
            height: 30px; 
            border-radius: 15px; 
            background: #e5e7eb; 
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .menu-toggle.active { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .menu-toggle::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .menu-toggle.active::after { left: 24px; }
        
        .menu-section { 
            font-size: 12px; 
            color: #94a3b8; 
            padding: 24px 8px 12px; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Sub-pages */
        .subpage { display: none; }
        .subpage.active { display: block; }
        .back-btn { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            background: none; 
            border: none; 
            color: #3b82f6; 
            font-size: 16px; 
            font-weight: 600; 
            margin-bottom: 20px;
            cursor: pointer;
            padding: 8px 0;
        }
        
        /* Reports */
        .report-card { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .report-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .report-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .report-row:last-child { border-bottom: none; }
        .report-label { color: #666; }
        .report-value { font-weight: 700; }
        .report-value.green { color: #16a34a; }
        .report-value.red { color: #dc2626; }
        
        /* Chart */
        .chart-container { 
            background: white; 
            border-radius: 18px; 
            padding: 20px; 
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f5;
        }
        .chart-title { font-weight: 700; margin-bottom: 16px; font-size: 15px; color: #1a1a2e; }
        .bar-chart { display: flex; align-items: flex-end; gap: 10px; height: 100px; padding: 0 4px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; }
        .bar { 
            width: 100%; 
            border-radius: 8px 8px 4px 4px; 
            min-height: 4px; 
            background: linear-gradient(to top, #3b82f6, #2563eb);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .bar:hover { 
            filter: brightness(1.1);
            transform: scaleY(1.05);
            transform-origin: bottom;
        }
        .bar-label { font-size: 11px; color: #94a3b8; margin-top: 10px; font-weight: 600; }
        
        /* Bottom Navigation */
        .nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            display: flex; 
            border-top: 1px solid #f0f0f5;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .nav-item { 
            flex: 1; 
            padding: 12px 8px; 
            padding-bottom: 8px;
            text-align: center; 
            color: #94a3b8; 
            background: none; 
            border: none; 
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            border-radius: 0 0 4px 4px;
            transition: width 0.2s ease;
        }
        .nav-item.active::before { width: 40px; }
        .nav-item.active { color: #3b82f6; }
        .nav-item:active { transform: scale(0.95); }
        .nav-icon { font-size: 24px; }
        .nav-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
        
        /* Modal */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px);
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            z-index: 100;
            padding: 0;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-box { 
            background: white; 
            border-radius: 28px 28px 0 0; 
            width: 100%; 
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        .modal-header { 
            padding: 24px 24px 16px; 
            border-bottom: 1px solid #f0f0f5; 
            font-size: 20px; 
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
            z-index: 1;
        }
        .modal-close { background: none; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; line-height: 1; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; gap: 12px; }
        .modal-footer .btn { flex: 1; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #1a1a2e; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid #e5e7eb; 
            border-radius: 12px; 
            font-size: 16px; 
            transition: all 0.2s ease;
            background: #fafafa;
        }
        .form-input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        .form-input::placeholder { color: #94a3b8; }
        
        .btn { 
            padding: 16px 24px; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            width: 100%;
            transition: all 0.2s ease;
            /* iOS touch improvements */
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }
        .btn-primary:hover { box-shadow: 0 6px 16px rgba(59, 130, 246, 0.35); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        
        .empty { 
            text-align: center; 
            padding: 48px 24px; 
            color: #94a3b8;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 20px;
            border: 2px dashed #e2e8f0;
        }
        .empty-icon { font-size: 56px; margin-bottom: 16px; filter: grayscale(0.3); }
        
        .loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            font-size: 18px; 
            color: #666; 
        }
        .hidden { display: none !important; }
        
        /* Dark Mode */
        body.dark { background: #0f0f1a; }
        body.dark .header { background: linear-gradient(135deg, #4338ca, #6d28d9); }
        body.dark .stat, body.dark .card, body.dark .chart-container, body.dark .report-card, body.dark .menu-item, body.dark .search-box { 
            background: #1a1a2e; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
        }
        body.dark .stat-label, body.dark .card-desc, body.dark .card-date, body.dark .report-label, body.dark .bar-label { color: #666; }
        body.dark .stat-value, body.dark .card-name, body.dark .section-title, body.dark .chart-title, body.dark .report-title, body.dark .report-value, body.dark .menu-text { color: #eee; }
        body.dark .form-input, body.dark .search-input { background: #1a1a2e; border-color: #333; color: #eee; }
        body.dark .modal-box, body.dark .modal-header { background: #1a1a2e; }
        body.dark .modal-header, body.dark .modal-footer { border-color: #333; }
        body.dark .nav { background: #1a1a2e; border-color: #333; }
        body.dark .filter-tab { background: #1a1a2e; border-color: #333; color: #888; }
        body.dark .filter-tab.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        body.dark .quick-btn.secondary { background: #1a1a2e; border-color: #3b82f6; }
        body.dark .card-amount, body.dark .form-label { color: #eee; }
        body.dark .auth-container { background: #0f0f1a; }
        body.dark .auth-box { background: #1a1a2e; }
        body.dark .auth-title { color: #fff; }
        body.dark .auth-subtitle { color: #aaa; }
        body.dark .social-btn { background: #252538; border-color: #3a3a4e; color: #fff; }
        body.dark .social-btn:hover { background: #2a2a40; }
        body.dark .social-btn.apple-btn { background: #fff; color: #000; }
        body.dark .auth-divider { color: #666; }
        body.dark .auth-divider::before, body.dark .auth-divider::after { background: #3a3a4e; }
        body.dark .email-form .form-input { background: #252538; border-color: #3a3a4e; color: #fff; }
        body.dark .email-form .form-label { color: #ccc; }
        body.dark .auth-toggle { color: #888; }
        
        /* iOS PWA Specific Styles */
        body.ios-pwa {
            /* Extra padding for status bar in standalone mode */
            padding-top: max(env(safe-area-inset-top), 20px);
        }
        body.ios-pwa .header {
            /* Account for iOS status bar */
            padding-top: 8px;
        }
        body.standalone {
            /* Smooth iOS-like scrolling */
            scroll-behavior: smooth;
        }
        /* Prevent iOS rubber-banding on fixed elements */
        body.ios-pwa .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        body.dark .auth-back { color: #666; }
        body.dark .auth-title, body.dark .tab { color: #eee; }
        body.dark .tabs { background: #0f0f1a; }
        body.dark .tab.active { background: #1a1a2e; }
        body.dark .menu-toggle { background: #333; }
        body.dark .btn-secondary { background: #333; color: #eee; }

        /* AI Chat */
        .ai-modal .modal-box { 
            height: 85vh; 
            display: flex; 
            flex-direction: column; 
            background: linear-gradient(180deg, #faf5ff 0%, #f5f3ff 50%, white 100%);
        }
        .ai-modal .modal-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-radius: 28px 28px 0 0;
        }
        .ai-modal .modal-close { color: white; }
        .ai-messages { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-msg { margin-bottom: 16px; display: flex; animation: msgFadeIn 0.3s ease; }
        @keyframes msgFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ai-msg.user { justify-content: flex-end; }
        .ai-bubble { 
            max-width: 85%; 
            padding: 14px 18px; 
            border-radius: 20px; 
            font-size: 15px; 
            line-height: 1.5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .ai-msg.assistant .ai-bubble { 
            background: white; 
            color: #1a1a2e; 
            border-bottom-left-radius: 6px;
            border: 1px solid #f0f0f5;
        }
        .ai-msg.user .ai-bubble { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        body.dark .ai-modal .modal-box { background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%); }
        body.dark .ai-msg.assistant .ai-bubble { background: #2a2a3e; color: #eee; border-color: #3a3a4e; }
        .ai-input-area { 
            padding: 16px; 
            border-top: 1px solid #e0e7ff; 
            display: flex; 
            gap: 10px;
            background: white;
        }
        body.dark .ai-input-area { border-color: #333; background: #1a1a2e; }
        .ai-input { 
            flex: 1; 
            padding: 14px 18px; 
            border: 2px solid #e0e7ff; 
            border-radius: 25px; 
            font-size: 16px; 
            outline: none;
            background: #fafafa;
            transition: all 0.2s ease;
        }
        .ai-input:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .ai-send { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white; 
            border: none; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }
        .ai-send:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4); }
        .ai-send:active { transform: scale(0.95); }
        .typing { display: flex; gap: 5px; padding: 14px 18px; }
        .typing span { width: 10px; height: 10px; background: #c7d2fe; border-radius: 50%; animation: bounce 1.4s infinite; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-8px); } }

        /* Customer Card */
        .customer-card { 
            background: white; 
            padding: 18px; 
            border-radius: 18px; 
            margin-bottom: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f5;
            transition: all 0.2s ease;
        }
        .customer-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-color: #e0e7ff;
        }
        body.dark .customer-card { background: #1a1a2e; border-color: #2a2a3e; }
        .customer-info { display: flex; justify-content: space-between; align-items: center; }
        .customer-name { font-weight: 700; font-size: 16px; color: #1a1a2e; }
        .customer-phone { font-size: 13px; color: #64748b; margin-top: 3px; }
        .customer-balance { font-weight: 800; font-size: 16px; }
        .customer-actions { display: flex; gap: 8px; margin-top: 14px; }

        /* Recurring Badge */
        .recurring-badge { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            color: #1d4ed8; 
            font-size: 10px; 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Payment History */
        .payment-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 14px 0; 
            border-bottom: 1px solid #f0f0f5; 
        }
        .payment-item:last-child { border-bottom: none; }
        .payment-date { color: #64748b; font-size: 14px; }
        .payment-amount { font-weight: 800; color: #16a34a; }

        /* ========== ANIMATIONS & POLISH ========== */
        
        /* Smooth page transitions */
        .main {
            animation: fadeInUp 0.3s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card entrance animation */
        .card, .stat, .menu-item, .customer-card {
            animation: cardFadeIn 0.4s ease backwards;
        }
        .card:nth-child(1), .stat:nth-child(1), .menu-item:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2), .stat:nth-child(2), .menu-item:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3), .stat:nth-child(3), .menu-item:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4), .stat:nth-child(4), .menu-item:nth-child(4) { animation-delay: 0.2s; }
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Page Transitions */
        .main { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Stagger Animation */
        .card, .customer-card, .menu-item, .stat, .report-card {
            animation: cardSlideIn 0.4s ease-out backwards;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:nth-child(1), .stat:nth-child(1), .menu-item:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2), .stat:nth-child(2), .menu-item:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3), .stat:nth-child(3), .menu-item:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4), .stat:nth-child(4), .menu-item:nth-child(4) { animation-delay: 0.2s; }
        .card:nth-child(5), .menu-item:nth-child(5) { animation-delay: 0.25s; }
        .card:nth-child(6), .menu-item:nth-child(6) { animation-delay: 0.3s; }
        @keyframes cardSlideIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Card Hover/Press Effects */
        .card:hover, .customer-card:hover, .menu-item:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15); 
        }
        .card:active, .customer-card:active { 
            transform: scale(0.98); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
        }
        
        /* Button Micro-interactions */
        .btn, .quick-btn, .card-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn:hover, .quick-btn:hover { transform: translateY(-1px); }
        .btn:active, .quick-btn:active { 
            transform: scale(0.96); 
            transition: transform 0.1s;
        }
        .card-btn:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card-btn:active { 
            transform: scale(0.94); 
            transition: transform 0.1s;
        }
        
        /* Ripple Effect */
        .btn::after, .quick-btn::after, .card-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn:active::after, .quick-btn:active::after, .card-btn:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }
        
        /* Header Animation */
        .header {
            animation: headerSlide 0.5s ease-out;
        }
        @keyframes headerSlide {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        .header h1 {
            animation: logoPopIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.2s backwards;
        }
        @keyframes logoPopIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Bottom Nav Animation */
        .nav {
            animation: navSlideUp 0.4s ease-out 0.3s backwards;
        }
        @keyframes navSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .nav-item {
            transition: all 0.2s ease;
        }
        .nav-item:active {
            transform: scale(0.9);
        }
        .nav-item.active .nav-icon {
            animation: navIconBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes navIconBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Modal Animation */
        .modal {
            animation: modalFadeIn 0.3s ease-out;
        }
        @keyframes modalFadeIn {
            from { background: rgba(0,0,0,0); }
            to { background: rgba(0,0,0,0.5); }
        }
        .modal-box {
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Input Focus Animation */
        .form-input, .search-input, .ai-input {
            transition: all 0.2s ease;
        }
        .form-input:focus, .search-input:focus, .ai-input:focus {
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Badge Pulse for Overdue */
        .badge-overdue {
            animation: pulseBadge 2s infinite;
        }
        @keyframes pulseBadge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Stats Counter Animation */
        .stat-value {
            animation: countUp 0.6s ease-out;
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Filter Tab Animation */
        .filter-tab {
            transition: all 0.2s ease;
        }
        .filter-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .filter-tab.active {
            animation: filterPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes filterPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        body.dark .skeleton {
            background: linear-gradient(90deg, #1a1a2e 25%, #252540 50%, #1a1a2e 75%);
            background-size: 200% 100%;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 14px 24px;
            border-radius: 30px;
            font-weight: 500;
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { background: linear-gradient(135deg, #16a34a, #22c55e); }
        .toast.error { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        
        /* Auto Reminder Prompt */
        .auto-reminder-prompt {
            position: fixed;
            bottom: 90px;
            left: 16px;
            right: 16px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            animation: slideUp 0.3s ease;
        }
        body.dark .auto-reminder-prompt {
            background: #1a1a2e;
        }
        body.dark .auto-reminder-prompt div {
            color: #eee;
        }
        
        /* Customer Portal Styles */
        .portal-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            padding: 0;
        }
        .portal-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 32px 20px;
            text-align: center;
        }
        .portal-business {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .portal-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .portal-customer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: white;
            margin: -20px 16px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .portal-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
        }
        .portal-name {
            font-size: 18px;
            font-weight: 700;
        }
        .portal-phone {
            font-size: 14px;
            color: #666;
        }
        .portal-balance {
            margin: 0 16px 16px;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
        }
        .portal-balance.has-balance {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
        }
        .portal-balance.clear {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
        }
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }
        .balance-amount {
            font-size: 36px;
            font-weight: 700;
        }
        .balance-detail {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }
        .portal-pay-all {
            display: block;
            width: calc(100% - 32px);
            margin: 0 16px 20px;
            padding: 16px;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
        }
        .portal-section {
            padding: 0 16px 16px;
        }
        .portal-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        .portal-invoice {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .portal-invoice.paid {
            opacity: 0.8;
        }
        .portal-inv-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .portal-inv-number {
            font-weight: 700;
            color: #3b82f6;
            font-size: 14px;
        }
        .portal-inv-desc {
            font-size: 15px;
            color: #333;
            margin-top: 4px;
        }
        .portal-inv-due {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }
        .portal-inv-due.overdue {
            color: #dc2626;
            font-weight: 600;
        }
        .portal-inv-paid-date {
            font-size: 12px;
            color: #16a34a;
            margin-top: 4px;
        }
        .portal-inv-amount {
            font-size: 20px;
            font-weight: 700;
            color: #dc2626;
        }
        .portal-inv-amount.paid {
            color: #16a34a;
        }
        .portal-inv-actions {
            display: flex;
            gap: 8px;
        }
        .portal-btn-view, .portal-btn-receipt {
            flex: 1;
            padding: 10px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .portal-btn-bank {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .portal-btn-pay {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .portal-payments {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        .portal-payment {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .portal-payment:last-child {
            border-bottom: none;
        }
        .portal-pay-date {
            font-weight: 600;
            font-size: 14px;
        }
        .portal-pay-ref {
            font-size: 12px;
            color: #888;
        }
        .portal-pay-amount {
            font-weight: 700;
            color: #16a34a;
        }
        .portal-contact {
            padding: 20px 16px;
            text-align: center;
        }
        .portal-contact-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #666;
        }
        .portal-contact-btn {
            display: inline-block;
            padding: 12px 20px;
            margin: 4px;
            background: white;
            border-radius: 25px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .portal-contact-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        .portal-footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 13px;
        }
        .portal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .portal-modal-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
        }
        .portal-modal-box {
            position: relative;
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        .portal-modal-btn {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
            color: #333;
        }
        .portal-modal-btn.whatsapp {
            background: #25d366;
            color: white;
        }
        .portal-modal-btn.close {
            background: #f0f0f0;
            color: #666;
        }
        
        /* Empty State Animation */
        .empty {
            animation: emptyFadeIn 0.5s ease-out;
        }
        .empty-icon {
            animation: emptyBounce 2s ease-in-out infinite;
        }
        @keyframes emptyFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes emptyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Auth Box Animation */
        .auth-box {
            animation: authPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes authPopIn {
            from { opacity: 0; transform: scale(0.8) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Smooth scrolling */
        html { scroll-behavior: smooth; }
        
        /* Selection color */
        ::selection { background: #3b82f6; color: white; }
        
        /* Focus ring for accessibility */
        *:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* AI Features */
        .ai-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            cursor: pointer;
            z-index: 100;
            animation: pulse-ai 2s infinite;
        }
        @keyframes pulse-ai {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .ai-fab:active { transform: scale(0.95); }

        .ai-insights {
            background: linear-gradient(135deg, #ede9fe, #e0e7ff);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #c4b5fd;
        }
        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 12px;
        }
        .ai-insight-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.5;
            border-left: 3px solid #8b5cf6;
        }
        .ai-insight-item:last-child { margin-bottom: 0; }
        .ai-insight-action {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }
        .ai-insight-action:active {
            transform: scale(0.95);
        }

        .ai-chat-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .ai-chat-box {
            background: white;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .ai-chat-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ai-chat-title {
            font-weight: 700;
            font-size: 18px;
        }
        .ai-chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            min-height: 200px;
            max-height: 50vh;
        }
        .ai-message {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
        }
        .ai-message.user { flex-direction: row-reverse; }
        .ai-message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        .ai-message.assistant .ai-message-bubble {
            background: #f3f4f6;
            border-bottom-left-radius: 4px;
        }
        .ai-message.user .ai-message-bubble {
            background: #8b5cf6;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        .ai-message.assistant .ai-message-avatar { background: #ede9fe; }
        .ai-message.user .ai-message-avatar { background: #ddd6fe; }
        .ai-chat-input-area {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        .ai-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
        }
        .ai-chat-input:focus { border-color: #8b5cf6; }
        .ai-chat-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        .ai-chat-send:disabled { opacity: 0.5; }
        .ai-voice-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            font-size: 20px;
            cursor: pointer;
        }
        .ai-voice-btn.recording {
            background: #fee2e2;
            border-color: #dc2626;
            animation: pulse-record 1s infinite;
        }
        @keyframes pulse-record {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0 16px 16px;
        }
        .ai-suggestion {
            padding: 8px 14px;
            background: #ede9fe;
            color: #6366f1;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }
        .ai-typing {
            display: flex;
            gap: 4px;
            padding: 8px;
        }
        .ai-typing span {
            width: 8px;
            height: 8px;
            background: #8b5cf6;
            border-radius: 50%;
            animation: typing 1s infinite;
        }
        .ai-typing span:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .ai-invoice-preview {
            background: #f0fdf4;
            border: 2px solid #16a34a;
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        .ai-invoice-preview h4 {
            color: #166534;
            margin: 0 0 12px;
            font-size: 14px;
        }
        .ai-invoice-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 13px;
        }
        .ai-invoice-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .ai-invoice-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .ai-btn-create { background: #16a34a; color: white; }
        .ai-btn-edit { background: #e5e7eb; color: #374151; }
    </style>
    <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body>
    <div id="app"></div>

    <script>
        // ========== CONFIG ==========
        const SUPABASE_URL = 'https://djqmtzqnwklwnvlqlejj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcW10enFud2tsd252bHFsZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzk4OTMsImV4cCI6MjA3OTY1NTg5M30.7zCs844TQdocVDeB7fXc1uIziiGxoiGNLYFyxXf7ZJ8';
        
        // Paystack key for Owo Mi subscription payments (change to pk_live_... for production)
        const OWOMI_PAYSTACK_KEY = 'pk_test_23e4f1eee82d5e72d9ea42fe615e7c10da8c6bb7';

        // ========== STATE ==========
        let state = {
            user: null,
            businessId: null,
            customers: [],
            invoices: [],
            quotes: [],
            products: [],
            expenses: [],
            activeTab: 'home',
            menuPage: null,
            loading: true,
            searchQuery: '',
            filterStatus: 'all',
            businessProfile: {},
            paymentHistory: [],
            recurringTemplates: [],
            reminderSettings: null,
            reminderHistory: [],
            invoiceTemplate: { color: '#3b82f6', style: 'modern' },
            currentSection: 'landing',
            authMode: 'login',
            onboardingStep: 1,
            // Subscription
            subscription: null,
            plans: []
        };

        // ========== SUPABASE DATABASE LAYER ==========
        const db = {
            // Generic fetch with auth header
            async fetch(endpoint, options = {}) {
                const session = getSession();
                const headers = {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${session?.access_token || SUPABASE_KEY}`
                };
                
                console.log('DB fetch:', endpoint);
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('DB error:', response.status, errorText);
                    try {
                        const error = JSON.parse(errorText);
                        throw new Error(error.message || error.error || 'Database error');
                    } catch (e) {
                        throw new Error(errorText || 'Database error');
                    }
                }
                
                const text = await response.text();
                return text ? JSON.parse(text) : null;
            },

            // Get current user's business
            async getBusiness() {
                const data = await this.fetch('businesses?select=*&limit=1');
                return data?.[0] || null;
            },

            // Create business (for new users if trigger didn't work)
            async createBusiness() {
                const session = getSession();
                if (!session?.user?.id) return null;
                
                const data = await this.fetch('businesses', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ 
                        user_id: session.user.id,
                        email: session.user.email || '',
                        name: ''
                    })
                });
                const business = data?.[0];
                if (business) {
                    state.businessId = business.id;
                }
                return business;
            },

            // Update business profile
            async updateBusiness(updates) {
                // If no businessId, try to create one first
                if (!state.businessId) {
                    const business = await this.getBusiness();
                    if (business) {
                        state.businessId = business.id;
                    } else {
                        // Create new business
                        const newBusiness = await this.createBusiness();
                        if (!newBusiness) return null;
                    }
                }
                
                await this.fetch(`businesses?id=eq.${state.businessId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
                return true;
            },

            // ===== CUSTOMERS =====
            async getCustomers() {
                return await this.fetch('customers?select=*&order=created_at.desc') || [];
            },

            async createCustomer(customer) {
                const data = await this.fetch('customers', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...customer, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateCustomer(id, updates) {
                await this.fetch(`customers?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteCustomer(id) {
                await this.fetch(`customers?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== INVOICES =====
            async getInvoices() {
                return await this.fetch('invoices?select=*&order=created_at.desc') || [];
            },

            async createInvoice(invoice) {
                const data = await this.fetch('invoices', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...invoice, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateInvoice(id, updates) {
                await this.fetch(`invoices?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteInvoice(id) {
                await this.fetch(`invoices?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== QUOTES =====
            async getQuotes() {
                return await this.fetch('quotes?select=*&order=created_at.desc') || [];
            },

            async createQuote(quote) {
                const data = await this.fetch('quotes', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...quote, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateQuote(id, updates) {
                await this.fetch(`quotes?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteQuote(id) {
                await this.fetch(`quotes?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== PRODUCTS =====
            async getProducts() {
                return await this.fetch('products?select=*&order=name.asc') || [];
            },

            async createProduct(product) {
                const data = await this.fetch('products', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...product, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateProduct(id, updates) {
                await this.fetch(`products?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteProduct(id) {
                await this.fetch(`products?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== EXPENSES =====
            async getExpenses() {
                return await this.fetch('expenses?select=*&order=date.desc') || [];
            },

            async createExpense(expense) {
                const data = await this.fetch('expenses', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...expense, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateExpense(id, updates) {
                await this.fetch(`expenses?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteExpense(id) {
                await this.fetch(`expenses?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== PAYMENTS =====
            async getPayments() {
                return await this.fetch('payments?select=*&order=date.desc') || [];
            },

            async createPayment(payment) {
                const data = await this.fetch('payments', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...payment, business_id: state.businessId })
                });
                return data?.[0];
            },

            // ===== RECURRING TEMPLATES =====
            async getRecurringTemplates() {
                return await this.fetch('recurring_templates?select=*&order=created_at.desc') || [];
            },

            async createRecurringTemplate(template) {
                const data = await this.fetch('recurring_templates', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...template, business_id: state.businessId })
                });
                return data?.[0];
            },

            async updateRecurringTemplate(id, updates) {
                await this.fetch(`recurring_templates?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updates)
                });
            },

            async deleteRecurringTemplate(id) {
                await this.fetch(`recurring_templates?id=eq.${id}`, { method: 'DELETE' });
            },

            // ===== REMINDER SETTINGS =====
            async getReminderSettings() {
                const data = await this.fetch('reminder_settings?select=*&limit=1');
                return data?.[0] || null;
            },

            async upsertReminderSettings(settings) {
                // Try update first, then insert
                if (state.reminderSettings?.id) {
                    await this.fetch(`reminder_settings?id=eq.${state.reminderSettings.id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(settings)
                    });
                } else {
                    const data = await this.fetch('reminder_settings', {
                        method: 'POST',
                        headers: { 'Prefer': 'return=representation' },
                        body: JSON.stringify({ ...settings, business_id: state.businessId })
                    });
                    return data?.[0];
                }
            },

            // ===== REMINDER HISTORY =====
            async getReminderHistory() {
                return await this.fetch('reminder_history?select=*&order=sent_at.desc&limit=50') || [];
            },

            async createReminderHistory(entry) {
                const data = await this.fetch('reminder_history', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({ ...entry, business_id: state.businessId })
                });
                return data?.[0];
            },

            async clearReminderHistory() {
                await this.fetch('reminder_history', { method: 'DELETE' });
            },

            // ===== SUBSCRIPTIONS =====
            async getPlans() {
                return await this.fetch('subscription_plans?is_active=eq.true&order=sort_order.asc') || [];
            },

            async getSubscription() {
                const data = await this.fetch('user_subscriptions?select=*,plan:subscription_plans(*)&limit=1');
                return data?.[0] || null;
            },

            async updateSubscription(updates) {
                if (!state.subscription?.id) return null;
                await this.fetch(`user_subscriptions?id=eq.${state.subscription.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ ...updates, updated_at: new Date().toISOString() })
                });
                return true;
            },

            async createSubscription(planId) {
                const data = await this.fetch('user_subscriptions', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        business_id: state.businessId,
                        plan_id: planId,
                        status: 'active',
                        current_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                    })
                });
                return data?.[0];
            },

            async recordPayment(payment) {
                const data = await this.fetch('subscription_payments', {
                    method: 'POST',
                    headers: { 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        business_id: state.businessId,
                        subscription_id: state.subscription?.id,
                        ...payment
                    })
                });
                return data?.[0];
            },

            async getPaymentHistory() {
                return await this.fetch('subscription_payments?order=created_at.desc&limit=20') || [];
            },

            async incrementUsage(type) {
                // Increment usage counters
                if (!state.subscription?.id) return;
                const field = type === 'invoice' ? 'invoices_this_month' : 
                              type === 'quote' ? 'quotes_this_month' :
                              type === 'sms' ? 'sms_this_month' :
                              type === 'ai' ? 'ai_chats_today' : null;
                if (!field) return;
                
                const current = state.subscription[field] || 0;
                await this.fetch(`user_subscriptions?id=eq.${state.subscription.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ [field]: current + 1 })
                });
                state.subscription[field] = current + 1;
            },

            // ===== LOAD ALL DATA =====
            async loadAllData() {
                try {
                    console.log('Loading all data...');
                    const [business, customers, invoices, quotes, products, expenses, payments, recurring, reminderSettings, reminderHistory, subscription, plans] = await Promise.all([
                        this.getBusiness().catch(e => { console.error('getBusiness error:', e); return null; }),
                        this.getCustomers().catch(e => { console.error('getCustomers error:', e); return []; }),
                        this.getInvoices().catch(e => { console.error('getInvoices error:', e); return []; }),
                        this.getQuotes().catch(e => { console.error('getQuotes error:', e); return []; }),
                        this.getProducts().catch(e => { console.error('getProducts error:', e); return []; }),
                        this.getExpenses().catch(e => { console.error('getExpenses error:', e); return []; }),
                        this.getPayments().catch(e => { console.error('getPayments error:', e); return []; }),
                        this.getRecurringTemplates().catch(e => { console.error('getRecurring error:', e); return []; }),
                        this.getReminderSettings().catch(e => { console.error('getReminderSettings error:', e); return null; }),
                        this.getReminderHistory().catch(e => { console.error('getReminderHistory error:', e); return []; }),
                        this.getSubscription().catch(e => { console.error('getSubscription error:', e); return null; }),
                        this.getPlans().catch(e => { console.error('getPlans error:', e); return []; })
                    ]);
                    
                    console.log('Data loaded:', { business, customers: customers?.length, invoices: invoices?.length, subscription });

                    if (business) {
                        state.businessId = business.id;
                        state.businessProfile = {
                            name: business.name || '',
                            phone: business.phone || '',
                            email: business.email || '',
                            address: business.address || '',
                            bank: business.bank_details || '',
                            bankName: business.bank_name || '',
                            accountNumber: business.account_number || '',
                            accountName: business.account_name || '',
                            logo: business.logo_url || '',
                            qrCode: business.qr_code_url || '',
                            footerNote: business.footer_note || '',
                            termsAndConditions: business.terms_and_conditions || '',
                            paystackEnabled: business.paystack_enabled || false,
                            paystackPublicKey: business.paystack_public_key || ''
                        };
                        state.invoiceTemplate = {
                            color: business.invoice_color || '#3b82f6',
                            style: business.invoice_style || 'modern'
                        };
                        
                        // Check if onboarded
                        if (!business.onboarded) {
                            state.currentSection = 'onboarding';
                        } else {
                            state.currentSection = 'app';
                        }
                    } else {
                        // No business record - new user, go to onboarding
                        console.log('No business record found, going to onboarding');
                        state.currentSection = 'onboarding';
                        state.businessProfile = {};
                    }

                    // Map database fields to app format
                    state.customers = customers.map(c => ({
                        id: c.id,
                        name: c.name,
                        phone: c.phone || '',
                        email: c.email || ''
                    }));

                    state.invoices = invoices.map(i => ({
                        id: i.id,
                        invoice_number: i.invoice_number,
                        customer_id: i.customer_id,
                        description: i.description,
                        items: i.items || [],
                        amount: parseFloat(i.amount) || 0,
                        amount_paid: parseFloat(i.amount_paid) || 0,
                        discount: parseFloat(i.discount) || 0,
                        discount_type: i.discount_type || 'percent',
                        include_vat: i.include_vat || false,
                        vat: parseFloat(i.vat_amount) || 0,
                        due_date: i.due_date,
                        created_at: i.created_at
                    }));

                    state.quotes = quotes.map(q => ({
                        id: q.id,
                        quote_number: q.quote_number,
                        customer_id: q.customer_id,
                        description: q.description,
                        items: q.items || [],
                        amount: parseFloat(q.amount) || 0,
                        discount: parseFloat(q.discount) || 0,
                        discount_type: q.discount_type || 'percent',
                        include_vat: q.include_vat || false,
                        vat: parseFloat(q.vat_amount) || 0,
                        valid_days: q.valid_days || 30,
                        status: q.status || 'pending',
                        created_at: q.created_at
                    }));

                    state.products = products.map(p => ({
                        id: p.id,
                        name: p.name,
                        price: parseFloat(p.price) || 0,
                        description: p.description || '',
                        unit: p.unit || 'item'
                    }));

                    state.expenses = expenses.map(e => ({
                        id: e.id,
                        description: e.description,
                        amount: parseFloat(e.amount) || 0,
                        category: e.category || '',
                        date: e.date,
                        vendor: e.vendor || ''
                    }));

                    state.paymentHistory = payments.map(p => ({
                        id: p.id,
                        invoiceId: p.invoice_id,
                        customerId: p.customer_id,
                        amount: parseFloat(p.amount) || 0,
                        method: p.method || 'transfer',
                        reference: p.reference || '',
                        notes: p.notes || '',
                        date: p.date
                    }));

                    state.recurringTemplates = recurring.map(r => ({
                        id: r.id,
                        customer_id: r.customer_id,
                        description: r.description,
                        items: r.items || [],
                        amount: parseFloat(r.amount) || 0,
                        frequency: r.frequency || 'monthly',
                        next_date: r.next_date,
                        active: r.active,
                        last_generated: r.last_generated
                    }));

                    state.reminderSettings = reminderSettings ? {
                        id: reminderSettings.id,
                        enabled: reminderSettings.enabled,
                        before_due_days: reminderSettings.before_due_days,
                        on_due_date: reminderSettings.on_due_date,
                        after_due_days: reminderSettings.after_due_days,
                        channel: reminderSettings.channel
                    } : { enabled: false, before_due_days: 3, on_due_date: true, after_due_days: [3, 7], channel: 'whatsapp' };

                    state.reminderHistory = (reminderHistory || []).map(h => ({
                        id: h.id,
                        invoiceId: h.invoice_id,
                        type: h.type,
                        channel: h.channel,
                        status: h.status,
                        sentAt: h.sent_at
                    }));
                    
                    // Also load from localStorage as backup/merge
                    const localHistory = JSON.parse(localStorage.getItem('owomi_reminder_history') || '[]');
                    if (localHistory.length > 0 && state.reminderHistory.length === 0) {
                        state.reminderHistory = localHistory;
                    }

                    // Subscription data
                    state.plans = plans || [];
                    state.subscription = subscription ? {
                        id: subscription.id,
                        planId: subscription.plan_id,
                        plan: subscription.plan,
                        status: subscription.status,
                        billingCycle: subscription.billing_cycle,
                        currentPeriodEnd: subscription.current_period_end,
                        invoices_this_month: subscription.invoices_this_month || 0,
                        quotes_this_month: subscription.quotes_this_month || 0,
                        sms_this_month: subscription.sms_this_month || 0,
                        ai_chats_today: subscription.ai_chats_today || 0,
                        paystackSubscriptionCode: subscription.paystack_subscription_code
                    } : null;

                    return true;
                } catch (err) {
                    console.error('Failed to load data:', err);
                    return false;
                }
            }
        };

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(message, type = 'info', duration = 3000) {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Add icon based on type
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                info: 'â„¹'
            };
            toast.innerHTML = `<span style="font-size:18px;">${icons[type] || icons.info}</span> ${message}`;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        // ========== SUBSCRIPTION HELPERS ==========
        function getPlanLimit(limitType) {
            const plan = state.subscription?.plan;
            if (!plan) return 5; // Default free limits
            
            const limits = {
                customers: plan.max_customers,
                invoices: plan.max_invoices_per_month,
                quotes: plan.max_quotes_per_month,
                products: plan.max_products,
                recurring: plan.max_recurring_templates,
                sms: plan.max_sms_per_month,
                ai: plan.max_ai_chats_per_day
            };
            return limits[limitType] ?? 0;
        }

        function getCurrentUsage(limitType) {
            switch (limitType) {
                case 'customers': return state.customers.length;
                case 'invoices': return state.subscription?.invoices_this_month || 0;
                case 'quotes': return state.subscription?.quotes_this_month || 0;
                case 'products': return state.products.length;
                case 'recurring': return state.recurringTemplates.length;
                case 'sms': return state.subscription?.sms_this_month || 0;
                case 'ai': return state.subscription?.ai_chats_today || 0;
                default: return 0;
            }
        }

        function canDoAction(limitType) {
            const limit = getPlanLimit(limitType);
            if (limit === -1) return true; // Unlimited
            const usage = getCurrentUsage(limitType);
            return usage < limit;
        }

        function hasFeature(featureName) {
            const plan = state.subscription?.plan;
            if (!plan) return false;
            
            const features = {
                expense_tracking: plan.has_expense_tracking,
                auto_reminders: plan.has_auto_reminders,
                customer_portal: plan.has_customer_portal,
                paystack: plan.has_paystack_integration,
                multiple_templates: plan.has_multiple_templates,
                custom_colors: plan.has_custom_colors,
                logo: plan.has_logo_upload,
                remove_branding: plan.has_remove_branding,
                reports_export: plan.has_reports_export,
                priority_support: plan.has_priority_support
            };
            return features[featureName] ?? false;
        }

        function showUpgradeModal(reason = '') {
            const plans = state.plans.filter(p => p.name !== 'free');
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-width: 600px;">
                        <div class="modal-header">
                            <span>ðŸš€ Upgrade Your Plan</span>
                            <button class="modal-close" id="modal-close">Ã—</button>
                        </div>
                        <div class="modal-body">
                            ${reason ? `<p style="color:#dc2626;margin-bottom:16px;padding:12px;background:#fee2e2;border-radius:8px;">âš ï¸ ${reason}</p>` : ''}
                            
                            <div style="display:grid;gap:16px;">
                                ${plans.map(plan => `
                                    <div style="border:2px solid ${plan.name === 'pro' ? '#3b82f6' : '#e5e5e5'};border-radius:16px;padding:20px;${plan.name === 'pro' ? 'background:linear-gradient(135deg,#eff6ff,#fff);' : ''}">
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                            <div>
                                                <h3 style="margin:0;font-size:20px;">${plan.display_name}</h3>
                                                <p style="margin:4px 0 0;color:#666;font-size:14px;">
                                                    ${plan.name === 'starter' ? 'For freelancers & small shops' : 'For growing businesses'}
                                                </p>
                                            </div>
                                            <div style="text-align:right;">
                                                <div style="font-size:24px;font-weight:700;">â‚¦${plan.price_monthly.toLocaleString()}</div>
                                                <div style="color:#666;font-size:12px;">/month</div>
                                            </div>
                                        </div>
                                        
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0;font-size:13px;">
                                            <div>âœ“ ${plan.max_customers === -1 ? 'Unlimited' : plan.max_customers} customers</div>
                                            <div>âœ“ ${plan.max_invoices_per_month === -1 ? 'Unlimited' : plan.max_invoices_per_month} invoices/mo</div>
                                            <div>âœ“ ${plan.max_sms_per_month === -1 ? 'Unlimited' : plan.max_sms_per_month} SMS/mo</div>
                                            <div>âœ“ ${plan.has_auto_reminders ? 'Auto reminders' : 'â€”'}</div>
                                            <div>âœ“ ${plan.has_expense_tracking ? 'Expense tracking' : 'â€”'}</div>
                                            <div>âœ“ ${plan.has_customer_portal ? 'Customer portal' : 'â€”'}</div>
                                        </div>
                                        
                                        <button class="btn btn-primary upgrade-btn" data-plan="${plan.name}" data-price="${plan.price_monthly}" style="width:100%;padding:14px;font-size:16px;${plan.name === 'pro' ? 'background:linear-gradient(135deg,#3b82f6,#8b5cf6);' : ''}">
                                            Upgrade to ${plan.display_name} â†’
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <p style="text-align:center;color:#666;margin-top:16px;font-size:13px;">
                                ðŸ’³ Secure payment via Paystack â€¢ Cancel anytime
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            
            document.querySelectorAll('.upgrade-btn').forEach(btn => {
                btn.onclick = async () => {
                    const planName = btn.dataset.plan;
                    const price = parseInt(btn.dataset.price);
                    console.log('Upgrade clicked:', planName, price);
                    btn.textContent = 'Processing...';
                    btn.disabled = true;
                    try {
                        await initiatePaystackSubscription(planName, price);
                    } catch (err) {
                        console.error('Payment error:', err);
                        showToast('Payment failed: ' + err.message, 'error');
                    }
                    btn.textContent = `Upgrade to ${planName === 'starter' ? 'Starter' : 'Pro'} â†’`;
                    btn.disabled = false;
                };
            });
        }

        async function initiatePaystackSubscription(planName, amount) {
            console.log('Initiating payment:', planName, amount);
            
            const email = state.user?.email || state.businessProfile?.email;
            console.log('User email:', email);
            
            if (!email) {
                showToast('Please set your email first', 'error');
                return;
            }
            
            // Check if Paystack is loaded
            if (typeof PaystackPop === 'undefined') {
                showToast('Payment system loading... please try again', 'error');
                console.error('PaystackPop not loaded');
                return;
            }
            
            console.log('Opening Paystack popup...');
            
            try {
                // Use Paystack inline
                const handler = PaystackPop.setup({
                    key: OWOMI_PAYSTACK_KEY, // Owo Mi subscription payments
                    email: email,
                    amount: amount * 100, // Kobo
                    currency: 'NGN',
                    ref: 'OWO-' + Date.now(),
                    metadata: {
                        business_id: state.businessId,
                        plan: planName,
                        type: 'subscription'
                    },
                    callback: function(response) {
                        console.log('Payment success:', response);
                        
                        // Record payment and upgrade plan
                        const plan = state.plans.find(p => p.name === planName);
                        if (plan) {
                            // Handle async operations
                            (async () => {
                                try {
                                    // Record payment
                                    await db.recordPayment({
                                        amount: amount,
                                        status: 'success',
                                        paystack_reference: response.reference,
                                        paystack_transaction_id: response.transaction,
                                        payment_method: 'card',
                                        description: `Upgrade to ${plan.display_name}`
                                    });
                                    
                                    // Update subscription
                                    await db.updateSubscription({
                                        plan_id: plan.id,
                                        status: 'active',
                                        current_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
                                    });
                                    
                                    // Reload data
                                    await db.loadAllData();
                                    closeModal();
                                    showToast(`ðŸŽ‰ Welcome to ${plan.display_name}!`, 'success');
                                    render();
                                } catch (err) {
                                    console.error('Upgrade error:', err);
                                    showToast('Payment received but upgrade failed. Contact support.', 'error');
                                }
                            })();
                        }
                    },
                    onClose: function() {
                        console.log('Payment window closed');
                    }
                });
                handler.openIframe();
            } catch (err) {
                console.error('Paystack error:', err);
                showToast('Payment failed to initialize: ' + err.message, 'error');
            }
        }

        function formatPlanLimit(value) {
            if (value === -1) return 'Unlimited';
            return value.toLocaleString();
        }

        // ========== LOGO & TEMPLATE FUNCTIONS ==========
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (500KB max)
            if (file.size > 500 * 1024) {
                showToast('Logo must be under 500KB', 'error');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                state.businessProfile.logo = base64;
                localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
                
                // Update preview
                const preview = document.getElementById('logo-preview');
                if (preview) {
                    preview.innerHTML = `<img src="${base64}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
                }
                
                showToast('Logo uploaded!', 'success');
                render();
            };
            reader.readAsDataURL(file);
        }
        
        function removeLogo() {
            delete state.businessProfile.logo;
            localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
            showToast('Logo removed', 'info');
            render();
        }
        
        function handleQRUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (500KB max)
            if (file.size > 500 * 1024) {
                showToast('QR code must be under 500KB', 'error');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                state.businessProfile.paymentQR = base64;
                localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
                
                // Update preview
                const preview = document.getElementById('qr-preview');
                if (preview) {
                    preview.innerHTML = `<img src="${base64}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
                }
                
                showToast('Payment QR uploaded!', 'success');
                render();
            };
            reader.readAsDataURL(file);
        }
        
        function removeQRCode() {
            delete state.businessProfile.paymentQR;
            localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
            showToast('QR code removed', 'info');
            render();
        }
        
        function selectTemplateColor(color) {
            state.invoiceTemplate.color = color;
            localStorage.setItem('owomi_template', JSON.stringify(state.invoiceTemplate));
            render();
        }
        
        function selectTemplateStyle(style) {
            state.invoiceTemplate.style = style;
            localStorage.setItem('owomi_template', JSON.stringify(state.invoiceTemplate));
            render();
        }
        
        function previewInvoice() {
            // Generate a sample invoice preview
            const sampleInvoice = {
                id: 'preview',
                invoice_number: 'INV-001',
                customer_id: state.customers[0]?.id || 'sample',
                description: 'Sample Invoice',
                items: [
                    { name: 'Product/Service 1', qty: 2, price: 50000 },
                    { name: 'Product/Service 2', qty: 1, price: 75000 }
                ],
                amount: 175000,
                amount_paid: 0,
                due_date: new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0],
                created_at: new Date().toISOString()
            };
            
            // Use existing customer or create sample
            const sampleCustomer = state.customers[0] || { name: 'John Doe', phone: '08012345678' };
            
            generatePDFWithTemplate(sampleInvoice, sampleCustomer);
        }

        // ========== AUTH ==========
        function getSession() {
            const data = localStorage.getItem('owomi_session');
            return data ? JSON.parse(data) : null;
        }

        function saveSession(session) {
            localStorage.setItem('owomi_session', JSON.stringify(session));
        }

        function clearSession() {
            localStorage.removeItem('owomi_session');
        }

        async function supabaseAuth(endpoint, body) {
            console.log('Auth request:', endpoint, JSON.stringify(body));
            const res = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const text = await res.text();
            console.log('Auth response:', res.status, text);
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Invalid response from server');
            }
            
            // Handle various error formats
            if (data.error) {
                throw new Error(data.error.message || data.error_description || data.error || 'Auth error');
            }
            if (data.code && data.msg) {
                throw new Error(data.msg);
            }
            if (!res.ok) {
                throw new Error(data.message || data.msg || data.error_description || 'Auth failed');
            }
            
            return data;
        }

        async function supabaseQuery(table, options = {}) {
            const session = getSession();
            if (!session) throw new Error('Not logged in');

            let url = `${SUPABASE_URL}/rest/v1/${table}`;
            if (options.query) url += `?${options.query}`;

            const res = await fetch(url, {
                method: options.method || 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json',
                    'Prefer': options.prefer || 'return=representation'
                },
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            const text = await res.text();
            if (!res.ok) throw new Error(text || 'API error');
            return text ? JSON.parse(text) : null;
        }

        // ========== DATA ==========
        async function loadData() {
            const session = getSession();
            if (!session) return;
            try {
                const [customers, invoices, reminderSettings] = await Promise.all([
                    supabaseQuery('customers', { query: `user_id=eq.${session.user.id}&order=created_at.desc` }),
                    supabaseQuery('invoices', { query: `user_id=eq.${session.user.id}&order=created_at.desc` }),
                    supabaseQuery('reminder_settings', { query: `user_id=eq.${session.user.id}` })
                ]);
                state.customers = customers || [];
                state.invoices = invoices || [];
                state.reminderSettings = reminderSettings?.[0] || null;
            } catch (err) {
                console.error('Load error:', err);
            }
        }

        async function addCustomer(name, phone) {
            const newCustomer = await db.createCustomer({ name, phone });
            if (newCustomer) {
                state.customers.unshift({
                    id: newCustomer.id,
                    name: newCustomer.name,
                    phone: newCustomer.phone || '',
                    email: newCustomer.email || ''
                });
            }
        }

        async function addInvoice(customerId, description, amount, dueDate, items = []) {
            const invoice_number = generateInvoiceNumber();
            
            const newInvoice = await db.createInvoice({
                customer_id: customerId,
                description,
                amount,
                amount_paid: 0,
                due_date: dueDate,
                invoice_number,
                items: items.length > 0 ? items : [{name: description, qty: 1, price: amount}]
            });
            
            if (newInvoice) {
                state.invoices.unshift({
                    id: newInvoice.id,
                    invoice_number: newInvoice.invoice_number,
                    customer_id: newInvoice.customer_id,
                    description: newInvoice.description,
                    items: newInvoice.items || [],
                    amount: parseFloat(newInvoice.amount) || 0,
                    amount_paid: 0,
                    due_date: newInvoice.due_date,
                    created_at: newInvoice.created_at
                });
                
                // Track usage for subscription limits
                await db.incrementUsage('invoice');
            }
        }

        async function recordPayment(invoiceId, amount, method = 'transfer', note = '') {
            const invoice = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === invoice.customer_id);
            const newPaid = Math.min(invoice.amount_paid + amount, invoice.amount);
            const isFullyPaid = newPaid >= invoice.amount;
            
            // Update invoice in database
            await db.updateInvoice(invoiceId, { 
                amount_paid: newPaid
            });
            
            // Create payment record in database
            const paymentRecord = await db.createPayment({
                invoice_id: invoiceId,
                customer_id: invoice.customer_id,
                amount,
                method,
                notes: note
            });
            
            // Update local state
            invoice.amount_paid = newPaid;
            if (isFullyPaid) {
                invoice.paid_date = new Date().toISOString();
            }
            
            if (paymentRecord) {
                state.paymentHistory.push({
                    id: paymentRecord.id,
                    invoiceId,
                    customerId: invoice.customer_id,
                    customerName: cust?.name || 'Unknown',
                    invoiceNumber: invoice.invoice_number,
                    amount,
                    method,
                    note,
                    date: paymentRecord.date,
                    isFullPayment: isFullyPaid
                });
            }
        }

        // ========== HELPERS ==========
        const formatNaira = (amt) => 'â‚¦' + Number(amt).toLocaleString();
        const formatDate = (d) => new Date(d).toLocaleDateString('en-NG', { day: 'numeric', month: 'short', year: 'numeric' });
        const getStatus = (inv) => {
            if (inv.amount_paid >= inv.amount) return 'paid';
            if (new Date(inv.due_date) < new Date()) return 'overdue';
            return 'pending';
        };
        
        function generateInvoiceNumber() {
            const existing = state.invoices.map(inv => {
                const match = inv.invoice_number?.match(/INV-(\d+)/);
                return match ? parseInt(match[1]) : 0;
            });
            const maxNum = existing.length > 0 ? Math.max(...existing) : 0;
            const nextNum = maxNum + 1;
            return `INV-${String(nextNum).padStart(3, '0')}`;
        }

        // ========== RENDER ==========
        function render() {
            const app = document.getElementById('app');
            
            // Handle different sections
            if (state.currentSection === 'landing') {
                app.innerHTML = renderLanding();
                attachLandingEvents();
                return;
            }
            
            if (state.currentSection === 'onboarding') {
                app.innerHTML = renderOnboarding();
                attachOnboardingEvents();
                return;
            }
            
            if (state.loading) { 
                app.innerHTML = `
                    <header class="header">
                        <div class="header-content">
                            <h1>Owo Mi ðŸ’°</h1>
                        </div>
                    </header>
                    <main class="main">
                        <div class="stats">
                            <div class="stat"><div class="skeleton" style="height:16px;width:60%;margin-bottom:8px;"></div><div class="skeleton" style="height:28px;width:80%;"></div></div>
                            <div class="stat"><div class="skeleton" style="height:16px;width:60%;margin-bottom:8px;"></div><div class="skeleton" style="height:28px;width:80%;"></div></div>
                        </div>
                        <div class="quick-actions">
                            <div class="skeleton" style="height:52px;border-radius:14px;"></div>
                            <div class="skeleton" style="height:52px;border-radius:14px;"></div>
                        </div>
                        <div class="skeleton" style="height:24px;width:40%;margin-bottom:16px;"></div>
                        <div class="card"><div class="skeleton" style="height:20px;width:50%;margin-bottom:12px;"></div><div class="skeleton" style="height:16px;width:70%;margin-bottom:8px;"></div><div class="skeleton" style="height:40px;margin-top:12px;border-radius:10px;"></div></div>
                        <div class="card"><div class="skeleton" style="height:20px;width:50%;margin-bottom:12px;"></div><div class="skeleton" style="height:16px;width:70%;margin-bottom:8px;"></div><div class="skeleton" style="height:40px;margin-top:12px;border-radius:10px;"></div></div>
                    </main>
                    <nav class="nav">
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                        <div class="nav-item"><div class="skeleton" style="width:30px;height:30px;border-radius:8px;margin:0 auto 4px;"></div><div class="skeleton" style="width:40px;height:12px;margin:0 auto;"></div></div>
                    </nav>
                `; 
                return; 
            }
            if (!state.user) { app.innerHTML = renderAuth(); attachAuthEvents(); return; }
            app.innerHTML = renderApp();
            attachAppEvents();
        }
        
        // ========== LANDING PAGE ==========
        function renderLanding() {
            return `
                <div class="landing-section">
                    <nav class="landing-nav">
                        <div class="landing-logo">ðŸ’° Owo Mi</div>
                        <button class="landing-nav-btn" id="landing-get-started">Get Started â†’</button>
                    </nav>
                    
                    <div class="landing-hero">
                        <div>
                            <div class="landing-badge">ðŸ‡³ðŸ‡¬ Made for Nigerian Businesses</div>
                            <h1 class="landing-title">Stop Chasing <span>Payments.</span> Start Growing.</h1>
                            <p class="landing-subtitle">Create invoices in seconds, send reminders via WhatsApp & SMS, and track every kobo your customers owe you.</p>
                            <div class="landing-ctas">
                                <button class="landing-cta-primary" id="landing-start-free">Start Free Today â†’</button>
                                <button class="landing-cta-secondary" id="landing-see-features">See Features â†“</button>
                            </div>
                            <div class="landing-stats">
                                <div>
                                    <div class="landing-stat-value">5,000+</div>
                                    <div class="landing-stat-label">Invoices Sent</div>
                                </div>
                                <div>
                                    <div class="landing-stat-value">â‚¦50M+</div>
                                    <div class="landing-stat-label">Collected</div>
                                </div>
                                <div>
                                    <div class="landing-stat-value">98%</div>
                                    <div class="landing-stat-label">Payment Rate</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="landing-phone">
                                <div class="landing-phone-screen">
                                    <div class="landing-phone-header">
                                        <div class="landing-phone-greeting">Good morning ðŸ‘‹</div>
                                        <div class="landing-phone-title">Owo Mi ðŸ’°</div>
                                    </div>
                                    <div class="landing-phone-stats">
                                        <div class="landing-phone-stat">
                                            <div class="landing-phone-stat-label">Outstanding</div>
                                            <div class="landing-phone-stat-value">â‚¦350K</div>
                                        </div>
                                        <div class="landing-phone-stat">
                                            <div class="landing-phone-stat-label">Collected</div>
                                            <div class="landing-phone-stat-value">â‚¦1.2M</div>
                                        </div>
                                    </div>
                                    <div class="landing-phone-card">
                                        <div class="landing-phone-card-top">
                                            <div>
                                                <div class="landing-phone-card-name">Chidi Okonkwo</div>
                                                <div class="landing-phone-card-desc">Website Design</div>
                                            </div>
                                            <div class="landing-phone-card-amount">â‚¦150K</div>
                                        </div>
                                        <span class="landing-phone-badge paid">Paid âœ“</span>
                                    </div>
                                    <div class="landing-phone-card">
                                        <div class="landing-phone-card-top">
                                            <div>
                                                <div class="landing-phone-card-name">Amaka Johnson</div>
                                                <div class="landing-phone-card-desc">Logo Design</div>
                                            </div>
                                            <div class="landing-phone-card-amount">â‚¦75K</div>
                                        </div>
                                        <span class="landing-phone-badge pending">Pending</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="landing-features" id="features">
                        <div class="landing-features-inner">
                            <h2 class="landing-section-title">Everything You Need to Get Paid</h2>
                            <div class="landing-features-grid">
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“„</div>
                                    <h3 class="landing-feature-title">Professional Invoices</h3>
                                    <p class="landing-feature-desc">Create beautiful PDF invoices with your logo and bank details.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“±</div>
                                    <h3 class="landing-feature-title">WhatsApp & SMS</h3>
                                    <p class="landing-feature-desc">Send payment reminders in one tap via WhatsApp or SMS.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ’³</div>
                                    <h3 class="landing-feature-title">Paystack Payments</h3>
                                    <p class="landing-feature-desc">Generate payment links so customers can pay online.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ“Š</div>
                                    <h3 class="landing-feature-title">Real-time Dashboard</h3>
                                    <p class="landing-feature-desc">See outstanding, collected, and overdue at a glance.</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">ðŸ¤–</div>
                                    <h3 class="landing-feature-title">AI Assistant</h3>
                                    <p class="landing-feature-desc">"Invoice Chidi â‚¦50k" - understands English and Pidgin!</p>
                                </div>
                                <div class="landing-feature-card">
                                    <div class="landing-feature-icon">â°</div>
                                    <h3 class="landing-feature-title">Auto Reminders</h3>
                                    <p class="landing-feature-desc">Set it and forget it. Automatic reminders on due dates.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="landing-cta-section">
                        <h2>Ready to Get Paid Faster?</h2>
                        <p>Join thousands of Nigerian businesses using Owo Mi.</p>
                        <button id="landing-cta-btn">Start Free - No Card Needed â†’</button>
                    </div>
                    
                    <footer class="landing-footer">
                        <div class="landing-footer-logo">ðŸ’° Owo Mi</div>
                        <p>Â© 2025 Owo Mi. Made with ðŸ’š in Nigeria ðŸ‡³ðŸ‡¬</p>
                    </footer>
                </div>
            `;
        }
        
        function attachLandingEvents() {
            document.getElementById('landing-get-started')?.addEventListener('click', goToAuth);
            document.getElementById('landing-start-free')?.addEventListener('click', goToAuth);
            document.getElementById('landing-cta-btn')?.addEventListener('click', goToAuth);
            document.getElementById('landing-see-features')?.addEventListener('click', () => {
                document.getElementById('features')?.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        function goToAuth() {
            state.currentSection = 'auth';
            state.loading = false;
            render();
        }
        
        // ========== ONBOARDING ==========
        function renderOnboarding() {
            const totalSteps = 6;
            
            let content = '';
            
            // Step 1: Welcome
            if (state.onboardingStep === 1) {
                content = `
                    <div class="onboarding-illustration">ðŸ’°</div>
                    <h2 class="onboarding-title">Welcome to Owo Mi!</h2>
                    <p class="onboarding-desc">The simplest way to create invoices, track payments, and grow your Nigerian business.</p>
                    
                    <div class="onboarding-features">
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ“„</div>
                            <div class="onboarding-feature-title">Easy Invoicing</div>
                            <div class="onboarding-feature-desc">Create in seconds</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ’¬</div>
                            <div class="onboarding-feature-title">WhatsApp Send</div>
                            <div class="onboarding-feature-desc">One-tap delivery</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ¤–</div>
                            <div class="onboarding-feature-title">AI Assistant</div>
                            <div class="onboarding-feature-desc">Speaks Pidgin!</div>
                        </div>
                        <div class="onboarding-feature">
                            <div class="onboarding-feature-icon">ðŸ“Š</div>
                            <div class="onboarding-feature-title">Smart Reports</div>
                            <div class="onboarding-feature-desc">Know your numbers</div>
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Get Started â†’</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip">I've used this before, skip setup</button>
                `;
            }
            
            // Step 2: Business Info
            else if (state.onboardingStep === 2) {
                content = `
                    <div class="onboarding-icon" style="text-align:center;">ðŸª</div>
                    <h2 class="onboarding-title">Your Business</h2>
                    <p class="onboarding-desc">This info appears on your invoices. Make it look professional!</p>
                    
                    <div class="onboarding-form">
                        <div class="form-group">
                            <label class="form-label">Business Name *</label>
                            <input type="text" class="form-input" id="onboard-business" placeholder="e.g. Chidi's Design Studio" value="${state.businessProfile.name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Your Phone Number</label>
                            <input type="tel" class="form-input" id="onboard-phone" placeholder="08012345678" value="${state.businessProfile.phone || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email (optional)</label>
                            <input type="email" class="form-input" id="onboard-email" placeholder="you@email.com" value="${state.businessProfile.email || ''}">
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â†</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Continue â†’</button>
                    </div>
                `;
            }
            
            // Step 3: Bank Details
            else if (state.onboardingStep === 3) {
                content = `
                    <div class="onboarding-icon" style="text-align:center;">ðŸ¦</div>
                    <h2 class="onboarding-title">Payment Details</h2>
                    <p class="onboarding-desc">Where should customers send money? This shows on every invoice.</p>
                    
                    <div class="onboarding-highlight">
                        <div class="onboarding-highlight-title">ðŸ’¡ Why this matters</div>
                        <div class="onboarding-highlight-text">Customers can pay faster when bank details are right on the invoice!</div>
                    </div>
                    
                    <div class="onboarding-form">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="onboard-bank" placeholder="e.g. GTBank, Access Bank" value="${state.businessProfile.bankName || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-input" id="onboard-account" placeholder="0123456789" maxlength="10" inputmode="numeric" value="${state.businessProfile.accountNumber || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" class="form-input" id="onboard-account-name" placeholder="Your name or business name" value="${state.businessProfile.accountName || ''}">
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â†</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Continue â†’</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip">Skip, I'll add later</button>
                `;
            }
            
            // Step 4: Add First Customer
            else if (state.onboardingStep === 4) {
                content = `
                    <div class="onboarding-icon" style="text-align:center;">ðŸ‘¤</div>
                    <h2 class="onboarding-title">Add Your First Customer</h2>
                    <p class="onboarding-desc">Let's add someone you do business with. You can add more later!</p>
                    
                    <div class="onboarding-form">
                        <div class="form-group">
                            <label class="form-label">Customer Name *</label>
                            <input type="text" class="form-input" id="onboard-cust-name" placeholder="e.g. Alhaji Musa, ABC Company">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone (for WhatsApp)</label>
                            <input type="tel" class="form-input" id="onboard-cust-phone" placeholder="08012345678">
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â†</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-next">Add Customer â†’</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip-customer">Skip, I'll add customers later</button>
                `;
            }
            
            // Step 5: Create First Invoice (Demo)
            else if (state.onboardingStep === 5) {
                const hasCustomer = state.customers.length > 0;
                const firstCustomer = state.customers[0];
                
                content = `
                    <div class="onboarding-icon" style="text-align:center;">ðŸ“„</div>
                    <h2 class="onboarding-title">Create Your First Invoice</h2>
                    <p class="onboarding-desc">${hasCustomer ? `Let's create an invoice for ${firstCustomer.name}!` : "See how easy it is to create invoices."}</p>
                    
                    <div class="onboarding-form">
                        ${hasCustomer ? `
                            <div style="background:#dcfce7;padding:12px;border-radius:10px;margin-bottom:8px;">
                                <span style="color:#166534;">âœ… Customer: <strong>${firstCustomer.name}</strong></span>
                            </div>
                        ` : `
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-input" id="onboard-inv-customer" placeholder="Customer name" value="Sample Customer">
                            </div>
                        `}
                        <div class="form-group">
                            <label class="form-label">What's this invoice for?</label>
                            <input type="text" class="form-input" id="onboard-inv-desc" placeholder="e.g. Website Design, Catering Service">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (â‚¦)</label>
                            <input type="number" class="form-input" id="onboard-inv-amount" placeholder="50000" inputmode="numeric">
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-secondary" id="onboard-prev">â†</button>
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-create-invoice">âœ¨ Create Invoice</button>
                    </div>
                    <button class="onboarding-skip" id="onboard-skip">Skip, I'll create invoices later</button>
                `;
            }
            
            // Step 6: All Done!
            else if (state.onboardingStep === 6) {
                const businessName = state.businessProfile.name || 'Your Business';
                const invoiceCount = state.invoices.length;
                const customerCount = state.customers.length;
                
                content = `
                    <div class="onboarding-success">
                        <div class="onboarding-success-icon">ðŸŽ‰</div>
                        <div class="onboarding-success-title">You're All Set!</div>
                        <div class="onboarding-success-text">${businessName} is ready to roll</div>
                    </div>
                    
                    ${invoiceCount > 0 || customerCount > 0 ? `
                        <div style="background:white;padding:16px;border-radius:12px;margin-bottom:20px;text-align:center;">
                            <div style="font-size:14px;color:#666;">You've already added:</div>
                            <div style="display:flex;justify-content:center;gap:24px;margin-top:12px;">
                                ${customerCount > 0 ? `<div><span style="font-size:24px;font-weight:700;color:#3b82f6;">${customerCount}</span><br><span style="font-size:12px;color:#666;">Customer${customerCount > 1 ? 's' : ''}</span></div>` : ''}
                                ${invoiceCount > 0 ? `<div><span style="font-size:24px;font-weight:700;color:#16a34a;">${invoiceCount}</span><br><span style="font-size:12px;color:#666;">Invoice${invoiceCount > 1 ? 's' : ''}</span></div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="onboarding-tips">
                        <div class="onboarding-tip">
                            <div class="onboarding-tip-icon">ðŸ¤–</div>
                            <div class="onboarding-tip-text"><strong>AI Assistant:</strong> Tap the floating button to create invoices with voice or chat!</div>
                        </div>
                        <div class="onboarding-tip">
                            <div class="onboarding-tip-icon">ðŸ’¬</div>
                            <div class="onboarding-tip-text"><strong>WhatsApp:</strong> Send invoices directly to customers with smart follow-up messages</div>
                        </div>
                        <div class="onboarding-tip">
                            <div class="onboarding-tip-icon">ðŸ“Š</div>
                            <div class="onboarding-tip-text"><strong>Reports:</strong> Track who owes you money and see business insights</div>
                        </div>
                    </div>
                    
                    <div class="onboarding-actions">
                        <button class="onboarding-btn onboarding-btn-primary" id="onboard-complete" style="background:linear-gradient(135deg,#16a34a,#15803d);box-shadow:0 4px 15px rgba(22,163,74,0.3);">
                            ðŸš€ Start Using Owo Mi
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="onboarding-section">
                    <div class="onboarding-container">
                        <div class="onboarding-progress">
                            ${Array.from({length: totalSteps}, (_, i) => i + 1).map(n => 
                                `<div class="onboarding-progress-step ${n < state.onboardingStep ? 'completed' : ''} ${n === state.onboardingStep ? 'active' : ''}"></div>`
                            ).join('')}
                        </div>
                        <div class="onboarding-step active">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function attachOnboardingEvents() {
            document.getElementById('onboard-next')?.addEventListener('click', nextOnboardingStep);
            document.getElementById('onboard-prev')?.addEventListener('click', prevOnboardingStep);
            document.getElementById('onboard-skip')?.addEventListener('click', skipOnboardingStep);
            document.getElementById('onboard-skip-customer')?.addEventListener('click', skipOnboardingStep);
            document.getElementById('onboard-complete')?.addEventListener('click', completeOnboarding);
            document.getElementById('onboard-create-invoice')?.addEventListener('click', createOnboardingInvoice);
        }
        
        async function nextOnboardingStep() {
            // Save current step data
            if (state.onboardingStep === 2) {
                const name = document.getElementById('onboard-business')?.value?.trim();
                if (!name) {
                    showToast('Please enter your business name', 'error');
                    return;
                }
                state.businessProfile.name = name;
                state.businessProfile.phone = document.getElementById('onboard-phone')?.value?.trim() || '';
                state.businessProfile.email = document.getElementById('onboard-email')?.value?.trim() || '';
                // Save to database
                await db.updateBusiness({
                    name: state.businessProfile.name,
                    phone: state.businessProfile.phone,
                    email: state.businessProfile.email
                });
            } 
            else if (state.onboardingStep === 3) {
                const bankName = document.getElementById('onboard-bank')?.value?.trim() || '';
                const accountNumber = document.getElementById('onboard-account')?.value?.trim() || '';
                const accountName = document.getElementById('onboard-account-name')?.value?.trim() || '';
                
                // Combine into bank details string for invoice
                if (bankName && accountNumber) {
                    state.businessProfile.bank = `${bankName}\n${accountNumber}${accountName ? '\n' + accountName : ''}`;
                    state.businessProfile.bankName = bankName;
                }
                state.businessProfile.accountNumber = accountNumber;
                state.businessProfile.accountName = accountName;
                // Save to database
                await db.updateBusiness({
                    bank_name: bankName,
                    account_number: accountNumber,
                    account_name: accountName,
                    bank_details: state.businessProfile.bank
                });
            }
            else if (state.onboardingStep === 4) {
                // Add customer
                const custName = document.getElementById('onboard-cust-name')?.value?.trim();
                const custPhone = document.getElementById('onboard-cust-phone')?.value?.trim() || '';
                
                if (!custName) {
                    showToast('Please enter a customer name', 'error');
                    return;
                }
                
                // Save to database
                const newCustomer = await db.createCustomer({ name: custName, phone: custPhone });
                if (newCustomer) {
                    state.customers.push({
                        id: newCustomer.id,
                        name: newCustomer.name,
                        phone: newCustomer.phone || '',
                        email: ''
                    });
                }
                showToast(`âœ… ${custName} added!`, 'success');
            }
            
            if (state.onboardingStep < 6) {
                state.onboardingStep++;
                render();
            }
        }
        
        async function skipOnboardingStep() {
            // Save any entered data before skipping
            if (state.onboardingStep === 2) {
                state.businessProfile.name = document.getElementById('onboard-business')?.value?.trim() || '';
                state.businessProfile.phone = document.getElementById('onboard-phone')?.value?.trim() || '';
                await db.updateBusiness({
                    name: state.businessProfile.name,
                    phone: state.businessProfile.phone
                });
            }
            
            // Skip to end or next relevant step
            if (state.onboardingStep === 1) {
                completeOnboarding();
            } else if (state.onboardingStep === 4) {
                // Skip customer, go to invoice step
                state.onboardingStep = 5;
                render();
            } else if (state.onboardingStep === 5) {
                // Skip invoice, go to final
                state.onboardingStep = 6;
                render();
            } else {
                state.onboardingStep++;
                render();
            }
        }
        
        async function createOnboardingInvoice() {
            const hasCustomer = state.customers.length > 0;
            let customerId;
            
            if (hasCustomer) {
                customerId = state.customers[0].id;
            } else {
                // Create sample customer in database
                const custName = document.getElementById('onboard-inv-customer')?.value?.trim() || 'Sample Customer';
                const newCustomer = await db.createCustomer({ name: custName, phone: '' });
                if (newCustomer) {
                    state.customers.push({
                        id: newCustomer.id,
                        name: custName,
                        phone: '',
                        email: ''
                    });
                    customerId = newCustomer.id;
                }
            }
            
            const description = document.getElementById('onboard-inv-desc')?.value?.trim();
            const amount = parseFloat(document.getElementById('onboard-inv-amount')?.value) || 0;
            
            if (!description) {
                showToast('Please describe what this invoice is for', 'error');
                return;
            }
            if (!amount || amount < 100) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            // Create invoice in database
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14);
            
            const invoiceNumber = generateInvoiceNumber();
            const newInvoice = await db.createInvoice({
                customer_id: customerId,
                description,
                items: [{ name: description, qty: 1, price: amount }],
                amount,
                amount_paid: 0,
                due_date: dueDate.toISOString().split('T')[0],
                invoice_number: invoiceNumber
            });
            
            if (newInvoice) {
                state.invoices.push({
                    id: newInvoice.id,
                    invoice_number: invoiceNumber,
                    customer_id: customerId,
                    description,
                    items: [{ name: description, qty: 1, price: amount }],
                    amount,
                    amount_paid: 0,
                    due_date: dueDate.toISOString().split('T')[0],
                    created_at: new Date().toISOString()
                });
            }
            
            showToast(`âœ… Invoice ${invoiceNumber} created!`, 'success');
            state.onboardingStep = 6;
            render();
        }
        
        function prevOnboardingStep() {
            if (state.onboardingStep > 1) {
                state.onboardingStep--;
                render();
            }
        }
        
        async function completeOnboarding() {
            // Save business profile to database
            try {
                await db.updateBusiness({
                    name: state.businessProfile.name || '',
                    phone: state.businessProfile.phone || '',
                    email: state.businessProfile.email || '',
                    bank_name: state.businessProfile.bankName || '',
                    account_number: state.businessProfile.accountNumber || '',
                    account_name: state.businessProfile.accountName || '',
                    bank_details: state.businessProfile.bank || '',
                    onboarded: true
                });
                
                state.currentSection = 'app';
                showToast('Welcome to Owo Mi! ðŸŽ‰', 'success');
                render();
            } catch (err) {
                console.error('Failed to save:', err);
                showToast('Error saving profile', 'error');
            }
        }
        
        function runOnboardingAgain() {
            if (confirm('Run the setup guide again? This will walk you through the app setup.')) {
                state.onboardingStep = 1;
                state.currentSection = 'onboarding';
                render();
            }
        }
        window.runOnboardingAgain = runOnboardingAgain;

        function renderAuth() {
            const isSignup = state.authMode === 'signup';
            return `
                <div class="auth-container">
                    <div class="auth-box">
                        <div class="auth-header">
                            <div class="auth-logo">ðŸ’°</div>
                            <h1 class="auth-title">${isSignup ? 'Create Account' : 'Welcome Back!'}</h1>
                            <p class="auth-subtitle">${isSignup ? 'Start managing your invoices like a pro' : 'Sign in to continue to Owo Mi'}</p>
                        </div>
                        
                        <div id="auth-error" class="error-msg hidden"></div>
                        <div id="auth-success" class="success-msg hidden"></div>
                        
                        <!-- Email Form -->
                        <form class="email-form" id="auth-form">
                            ${isSignup ? `
                                <div class="form-group">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" class="form-input" id="auth-name" placeholder="Your business name">
                                </div>
                            ` : ''}
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="auth-email" placeholder="you@example.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="auth-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
                            </div>
                            ${isSignup ? `
                                <div class="form-group">
                                    <label class="form-label">Confirm Password</label>
                                    <input type="password" class="form-input" id="auth-password-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">
                                </div>
                            ` : ''}
                            <button type="submit" class="auth-submit-btn" id="auth-btn">
                                ${isSignup ? 'Create Account' : 'Sign In'}
                            </button>
                        </form>
                        
                        <div class="auth-toggle">
                            ${isSignup 
                                ? 'Already have an account? <a id="toggle-auth">Sign In</a>' 
                                : "Don't have an account? <a id=\"toggle-auth\">Sign Up</a>"}
                        </div>
                        
                        <button class="auth-back" id="auth-back-btn">â† Back to Home</button>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            
            // Time-based greeting
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            const businessName = state.businessProfile.name ? state.businessProfile.name.split(' ')[0] : '';
            
            // Tab-specific header content
            let headerTitle, headerSubtitle;
            if (state.activeTab === 'home') {
                headerTitle = `${greeting}${businessName ? ', ' + businessName : ''} ðŸ‘‹`;
                headerSubtitle = 'Owo Mi ðŸ’°';
            } else if (state.activeTab === 'invoices') {
                headerTitle = 'ðŸ“„ Invoices';
                headerSubtitle = `${state.invoices.length} total â€¢ ${formatNaira(outstanding)} outstanding`;
            } else if (state.activeTab === 'menu') {
                headerTitle = 'âš™ï¸ Menu';
                headerSubtitle = 'Settings & More';
            }

            return `
                <header class="header">
                    <div class="header-content">
                        <div>
                            <h1>${headerTitle}</h1>
                            <p>${headerSubtitle}</p>
                        </div>
                    </div>
                </header>
                <main class="main">
                    ${state.activeTab === 'home' ? renderHome(outstanding, collected) : ''}
                    ${state.activeTab === 'invoices' ? renderInvoices() : ''}
                    ${state.activeTab === 'menu' ? renderMenu() : ''}
                </main>
                <nav class="nav">
                    <button class="nav-item ${state.activeTab === 'home' ? 'active' : ''}" data-tab="home">
                        <div class="nav-icon">ðŸ </div>
                        <div class="nav-label">Home</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'invoices' ? 'active' : ''}" data-tab="invoices">
                        <div class="nav-icon">ðŸ“„</div>
                        <div class="nav-label">Invoices</div>
                    </button>
                    <button class="nav-item ${state.activeTab === 'menu' ? 'active' : ''}" data-tab="menu">
                        <div class="nav-icon">â˜°</div>
                        <div class="nav-label">Menu</div>
                    </button>
                </nav>
                <button class="ai-fab" id="ai-assistant-btn" title="AI Assistant">ðŸ¤–</button>
                <div id="modal-container"></div>
            `;
        }

        function renderHome(outstanding, collected) {
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmt = overdue.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            const aiInsights = generateAIInsights();

            return `
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Outstanding</div>
                        <div class="stat-value">${formatNaira(outstanding)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Collected</div>
                        <div class="stat-value green">${formatNaira(collected)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Overdue</div>
                        <div class="stat-value red">${formatNaira(overdueAmt)}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Customers</div>
                        <div class="stat-value">${state.customers.length}</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-btn primary" id="btn-new-invoice">ðŸ“„ New Invoice</button>
                    <button class="quick-btn secondary" id="btn-new-customer">ðŸ‘¤ Customer</button>
                </div>

                ${aiInsights.length > 0 ? `
                    <div class="ai-insights">
                        <div class="ai-insights-header">
                            <span style="font-size:20px;">ðŸ§ </span>
                            <span>AI Business Coach</span>
                        </div>
                        ${aiInsights.slice(0, 3).map(insight => `
                            <div class="ai-insight-item">
                                ${insight.icon} ${insight.text}
                                ${insight.action ? `<br><button class="ai-insight-action" data-insight-action="${insight.actionType}">${insight.action}</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${renderChart()}

                <div class="section-header">
                    <div class="section-title">Recent Invoices</div>
                    <button class="section-link" data-goto="invoices">See All</button>
                </div>
                ${state.invoices.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“„</div>No invoices yet.<br>Create your first one!</div>' : 
                    state.invoices.slice(0, 3).map(renderInvoiceCard).join('')}
            `;
        }

        function generateAIInsights() {
            const insights = [];
            const today = new Date();
            
            // Check overdue invoices
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            if (overdue.length > 0) {
                const overdueAmt = overdue.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                const topDebtor = overdue.sort((a, b) => (b.amount - b.amount_paid) - (a.amount - a.amount_paid))[0];
                const topDebtorCust = state.customers.find(c => c.id === topDebtor?.customer_id);
                insights.push({
                    icon: 'âš ï¸',
                    text: `You have ${overdue.length} overdue invoice${overdue.length > 1 ? 's' : ''} worth ${formatNaira(overdueAmt)}. ${topDebtorCust ? `${topDebtorCust.name} owes the most.` : ''} Follow up today!`,
                    action: 'Send Reminders',
                    actionType: 'send-overdue'
                });
            }
            
            // Check collection rate
            const totalInvoiced = state.invoices.reduce((s, i) => s + Number(i.amount), 0);
            const totalCollected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            const collectionRate = totalInvoiced > 0 ? (totalCollected / totalInvoiced) * 100 : 0;
            if (collectionRate < 70 && totalInvoiced > 0) {
                insights.push({
                    icon: 'ðŸ“‰',
                    text: `Your collection rate is ${collectionRate.toFixed(0)}%. Try sending payment reminders earlier or offering small discounts for quick payment.`,
                    action: 'View Reports',
                    actionType: 'view-reports'
                });
            }
            
            // Check for invoices due soon
            const dueSoon = state.invoices.filter(i => {
                if (getStatus(i) === 'paid') return false;
                const due = new Date(i.due_date);
                const daysUntil = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                return daysUntil >= 0 && daysUntil <= 3;
            });
            if (dueSoon.length > 0) {
                const dueSoonAmt = dueSoon.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                insights.push({
                    icon: 'â°',
                    text: `${dueSoon.length} invoice${dueSoon.length > 1 ? 's' : ''} worth ${formatNaira(dueSoonAmt)} due within 3 days. Send gentle reminders now!`,
                    action: 'Send Reminders',
                    actionType: 'send-due-soon'
                });
            }
            
            // Best performing product
            const productStats = {};
            state.invoices.forEach(inv => {
                if (inv.items) {
                    inv.items.forEach(item => {
                        const key = item.name.toLowerCase().trim();
                        if (!productStats[key]) productStats[key] = { name: item.name, revenue: 0 };
                        productStats[key].revenue += (Number(item.qty) || 1) * Number(item.price);
                    });
                }
            });
            const topProduct = Object.values(productStats).sort((a, b) => b.revenue - a.revenue)[0];
            if (topProduct && topProduct.revenue > 0) {
                insights.push({
                    icon: 'â­',
                    text: `"${topProduct.name}" is your best seller at ${formatNaira(topProduct.revenue)}! Consider promoting it more or raising the price.`,
                });
            }
            
            // Cash flow warning
            const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
            const profit = totalCollected - totalExpenses;
            if (profit < 0) {
                insights.push({
                    icon: 'ðŸ”´',
                    text: `Your expenses (${formatNaira(totalExpenses)}) exceed collections (${formatNaira(totalCollected)}). Focus on collecting outstanding payments!`,
                    action: 'View Reports',
                    actionType: 'view-reports'
                });
            }
            
            // Positive insight
            if (collectionRate >= 80 && insights.length === 0) {
                insights.push({
                    icon: 'ðŸŽ‰',
                    text: `Great job! Your ${collectionRate.toFixed(0)}% collection rate is excellent. Keep up the good work!`,
                });
            }
            
            // No invoices yet
            if (state.invoices.length === 0) {
                insights.push({
                    icon: 'ðŸ’¡',
                    text: `Ready to start? Create your first invoice and I'll help you track payments and grow your business!`,
                    action: 'Create Invoice',
                    actionType: 'create-invoice'
                });
            }
            
            // Best customer insight
            if (state.invoices.length >= 5) {
                const customerTotals = {};
                state.invoices.forEach(inv => {
                    if (!customerTotals[inv.customer_id]) customerTotals[inv.customer_id] = 0;
                    customerTotals[inv.customer_id] += Number(inv.amount_paid);
                });
                const topCustomerId = Object.keys(customerTotals).sort((a, b) => customerTotals[b] - customerTotals[a])[0];
                const topCustomer = state.customers.find(c => c.id === topCustomerId);
                if (topCustomer && customerTotals[topCustomerId] > 0) {
                    insights.push({
                        icon: 'ðŸ‘‘',
                        text: `${topCustomer.name} is your VIP! They've paid ${formatNaira(customerTotals[topCustomerId])}. Consider offering them loyalty discounts.`,
                    });
                }
            }
            
            return insights;
        }

        function renderChart() {
            const months = [];
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({ label: d.toLocaleDateString('en-US', { month: 'short' }), year: d.getFullYear(), month: d.getMonth(), collected: 0 });
            }
            state.invoices.forEach(inv => {
                const d = new Date(inv.created_at);
                months.forEach(m => { if (d.getFullYear() === m.year && d.getMonth() === m.month) m.collected += Number(inv.amount_paid); });
            });
            const max = Math.max(...months.map(m => m.collected), 1);

            return `
                <div class="chart-container">
                    <div class="chart-title">ðŸ“Š Collections (6 Months)</div>
                    <div class="bar-chart">
                        ${months.map(m => `
                            <div class="bar-group">
                                <div class="bar" style="height: ${(m.collected / max) * 80}px;" title="${formatNaira(m.collected)}"></div>
                                <div class="bar-label">${m.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderInvoices() {
            let filtered = state.invoices;
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(inv => {
                    const cust = state.customers.find(c => c.id === inv.customer_id);
                    return inv.description.toLowerCase().includes(q) || (cust && cust.name.toLowerCase().includes(q));
                });
            }
            if (state.filterStatus !== 'all') filtered = filtered.filter(inv => getStatus(inv) === state.filterStatus);

            return `
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="ðŸ” Search invoices..." value="${state.searchQuery}">
                </div>
                <div class="filter-tabs">
                    <button class="filter-tab ${state.filterStatus === 'all' ? 'active' : ''}" data-filter="all">All</button>
                    <button class="filter-tab ${state.filterStatus === 'pending' ? 'active' : ''}" data-filter="pending">Pending</button>
                    <button class="filter-tab ${state.filterStatus === 'overdue' ? 'active' : ''}" data-filter="overdue">Overdue</button>
                    <button class="filter-tab ${state.filterStatus === 'paid' ? 'active' : ''}" data-filter="paid">Paid</button>
                </div>
                ${filtered.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“„</div>No invoices found</div>' : 
                    filtered.map(renderInvoiceCard).join('')}
            `;
        }

        function renderInvoiceCard(inv) {
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 3).toUpperCase()}`;
            const itemCount = inv.items?.length || 1;
            const viewedIndicator = inv.viewed_at ? `<span style="color:#16a34a;font-size:11px;" title="Viewed ${formatDate(inv.viewed_at)}">ðŸ‘ï¸ Viewed</span>` : '';
            return `
                <div class="card">
                    <div class="card-top">
                        <div>
                            <div class="card-name">${cust?.name || 'Unknown'} <span style="color:#3b82f6;font-size:12px;font-weight:600;">${invNumber}</span> ${viewedIndicator}</div>
                            <div class="card-desc">${inv.description} ${itemCount > 1 ? `<span style="color:#999;">(${itemCount} items)</span>` : ''}</div>
                            <div class="card-date">Due: ${formatDate(inv.due_date)}</div>
                        </div>
                        <div class="card-amount">
                            ${formatNaira(inv.amount)}
                            <div class="badge badge-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn btn-pdf" data-pdf="${inv.id}" title="Download Invoice PDF">ðŸ“„ PDF</button>
                        ${status === 'paid' ? `<button class="card-btn btn-pay" data-receipt="${inv.id}" title="Generate Receipt">ðŸ§¾ Receipt</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-pay" data-pay="${inv.id}" title="Record Payment">ðŸ’° Record</button>` : ''}
                        ${status !== 'paid' ? `<button class="card-btn btn-whatsapp" data-whatsapp="${inv.id}" title="Send Invoice via WhatsApp">ðŸ’¬ Send</button>` : ''}
                        ${status !== 'paid' && state.businessProfile.paystackEnabled && state.businessProfile.paystackPublicKey ? `<button class="card-btn btn-paylink" data-paylink="${inv.id}" title="Collect Card Payment">ðŸ’³ Card</button>` : ''}
                        <button class="card-btn btn-edit" data-edit-inv="${inv.id}" title="Edit Invoice">âœï¸</button>
                    </div>
                </div>
            `;
        }

        function renderMenu() {
            if (state.menuPage === 'customers') return renderCustomersPage();
            if (state.menuPage === 'reports') return renderReportsPage();
            if (state.menuPage === 'recurring') return renderRecurringPage();
            if (state.menuPage === 'products') return renderProductsPage();
            if (state.menuPage === 'expenses') return renderExpensesPage();
            if (state.menuPage === 'settings') return renderSettingsPage();
            if (state.menuPage === 'reminders') return renderRemindersPage();
            if (state.menuPage === 'payments') return renderPaymentsPage();
            if (state.menuPage === 'quotes') return renderQuotesPage();
            if (state.menuPage === 'backup') return renderBackupPage();
            if (state.menuPage === 'billing') return renderBillingPage();

            const isDark = document.body.classList.contains('dark');
            const remindersEnabled = state.reminderSettings?.enabled;
            const recentPaymentsCount = state.paymentHistory.filter(p => {
                const date = new Date(p.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return date > weekAgo;
            }).length;
            const pendingQuotes = state.quotes.filter(q => q.status === 'pending').length;
            
            return `
                <div class="menu-section">Business</div>
                <div class="menu-grid">
                    <button class="menu-item" data-menu="quotes">
                        <div class="menu-icon">ðŸ“</div>
                        <div class="menu-text">Quotes & Estimates</div>
                        ${pendingQuotes > 0 ? `<div style="font-size:11px;padding:3px 8px;border-radius:10px;background:#fef3c7;color:#92400e;">${pendingQuotes} pending</div>` : '<div class="menu-arrow">â€º</div>'}
                    </button>
                    <button class="menu-item" data-menu="customers">
                        <div class="menu-icon">ðŸ‘¥</div>
                        <div class="menu-text">Customers</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="payments">
                        <div class="menu-icon">ðŸ’°</div>
                        <div class="menu-text">Payment History</div>
                        ${recentPaymentsCount > 0 ? `<div style="font-size:11px;padding:3px 8px;border-radius:10px;background:#dcfce7;color:#166534;">${recentPaymentsCount} this week</div>` : '<div class="menu-arrow">â€º</div>'}
                    </button>
                    <button class="menu-item" data-menu="products">
                        <div class="menu-icon">ðŸ“¦</div>
                        <div class="menu-text">Products & Services</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="expenses">
                        <div class="menu-icon">ðŸ’¸</div>
                        <div class="menu-text">Expenses</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="reports">
                        <div class="menu-icon">ðŸ“Š</div>
                        <div class="menu-text">Reports & Analytics</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="recurring">
                        <div class="menu-icon">ðŸ”„</div>
                        <div class="menu-text">Recurring Invoices</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                </div>

                <div class="menu-section">Settings</div>
                <div class="menu-grid">
                    <button class="menu-item" data-menu="reminders">
                        <div class="menu-icon">â°</div>
                        <div class="menu-text">Auto Reminders</div>
                        <div style="font-size:11px;padding:3px 8px;border-radius:10px;background:${remindersEnabled ? '#dcfce7' : '#fee2e2'};color:${remindersEnabled ? '#166534' : '#dc2626'};">${remindersEnabled ? 'ON' : 'OFF'}</div>
                    </button>
                    <button class="menu-item" data-menu="settings">
                        <div class="menu-icon">âš™ï¸</div>
                        <div class="menu-text">Business Profile</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" data-menu="billing">
                        <div class="menu-icon">ðŸ’³</div>
                        <div class="menu-text">Plan & Billing</div>
                        <div style="font-size:11px;padding:3px 8px;border-radius:10px;background:#eff6ff;color:#3b82f6;">${state.subscription?.plan?.display_name || 'Free'}</div>
                    </button>
                    <button class="menu-item" data-menu="backup">
                        <div class="menu-icon">ðŸ’¾</div>
                        <div class="menu-text">Backup & Restore</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <button class="menu-item" id="btn-export">
                        <div class="menu-icon">ðŸ“¥</div>
                        <div class="menu-text">Export to CSV</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                    <div class="menu-item" id="dark-toggle">
                        <div class="menu-icon">ðŸŒ™</div>
                        <div class="menu-text">Dark Mode</div>
                        <div class="menu-toggle ${isDark ? 'active' : ''}"></div>
                    </div>
                    <button class="menu-item" id="btn-logout" style="color: #dc2626;">
                        <div class="menu-icon">ðŸšª</div>
                        <div class="menu-text" style="color: #dc2626;">Logout</div>
                        <div class="menu-arrow">â€º</div>
                    </button>
                </div>
                
                <div class="menu-section">About</div>
                <div class="menu-grid">
                    <a href="owo-mi-landing.html" class="menu-item" style="text-decoration:none;color:inherit;">
                        <div class="menu-icon">ðŸ </div>
                        <div class="menu-text">Visit Website</div>
                        <div class="menu-arrow">â€º</div>
                    </a>
                    <a href="https://wa.me/2348000000000" class="menu-item" style="text-decoration:none;color:inherit;" target="_blank">
                        <div class="menu-icon">ðŸ’¬</div>
                        <div class="menu-text">WhatsApp Support</div>
                        <div class="menu-arrow">â€º</div>
                    </a>
                    <div class="menu-item" style="opacity:0.7;">
                        <div class="menu-icon">ðŸ“±</div>
                        <div class="menu-text">Version 1.0.0</div>
                        <div class="menu-arrow"></div>
                    </div>
                </div>
            `;
        }

        function renderCustomersPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">Customers</div>
                    <button class="section-link" id="btn-add-customer">+ Add</button>
                </div>
                ${state.customers.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ‘¥</div>No customers yet</div>' :
                    state.customers.map(cust => {
                        const owed = state.invoices.filter(i => i.customer_id === cust.id).reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                        const invoiceCount = state.invoices.filter(i => i.customer_id === cust.id).length;
                        return `
                            <div class="customer-card">
                                <div class="customer-info">
                                    <div>
                                        <div class="customer-name">${cust.name}</div>
                                        <div class="customer-phone">${cust.phone} â€¢ ${invoiceCount} invoice(s)</div>
                                    </div>
                                    <div class="customer-balance" style="color: ${owed > 0 ? '#dc2626' : '#16a34a'}">
                                        ${owed > 0 ? 'Owes ' + formatNaira(owed) : 'Clear âœ“'}
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <button class="card-btn btn-whatsapp" data-share-portal="${cust.id}" title="Share payment portal link">ðŸ”— Portal</button>
                                    <button class="card-btn btn-pdf" data-statement="${cust.id}">ðŸ“‹ Statement</button>
                                    <button class="card-btn btn-edit" data-edit-cust="${cust.id}">âœï¸ Edit</button>
                                    <button class="card-btn btn-sms" data-delete-cust="${cust.id}">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderReportsPage() {
            const totalInvoiced = state.invoices.reduce((s, i) => s + Number(i.amount), 0);
            const totalCollected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            const collectionRate = totalInvoiced > 0 ? ((totalCollected / totalInvoiced) * 100).toFixed(1) : 0;
            const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
            const overdueAmount = overdueInvoices.reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);
            
            const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
            const profit = totalCollected - totalExpenses;
            
            // Monthly breakdown - current month
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthlyRevenue = state.invoices.filter(i => {
                const d = new Date(i.created_at);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).reduce((s, i) => s + Number(i.amount_paid), 0);
            const monthlyExpenses = state.expenses.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).reduce((s, e) => s + Number(e.amount), 0);
            const monthlyProfit = monthlyRevenue - monthlyExpenses;

            // Monthly trends - last 6 months
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyTrends = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const month = d.getMonth();
                const year = d.getFullYear();
                
                const revenue = state.invoices.filter(inv => {
                    const invDate = new Date(inv.created_at);
                    return invDate.getMonth() === month && invDate.getFullYear() === year;
                }).reduce((s, inv) => s + Number(inv.amount_paid), 0);
                
                const expenses = state.expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() === month && expDate.getFullYear() === year;
                }).reduce((s, exp) => s + Number(exp.amount), 0);
                
                monthlyTrends.push({
                    label: monthNames[month],
                    revenue,
                    expenses,
                    profit: revenue - expenses
                });
            }
            const maxTrendValue = Math.max(...monthlyTrends.map(m => Math.max(m.revenue, m.expenses)), 1);

            // Best customers with payment speed
            const bestCustomers = state.customers.map(c => {
                const custInv = state.invoices.filter(i => i.customer_id === c.id);
                const paidInvoices = custInv.filter(i => i.amount_paid >= i.amount);
                let avgPayDays = 0;
                if (paidInvoices.length > 0) {
                    const totalDays = paidInvoices.reduce((s, inv) => {
                        const created = new Date(inv.created_at);
                        const paid = new Date(inv.paid_date || inv.created_at);
                        return s + Math.max(0, (paid - created) / (1000 * 60 * 60 * 24));
                    }, 0);
                    avgPayDays = Math.round(totalDays / paidInvoices.length);
                }
                return { 
                    name: c.name, 
                    total: custInv.reduce((s, i) => s + Number(i.amount_paid), 0),
                    invoiceCount: custInv.length,
                    avgPayDays
                };
            }).filter(c => c.total > 0).sort((a, b) => b.total - a.total).slice(0, 5);

            // Top debtors
            const customerDebts = state.customers.map(c => {
                const custInv = state.invoices.filter(i => i.customer_id === c.id);
                const overdueCount = custInv.filter(i => getStatus(i) === 'overdue').length;
                return { 
                    name: c.name, 
                    owed: custInv.reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0),
                    overdueCount
                };
            }).filter(c => c.owed > 0).sort((a, b) => b.owed - a.owed).slice(0, 5);
            
            // Product/Service performance
            const productStats = {};
            state.invoices.forEach(inv => {
                if (inv.items && inv.items.length > 0) {
                    inv.items.forEach(item => {
                        const key = item.name.toLowerCase().trim();
                        if (!productStats[key]) {
                            productStats[key] = { name: item.name, qty: 0, revenue: 0, count: 0 };
                        }
                        productStats[key].qty += Number(item.qty) || 1;
                        productStats[key].revenue += (Number(item.qty) || 1) * Number(item.price);
                        productStats[key].count++;
                    });
                }
            });
            const topProducts = Object.values(productStats).sort((a, b) => b.revenue - a.revenue).slice(0, 5);
            const maxProductRevenue = topProducts.length > 0 ? topProducts[0].revenue : 1;

            // Cash flow forecast - next 30 days
            const today = new Date();
            const next7 = new Date(today); next7.setDate(next7.getDate() + 7);
            const next14 = new Date(today); next14.setDate(next14.getDate() + 14);
            const next30 = new Date(today); next30.setDate(next30.getDate() + 30);
            
            const unpaidInvoices = state.invoices.filter(i => i.amount_paid < i.amount);
            
            const forecast7 = unpaidInvoices.filter(i => new Date(i.due_date) <= next7)
                .reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);
            const forecast14 = unpaidInvoices.filter(i => new Date(i.due_date) <= next14)
                .reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);
            const forecast30 = unpaidInvoices.filter(i => new Date(i.due_date) <= next30)
                .reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);
            const overdueTotal = overdueInvoices.reduce((s, i) => s + (Number(i.amount) - Number(i.amount_paid)), 0);

            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 16px;">ðŸ“Š Business Intelligence</div>

                <!-- Profit/Loss Dashboard -->
                <div class="report-card" style="background:linear-gradient(135deg,${profit >= 0 ? '#dcfce7' : '#fee2e2'},white);border:2px solid ${profit >= 0 ? '#16a34a' : '#dc2626'};">
                    <div class="report-title">ðŸ’° Profit & Loss Dashboard</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                        <div style="text-align:center;padding:16px;background:rgba(255,255,255,0.7);border-radius:12px;">
                            <div style="font-size:12px;color:#666;margin-bottom:4px;">Total Revenue</div>
                            <div style="font-size:24px;font-weight:700;color:#16a34a;">${formatNaira(totalCollected)}</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:rgba(255,255,255,0.7);border-radius:12px;">
                            <div style="font-size:12px;color:#666;margin-bottom:4px;">Total Expenses</div>
                            <div style="font-size:24px;font-weight:700;color:#dc2626;">${formatNaira(totalExpenses)}</div>
                        </div>
                    </div>
                    <div style="text-align:center;padding:20px;background:${profit >= 0 ? '#16a34a' : '#dc2626'};border-radius:12px;color:white;">
                        <div style="font-size:14px;opacity:0.9;">Net Profit</div>
                        <div style="font-size:32px;font-weight:700;">${profit >= 0 ? '+' : ''}${formatNaira(profit)}</div>
                        <div style="font-size:12px;opacity:0.8;margin-top:4px;">
                            ${totalCollected > 0 ? `${((profit / totalCollected) * 100).toFixed(1)}% margin` : ''}
                        </div>
                    </div>
                </div>

                <!-- Monthly Trends Chart -->
                <div class="report-card">
                    <div class="report-title">ðŸ“ˆ Monthly Trends (Last 6 Months)</div>
                    <div style="display:flex;align-items:flex-end;justify-content:space-between;height:150px;padding:10px 0;border-bottom:1px solid #eee;">
                        ${monthlyTrends.map(m => `
                            <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">
                                <div style="display:flex;gap:2px;align-items:flex-end;height:100px;">
                                    <div style="width:12px;background:#16a34a;border-radius:4px 4px 0 0;height:${Math.max(2, (m.revenue / maxTrendValue) * 100)}px;" title="Revenue: ${formatNaira(m.revenue)}"></div>
                                    <div style="width:12px;background:#dc2626;border-radius:4px 4px 0 0;height:${Math.max(2, (m.expenses / maxTrendValue) * 100)}px;" title="Expenses: ${formatNaira(m.expenses)}"></div>
                                </div>
                                <div style="font-size:11px;color:#666;">${m.label}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="display:flex;justify-content:center;gap:20px;margin-top:12px;font-size:12px;">
                        <span><span style="display:inline-block;width:12px;height:12px;background:#16a34a;border-radius:2px;margin-right:4px;"></span>Revenue</span>
                        <span><span style="display:inline-block;width:12px;height:12px;background:#dc2626;border-radius:2px;margin-right:4px;"></span>Expenses</span>
                    </div>
                    <div style="margin-top:16px;padding-top:12px;border-top:1px solid #eee;">
                        <div class="report-row"><span class="report-label">This Month Revenue</span><span class="report-value green">${formatNaira(monthlyRevenue)}</span></div>
                        <div class="report-row"><span class="report-label">This Month Expenses</span><span class="report-value red">${formatNaira(monthlyExpenses)}</span></div>
                        <div class="report-row"><span class="report-label">This Month Profit</span><span class="report-value" style="color:${monthlyProfit >= 0 ? '#16a34a' : '#dc2626'};">${monthlyProfit >= 0 ? '+' : ''}${formatNaira(monthlyProfit)}</span></div>
                    </div>
                </div>

                <!-- Cash Flow Forecast -->
                <div class="report-card" style="background:linear-gradient(135deg,#eff6ff,white);border:1px solid #3b82f6;">
                    <div class="report-title">ðŸ”® Cash Flow Forecast</div>
                    <p style="font-size:12px;color:#666;margin-bottom:16px;">Expected income from unpaid invoices</p>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                        <div style="background:white;padding:16px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;">
                            <div style="font-size:11px;color:#666;">Overdue</div>
                            <div style="font-size:20px;font-weight:700;color:#dc2626;">${formatNaira(overdueTotal)}</div>
                            <div style="font-size:10px;color:#999;">${overdueInvoices.length} invoice${overdueInvoices.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div style="background:white;padding:16px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;">
                            <div style="font-size:11px;color:#666;">Next 7 Days</div>
                            <div style="font-size:20px;font-weight:700;color:#f59e0b;">${formatNaira(forecast7)}</div>
                        </div>
                        <div style="background:white;padding:16px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;">
                            <div style="font-size:11px;color:#666;">Next 14 Days</div>
                            <div style="font-size:20px;font-weight:700;color:#3b82f6;">${formatNaira(forecast14)}</div>
                        </div>
                        <div style="background:white;padding:16px;border-radius:12px;text-align:center;border:1px solid #e5e7eb;">
                            <div style="font-size:11px;color:#666;">Next 30 Days</div>
                            <div style="font-size:20px;font-weight:700;color:#16a34a;">${formatNaira(forecast30)}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top:16px;padding:12px;background:#fef3c7;border-radius:8px;">
                        <div style="font-size:12px;color:#92400e;">ðŸ’¡ <strong>Tip:</strong> Follow up on overdue invoices to improve cash flow!</div>
                    </div>
                </div>

                <!-- Product Performance -->
                <div class="report-card">
                    <div class="report-title">ðŸ“¦ Product/Service Performance</div>
                    ${topProducts.length === 0 ? '<div style="color:#999;padding:20px 0;text-align:center;">No product data yet.<br>Create invoices with line items to see performance.</div>' : `
                        <div style="margin-bottom:8px;">
                            ${topProducts.map((p, i) => `
                                <div style="margin-bottom:12px;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                                        <span style="font-size:13px;font-weight:600;">${i + 1}. ${p.name}</span>
                                        <span style="font-size:14px;font-weight:700;color:#16a34a;">${formatNaira(p.revenue)}</span>
                                    </div>
                                    <div style="background:#e5e7eb;height:8px;border-radius:4px;overflow:hidden;">
                                        <div style="background:linear-gradient(90deg,#3b82f6,#60a5fa);height:100%;width:${(p.revenue / maxProductRevenue) * 100}%;border-radius:4px;"></div>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:11px;color:#666;margin-top:4px;">
                                        <span>${p.qty} units sold</span>
                                        <span>${p.count} invoice${p.count !== 1 ? 's' : ''}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>

                <!-- Best Customers -->
                <div class="report-card">
                    <div class="report-title">â­ Best Customers</div>
                    ${bestCustomers.length === 0 ? '<div style="color:#999;padding:10px 0;">No payments recorded yet</div>' : `
                        <div style="overflow-x:auto;">
                            <table style="width:100%;font-size:13px;border-collapse:collapse;">
                                <thead>
                                    <tr style="border-bottom:2px solid #e5e7eb;">
                                        <th style="text-align:left;padding:8px 4px;font-weight:600;">Customer</th>
                                        <th style="text-align:right;padding:8px 4px;font-weight:600;">Total Paid</th>
                                        <th style="text-align:center;padding:8px 4px;font-weight:600;">Invoices</th>
                                        <th style="text-align:center;padding:8px 4px;font-weight:600;">Avg Pay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${bestCustomers.map((c, i) => `
                                        <tr style="border-bottom:1px solid #f3f4f6;">
                                            <td style="padding:10px 4px;">
                                                <span style="display:inline-block;width:20px;height:20px;background:${i === 0 ? '#fbbf24' : i === 1 ? '#9ca3af' : i === 2 ? '#cd7f32' : '#e5e7eb'};color:${i < 3 ? 'white' : '#666'};border-radius:50%;text-align:center;line-height:20px;font-size:11px;margin-right:8px;">${i + 1}</span>
                                                ${c.name}
                                            </td>
                                            <td style="text-align:right;padding:10px 4px;color:#16a34a;font-weight:600;">${formatNaira(c.total)}</td>
                                            <td style="text-align:center;padding:10px 4px;">${c.invoiceCount}</td>
                                            <td style="text-align:center;padding:10px 4px;">
                                                <span style="background:${c.avgPayDays <= 7 ? '#dcfce7' : c.avgPayDays <= 14 ? '#fef3c7' : '#fee2e2'};color:${c.avgPayDays <= 7 ? '#166534' : c.avgPayDays <= 14 ? '#92400e' : '#dc2626'};padding:2px 8px;border-radius:10px;font-size:11px;">
                                                    ${c.avgPayDays}d
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>

                <!-- Top Debtors -->
                <div class="report-card">
                    <div class="report-title">ðŸ”´ Top Debtors</div>
                    ${customerDebts.length === 0 ? '<div style="color:#999;padding:10px 0;text-align:center;">No outstanding debts! ðŸŽ‰</div>' :
                        customerDebts.map((c, i) => `
                            <div class="report-row" style="padding:12px 0;${i < customerDebts.length - 1 ? 'border-bottom:1px solid #f3f4f6;' : ''}">
                                <span class="report-label">
                                    ${i + 1}. ${c.name}
                                    ${c.overdueCount > 0 ? `<span style="background:#fee2e2;color:#dc2626;padding:2px 6px;border-radius:8px;font-size:10px;margin-left:6px;">${c.overdueCount} overdue</span>` : ''}
                                </span>
                                <span class="report-value red">${formatNaira(c.owed)}</span>
                            </div>
                        `).join('')}
                </div>

                <!-- Revenue Summary -->
                <div class="report-card">
                    <div class="report-title">ðŸ“‹ Revenue Summary</div>
                    <div class="report-row"><span class="report-label">Total Invoiced</span><span class="report-value">${formatNaira(totalInvoiced)}</span></div>
                    <div class="report-row"><span class="report-label">Total Collected</span><span class="report-value green">${formatNaira(totalCollected)}</span></div>
                    <div class="report-row"><span class="report-label">Outstanding</span><span class="report-value red">${formatNaira(totalInvoiced - totalCollected)}</span></div>
                    <div class="report-row"><span class="report-label">Collection Rate</span>
                        <span class="report-value">
                            <span style="background:${collectionRate >= 80 ? '#dcfce7' : collectionRate >= 50 ? '#fef3c7' : '#fee2e2'};color:${collectionRate >= 80 ? '#166534' : collectionRate >= 50 ? '#92400e' : '#dc2626'};padding:4px 10px;border-radius:10px;">
                                ${collectionRate}%
                            </span>
                        </span>
                    </div>
                    <div class="report-row"><span class="report-label">Overdue Invoices</span><span class="report-value red">${overdueInvoices.length}</span></div>
                </div>
            `;
        }

        function renderQuotesPage() {
            const sortedQuotes = [...state.quotes].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ“ Quotes & Estimates</div>
                    <button class="section-link" id="btn-add-quote">+ New Quote</button>
                </div>
                <p style="color:#666;font-size:14px;margin-bottom:16px;">Create quotes for customers. Convert to invoice when approved!</p>
                
                ${sortedQuotes.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“</div>No quotes yet.<br>Create your first quote!</div>' :
                    sortedQuotes.map(quote => {
                        const cust = state.customers.find(c => c.id === quote.customer_id);
                        const statusColors = { pending: '#f59e0b', approved: '#16a34a', declined: '#dc2626', converted: '#3b82f6' };
                        return `
                            <div class="card">
                                <div class="card-top">
                                    <div>
                                        <div class="card-name">${cust?.name || 'Unknown'}</div>
                                        <div class="card-desc">${quote.description}</div>
                                        <div class="card-date">${formatDate(quote.created_at)} â€¢ Valid ${quote.valid_days || 30} days</div>
                                    </div>
                                    <div class="card-amount">
                                        ${formatNaira(quote.amount)}
                                        <div class="badge" style="background:${statusColors[quote.status]}20;color:${statusColors[quote.status]};">${quote.status.charAt(0).toUpperCase() + quote.status.slice(1)}</div>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="card-btn btn-pdf" data-quote-pdf="${quote.id}">ðŸ“„ PDF</button>
                                    ${quote.status === 'pending' ? `<button class="card-btn btn-pay" data-convert-quote="${quote.id}">âœ… Convert to Invoice</button>` : ''}
                                    ${quote.status === 'pending' ? `<button class="card-btn btn-whatsapp" data-quote-status="${quote.id}" data-status="approved">ðŸ‘</button>` : ''}
                                    ${quote.status === 'pending' ? `<button class="card-btn btn-sms" data-quote-status="${quote.id}" data-status="declined">ðŸ‘Ž</button>` : ''}
                                    <button class="card-btn btn-edit" data-delete-quote="${quote.id}">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderBackupPage() {
            const dataSize = JSON.stringify({
                customers: state.customers,
                invoices: state.invoices,
                quotes: state.quotes,
                products: state.products,
                expenses: state.expenses,
                businessProfile: state.businessProfile,
                paymentHistory: state.paymentHistory,
                recurringTemplates: state.recurringTemplates,
                reminderSettings: state.reminderSettings,
                invoiceTemplate: state.invoiceTemplate
            }).length;
            const sizeKB = (dataSize / 1024).toFixed(1);
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 16px;">ðŸ’¾ Backup & Restore</div>
                <p style="color:#666;font-size:14px;margin-bottom:20px;">Keep your data safe by backing up regularly</p>
                
                <div class="report-card">
                    <div class="report-title">ðŸ“Š Your Data</div>
                    <div class="report-row"><span class="report-label">Customers</span><span class="report-value">${state.customers.length}</span></div>
                    <div class="report-row"><span class="report-label">Invoices</span><span class="report-value">${state.invoices.length}</span></div>
                    <div class="report-row"><span class="report-label">Quotes</span><span class="report-value">${state.quotes.length}</span></div>
                    <div class="report-row"><span class="report-label">Products</span><span class="report-value">${state.products.length}</span></div>
                    <div class="report-row"><span class="report-label">Expenses</span><span class="report-value">${state.expenses.length}</span></div>
                    <div class="report-row"><span class="report-label">Payment Records</span><span class="report-value">${state.paymentHistory.length}</span></div>
                    <div class="report-row" style="border-top:1px solid #eee;margin-top:8px;padding-top:8px;"><span class="report-label">Total Size</span><span class="report-value">${sizeKB} KB</span></div>
                </div>

                <div class="card" style="padding:20px;margin-bottom:16px;">
                    <div style="font-weight:600;margin-bottom:12px;">ðŸ“¥ Backup Data</div>
                    <p style="font-size:13px;color:#666;margin-bottom:16px;">Download all your data as a file. Save it to Google Drive, WhatsApp, or your device.</p>
                    <button class="btn btn-primary" id="btn-backup" style="width:100%;">ðŸ’¾ Download Backup</button>
                </div>

                <div class="card" style="padding:20px;">
                    <div style="font-weight:600;margin-bottom:12px;">ðŸ“¤ Restore Data</div>
                    <p style="font-size:13px;color:#666;margin-bottom:16px;">Upload a backup file to restore your data. This will replace all current data.</p>
                    <input type="file" id="restore-input" accept=".json" style="display:none;">
                    <button class="btn btn-secondary" id="btn-restore" style="width:100%;">ðŸ“‚ Select Backup File</button>
                </div>

                <div style="background:#fef3c7;padding:16px;border-radius:12px;margin-top:16px;">
                    <div style="font-weight:600;color:#92400e;margin-bottom:8px;">âš ï¸ Important</div>
                    <ul style="font-size:13px;color:#78350f;margin-left:16px;">
                        <li>Backup regularly to avoid data loss</li>
                        <li>Store backups in multiple places</li>
                        <li>Restoring will replace ALL current data</li>
                    </ul>
                </div>
            `;
        }

        function renderBillingPage() {
            const plan = state.subscription?.plan;
            const planName = plan?.display_name || 'Free';
            const isFreePlan = plan?.name === 'free' || !plan;
            
            // Current usage
            const usage = {
                customers: { current: state.customers.length, limit: plan?.max_customers || 5 },
                invoices: { current: state.subscription?.invoices_this_month || 0, limit: plan?.max_invoices_per_month || 10 },
                quotes: { current: state.subscription?.quotes_this_month || 0, limit: plan?.max_quotes_per_month || 5 },
                products: { current: state.products.length, limit: plan?.max_products || 10 },
                sms: { current: state.subscription?.sms_this_month || 0, limit: plan?.max_sms_per_month || 0 }
            };
            
            const renderUsageBar = (label, current, limit) => {
                const isUnlimited = limit === -1;
                const percentage = isUnlimited ? 20 : Math.min(100, (current / limit) * 100);
                const color = percentage > 90 ? '#dc2626' : percentage > 70 ? '#f59e0b' : '#22c55e';
                
                return `
                    <div style="margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span style="font-size:14px;color:#666;">${label}</span>
                            <span style="font-size:14px;font-weight:600;">
                                ${current} / ${isUnlimited ? 'âˆž' : limit}
                            </span>
                        </div>
                        <div style="height:8px;background:#e5e5e5;border-radius:4px;overflow:hidden;">
                            <div style="height:100%;width:${percentage}%;background:${isUnlimited ? '#3b82f6' : color};border-radius:4px;transition:width 0.3s;"></div>
                        </div>
                    </div>
                `;
            };
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                
                <div class="section-header">
                    <div class="section-title">ðŸ’³ Plan & Billing</div>
                </div>
                
                <!-- Current Plan Card -->
                <div style="background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:20px;padding:24px;color:white;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <div style="font-size:14px;opacity:0.9;">Current Plan</div>
                            <div style="font-size:28px;font-weight:700;margin:4px 0;">${planName}</div>
                            ${!isFreePlan ? `
                                <div style="font-size:13px;opacity:0.9;">
                                    â‚¦${(plan?.price_monthly || 0).toLocaleString()}/month
                                </div>
                            ` : `
                                <div style="font-size:13px;opacity:0.9;">Forever free</div>
                            `}
                        </div>
                        <div style="font-size:48px;">${isFreePlan ? 'ðŸ†“' : plan?.name === 'starter' ? 'â­' : 'ðŸš€'}</div>
                    </div>
                    
                    ${isFreePlan ? `
                        <button class="btn" id="btn-upgrade" style="margin-top:20px;background:white;color:#3b82f6;width:100%;font-weight:600;">
                            ðŸš€ Upgrade Now
                        </button>
                    ` : `
                        <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.3);font-size:13px;">
                            <span style="opacity:0.9;">Renews:</span> 
                            <span style="font-weight:500;">${state.subscription?.currentPeriodEnd ? new Date(state.subscription.currentPeriodEnd).toLocaleDateString() : 'N/A'}</span>
                        </div>
                    `}
                </div>
                
                <!-- Usage Section -->
                <div style="background:white;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:24px;">
                    <h3 style="margin:0 0 20px;font-size:16px;">ðŸ“Š This Month's Usage</h3>
                    
                    ${renderUsageBar('Customers', usage.customers.current, usage.customers.limit)}
                    ${renderUsageBar('Invoices', usage.invoices.current, usage.invoices.limit)}
                    ${renderUsageBar('Quotes', usage.quotes.current, usage.quotes.limit)}
                    ${renderUsageBar('Products', usage.products.current, usage.products.limit)}
                    ${renderUsageBar('SMS Reminders', usage.sms.current, usage.sms.limit)}
                    
                    <p style="color:#666;font-size:12px;margin:16px 0 0;text-align:center;">
                        Usage resets on the 1st of each month
                    </p>
                </div>
                
                <!-- Features Section -->
                <div style="background:white;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:24px;">
                    <h3 style="margin:0 0 16px;font-size:16px;">âœ¨ Plan Features</h3>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        ${[
                            { name: 'Expense Tracking', key: 'has_expense_tracking' },
                            { name: 'Auto Reminders', key: 'has_auto_reminders' },
                            { name: 'Customer Portal', key: 'has_customer_portal' },
                            { name: 'Paystack Integration', key: 'has_paystack_integration' },
                            { name: 'Multiple Templates', key: 'has_multiple_templates' },
                            { name: 'Custom Colors', key: 'has_custom_colors' },
                            { name: 'Logo Upload', key: 'has_logo_upload' },
                            { name: 'Remove Branding', key: 'has_remove_branding' },
                            { name: 'Export Reports', key: 'has_reports_export' },
                            { name: 'Priority Support', key: 'has_priority_support' }
                        ].map(f => {
                            const hasIt = plan?.[f.key] || false;
                            return `
                                <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:${hasIt ? '#166534' : '#999'};">
                                    <span>${hasIt ? 'âœ“' : 'âœ—'}</span>
                                    <span style="${hasIt ? '' : 'text-decoration:line-through;'}">${f.name}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Compare Plans -->
                ${isFreePlan ? `
                    <div style="background:white;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:24px;">
                        <h3 style="margin:0 0 16px;font-size:16px;">ðŸ“ˆ Upgrade for More</h3>
                        
                        <div style="display:flex;flex-direction:column;gap:12px;">
                            ${state.plans.filter(p => p.name !== 'free').map(p => `
                                <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border:1px solid #e5e5e5;border-radius:12px;">
                                    <div>
                                        <div style="font-weight:600;">${p.display_name}</div>
                                        <div style="color:#666;font-size:13px;">
                                            ${p.max_customers === -1 ? 'Unlimited' : p.max_customers} customers, 
                                            ${p.max_invoices_per_month === -1 ? 'Unlimited' : p.max_invoices_per_month} invoices
                                        </div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-weight:700;color:#3b82f6;">â‚¦${p.price_monthly.toLocaleString()}</div>
                                        <div style="font-size:11px;color:#666;">/month</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn btn-primary" id="btn-upgrade-bottom" style="width:100%;margin-top:16px;">
                            Compare Plans & Upgrade
                        </button>
                    </div>
                ` : `
                    <div style="background:white;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:24px;">
                        <h3 style="margin:0 0 16px;font-size:16px;">ðŸ”§ Manage Subscription</h3>
                        
                        <div style="display:flex;flex-direction:column;gap:12px;">
                            <button class="btn" id="btn-change-plan" style="width:100%;">
                                Change Plan
                            </button>
                            <button class="btn" id="btn-cancel-plan" style="width:100%;background:#fee2e2;color:#dc2626;">
                                Cancel Subscription
                            </button>
                        </div>
                        
                        <p style="color:#666;font-size:12px;margin:16px 0 0;text-align:center;">
                            Need help? Contact support@owomi.com
                        </p>
                    </div>
                `}
            `;
        }

        function renderRecurringPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ”„ Recurring</div>
                    <button class="section-link" id="btn-add-recurring">+ Add</button>
                </div>
                ${state.recurringTemplates.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ”„</div>No recurring invoices yet.<br>Auto-generate invoices monthly!</div>' :
                    state.recurringTemplates.map(tmpl => {
                        const cust = state.customers.find(c => c.id === tmpl.customerId);
                        return `
                            <div class="card">
                                <div class="card-top">
                                    <div>
                                        <div class="card-name">${cust?.name || 'Unknown'}<span class="recurring-badge">${tmpl.frequency}</span></div>
                                        <div class="card-desc">${tmpl.description}</div>
                                    </div>
                                    <div class="card-amount">
                                        ${formatNaira(tmpl.amount)}
                                        <div class="badge ${tmpl.active ? 'badge-paid' : 'badge-pending'}">${tmpl.active ? 'Active' : 'Paused'}</div>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="card-btn btn-pay" data-generate="${tmpl.id}">âš¡ Generate</button>
                                    <button class="card-btn btn-edit" data-toggle-rec="${tmpl.id}">${tmpl.active ? 'â¸ï¸' : 'â–¶ï¸'}</button>
                                    <button class="card-btn btn-pdf" data-delete-rec="${tmpl.id}">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
            `;
        }

        function renderProductsPage() {
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ“¦ Products & Services</div>
                    <button class="section-link" id="btn-add-product">+ Add</button>
                </div>
                <p style="color:#666;font-size:14px;margin-bottom:16px;">Save your common products/services for quick invoicing</p>
                ${state.products.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ“¦</div>No products yet.<br>Add products to speed up invoicing!</div>' :
                    state.products.map(prod => `
                        <div class="card">
                            <div class="card-top">
                                <div>
                                    <div class="card-name">${prod.name}</div>
                                    <div class="card-desc">${prod.description || 'No description'}</div>
                                </div>
                                <div class="card-amount">
                                    ${formatNaira(prod.price)}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn btn-edit" data-edit-prod="${prod.id}">âœï¸ Edit</button>
                                <button class="card-btn btn-pdf" data-delete-prod="${prod.id}">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `).join('')}
            `;
        }

        function renderExpensesPage() {
            const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
            const categories = [...new Set(state.expenses.map(e => e.category))];
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-header">
                    <div class="section-title">ðŸ’¸ Expenses</div>
                    <button class="section-link" id="btn-add-expense">+ Add</button>
                </div>
                
                <div class="stat" style="margin-bottom:16px;">
                    <div class="stat-label">Total Expenses (This Month)</div>
                    <div class="stat-value red">${formatNaira(totalExpenses)}</div>
                </div>
                
                ${categories.length > 0 ? `
                <div class="report-card" style="margin-bottom:16px;">
                    <div class="report-title">ðŸ“Š By Category</div>
                    ${categories.map(cat => {
                        const catTotal = state.expenses.filter(e => e.category === cat).reduce((s, e) => s + Number(e.amount), 0);
                        return `<div class="report-row"><span class="report-label">${cat}</span><span class="report-value red">${formatNaira(catTotal)}</span></div>`;
                    }).join('')}
                </div>
                ` : ''}
                
                ${state.expenses.length === 0 ? 
                    '<div class="empty"><div class="empty-icon">ðŸ’¸</div>No expenses recorded.<br>Track your costs to see real profit!</div>' :
                    state.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => `
                        <div class="card">
                            <div class="card-top">
                                <div>
                                    <div class="card-name">${exp.description}</div>
                                    <div class="card-desc">${exp.category || 'Uncategorized'}</div>
                                    <div class="card-date">${formatDate(exp.date)}</div>
                                </div>
                                <div class="card-amount" style="color:#dc2626;">
                                    -${formatNaira(exp.amount)}
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="card-btn btn-edit" data-edit-exp="${exp.id}">âœï¸ Edit</button>
                                <button class="card-btn btn-pdf" data-delete-exp="${exp.id}">ðŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `).join('')}
            `;
        }

        function renderSettingsPage() {
            const p = state.businessProfile;
            const r = state.reminderSettings || { before_due_days: 3, on_due_date: true, after_due_days: [3, 7], enabled: false };
            const t = state.invoiceTemplate || { color: '#3b82f6', style: 'modern' };
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 16px;">âš™ï¸ Business Profile</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">This info appears on your PDF invoices</p>
                
                <!-- Logo Upload -->
                <div class="form-group">
                    <label class="form-label">Business Logo</label>
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:8px;">
                        <div id="logo-preview" style="width:80px;height:80px;border-radius:12px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f9f9f9;">
                            ${p.logo ? `<img src="${p.logo}" style="max-width:100%;max-height:100%;object-fit:contain;">` : '<span style="font-size:32px;">ðŸ¢</span>'}
                        </div>
                        <div>
                            <input type="file" id="logo-input" accept="image/*" style="display:none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('logo-input').click()" style="padding:10px 16px;font-size:13px;">ðŸ“· Upload Logo</button>
                            ${p.logo ? `<button class="btn" onclick="removeLogo()" style="padding:10px 16px;font-size:13px;color:#dc2626;margin-left:8px;">Remove</button>` : ''}
                            <div style="font-size:12px;color:#888;margin-top:6px;">PNG, JPG up to 500KB</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Business Name</label>
                    <input type="text" class="form-input" id="set-name" value="${p.name || ''}" placeholder="Your Business Name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-input" id="set-phone" value="${p.phone || ''}" placeholder="08012345678">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="set-email" value="${p.email || ''}" placeholder="business@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="set-address" value="${p.address || ''}" placeholder="Business Address">
                </div>
                <div class="form-group">
                    <label class="form-label">Bank Details</label>
                    <textarea class="form-input" id="set-bank" rows="3" placeholder="Bank Name&#10;Account Number&#10;Account Name">${p.bank || ''}</textarea>
                </div>

                <!-- Payment QR Code -->
                <div class="form-group">
                    <label class="form-label">Payment QR Code (Optional)</label>
                    <p style="font-size:12px;color:#666;margin-bottom:12px;">Upload your OPay, bank app, or any payment QR code</p>
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div id="qr-preview" style="width:120px;height:120px;border-radius:12px;border:2px dashed #ddd;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#f9f9f9;">
                            ${p.paymentQR ? `<img src="${p.paymentQR}" style="max-width:100%;max-height:100%;object-fit:contain;">` : '<span style="font-size:40px;">ðŸ“±</span>'}
                        </div>
                        <div>
                            <input type="file" id="qr-input" accept="image/*" style="display:none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('qr-input').click()" style="padding:10px 16px;font-size:13px;">ðŸ“· Upload QR</button>
                            ${p.paymentQR ? `<button class="btn" onclick="removeQRCode()" style="padding:10px 16px;font-size:13px;color:#dc2626;margin-left:8px;">Remove</button>` : ''}
                            <div style="font-size:11px;color:#888;margin-top:6px;">PNG, JPG up to 500KB</div>
                            <div style="font-size:11px;color:#3b82f6;margin-top:4px;">ðŸ’¡ Screenshot your OPay/Bank QR</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-settings" style="margin-top:16px;">Save Business Settings</button>

                <!-- Invoice Template Customization -->
                <div class="section-title" style="margin: 32px 0 16px;">ðŸŽ¨ Invoice Template</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">Customize how your invoices look</p>
                
                <div class="card" style="padding:20px;">
                    <div class="form-group">
                        <label class="form-label">Brand Color</label>
                        <div style="display:flex;gap:12px;flex-wrap:wrap;">
                            ${['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#1a1a2e'].map(c => `
                                <div onclick="selectTemplateColor('${c}')" style="width:40px;height:40px;border-radius:10px;background:${c};cursor:pointer;border:3px solid ${t.color === c ? '#333' : 'transparent'};transition:all 0.2s;"></div>
                            `).join('')}
                            <input type="color" id="custom-color" value="${t.color}" onchange="selectTemplateColor(this.value)" style="width:40px;height:40px;border:none;border-radius:10px;cursor:pointer;">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:20px;">
                        <label class="form-label">Invoice Style</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div onclick="selectTemplateStyle('modern')" class="template-option ${t.style === 'modern' ? 'selected' : ''}" style="padding:16px;border:2px solid ${t.style === 'modern' ? '#3b82f6' : '#e5e5e5'};border-radius:12px;cursor:pointer;text-align:center;">
                                <div style="font-size:24px;margin-bottom:8px;">ðŸ“„</div>
                                <div style="font-weight:600;">Modern</div>
                                <div style="font-size:12px;color:#666;">Clean & minimal</div>
                            </div>
                            <div onclick="selectTemplateStyle('classic')" class="template-option ${t.style === 'classic' ? 'selected' : ''}" style="padding:16px;border:2px solid ${t.style === 'classic' ? '#3b82f6' : '#e5e5e5'};border-radius:12px;cursor:pointer;text-align:center;">
                                <div style="font-size:24px;margin-bottom:8px;">ðŸ“‹</div>
                                <div style="font-weight:600;">Classic</div>
                                <div style="font-size:12px;color:#666;">Traditional layout</div>
                            </div>
                            <div onclick="selectTemplateStyle('bold')" class="template-option ${t.style === 'bold' ? 'selected' : ''}" style="padding:16px;border:2px solid ${t.style === 'bold' ? '#3b82f6' : '#e5e5e5'};border-radius:12px;cursor:pointer;text-align:center;">
                                <div style="font-size:24px;margin-bottom:8px;">ðŸŽ¯</div>
                                <div style="font-weight:600;">Bold</div>
                                <div style="font-size:12px;color:#666;">Stand out</div>
                            </div>
                            <div onclick="selectTemplateStyle('minimal')" class="template-option ${t.style === 'minimal' ? 'selected' : ''}" style="padding:16px;border:2px solid ${t.style === 'minimal' ? '#3b82f6' : '#e5e5e5'};border-radius:12px;cursor:pointer;text-align:center;">
                                <div style="font-size:24px;margin-bottom:8px;">âœ¨</div>
                                <div style="font-weight:600;">Minimal</div>
                                <div style="font-size:12px;color:#666;">Simple & elegant</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:20px;">
                        <label class="form-label">Invoice Footer Note</label>
                        <textarea class="form-input" id="set-footer" rows="2" placeholder="Thank you for your business!">${p.footerNote || ''}</textarea>
                    </div>
                    
                    <div class="form-group" style="margin-top:16px;">
                        <label class="form-label">Terms & Conditions (optional)</label>
                        <textarea class="form-input" id="set-terms" rows="3" placeholder="E.g., Payment is due within 14 days. Late payments may incur a 5% fee.">${p.termsAndConditions || ''}</textarea>
                        <div style="font-size:11px;color:#888;margin-top:4px;">Appears at the bottom of invoices</div>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-template" style="margin-top:16px;">Save Template Settings</button>
                <button class="btn btn-secondary" id="btn-preview-invoice" style="margin-top:8px;">ðŸ‘ï¸ Preview Invoice</button>

                <div class="section-title" style="margin: 32px 0 16px;">ðŸ’³ Paystack (Optional)</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">Accept card payments in-person. Most Nigerian customers prefer bank transfer.</p>
                
                <div class="card" style="padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <div>
                            <div style="font-weight:600;">Enable Card Payments</div>
                            <div style="font-size:13px;color:#666;">Collect card/USSD payments on your device</div>
                        </div>
                        <div class="menu-toggle ${p.paystackEnabled ? 'active' : ''}" id="toggle-paystack"></div>
                    </div>

                    <div id="paystack-options" class="${p.paystackEnabled ? '' : 'hidden'}">
                        <div class="form-group">
                            <label class="form-label">Paystack Public Key</label>
                            <input type="text" class="form-input" id="set-paystack-public" value="${p.paystackPublicKey || ''}" placeholder="pk_live_xxxxxxxxxxxxxxxx">
                            <div style="font-size:11px;color:#888;margin-top:4px;">Starts with pk_live_ or pk_test_</div>
                        </div>
                        
                        <div style="background:#e0f2fe;padding:12px;border-radius:8px;margin-top:12px;">
                            <div style="font-weight:600;color:#0369a1;font-size:13px;">ðŸ’¡ How it works:</div>
                            <p style="font-size:12px;color:#0369a1;margin-top:4px;">A "ðŸ’³ Card" button appears on unpaid invoices. Tap it when customer is ready to pay with card or USSD.</p>
                        </div>
                        
                        <div style="background:#dcfce7;padding:12px;border-radius:8px;margin-top:12px;">
                            <div style="font-weight:600;color:#166534;font-size:13px;">ðŸ”’ Secure:</div>
                            <p style="font-size:12px;color:#166534;margin-top:4px;">Only your Public Key is needed. Money goes directly to your Paystack account.</p>
                        </div>
                        
                        <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:12px;">
                            <div style="font-weight:600;color:#92400e;font-size:13px;">ðŸ” Get your key:</div>
                            <ol style="font-size:12px;color:#92400e;margin:8px 0 0 16px;">
                                <li>Login to <a href="https://dashboard.paystack.com" target="_blank" style="color:#3b82f6;">dashboard.paystack.com</a></li>
                                <li>Go to Settings â†’ API Keys & Webhooks</li>
                                <li>Copy your <strong>Public Key</strong> only</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-paystack" style="margin-top:16px;">Save Paystack Settings</button>

                <div class="section-title" style="margin: 32px 0 16px;">ðŸ”” Auto Reminders</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">Automatically remind customers about unpaid invoices</p>
                
                <div class="card" style="padding:20px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <div>
                            <div style="font-weight:600;">Enable Auto Reminders</div>
                            <div style="font-size:13px;color:#666;">Send SMS reminders automatically</div>
                        </div>
                        <div class="menu-toggle ${r.enabled ? 'active' : ''}" id="toggle-reminders"></div>
                    </div>

                    <div id="reminder-options" class="${r.enabled ? '' : 'hidden'}">
                        <div class="form-group">
                            <label class="form-label">Days before due date</label>
                            <select class="form-input" id="rem-before">
                                <option value="1" ${r.before_due_days === 1 ? 'selected' : ''}>1 day before</option>
                                <option value="2" ${r.before_due_days === 2 ? 'selected' : ''}>2 days before</option>
                                <option value="3" ${r.before_due_days === 3 ? 'selected' : ''}>3 days before</option>
                                <option value="5" ${r.before_due_days === 5 ? 'selected' : ''}>5 days before</option>
                                <option value="7" ${r.before_due_days === 7 ? 'selected' : ''}>7 days before</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="rem-due" ${r.on_due_date ? 'checked' : ''} style="width:20px;height:20px;">
                                Remind on due date
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Overdue reminders</label>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-3" ${r.after_due_days?.includes(3) ? 'checked' : ''}> 3 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-7" ${r.after_due_days?.includes(7) ? 'checked' : ''}> 7 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-14" ${r.after_due_days?.includes(14) ? 'checked' : ''}> 14 days
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;font-size:14px;">
                                    <input type="checkbox" id="rem-over-30" ${r.after_due_days?.includes(30) ? 'checked' : ''}> 30 days
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" id="btn-save-reminders" style="margin-top:16px;">Save Reminder Settings</button>

                <button class="btn btn-secondary" id="btn-send-all-overdue" style="margin-top:12px;">ðŸ“¢ Send All Overdue Reminders Now</button>

                <div class="section-title" style="margin: 32px 0 16px;">ðŸ“± App</div>
                
                <div class="card" style="padding:20px;">
                    <div class="menu-item" id="btn-run-onboarding" style="cursor:pointer;">
                        <div class="menu-icon">ðŸŽ“</div>
                        <div class="menu-text">Run Setup Guide Again</div>
                        <div class="menu-arrow">â€º</div>
                    </div>
                </div>

                <div style="text-align:center;padding:24px;color:#888;font-size:13px;">
                    <div style="font-size:24px;margin-bottom:8px;">ðŸ’°</div>
                    <div style="font-weight:600;">Owo Mi v1.0</div>
                    <div style="margin-top:4px;">Made with â¤ï¸ for Nigerian SMBs</div>
                </div>
            `;
        }

        function renderPaymentsPage() {
            const payments = [...state.paymentHistory].reverse();
            const totalReceived = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Group by month
            const grouped = {};
            payments.forEach(p => {
                const month = new Date(p.date).toLocaleDateString('en-NG', { month: 'long', year: 'numeric' });
                if (!grouped[month]) grouped[month] = [];
                grouped[month].push(p);
            });
            
            const methodIcons = {
                transfer: 'ðŸ¦',
                cash: 'ðŸ’µ',
                card: 'ðŸ’³',
                paystack: 'ðŸ”—'
            };
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 8px;">ðŸ’° Payment History</div>
                <p style="color:#666;margin-bottom:20px;font-size:14px;">All recorded payments</p>
                
                <!-- Summary Card -->
                <div class="card" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white;margin-bottom:20px;">
                    <div style="text-align:center;">
                        <div style="font-size:13px;opacity:0.9;">Total Received</div>
                        <div style="font-size:32px;font-weight:700;">${formatNaira(totalReceived)}</div>
                        <div style="font-size:13px;opacity:0.9;margin-top:4px;">${payments.length} payment${payments.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
                
                ${payments.length === 0 ? 
                    '<div class="card" style="padding:40px;text-align:center;color:#888;"><div style="font-size:48px;margin-bottom:12px;">ðŸ’°</div>No payments recorded yet<br><span style="font-size:13px;">Payments will appear here when you record them</span></div>' :
                    Object.entries(grouped).map(([month, monthPayments]) => `
                        <div class="menu-section">${month}</div>
                        ${monthPayments.map(p => {
                            const inv = state.invoices.find(i => i.id === p.invoiceId);
                            return `
                                <div class="card" style="margin-bottom:10px;">
                                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                        <div style="flex:1;">
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <span style="font-size:20px;">${methodIcons[p.method] || 'ðŸ’°'}</span>
                                                <div>
                                                    <div style="font-weight:600;">${p.customerName || 'Customer'}</div>
                                                    <div style="font-size:12px;color:#666;">${p.invoiceNumber || 'Invoice'}</div>
                                                </div>
                                            </div>
                                            ${p.note ? `<div style="font-size:12px;color:#888;margin-top:6px;font-style:italic;">"${p.note}"</div>` : ''}
                                        </div>
                                        <div style="text-align:right;">
                                            <div style="font-weight:700;color:#16a34a;">${formatNaira(p.amount)}</div>
                                            <div style="font-size:11px;color:#888;">${formatDate(p.date)}</div>
                                            ${p.isFullPayment ? '<span style="font-size:10px;background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;">FULL</span>' : ''}
                                        </div>
                                    </div>
                                    ${inv && getStatus(inv) === 'paid' ? `
                                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid #f0f0f0;">
                                            <button class="btn btn-secondary" style="width:100%;padding:10px;" data-receipt="${p.invoiceId}">ðŸ§¾ Generate Receipt</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    `).join('')
                }
            `;
        }

        // ========== CUSTOMER PAYMENT PORTAL ==========
        function renderCustomerPortal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            if (!cust) {
                return `
                    <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:#f8fafc;">
                        <div style="text-align:center;">
                            <div style="font-size:64px;margin-bottom:16px;">ðŸ”—</div>
                            <h2 style="margin-bottom:8px;">Portal Not Found</h2>
                            <p style="color:#666;">This payment portal link is invalid or has expired.</p>
                        </div>
                    </div>
                `;
            }
            
            const p = state.businessProfile;
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId);
            const unpaidInvoices = custInvoices.filter(i => getStatus(i) !== 'paid');
            const paidInvoices = custInvoices.filter(i => getStatus(i) === 'paid');
            const totalOwed = unpaidInvoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            const totalPaid = custInvoices.reduce((s, i) => s + i.amount_paid, 0);
            
            // Get payment history for this customer
            const custPayments = state.paymentHistory.filter(pay => pay.customerId === customerId);
            
            return `
                <div class="portal-container">
                    <!-- Header -->
                    <div class="portal-header">
                        <div class="portal-business">${p.name || 'Owo Mi ðŸ’°'}</div>
                        <div class="portal-subtitle">Customer Payment Portal</div>
                    </div>
                    
                    <!-- Customer Info -->
                    <div class="portal-customer">
                        <div class="portal-avatar">${cust.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="portal-name">${cust.name}</div>
                            <div class="portal-phone">${cust.phone}</div>
                        </div>
                    </div>
                    
                    <!-- Balance Card -->
                    <div class="portal-balance ${totalOwed > 0 ? 'has-balance' : 'clear'}">
                        <div class="balance-label">${totalOwed > 0 ? 'Total Outstanding' : 'Account Status'}</div>
                        <div class="balance-amount">${totalOwed > 0 ? formatNaira(totalOwed) : 'âœ“ All Clear!'}</div>
                        <div class="balance-detail">${unpaidInvoices.length} unpaid invoice${unpaidInvoices.length !== 1 ? 's' : ''}</div>
                    </div>
                    
                    ${totalOwed > 0 ? `
                        <button class="portal-pay-all" id="portal-pay-all" data-amount="${totalOwed}">
                            ${state.businessProfile.paystackEnabled && state.businessProfile.paystackPublicKey ? 'ðŸ’³ Pay All' : 'ðŸ¦ View Bank Details'} ${formatNaira(totalOwed)}
                        </button>
                    ` : ''}
                    
                    <!-- Unpaid Invoices -->
                    ${unpaidInvoices.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">ðŸ“‹ Unpaid Invoices</div>
                            ${unpaidInvoices.map(inv => {
                                const owed = inv.amount - inv.amount_paid;
                                const status = getStatus(inv);
                                return `
                                    <div class="portal-invoice">
                                        <div class="portal-inv-top">
                                            <div>
                                                <div class="portal-inv-number">${inv.invoice_number || 'Invoice'}</div>
                                                <div class="portal-inv-desc">${inv.description}</div>
                                                <div class="portal-inv-due ${status === 'overdue' ? 'overdue' : ''}">
                                                    ${status === 'overdue' ? 'âš ï¸ Overdue' : 'Due: ' + formatDate(inv.due_date)}
                                                </div>
                                            </div>
                                            <div class="portal-inv-amount">${formatNaira(owed)}</div>
                                        </div>
                                        <div class="portal-inv-actions">
                                            <button class="portal-btn-view" data-portal-view="${inv.id}">ðŸ“„ View</button>
                                            <button class="portal-btn-bank" data-portal-bank="${inv.id}" data-amount="${owed}">ðŸ¦ Bank Details</button>
                                            ${state.businessProfile.paystackEnabled && state.businessProfile.paystackPublicKey ? `<button class="portal-btn-pay" data-portal-pay="${inv.id}" data-amount="${owed}">ðŸ’³ Pay Card</button>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Paid Invoices -->
                    ${paidInvoices.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">âœ… Paid Invoices</div>
                            ${paidInvoices.map(inv => `
                                <div class="portal-invoice paid">
                                    <div class="portal-inv-top">
                                        <div>
                                            <div class="portal-inv-number">${inv.invoice_number || 'Invoice'}</div>
                                            <div class="portal-inv-desc">${inv.description}</div>
                                            <div class="portal-inv-paid-date">Paid ${inv.paid_date ? formatDate(inv.paid_date) : ''}</div>
                                        </div>
                                        <div class="portal-inv-amount paid">${formatNaira(inv.amount)}</div>
                                    </div>
                                    <div class="portal-inv-actions">
                                        <button class="portal-btn-view" data-portal-view="${inv.id}">ðŸ“„ Invoice</button>
                                        <button class="portal-btn-receipt" data-portal-receipt="${inv.id}">ðŸ§¾ Receipt</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Payment History -->
                    ${custPayments.length > 0 ? `
                        <div class="portal-section">
                            <div class="portal-section-title">ðŸ’° Payment History</div>
                            <div class="portal-payments">
                                ${custPayments.slice(-5).reverse().map(pay => `
                                    <div class="portal-payment">
                                        <div>
                                            <div class="portal-pay-date">${formatDate(pay.date)}</div>
                                            <div class="portal-pay-ref">${pay.invoiceNumber || 'Invoice'}</div>
                                        </div>
                                        <div class="portal-pay-amount">${formatNaira(pay.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Contact -->
                    <div class="portal-contact">
                        <div class="portal-contact-title">Need Help?</div>
                        ${p.phone ? `<a href="tel:${p.phone}" class="portal-contact-btn">ðŸ“ž Call ${p.phone}</a>` : ''}
                        ${p.phone ? `<a href="https://wa.me/234${p.phone.replace(/^0/, '')}" class="portal-contact-btn whatsapp" target="_blank">ðŸ’¬ WhatsApp</a>` : ''}
                    </div>
                    
                    <div class="portal-footer">
                        Powered by <strong>Owo Mi</strong> ðŸ’°
                    </div>
                </div>
            `;
        }

        function renderRemindersPage() {
            const r = state.reminderSettings || { 
                enabled: false, 
                before_due_days: 3, 
                on_due_date: true, 
                after_due_days: [3, 7],
                channel: 'whatsapp' // 'whatsapp', 'sms', or 'both'
            };
            
            // Get reminder history from state
            const reminderHistory = state.reminderHistory || [];
            const recentReminders = reminderHistory.slice(-20).reverse();
            
            // Calculate upcoming reminders
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingReminders = [];
            state.invoices.forEach(inv => {
                if (getStatus(inv) === 'paid') return;
                
                const cust = state.customers.find(c => c.id === inv.customer_id);
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                // Before due date
                if (diffDays === r.before_due_days) {
                    upcomingReminders.push({
                        invoice: inv,
                        customer: cust,
                        type: 'before',
                        label: `${r.before_due_days} days before due`,
                        daysUntil: diffDays
                    });
                }
                // On due date
                if (diffDays === 0 && r.on_due_date) {
                    upcomingReminders.push({
                        invoice: inv,
                        customer: cust,
                        type: 'due',
                        label: 'Due today',
                        daysUntil: 0
                    });
                }
                // Overdue
                if (diffDays < 0) {
                    const overdueDays = Math.abs(diffDays);
                    if (r.after_due_days?.includes(overdueDays)) {
                        upcomingReminders.push({
                            invoice: inv,
                            customer: cust,
                            type: 'overdue',
                            label: `${overdueDays} days overdue`,
                            daysUntil: diffDays
                        });
                    }
                }
            });
            
            return `
                <button class="back-btn" data-back>â† Back</button>
                <div class="section-title" style="margin-bottom: 8px;">â° Auto Reminders</div>
                <p style="color:#666;margin-bottom:24px;font-size:14px;">Automatically remind customers about unpaid invoices</p>
                
                <!-- Master Toggle -->
                <div class="card" style="padding:20px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <div style="font-weight:700;font-size:17px;">Auto Reminders</div>
                            <div style="font-size:13px;color:#666;margin-top:4px;">${r.enabled ? 'Reminders will send automatically' : 'Turn on to send automatic reminders'}</div>
                        </div>
                        <div class="menu-toggle ${r.enabled ? 'active' : ''}" id="toggle-reminders-master" style="transform:scale(1.2);"></div>
                    </div>
                </div>
                
                <!-- Settings -->
                <div class="card" style="padding:20px;margin-bottom:16px;${r.enabled ? '' : 'opacity:0.5;pointer-events:none;'}">
                    <div style="font-weight:600;margin-bottom:16px;">ðŸ“… When to Remind</div>
                    
                    <div class="form-group" style="margin-bottom:16px;">
                        <label class="form-label">Before due date</label>
                        <select class="form-input" id="rem-before">
                            <option value="0" ${r.before_due_days === 0 ? 'selected' : ''}>Don't remind before</option>
                            <option value="1" ${r.before_due_days === 1 ? 'selected' : ''}>1 day before</option>
                            <option value="2" ${r.before_due_days === 2 ? 'selected' : ''}>2 days before</option>
                            <option value="3" ${r.before_due_days === 3 ? 'selected' : ''}>3 days before</option>
                            <option value="5" ${r.before_due_days === 5 ? 'selected' : ''}>5 days before</option>
                            <option value="7" ${r.before_due_days === 7 ? 'selected' : ''}>7 days before</option>
                        </select>
                    </div>

                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:12px;background:#f8fafc;border-radius:10px;">
                        <input type="checkbox" id="rem-due" ${r.on_due_date ? 'checked' : ''} style="width:20px;height:20px;">
                        <label for="rem-due" style="font-size:15px;">Remind on due date</label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">After overdue (select all that apply)</label>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;">
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-3" ${r.after_due_days?.includes(3) ? 'checked' : ''}> 3 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-7" ${r.after_due_days?.includes(7) ? 'checked' : ''}> 7 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-14" ${r.after_due_days?.includes(14) ? 'checked' : ''}> 14 days
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:14px;padding:8px 12px;background:#f8fafc;border-radius:8px;">
                                <input type="checkbox" id="rem-over-30" ${r.after_due_days?.includes(30) ? 'checked' : ''}> 30 days
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Channel Selection -->
                <div class="card" style="padding:20px;margin-bottom:16px;${r.enabled ? '' : 'opacity:0.5;pointer-events:none;'}">
                    <div style="font-weight:600;margin-bottom:16px;">ðŸ“± How to Remind</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'whatsapp' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="whatsapp" ${r.channel === 'whatsapp' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ’¬</span>
                            <div>
                                <div style="font-weight:600;">WhatsApp</div>
                                <div style="font-size:12px;color:#666;">Opens WhatsApp with pre-filled message</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'sms' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="sms" ${r.channel === 'sms' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ“±</span>
                            <div>
                                <div style="font-weight:600;">SMS (Termii)</div>
                                <div style="font-size:12px;color:#666;">Sends SMS automatically via Termii API</div>
                            </div>
                        </label>
                        <label style="display:flex;align-items:center;gap:10px;padding:12px;background:${r.channel === 'both' ? '#dcfce7' : '#f8fafc'};border-radius:10px;cursor:pointer;">
                            <input type="radio" name="rem-channel" value="both" ${r.channel === 'both' ? 'checked' : ''}>
                            <span style="font-size:20px;">ðŸ””</span>
                            <div>
                                <div style="font-weight:600;">Both</div>
                                <div style="font-size:12px;color:#666;">Send via both WhatsApp and SMS</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="btn-save-reminder-settings" style="width:100%;">ðŸ’¾ Save Settings</button>
                
                <!-- Upcoming Reminders -->
                <div class="section-title" style="margin: 28px 0 12px;">ðŸ“‹ Due for Reminder Today</div>
                ${upcomingReminders.length === 0 ? 
                    '<div class="card" style="padding:24px;text-align:center;color:#888;"><div style="font-size:32px;margin-bottom:8px;">âœ…</div>No reminders due today</div>' :
                    upcomingReminders.map(r => `
                        <div class="card" style="margin-bottom:10px;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div>
                                    <div style="font-weight:600;">${r.customer?.name || 'Unknown'}</div>
                                    <div style="font-size:13px;color:#666;">${r.invoice.description} â€¢ ${formatNaira(r.invoice.amount - r.invoice.amount_paid)}</div>
                                    <span class="badge ${r.type === 'overdue' ? 'badge-overdue' : r.type === 'due' ? 'badge-pending' : 'badge-paid'}" style="margin-top:6px;">${r.label}</span>
                                </div>
                                <button class="btn btn-primary" style="padding:8px 14px;font-size:13px;" data-send-reminder="${r.invoice.id}">
                                    Send Now
                                </button>
                            </div>
                        </div>
                    `).join('')
                }
                
                <!-- Quick Actions -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px;">
                    <button class="btn btn-secondary" id="btn-send-all-due" style="padding:14px;">
                        ðŸ“¤ Send All Due
                    </button>
                    <button class="btn btn-secondary" id="btn-send-all-overdue-now" style="padding:14px;background:#fee2e2;color:#dc2626;border-color:#dc2626;">
                        ðŸš¨ All Overdue
                    </button>
                </div>
                
                <!-- Reminder History -->
                <div class="section-title" style="margin: 28px 0 12px;">ðŸ“œ Reminder History</div>
                ${recentReminders.length === 0 ? 
                    '<div class="card" style="padding:24px;text-align:center;color:#888;">No reminders sent yet</div>' :
                    `<div class="card" style="padding:0;overflow:hidden;">
                        ${recentReminders.map((h, i) => `
                            <div style="padding:12px 16px;border-bottom:1px solid #f0f0f0;${i === 0 ? 'background:#f8fafc;' : ''}">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-weight:500;font-size:14px;">${h.customerName}</div>
                                        <div style="font-size:12px;color:#888;">${h.channel === 'sms' ? 'ðŸ“± SMS' : 'ðŸ’¬ WhatsApp'} â€¢ ${formatNaira(h.amount)}</div>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="font-size:12px;color:#666;">${formatDate(h.sentAt)}</div>
                                        <span style="font-size:11px;color:#16a34a;">âœ“ Sent</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`
                }
                
                <button class="btn" id="btn-clear-history" style="margin-top:12px;background:#f8fafc;color:#666;width:100%;">Clear History</button>
            `;
        }

        // ========== EVENTS ==========
        function attachAuthEvents() {
            const isSignup = state.authMode === 'signup';
            
            // Toggle between login and signup
            document.getElementById('toggle-auth')?.addEventListener('click', () => {
                state.authMode = state.authMode === 'login' ? 'signup' : 'login';
                render();
            });
            
            // Back to landing button
            document.getElementById('auth-back-btn')?.addEventListener('click', () => {
                state.currentSection = 'landing';
                render();
            });

            // Real-time password match validation for signup
            if (isSignup) {
                const passwordInput = document.getElementById('auth-password');
                const confirmInput = document.getElementById('auth-password-confirm');
                
                const checkPasswordMatch = () => {
                    if (!confirmInput || !passwordInput) return;
                    const password = passwordInput.value;
                    const confirm = confirmInput.value;
                    
                    if (confirm.length > 0) {
                        if (password === confirm) {
                            confirmInput.style.borderColor = '#22c55e';
                            confirmInput.style.backgroundColor = '#f0fdf4';
                        } else {
                            confirmInput.style.borderColor = '#ef4444';
                            confirmInput.style.backgroundColor = '#fef2f2';
                        }
                    } else {
                        confirmInput.style.borderColor = '#e0e0e0';
                        confirmInput.style.backgroundColor = '';
                    }
                };
                
                passwordInput?.addEventListener('input', checkPasswordMatch);
                confirmInput?.addEventListener('input', checkPasswordMatch);
            }

            // Email/Password Form
            const authForm = document.getElementById('auth-form');
            if (!authForm) return;
            
            authForm.onsubmit = async (e) => {
                e.preventDefault();
                
                const btn = document.getElementById('auth-btn');
                const emailInput = document.getElementById('auth-email');
                const passwordInput = document.getElementById('auth-password');
                const passwordConfirmInput = document.getElementById('auth-password-confirm');
                const nameInput = document.getElementById('auth-name');
                
                if (!btn || !emailInput || !passwordInput) return;
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const passwordConfirm = passwordConfirmInput?.value || '';
                const name = nameInput?.value?.trim() || '';

                // Validation
                if (!email || !password) {
                    showAuthError('Please enter email and password');
                    return;
                }
                
                if (isSignup) {
                    if (password.length < 6) {
                        showAuthError('Password must be at least 6 characters');
                        return;
                    }
                    if (password !== passwordConfirm) {
                        showAuthError('Passwords do not match');
                        return;
                    }
                }

                btn.disabled = true;
                btn.textContent = 'Please wait...';
                hideAuthMessages();
                
                let signupSuccess = false; // Track if we showed success

                try {
                    if (isSignup) {
                        // Sign up - correct body format for Supabase REST API
                        const data = await supabaseAuth('signup', { 
                            email, 
                            password,
                            data: { business_name: name }
                        });
                        
                        console.log('Signup response:', JSON.stringify(data, null, 2));
                        
                        // Supabase returns different structures depending on settings
                        // Could be: { user, session } or { id, email, ... } or { access_token, user }
                        const user = data.user || (data.id ? data : null);
                        
                        if (user) {
                            // Check if auto-confirmed or needs email confirmation
                            const hasSession = data.access_token || data.session?.access_token;
                            const isConfirmed = user.email_confirmed_at || user.confirmed_at;
                            
                            console.log('User:', user);
                            console.log('Has session:', hasSession, 'Is confirmed:', isConfirmed);
                            
                            if (hasSession) {
                                // Auto-confirmed (email confirmation disabled)
                                const session = data.session || data;
                                saveSession(session);
                                state.user = user;
                                await db.loadAllData();
                                showToast('Account created successfully! ðŸŽ‰', 'success');
                                state.currentSection = 'onboarding';
                                render();
                                return; // Exit early
                            } else {
                                // Email confirmation required - show success with instructions
                                signupSuccess = true;
                                showAuthSuccess(`
                                    <div style="text-align:center;">
                                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“§</div>
                                        <strong style="font-size: 18px;">Account Created!</strong><br><br>
                                        <span style="color: #166534;">We've sent a confirmation email to:</span><br>
                                        <strong style="font-size: 16px; color: #15803d;">${email}</strong><br><br>
                                        <span style="color: #166534;">Please check your inbox (and spam folder) and click the confirmation link.</span><br><br>
                                        <span style="color: #15803d; font-weight: 500;">Then come back and click "Sign In" below.</span>
                                    </div>
                                `);
                                // Change button to indicate next step
                                btn.textContent = 'âœ“ Email Sent - Check Inbox';
                                btn.disabled = true;
                                btn.style.background = '#22c55e';
                                
                                // After 5 seconds, switch to login mode
                                setTimeout(() => {
                                    state.authMode = 'login';
                                    render();
                                }, 5000);
                                return; // Exit early
                            }
                        } else {
                            // No user in response - log and show helpful error
                            console.error('No user in signup response:', data);
                            
                            // Check for common issues
                            if (data.msg || data.message || data.error_description) {
                                showAuthError(data.msg || data.message || data.error_description);
                            } else {
                                showAuthError('Signup failed. Please try again.');
                            }
                        }
                    } else {
                        // Login
                        const data = await supabaseAuth('token?grant_type=password', { email, password });
                        console.log('Login response:', data);
                        saveSession(data);
                        state.user = data.user;
                        await db.loadAllData();
                        showToast('Welcome back! ðŸ‘‹', 'success');
                        render();
                        return; // Exit early
                    }
                } catch (err) {
                    console.error('Auth error:', err);
                    let errorMsg = err.message || 'Something went wrong';
                    
                    // User-friendly error messages
                    if (errorMsg.includes('Invalid login')) {
                        errorMsg = 'Invalid email or password';
                    } else if (errorMsg.includes('Email not confirmed')) {
                        errorMsg = 'Please check your email and confirm your account first';
                    } else if (errorMsg.includes('already registered') || errorMsg.includes('already been registered') || errorMsg.includes('User already registered')) {
                        errorMsg = 'This email is already registered. Try signing in instead.';
                    } else if (errorMsg.includes('Password should be') || errorMsg.includes('password')) {
                        errorMsg = 'Password must be at least 6 characters';
                    } else if (errorMsg.includes('Invalid email')) {
                        errorMsg = 'Please enter a valid email address';
                    } else if (errorMsg.includes('rate limit') || errorMsg.includes('too many')) {
                        errorMsg = 'Too many attempts. Please wait a moment and try again.';
                    } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                        errorMsg = 'Network error. Please check your internet connection.';
                    }
                    
                    showAuthError(errorMsg);
                }
                
                // Re-enable button only if we didn't show success
                if (!signupSuccess && btn) {
                    btn.disabled = false;
                    btn.textContent = isSignup ? 'Create Account' : 'Sign In';
                    btn.style.background = '';
                }
            };
        }

        // Helper functions for auth
        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            if (el) {
                el.innerHTML = `âš ï¸ ${message}`;
                el.classList.remove('hidden');
                // Scroll to show error
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function showAuthSuccess(message) {
            const el = document.getElementById('auth-success');
            if (el) {
                // Check if message is HTML or plain text
                if (message.includes('<')) {
                    el.innerHTML = message;
                } else {
                    el.innerHTML = `âœ… ${message}`;
                }
                el.classList.remove('hidden');
                // Scroll to show success
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function hideAuthMessages() {
            document.getElementById('auth-error')?.classList.add('hidden');
            document.getElementById('auth-success')?.classList.add('hidden');
        }

        async function signInWithProvider(provider) {
            const redirectUrl = window.location.origin + window.location.pathname;
            const url = `${SUPABASE_URL}/auth/v1/authorize?provider=${provider}&redirect_to=${encodeURIComponent(redirectUrl)}`;
            window.location.href = url;
        }

        // Check for OAuth callback on page load
        async function handleAuthCallback() {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                const refreshToken = params.get('refresh_token');
                
                if (accessToken) {
                    try {
                        // Get user info
                        const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        const user = await res.json();
                        
                        if (user.id) {
                            const session = {
                                access_token: accessToken,
                                refresh_token: refreshToken,
                                user: user
                            };
                            saveSession(session);
                            state.user = user;
                            
                            // Clear hash from URL
                            history.replaceState(null, '', window.location.pathname);
                            
                            // Load data and redirect
                            await db.loadAllData();
                            render();
                        }
                    } catch (err) {
                        console.error('OAuth callback error:', err);
                    }
                }
            }
        }

        function attachAppEvents() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => { state.activeTab = btn.dataset.tab; state.menuPage = null; state.searchQuery = ''; render(); };
            });

            // Quick Actions
            document.getElementById('btn-new-invoice')?.addEventListener('click', showInvoiceModal);
            document.getElementById('btn-new-customer')?.addEventListener('click', showCustomerModal);
            document.querySelector('[data-goto="invoices"]')?.addEventListener('click', () => { state.activeTab = 'invoices'; render(); });

            // AI Assistant
            document.getElementById('ai-assistant-btn')?.addEventListener('click', openAIAssistant);
            
            // AI Insight Actions
            document.querySelectorAll('[data-insight-action]').forEach(btn => {
                btn.onclick = () => {
                    const action = btn.dataset.insightAction;
                    if (action === 'send-overdue') {
                        sendAllOverdueReminders();
                    } else if (action === 'send-due-soon') {
                        state.menuPage = 'reminders';
                        state.activeTab = 'menu';
                        render();
                    } else if (action === 'view-reports') {
                        state.menuPage = 'reports';
                        state.activeTab = 'menu';
                        render();
                    } else if (action === 'create-invoice') {
                        showInvoiceModal();
                    }
                };
            });

            // Search & Filter
            document.getElementById('search-input')?.addEventListener('input', (e) => { state.searchQuery = e.target.value; render(); });
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.onclick = () => { state.filterStatus = btn.dataset.filter; render(); };
            });

            // Invoice Actions
            document.querySelectorAll('[data-pdf]').forEach(btn => { btn.onclick = () => generatePDF(btn.dataset.pdf); });
            document.querySelectorAll('[data-receipt]').forEach(btn => { btn.onclick = () => generateReceipt(btn.dataset.receipt); });
            document.querySelectorAll('[data-whatsapp]').forEach(btn => { btn.onclick = () => sendWhatsApp(btn.dataset.whatsapp); });
            document.querySelectorAll('[data-sms]').forEach(btn => { btn.onclick = () => sendSMS(btn.dataset.sms); });
            document.querySelectorAll('[data-paylink]').forEach(btn => { btn.onclick = () => generatePaymentLink(btn.dataset.paylink); });
            document.querySelectorAll('[data-pay]').forEach(btn => { btn.onclick = () => showPaymentModal(btn.dataset.pay); });
            document.querySelectorAll('[data-edit-inv]').forEach(btn => { btn.onclick = () => showEditInvoiceModal(btn.dataset.editInv); });

            // Menu Navigation
            document.querySelectorAll('[data-menu]').forEach(btn => {
                btn.onclick = () => { state.menuPage = btn.dataset.menu; render(); };
            });
            document.querySelector('[data-back]')?.addEventListener('click', () => { state.menuPage = null; render(); });

            // Menu Actions
            document.getElementById('btn-export')?.addEventListener('click', exportCSV);
            document.getElementById('dark-toggle')?.addEventListener('click', toggleDarkMode);
            document.getElementById('btn-logout')?.addEventListener('click', () => { 
                clearSession(); 
                localStorage.removeItem('owomi_user');
                localStorage.removeItem('owomi_onboarded');
                state.user = null; 
                state.currentSection = 'landing';
                render(); 
            });

            // Customers Page
            document.getElementById('btn-add-customer')?.addEventListener('click', showCustomerModal);
            document.querySelectorAll('[data-edit-cust]').forEach(btn => { btn.onclick = () => showEditCustomerModal(btn.dataset.editCust); });
            document.querySelectorAll('[data-delete-cust]').forEach(btn => { btn.onclick = () => deleteCustomer(btn.dataset.deleteCust); });

            // Settings Page
            document.getElementById('btn-save-settings')?.addEventListener('click', saveSettings);
            document.getElementById('logo-input')?.addEventListener('change', handleLogoUpload);
            document.getElementById('qr-input')?.addEventListener('change', handleQRUpload);
            document.getElementById('btn-save-template')?.addEventListener('click', saveTemplateSettings);
            document.getElementById('btn-preview-invoice')?.addEventListener('click', previewInvoice);
            
            const runOnboardBtn = document.getElementById('btn-run-onboarding');
            if (runOnboardBtn) {
                runOnboardBtn.onclick = () => {
                    if (confirm('Run the setup guide again? This will walk you through the app setup.')) {
                        state.onboardingStep = 1;
                        state.currentSection = 'onboarding';
                        render();
                    }
                };
            }
            
            // Paystack settings
            document.getElementById('toggle-paystack')?.addEventListener('click', () => {
                state.businessProfile.paystackEnabled = !state.businessProfile.paystackEnabled;
                localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
                render();
            });
            document.getElementById('btn-save-paystack')?.addEventListener('click', savePaystackSettings);

            // Billing Page
            document.getElementById('btn-upgrade')?.addEventListener('click', () => showUpgradeModal());
            document.getElementById('btn-upgrade-bottom')?.addEventListener('click', () => showUpgradeModal());
            document.getElementById('btn-change-plan')?.addEventListener('click', () => showUpgradeModal());
            document.getElementById('btn-cancel-plan')?.addEventListener('click', async () => {
                if (confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.')) {
                    try {
                        await db.updateSubscription({ status: 'cancelled', cancelled_at: new Date().toISOString() });
                        showToast('Subscription cancelled', 'info');
                        await db.loadAllData();
                        render();
                    } catch (err) {
                        console.error('Cancel error:', err);
                        showToast('Failed to cancel subscription', 'error');
                    }
                }
            });

            // Recurring Page
            document.getElementById('btn-add-recurring')?.addEventListener('click', showRecurringModal);
            document.querySelectorAll('[data-generate]').forEach(btn => { btn.onclick = () => generateRecurring(btn.dataset.generate); });
            document.querySelectorAll('[data-toggle-rec]').forEach(btn => {
                btn.onclick = async () => {
                    const tmpl = state.recurringTemplates.find(t => t.id === btn.dataset.toggleRec);
                    if (tmpl) { 
                        tmpl.active = !tmpl.active; 
                        try {
                            await db.updateRecurringTemplate(tmpl.id, { active: tmpl.active });
                        } catch (err) {
                            console.error('Failed to update recurring template:', err);
                        }
                        render(); 
                    }
                };
            });
            document.querySelectorAll('[data-delete-rec]').forEach(btn => {
                btn.onclick = async () => {
                    if (confirm('Delete this recurring template?')) {
                        try {
                            await db.deleteRecurringTemplate(btn.dataset.deleteRec);
                            state.recurringTemplates = state.recurringTemplates.filter(t => t.id !== btn.dataset.deleteRec);
                            render();
                        } catch (err) {
                            console.error('Failed to delete recurring template:', err);
                            showToast('Failed to delete template', 'error');
                        }
                    }
                };
            });

            // Products Page
            document.getElementById('btn-add-product')?.addEventListener('click', showProductModal);
            document.querySelectorAll('[data-edit-prod]').forEach(btn => { btn.onclick = () => showEditProductModal(btn.dataset.editProd); });
            document.querySelectorAll('[data-delete-prod]').forEach(btn => {
                btn.onclick = async () => {
                    if (confirm('Delete this product?')) {
                        try {
                            await db.deleteProduct(btn.dataset.deleteProd);
                            state.products = state.products.filter(p => p.id !== btn.dataset.deleteProd);
                            showToast('Product deleted', 'success');
                            render();
                        } catch (err) {
                            console.error('Delete failed:', err);
                            showToast('Error deleting product', 'error');
                        }
                    }
                };
            });

            // Expenses Page
            document.getElementById('btn-add-expense')?.addEventListener('click', showExpenseModal);
            document.querySelectorAll('[data-edit-exp]').forEach(btn => { btn.onclick = () => showEditExpenseModal(btn.dataset.editExp); });
            document.querySelectorAll('[data-delete-exp]').forEach(btn => {
                btn.onclick = async () => {
                    if (confirm('Delete this expense?')) {
                        try {
                            await db.deleteExpense(btn.dataset.deleteExp);
                            state.expenses = state.expenses.filter(e => e.id !== btn.dataset.deleteExp);
                            showToast('Expense deleted', 'success');
                            render();
                        } catch (err) {
                            console.error('Delete failed:', err);
                            showToast('Error deleting expense', 'error');
                        }
                    }
                };
            });

            // Quotes Page
            document.getElementById('btn-add-quote')?.addEventListener('click', showQuoteModal);
            document.querySelectorAll('[data-quote-pdf]').forEach(btn => { btn.onclick = () => generateQuotePDF(btn.dataset.quotePdf); });
            document.querySelectorAll('[data-convert-quote]').forEach(btn => { btn.onclick = () => convertQuoteToInvoice(btn.dataset.convertQuote); });
            document.querySelectorAll('[data-quote-status]').forEach(btn => {
                btn.onclick = () => {
                    const quote = state.quotes.find(q => q.id === btn.dataset.quoteStatus);
                    if (quote) {
                        quote.status = btn.dataset.status;
                        localStorage.setItem('owomi_quotes', JSON.stringify(state.quotes));
                        showToast(`Quote marked as ${btn.dataset.status}`, 'success');
                        render();
                    }
                };
            });
            document.querySelectorAll('[data-delete-quote]').forEach(btn => {
                btn.onclick = () => {
                    if (confirm('Delete this quote?')) {
                        state.quotes = state.quotes.filter(q => q.id !== btn.dataset.deleteQuote);
                        localStorage.setItem('owomi_quotes', JSON.stringify(state.quotes));
                        render();
                    }
                };
            });

            // Backup Page
            document.getElementById('btn-backup')?.addEventListener('click', downloadBackup);
            document.getElementById('btn-restore')?.addEventListener('click', () => document.getElementById('restore-input')?.click());
            document.getElementById('restore-input')?.addEventListener('change', restoreBackup);

            // Customer Statement
            document.querySelectorAll('[data-statement]').forEach(btn => { btn.onclick = () => generateStatement(btn.dataset.statement); });

            // Reminder settings (old settings page)
            document.getElementById('toggle-reminders')?.addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('reminder-options')?.classList.toggle('hidden');
            });

            document.getElementById('btn-save-reminders')?.addEventListener('click', saveReminderSettings);
            document.getElementById('btn-send-all-overdue')?.addEventListener('click', sendAllOverdueReminders);
            
            // New Reminders Page events
            document.getElementById('toggle-reminders-master')?.addEventListener('click', async function() {
                this.classList.toggle('active');
                const enabled = this.classList.contains('active');
                state.reminderSettings = state.reminderSettings || {};
                state.reminderSettings.enabled = enabled;
                try {
                    await db.upsertReminderSettings({ enabled });
                } catch (err) {
                    console.error('Failed to save reminder settings:', err);
                }
                showToast(enabled ? 'Auto reminders enabled! â°' : 'Auto reminders disabled', enabled ? 'success' : 'info');
                render();
            });
            
            document.getElementById('btn-save-reminder-settings')?.addEventListener('click', saveReminderSettingsNew);
            document.getElementById('btn-send-all-due')?.addEventListener('click', sendAllDueReminders);
            document.getElementById('btn-send-all-overdue-now')?.addEventListener('click', sendAllOverdueReminders);
            document.getElementById('btn-clear-history')?.addEventListener('click', async () => {
                if (confirm('Clear all reminder history?')) {
                    try {
                        localStorage.removeItem('owomi_reminder_history');
                        state.reminderHistory = [];
                        showToast('History cleared', 'info');
                        render();
                    } catch (err) {
                        console.error('Failed to clear history:', err);
                        showToast('Error clearing history', 'error');
                    }
                }
            });
            
            // Individual send reminder buttons
            document.querySelectorAll('[data-send-reminder]').forEach(btn => {
                btn.onclick = () => sendSingleReminder(btn.dataset.sendReminder);
            });
            
            // Channel selection
            document.querySelectorAll('input[name="rem-channel"]').forEach(radio => {
                radio.onchange = () => {
                    state.reminderSettings = state.reminderSettings || {};
                    state.reminderSettings.channel = radio.value;
                    render();
                };
            });
            
            // Share Portal buttons
            document.querySelectorAll('[data-share-portal]').forEach(btn => {
                btn.onclick = () => showSharePortalModal(btn.dataset.sharePortal);
            });
        }

        // ========== REMINDER FUNCTIONS ==========
        async function saveReminderSettings() {
            const session = getSession();
            const enabled = document.getElementById('toggle-reminders')?.classList.contains('active');
            const before_due_days = parseInt(document.getElementById('rem-before')?.value) || 3;
            const on_due_date = document.getElementById('rem-due')?.checked || false;
            
            const after_due_days = [];
            if (document.getElementById('rem-over-3')?.checked) after_due_days.push(3);
            if (document.getElementById('rem-over-7')?.checked) after_due_days.push(7);
            if (document.getElementById('rem-over-14')?.checked) after_due_days.push(14);
            if (document.getElementById('rem-over-30')?.checked) after_due_days.push(30);

            const data = {
                user_id: session.user.id,
                enabled,
                before_due_days,
                on_due_date,
                after_due_days,
                reminder_channel: 'sms'
            };

            try {
                if (state.reminderSettings?.id) {
                    await supabaseQuery('reminder_settings', {
                        method: 'PATCH',
                        query: `id=eq.${state.reminderSettings.id}`,
                        body: data
                    });
                } else {
                    const result = await supabaseQuery('reminder_settings', {
                        method: 'POST',
                        body: data
                    });
                    state.reminderSettings = result[0];
                }
                state.reminderSettings = { ...state.reminderSettings, ...data };
                showToast('Reminder settings saved!', 'success');
            } catch (err) {
                alert('âŒ Error: ' + err.message);
            }
        }

        async function sendAllOverdueReminders() {
            const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
            if (overdue.length === 0) {
                showToast('No overdue invoices! ðŸŽ‰', 'success');
                return;
            }

            // Show options modal
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">
                            <span>ðŸ“¤ Send Reminders</span>
                            <button class="modal-close" id="modal-close">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom:16px;">You have <strong>${overdue.length} overdue invoice${overdue.length > 1 ? 's' : ''}</strong> to follow up on.</p>
                            
                            <div style="display:flex;flex-direction:column;gap:12px;">
                                <button class="btn btn-primary" id="btn-reminder-whatsapp" style="background:linear-gradient(135deg,#25D366,#128C7E);padding:16px;">
                                    ðŸ’¬ Open WhatsApp (One by One)
                                </button>
                                <button class="btn btn-secondary" id="btn-reminder-sms" style="padding:16px;">
                                    ðŸ“± Send SMS to All (Requires Credits)
                                </button>
                            </div>
                            
                            <p style="font-size:12px;color:#666;margin-top:16px;text-align:center;">
                                WhatsApp is free â€¢ SMS uses Termii credits
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            
            document.getElementById('btn-reminder-whatsapp').onclick = () => {
                closeModal();
                // Open WhatsApp for first overdue invoice
                const firstOverdue = overdue[0];
                sendWhatsApp(firstOverdue.id);
                if (overdue.length > 1) {
                    showToast(`Opened 1 of ${overdue.length}. Send more from Invoices tab.`, 'info', 5000);
                }
            };
            
            document.getElementById('btn-reminder-sms').onclick = async () => {
                closeModal();
                await sendOverdueSMS(overdue);
            };
        }
        
        async function sendOverdueSMS(overdue) {
            if (!confirm(`Send SMS reminders to ${overdue.length} overdue customers? This will use SMS credits.`)) return;

            let sent = 0, failed = 0;

            for (const inv of overdue) {
                const cust = state.customers.find(c => c.id === inv.customer_id);
                if (!cust?.phone) { failed++; continue; }

                const owed = inv.amount - inv.amount_paid;
                const daysOverdue = Math.floor((new Date() - new Date(inv.due_date)) / (1000 * 60 * 60 * 24));
                const message = `Hi ${cust.name}, OVERDUE: â‚¦${owed.toLocaleString()} for "${inv.description}" is ${daysOverdue} days late. Please pay immediately. - ${state.businessProfile.name || 'Owo Mi'}`;

                try {
                    let phone = cust.phone.replace(/\s/g, '');
                    if (phone.startsWith('0')) phone = '234' + phone.slice(1);
                    if (!phone.startsWith('234')) phone = '234' + phone;
                    
                    // DEV_MODE check
                    if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                        sent++;
                        continue;
                    }

                    const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify({ phone, message })
                    });

                    const data = await res.json();
                    if (data.code === 'ok' || data.message_id) sent++;
                    else failed++;
                } catch (err) {
                    failed++;
                }
            }

            showToast(`âœ… Sent: ${sent} | âŒ Failed: ${failed}`, sent > 0 ? 'success' : 'error');
        }
        
        // New reminder settings save function
        async function saveReminderSettingsNew() {
            const before_due_days = parseInt(document.getElementById('rem-before')?.value) || 3;
            const on_due_date = document.getElementById('rem-due')?.checked || false;
            const channel = document.querySelector('input[name="rem-channel"]:checked')?.value || 'whatsapp';
            
            const after_due_days = [];
            if (document.getElementById('rem-over-3')?.checked) after_due_days.push(3);
            if (document.getElementById('rem-over-7')?.checked) after_due_days.push(7);
            if (document.getElementById('rem-over-14')?.checked) after_due_days.push(14);
            if (document.getElementById('rem-over-30')?.checked) after_due_days.push(30);

            state.reminderSettings = {
                ...state.reminderSettings,
                before_due_days,
                on_due_date,
                after_due_days,
                channel
            };
            
            // Save to database
            try {
                await db.upsertReminderSettings({
                    enabled: state.reminderSettings.enabled || false,
                    before_due_days,
                    on_due_date,
                    after_due_days,
                    channel
                });
                showToast('Reminder settings saved! â°', 'success');
            } catch (err) {
                console.error('Save reminder settings failed:', err);
                showToast('Error saving settings', 'error');
            }
        }
        
        // Send reminder for a single invoice
        async function sendSingleReminder(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv?.customer_id);
            
            if (!inv || !cust) {
                showToast('Invoice or customer not found', 'error');
                return;
            }
            
            const channel = state.reminderSettings?.channel || 'whatsapp';
            const owed = inv.amount - inv.amount_paid;
            
            if (channel === 'whatsapp') {
                // WhatsApp opens a modal - handle separately
                try {
                    sendWhatsApp(invoiceId);
                    logReminderLocally(inv, cust, 'whatsapp');
                } catch (err) {
                    console.error('WhatsApp modal error:', err);
                    // Still show the modal even if logging fails
                }
                return; // Don't show success toast - user needs to send manually
            }
            
            try {
                if (channel === 'sms') {
                    await sendSMS(invoiceId);
                    logReminderLocally(inv, cust, 'sms');
                    showToast(`SMS reminder sent to ${cust.name}! ðŸ“¤`, 'success');
                }
                
                if (channel === 'both') {
                    sendWhatsApp(invoiceId);
                    await sendSMS(invoiceId);
                    logReminderLocally(inv, cust, 'both');
                    showToast(`Reminders sent to ${cust.name}! ðŸ“¤`, 'success');
                }
                
                render();
            } catch (err) {
                console.error('Reminder error:', err);
                showToast('Failed to send reminder: ' + (err.message || 'Unknown error'), 'error');
            }
        }
        
        // Log reminder to local storage (simpler than database for now)
        function logReminderLocally(inv, cust, channel) {
            try {
                const history = JSON.parse(localStorage.getItem('owomi_reminder_history') || '[]');
                history.unshift({
                    id: Date.now(),
                    invoiceId: inv?.id || 'unknown',
                    invoiceNumber: inv?.invoice_number || 'INV',
                    customerId: cust?.id || 'unknown',
                    customerName: cust?.name || 'Customer',
                    amount: (inv?.amount || 0) - (inv?.amount_paid || 0),
                    channel: channel,
                    sentAt: new Date().toISOString(),
                    status: 'sent'
                });
                // Keep last 100 entries
                localStorage.setItem('owomi_reminder_history', JSON.stringify(history.slice(0, 100)));
                
                // Update state for display
                state.reminderHistory = history.slice(0, 100);
            } catch (err) {
                console.error('Error logging reminder:', err);
            }
        }
        
        // Send reminders to all invoices due today
        async function sendAllDueReminders() {
            const r = state.reminderSettings || {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find invoices due for reminder today
            const dueForReminder = state.invoices.filter(inv => {
                if (getStatus(inv) === 'paid') return false;
                
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                // Check if this invoice is due for a reminder
                if (diffDays === r.before_due_days) return true;
                if (diffDays === 0 && r.on_due_date) return true;
                if (diffDays < 0 && r.after_due_days?.includes(Math.abs(diffDays))) return true;
                
                return false;
            });
            
            if (dueForReminder.length === 0) {
                showToast('No reminders due today! âœ…', 'success');
                return;
            }
            
            if (!confirm(`Send reminders to ${dueForReminder.length} customers?`)) return;
            
            let sent = 0, failed = 0;
            
            for (const inv of dueForReminder) {
                try {
                    await sendSingleReminder(inv.id);
                    sent++;
                } catch (err) {
                    failed++;
                }
                // Small delay between sends
                await new Promise(r => setTimeout(r, 500));
            }
            
            showToast(`Sent: ${sent}, Failed: ${failed}`, sent > 0 ? 'success' : 'error');
        }
        
        // Check for auto reminders on app load
        function checkAutoReminders() {
            const r = state.reminderSettings;
            if (!r?.enabled) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayKey = today.toISOString().split('T')[0];
            
            // Check if we already ran today
            const lastRun = localStorage.getItem('owomi_last_reminder_check');
            if (lastRun === todayKey) return;
            
            // Find invoices due for reminder today
            const dueForReminder = [];
            
            state.invoices.forEach(inv => {
                if (getStatus(inv) === 'paid') return;
                
                const cust = state.customers.find(c => c.id === inv.customer_id);
                if (!cust?.phone) return;
                
                const dueDate = new Date(inv.due_date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let reminderType = null;
                
                if (diffDays === r.before_due_days && r.before_due_days > 0) {
                    reminderType = 'before';
                } else if (diffDays === 0 && r.on_due_date) {
                    reminderType = 'due';
                } else if (diffDays < 0 && r.after_due_days?.includes(Math.abs(diffDays))) {
                    reminderType = 'overdue';
                }
                
                if (reminderType) {
                    dueForReminder.push({ inv, cust, type: reminderType, days: diffDays });
                }
            });
            
            if (dueForReminder.length > 0) {
                // Show notification
                setTimeout(() => {
                    const names = dueForReminder.slice(0, 3).map(d => d.cust.name).join(', ');
                    const more = dueForReminder.length > 3 ? ` +${dueForReminder.length - 3} more` : '';
                    
                    showAutoReminderPrompt(dueForReminder.length, names + more);
                }, 2000);
            }
            
            // Mark today as checked
            localStorage.setItem('owomi_last_reminder_check', todayKey);
        }
        
        // Show auto reminder prompt
        function showAutoReminderPrompt(count, names) {
            const prompt = document.createElement('div');
            prompt.className = 'auto-reminder-prompt';
            prompt.innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:12px;">
                    <div style="font-size:32px;">â°</div>
                    <div style="flex:1;">
                        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${count} Reminder${count > 1 ? 's' : ''} Due Today</div>
                        <div style="font-size:13px;color:#666;margin-bottom:12px;">${names}</div>
                        <div style="display:flex;gap:8px;">
                            <button id="auto-send-all" style="background:#3b82f6;color:white;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Send All</button>
                            <button id="auto-view" style="background:#f3f4f6;color:#333;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">View</button>
                            <button id="auto-dismiss" style="background:none;border:none;color:#888;padding:10px;cursor:pointer;">Later</button>
                        </div>
                    </div>
                </div>
            `;
            prompt.style.cssText = `
                position: fixed;
                bottom: 90px;
                left: 16px;
                right: 16px;
                background: white;
                padding: 16px;
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 1001;
                animation: slideUp 0.3s ease;
            `;
            document.body.appendChild(prompt);
            
            document.getElementById('auto-send-all').onclick = async () => {
                prompt.remove();
                await sendAllDueReminders();
            };
            
            document.getElementById('auto-view').onclick = () => {
                prompt.remove();
                state.activeTab = 'menu';
                state.menuPage = 'reminders';
                render();
            };
            
            document.getElementById('auto-dismiss').onclick = () => {
                prompt.remove();
            };
        }

        // ========== MODALS ==========
        function closeModal() { document.getElementById('modal-container').innerHTML = ''; }

        function showCustomerModal() {
            // Check plan limits
            if (!canDoAction('customers')) {
                showUpgradeModal(`You've reached your customer limit (${getPlanLimit('customers')} customers). Upgrade to add more!`);
                return;
            }
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Customer<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="cust-name" placeholder="Customer name"></div>
                            <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="cust-phone" placeholder="08012345678"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Customer</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('cust-name').value.trim();
                const phone = document.getElementById('cust-phone').value.trim();
                if (!name || !phone) return alert('Please fill all fields');
                try { await addCustomer(name, phone); closeModal(); render(); } catch (err) { alert('Error: ' + err.message); }
            };
        }

        function showInvoiceModal() {
            // Check plan limits
            if (!canDoAction('invoices')) {
                showUpgradeModal(`You've reached your monthly invoice limit (${getPlanLimit('invoices')} invoices). Upgrade to create more!`);
                return;
            }
            
            if (state.customers.length === 0) { alert('Add a customer first!'); showCustomerModal(); return; }
            
            const productOptions = state.products.length > 0 
                ? `<option value="">-- Select product --</option>` + state.products.map(p => `<option value="${p.id}">${p.name} - ${formatNaira(p.price)}</option>`).join('')
                : `<option value="">No products saved</option>`;
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">New Invoice<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Customer</label><select class="form-input" id="inv-cust">${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                            <div class="form-group"><label class="form-label">Invoice Title</label><input type="text" class="form-input" id="inv-desc" placeholder="e.g. Website Project"></div>
                            
                            <div class="form-group">
                                <label class="form-label">Line Items</label>
                                <div id="line-items-container">
                                    <div class="line-item" style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                                        <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                                        <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                                    </div>
                                </div>
                                <button type="button" id="btn-add-item" style="background:#f0f0f0;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;width:100%;margin-top:8px;">+ Add Item</button>
                                
                                ${state.products.length > 0 ? `
                                <div style="margin-top:12px;">
                                    <label class="form-label" style="font-size:12px;color:#666;">Quick add from products:</label>
                                    <select class="form-input" id="inv-product-quick" style="font-size:13px;">${productOptions}</select>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Discount & VAT -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-size:12px;">Discount</label>
                                    <div style="display:flex;gap:4px;">
                                        <input type="number" class="form-input" id="inv-discount" placeholder="0" min="0" style="flex:1;">
                                        <select class="form-input" id="inv-discount-type" style="width:60px;">
                                            <option value="percent">%</option>
                                            <option value="fixed">â‚¦</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-size:12px;display:flex;align-items:center;gap:8px;cursor:pointer;">
                                        <input type="checkbox" id="inv-vat" style="width:18px;height:18px;"> Add VAT (7.5%)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group" style="background:#f0f9ff;padding:16px;border-radius:12px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span>Subtotal:</span>
                                    <span id="inv-subtotal">â‚¦0</span>
                                </div>
                                <div id="inv-discount-row" style="display:none;justify-content:space-between;margin-bottom:8px;color:#dc2626;">
                                    <span>Discount:</span>
                                    <span id="inv-discount-amount">-â‚¦0</span>
                                </div>
                                <div id="inv-vat-row" style="display:none;justify-content:space-between;margin-bottom:8px;">
                                    <span>VAT (7.5%):</span>
                                    <span id="inv-vat-amount">â‚¦0</span>
                                </div>
                                <div id="inv-shipping-row" style="display:none;justify-content:space-between;margin-bottom:8px;color:#0369a1;">
                                    <span id="inv-shipping-label">Shipping:</span>
                                    <span id="inv-shipping-display">â‚¦0</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:700;font-size:18px;border-top:2px solid #3b82f6;padding-top:8px;">
                                    <span>Total:</span>
                                    <span id="inv-total">â‚¦0</span>
                                </div>
                            </div>
                            
                            <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="inv-due"></div>
                            
                            <!-- Shipping/Delivery -->
                            <div class="form-group">
                                <label class="form-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" id="inv-shipping-toggle" style="width:18px;height:18px;"> Add Shipping/Delivery Fee
                                </label>
                                <div id="inv-shipping-fields" style="display:none;margin-top:8px;">
                                    <div style="display:flex;gap:8px;">
                                        <input type="text" class="form-input" id="inv-shipping-desc" placeholder="e.g. Delivery to Lagos" style="flex:2;">
                                        <input type="number" class="form-input" id="inv-shipping-amount" placeholder="Amount" style="flex:1;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="form-group">
                                <label class="form-label">Notes (optional)</label>
                                <textarea class="form-input" id="inv-notes" rows="2" placeholder="Payment instructions, thank you message, etc." style="resize:none;"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Create Invoice</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Listen for discount/VAT changes
            document.getElementById('inv-discount')?.addEventListener('input', updateTotal);
            document.getElementById('inv-discount-type')?.addEventListener('change', updateTotal);
            document.getElementById('inv-vat')?.addEventListener('change', updateTotal);
            
            // Shipping toggle
            document.getElementById('inv-shipping-toggle')?.addEventListener('change', (e) => {
                document.getElementById('inv-shipping-fields').style.display = e.target.checked ? 'block' : 'none';
                updateTotal();
            });
            document.getElementById('inv-shipping-amount')?.addEventListener('input', updateTotal);
            
            // Add item button
            document.getElementById('btn-add-item').onclick = () => {
                const container = document.getElementById('line-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                newItem.innerHTML = `
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                    <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                `;
                container.appendChild(newItem);
                attachItemListeners();
            };
            
            // Quick add from products
            document.getElementById('inv-product-quick')?.addEventListener('change', (e) => {
                const prod = state.products.find(p => p.id === e.target.value);
                if (prod) {
                    const container = document.getElementById('line-items-container');
                    const newItem = document.createElement('div');
                    newItem.className = 'line-item';
                    newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                    newItem.innerHTML = `
                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;" value="${prod.name}">
                        <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;" value="${prod.price}">
                        <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                    `;
                    container.appendChild(newItem);
                    e.target.value = '';
                    attachItemListeners();
                    updateTotal();
                }
            });
            
            function attachItemListeners() {
                document.querySelectorAll('.btn-remove-item').forEach(btn => {
                    btn.onclick = (e) => {
                        const items = document.querySelectorAll('.line-item');
                        if (items.length > 1) {
                            e.target.closest('.line-item').remove();
                            updateTotal();
                        } else {
                            alert('At least one item required');
                        }
                    };
                });
                document.querySelectorAll('.item-qty, .item-price').forEach(input => {
                    input.oninput = updateTotal;
                });
            }
            
            function updateTotal() {
                let subtotal = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    subtotal += qty * price;
                });
                
                // Calculate discount
                const discountValue = parseFloat(document.getElementById('inv-discount')?.value) || 0;
                const discountType = document.getElementById('inv-discount-type')?.value || 'percent';
                let discountAmount = 0;
                if (discountValue > 0) {
                    discountAmount = discountType === 'percent' ? (subtotal * discountValue / 100) : discountValue;
                }
                
                const afterDiscount = subtotal - discountAmount;
                
                // Calculate VAT
                const includeVat = document.getElementById('inv-vat')?.checked;
                const vatAmount = includeVat ? afterDiscount * 0.075 : 0;
                
                // Shipping
                const includeShipping = document.getElementById('inv-shipping-toggle')?.checked;
                const shippingAmount = includeShipping ? (parseFloat(document.getElementById('inv-shipping-amount')?.value) || 0) : 0;
                const shippingDesc = document.getElementById('inv-shipping-desc')?.value?.trim() || 'Shipping';
                
                const total = afterDiscount + vatAmount + shippingAmount;
                
                // Update display
                document.getElementById('inv-subtotal').textContent = formatNaira(subtotal);
                document.getElementById('inv-discount-row').style.display = discountAmount > 0 ? 'flex' : 'none';
                document.getElementById('inv-discount-amount').textContent = '-' + formatNaira(discountAmount);
                document.getElementById('inv-vat-row').style.display = includeVat ? 'flex' : 'none';
                document.getElementById('inv-vat-amount').textContent = formatNaira(vatAmount);
                document.getElementById('inv-shipping-row').style.display = shippingAmount > 0 ? 'flex' : 'none';
                document.getElementById('inv-shipping-label').textContent = shippingDesc + ':';
                document.getElementById('inv-shipping-display').textContent = formatNaira(shippingAmount);
                document.getElementById('inv-total').textContent = formatNaira(total);
            }
            
            attachItemListeners();
            
            document.getElementById('modal-save').onclick = async () => {
                const cust = document.getElementById('inv-cust').value;
                const desc = document.getElementById('inv-desc').value.trim();
                const due = document.getElementById('inv-due').value;
                
                // Collect line items
                const items = [];
                let subtotal = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    if (name && price > 0) {
                        items.push({ name, qty, price });
                        subtotal += qty * price;
                    }
                });
                
                if (!desc || items.length === 0 || !due) return alert('Please fill invoice title, at least one item, and due date');
                
                // Calculate discount
                const discountValue = parseFloat(document.getElementById('inv-discount')?.value) || 0;
                const discountType = document.getElementById('inv-discount-type')?.value || 'percent';
                let discountAmount = 0;
                if (discountValue > 0) {
                    discountAmount = discountType === 'percent' ? (subtotal * discountValue / 100) : discountValue;
                }
                
                const afterDiscount = subtotal - discountAmount;
                
                // Calculate VAT
                const includeVat = document.getElementById('inv-vat')?.checked;
                const vatAmount = includeVat ? afterDiscount * 0.075 : 0;
                
                // Shipping
                const includeShipping = document.getElementById('inv-shipping-toggle')?.checked;
                const shippingDesc = document.getElementById('inv-shipping-desc')?.value?.trim() || 'Shipping/Delivery';
                const shippingAmount = includeShipping ? (parseFloat(document.getElementById('inv-shipping-amount')?.value) || 0) : 0;
                
                // Notes
                const notes = document.getElementById('inv-notes')?.value?.trim() || '';
                
                const total = afterDiscount + vatAmount + shippingAmount;
                
                try { 
                    await addInvoiceWithDetails(cust, desc, total, due, items, {
                        subtotal,
                        discount: discountAmount,
                        discountValue,
                        discountType,
                        vat: vatAmount,
                        includeVat,
                        shipping: shippingAmount,
                        shippingDesc: includeShipping ? shippingDesc : null,
                        notes
                    }); 
                    const newInvNumber = state.invoices[0].invoice_number;
                    closeModal(); 
                    render(); 
                    showToast(`Invoice ${newInvNumber} created!`, 'success');
                } catch (err) { alert('Error: ' + err.message); }
            };
        }
        
        async function addInvoiceWithDetails(customerId, description, amount, dueDate, items, details) {
            const invoiceNumber = 'INV-' + String(state.invoices.length + 1).padStart(4, '0');
            
            // Prepare invoice for Supabase - use exact column names from database
            const invoiceData = {
                invoice_number: invoiceNumber,
                customer_id: customerId,
                description,
                items: items,
                amount: amount,
                amount_paid: 0,
                due_date: dueDate,
                // These columns need to exist in database - run SQL migration first!
                subtotal: details.subtotal || amount,
                discount: details.discount || 0,
                discount_type: details.discountType || 'percent',
                vat_amount: details.vat || 0,
                include_vat: details.includeVat || false,
                shipping_amount: details.shipping || 0,
                shipping_desc: details.shippingDesc || null,
                notes: details.notes || ''
            };
            
            try {
                // Save to Supabase
                const created = await db.createInvoice(invoiceData);
                
                if (created) {
                    // Add to state with returned ID
                    state.invoices.unshift({
                        id: created.id,
                        invoice_number: created.invoice_number,
                        customer_id: created.customer_id,
                        description: created.description,
                        items: created.items || items,
                        amount: parseFloat(created.amount) || amount,
                        amount_paid: parseFloat(created.amount_paid) || 0,
                        subtotal: parseFloat(created.subtotal) || details.subtotal,
                        discount: parseFloat(created.discount) || 0,
                        discount_type: created.discount_type || 'percent',
                        vat: parseFloat(created.vat_amount) || 0,
                        include_vat: created.include_vat || false,
                        shipping: parseFloat(created.shipping_amount) || 0,
                        shipping_desc: created.shipping_desc || null,
                        notes: created.notes || '',
                        due_date: created.due_date,
                        created_at: created.created_at,
                        viewed_at: null
                    });
                    
                    // Track usage for subscription limits
                    await db.incrementUsage('invoice');
                } else {
                    throw new Error('Failed to create invoice');
                }
            } catch (err) {
                console.error('Error creating invoice:', err);
                showToast('Error saving invoice: ' + (err.message || 'Database error'), 'error');
                throw err;
            }
        }

        function showPaymentModal(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Record Payment<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div style="background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:20px;">
                                <div style="font-weight:600;margin-bottom:4px;">${cust?.name || 'Customer'}</div>
                                <div style="font-size:13px;color:#666;">${inv.description}</div>
                                <div style="margin-top:12px;display:flex;justify-content:space-between;">
                                    <span style="color:#666;">Outstanding:</span>
                                    <span style="font-weight:700;color:#dc2626;">${formatNaira(owed)}</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Amount (â‚¦)</label>
                                <input type="number" class="form-input" id="pay-amount" placeholder="0" max="${owed}" style="font-size:18px;font-weight:600;">
                                <button type="button" id="pay-full-btn" style="background:#dcfce7;color:#166534;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px;cursor:pointer;">Pay Full: ${formatNaira(owed)}</button>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="transfer">
                                        <input type="radio" name="pay-method" value="transfer" checked style="display:none;">
                                        <span style="font-size:20px;">ðŸ¦</span>
                                        <span style="font-size:13px;font-weight:500;">Transfer</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="cash">
                                        <input type="radio" name="pay-method" value="cash" style="display:none;">
                                        <span style="font-size:20px;">ðŸ’µ</span>
                                        <span style="font-size:13px;font-weight:500;">Cash</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="card">
                                        <input type="radio" name="pay-method" value="card" style="display:none;">
                                        <span style="font-size:20px;">ðŸ’³</span>
                                        <span style="font-size:13px;font-weight:500;">Card/POS</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;padding:12px;background:#f8fafc;border-radius:10px;cursor:pointer;border:2px solid transparent;" class="pay-method-option" data-method="paystack">
                                        <input type="radio" name="pay-method" value="paystack" style="display:none;">
                                        <span style="font-size:20px;">ðŸ”—</span>
                                        <span style="font-size:13px;font-weight:500;">Paystack</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Note (Optional)</label>
                                <input type="text" class="form-input" id="pay-note" placeholder="e.g. Bank transfer ref: 12345">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">ðŸ’° Record Payment</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Pay full button
            document.getElementById('pay-full-btn').onclick = () => {
                document.getElementById('pay-amount').value = owed;
            };
            
            // Payment method selection styling
            document.querySelectorAll('.pay-method-option').forEach(option => {
                option.onclick = () => {
                    document.querySelectorAll('.pay-method-option').forEach(o => o.style.borderColor = 'transparent');
                    option.style.borderColor = '#3b82f6';
                    option.querySelector('input').checked = true;
                };
            });
            // Select first option by default
            document.querySelector('.pay-method-option').style.borderColor = '#3b82f6';
            
            document.getElementById('modal-save').onclick = async () => {
                const amt = parseFloat(document.getElementById('pay-amount').value);
                const method = document.querySelector('input[name="pay-method"]:checked')?.value || 'transfer';
                const note = document.getElementById('pay-note').value.trim();
                
                if (!amt || amt <= 0) return alert('Enter a valid amount');
                if (amt > owed) return alert('Amount cannot exceed outstanding balance');
                
                try { 
                    await recordPayment(invoiceId, amt, method, note); 
                    closeModal(); 
                    
                    // Check if fully paid and show receipt option
                    const updatedInv = state.invoices.find(i => i.id === invoiceId);
                    if (updatedInv.amount_paid >= updatedInv.amount) {
                        showPaymentSuccessModal(invoiceId, amt, true);
                    } else {
                        showPaymentSuccessModal(invoiceId, amt, false);
                    }
                } catch (err) { 
                    alert('Error: ' + err.message); 
                }
            };
        }
        
        function showPaymentSuccessModal(invoiceId, amount, isFullyPaid) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="text-align:center;padding:32px;">
                        <div style="font-size:64px;margin-bottom:16px;">${isFullyPaid ? 'ðŸŽ‰' : 'âœ…'}</div>
                        <h2 style="margin-bottom:8px;">${isFullyPaid ? 'Invoice Fully Paid!' : 'Payment Recorded!'}</h2>
                        <p style="color:#666;margin-bottom:24px;">
                            ${formatNaira(amount)} received from ${cust?.name}
                            ${isFullyPaid ? '<br><span style="color:#16a34a;font-weight:600;">Balance: â‚¦0</span>' : `<br>Remaining: ${formatNaira(inv.amount - inv.amount_paid)}`}
                        </p>
                        
                        ${isFullyPaid ? `
                            <button class="btn btn-primary" id="success-receipt" style="width:100%;margin-bottom:12px;">
                                ðŸ§¾ Generate Receipt
                            </button>
                        ` : ''}
                        
                        <button class="btn ${isFullyPaid ? 'btn-secondary' : 'btn-primary'}" id="success-close" style="width:100%;">
                            ${isFullyPaid ? 'Done' : 'OK'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('success-close').onclick = () => {
                closeModal();
                render();
            };
            
            document.getElementById('success-receipt')?.addEventListener('click', () => {
                closeModal();
                generateReceipt(invoiceId);
                render();
            });
        }

        // ========== CUSTOMER PORTAL ==========
        function showSharePortalModal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            const portalUrl = `${window.location.origin}${window.location.pathname}#portal/${customerId}`;
            
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId);
            const totalOwed = custInvoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Share Payment Portal<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div style="text-align:center;margin-bottom:20px;">
                                <div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;margin:0 auto 12px;">
                                    ${cust.name.charAt(0).toUpperCase()}
                                </div>
                                <div style="font-weight:700;font-size:18px;">${cust.name}</div>
                                <div style="color:#666;">${cust.phone}</div>
                                ${totalOwed > 0 ? `<div style="margin-top:8px;color:#dc2626;font-weight:600;">Owes ${formatNaira(totalOwed)}</div>` : '<div style="margin-top:8px;color:#16a34a;">âœ“ All paid up</div>'}
                            </div>
                            
                            <div style="background:#f8fafc;padding:16px;border-radius:12px;margin-bottom:16px;">
                                <div style="font-size:12px;color:#666;margin-bottom:8px;">Portal Link</div>
                                <div style="display:flex;gap:8px;">
                                    <input type="text" class="form-input" id="portal-link" value="${portalUrl}" readonly style="flex:1;font-size:12px;">
                                    <button class="btn btn-primary" id="copy-portal-link" style="padding:10px 16px;">ðŸ“‹ Copy</button>
                                </div>
                            </div>
                            
                            <div style="font-size:13px;color:#666;margin-bottom:16px;">
                                <strong>What your customer can do:</strong>
                                <ul style="margin:8px 0 0 16px;padding:0;">
                                    <li>View all their invoices</li>
                                    <li>See payment history</li>
                                    <li>Pay directly via Paystack</li>
                                    <li>Download receipts</li>
                                </ul>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                                <button class="btn btn-secondary" id="share-whatsapp" style="padding:14px;">
                                    ðŸ’¬ WhatsApp
                                </button>
                                <button class="btn btn-secondary" id="share-sms" style="padding:14px;">
                                    ðŸ“± SMS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            
            document.getElementById('copy-portal-link').onclick = () => {
                const input = document.getElementById('portal-link');
                input.select();
                document.execCommand('copy');
                showToast('Link copied! ðŸ“‹', 'success');
            };
            
            document.getElementById('share-whatsapp').onclick = () => {
                const message = `Hi ${cust.name},\n\nHere's your payment portal to view invoices and make payments:\n${portalUrl}\n\n- ${state.businessProfile.name || 'Owo Mi'}`;
                let phone = cust.phone.replace(/\s/g, '');
                if (phone.startsWith('0')) phone = '234' + phone.slice(1);
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
                closeModal();
            };
            
            document.getElementById('share-sms').onclick = () => {
                const message = `Hi ${cust.name}, view your invoices & pay online: ${portalUrl}`;
                window.open(`sms:${cust.phone}?body=${encodeURIComponent(message)}`, '_blank');
                closeModal();
            };
        }
        
        function renderPortal() {
            const app = document.getElementById('app');
            app.innerHTML = renderCustomerPortal(state.portalCustomerId);
            
            // Mark all customer's invoices as viewed when they open the portal
            const customerInvoices = state.invoices.filter(inv => inv.customer_id === state.portalCustomerId);
            customerInvoices.forEach(inv => {
                if (!inv.viewed_at) {
                    inv.viewed_at = new Date().toISOString();
                }
            });
            localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
            
            attachPortalEvents();
        }
        
        function attachPortalEvents() {
            // Pay All button
            document.getElementById('portal-pay-all')?.addEventListener('click', function() {
                const amount = parseFloat(this.dataset.amount);
                if (state.businessProfile.paystackEnabled && state.businessProfile.paystackPublicKey) {
                    initiatePortalPayment(null, amount, true);
                } else {
                    showPortalPaymentInfo(amount, 'all invoices');
                }
            });
            
            // Bank details buttons
            document.querySelectorAll('[data-portal-bank]').forEach(btn => {
                btn.onclick = () => {
                    const invoiceId = btn.dataset.portalBank;
                    const amount = parseFloat(btn.dataset.amount);
                    showPortalPaymentInfo(amount, invoiceId);
                };
            });
            
            // Individual pay buttons (Paystack)
            document.querySelectorAll('[data-portal-pay]').forEach(btn => {
                btn.onclick = () => {
                    const invoiceId = btn.dataset.portalPay;
                    const amount = parseFloat(btn.dataset.amount);
                    initiatePortalPayment(invoiceId, amount, false);
                };
            });
            
            // View invoice buttons
            document.querySelectorAll('[data-portal-view]').forEach(btn => {
                btn.onclick = () => {
                    const invoiceId = btn.dataset.portalView;
                    // Mark as viewed
                    markInvoiceViewed(invoiceId);
                    generatePDF(invoiceId);
                };
            });
            
            // Receipt buttons
            document.querySelectorAll('[data-portal-receipt]').forEach(btn => {
                btn.onclick = () => generateReceipt(btn.dataset.portalReceipt);
            });
        }
        
        function markInvoiceViewed(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            if (inv && !inv.viewed_at) {
                inv.viewed_at = new Date().toISOString();
                localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                // Could also sync to Supabase here for real-time tracking
            }
        }
        
        function initiatePortalPayment(invoiceId, amount, isPayAll) {
            const cust = state.customers.find(c => c.id === state.portalCustomerId);
            const p = state.businessProfile;
            
            // Check if Paystack is available
            if (!p.paystackEnabled || !p.paystackPublicKey) {
                // Show bank details modal instead
                showPortalPaymentInfo(amount, isPayAll ? 'all invoices' : invoiceId);
                return;
            }
            
            const ref = 'PORTAL-' + Date.now();
            
            // Initialize Paystack
            const handler = PaystackPop.setup({
                key: p.paystackPublicKey,
                email: cust.email || `${cust.phone}@owomi.portal`,
                amount: amount * 100, // Paystack uses kobo
                currency: 'NGN',
                ref: ref,
                metadata: {
                    custom_fields: [
                        { display_name: 'Customer', variable_name: 'customer', value: cust.name },
                        { display_name: 'Phone', variable_name: 'phone', value: cust.phone },
                        { display_name: 'Invoice', variable_name: 'invoice', value: invoiceId || 'Multiple' }
                    ]
                },
                callback: function(response) {
                    // Payment successful
                    if (isPayAll) {
                        // Mark all unpaid invoices as paid
                        const unpaid = state.invoices.filter(i => i.customer_id === state.portalCustomerId && getStatus(i) !== 'paid');
                        unpaid.forEach(inv => {
                            inv.amount_paid = inv.amount;
                            inv.paid_date = new Date().toISOString();
                            state.paymentHistory.push({
                                id: 'pay-' + Date.now(),
                                invoiceId: inv.id,
                                customerId: cust.id,
                                customerName: cust.name,
                                invoiceNumber: inv.invoice_number,
                                amount: inv.amount - inv.amount_paid,
                                method: 'paystack',
                                note: 'Portal payment - ' + response.reference,
                                date: new Date().toISOString(),
                                isFullPayment: true
                            });
                        });
                    } else {
                        // Mark single invoice as paid
                        const inv = state.invoices.find(i => i.id === invoiceId);
                        if (inv) {
                            inv.amount_paid = inv.amount;
                            inv.paid_date = new Date().toISOString();
                            state.paymentHistory.push({
                                id: 'pay-' + Date.now(),
                                invoiceId: inv.id,
                                customerId: cust.id,
                                customerName: cust.name,
                                invoiceNumber: inv.invoice_number,
                                amount: amount,
                                method: 'paystack',
                                note: 'Portal payment - ' + response.reference,
                                date: new Date().toISOString(),
                                isFullPayment: true
                            });
                        }
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                    localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
                    
                    // Show success and refresh
                    alert('ðŸŽ‰ Payment successful!\n\nReference: ' + response.reference + '\n\nThank you for your payment!');
                    renderPortal();
                },
                onClose: function() {
                    // User closed popup
                }
            });
            
            handler.openIframe();
        }
        
        function showPortalPaymentInfo(amount, invoiceRef) {
            const p = state.businessProfile;
            const cust = state.customers.find(c => c.id === state.portalCustomerId);
            const inv = invoiceRef !== 'all invoices' ? state.invoices.find(i => i.id === invoiceRef) : null;
            const invNumber = inv?.invoice_number || invoiceRef;
            
            const modal = document.createElement('div');
            modal.className = 'portal-modal';
            modal.innerHTML = `
                <div class="portal-modal-bg"></div>
                <div class="portal-modal-box">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="font-size:48px;margin-bottom:12px;">ðŸ¦</div>
                        <h2 style="margin-bottom:8px;">Bank Transfer</h2>
                        <p style="color:#666;">Amount: <strong style="color:#16a34a;font-size:20px;">${formatNaira(amount)}</strong></p>
                        ${inv ? `<p style="color:#888;font-size:13px;">Invoice: ${invNumber}</p>` : ''}
                    </div>
                    
                    ${p.paymentQR ? `
                        <div style="text-align:center;margin-bottom:16px;">
                            <div style="background:#f0fdf4;padding:16px;border-radius:12px;border:2px solid #16a34a;display:inline-block;">
                                <img src="${p.paymentQR}" style="max-width:180px;max-height:180px;border-radius:8px;">
                                <p style="font-size:13px;color:#166534;margin-top:8px;font-weight:600;">ðŸ“± Scan with OPay, Bank App, etc.</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${p.bank ? `
                        <div style="background:#dcfce7;padding:16px;border-radius:12px;margin-bottom:16px;border:2px solid #16a34a;">
                            <div style="font-weight:600;margin-bottom:12px;color:#166534;">ðŸ’° ${p.paymentQR ? 'Or Transfer to:' : 'Transfer to:'}</div>
                            <div style="white-space:pre-line;font-size:15px;line-height:1.8;color:#166534;">${p.bank}</div>
                        </div>
                    ` : !p.paymentQR ? `
                        <div style="background:#fee2e2;padding:16px;border-radius:12px;margin-bottom:16px;">
                            <p style="color:#dc2626;">Payment details not available. Please contact the business directly.</p>
                        </div>
                    ` : ''}
                    
                    <div style="background:#fef3c7;padding:16px;border-radius:12px;margin-bottom:16px;">
                        <div style="font-weight:600;margin-bottom:8px;color:#92400e;">ðŸ“ After Payment:</div>
                        <ol style="font-size:13px;color:#78350f;margin-left:16px;">
                            <li style="margin-bottom:4px;">Use "<strong>${cust?.name || 'your name'}</strong>" as reference</li>
                            <li>Send screenshot to business via WhatsApp</li>
                        </ol>
                    </div>
                    
                    <div style="display:grid;gap:8px;">
                        ${p.phone ? `<a href="https://wa.me/234${p.phone.replace(/^0/, '')}?text=${encodeURIComponent(`Hi! I just paid ${formatNaira(amount)} for invoice ${invNumber}. Here's my proof of payment:`)}" class="portal-modal-btn whatsapp" target="_blank">ðŸ’¬ Send Proof via WhatsApp</a>` : ''}
                        ${p.phone ? `<a href="tel:${p.phone}" class="portal-modal-btn">ðŸ“ž Call ${p.name || 'Business'}</a>` : ''}
                        <button class="portal-modal-btn close" onclick="this.closest('.portal-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showEditInvoiceModal(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            
            const itemsHtml = items.map(item => `
                <div class="line-item" style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;" value="${item.name}">
                    <input type="number" class="form-input item-qty" placeholder="Qty" min="1" style="flex:0.5;text-align:center;" value="${item.qty}">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;" value="${item.price}">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                </div>
            `).join('');
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">Edit Invoice<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Invoice Title</label><input type="text" class="form-input" id="edit-desc" value="${inv.description}"></div>
                            
                            <div class="form-group">
                                <label class="form-label">Line Items</label>
                                <div id="line-items-container">
                                    ${itemsHtml}
                                </div>
                                <button type="button" id="btn-add-item" style="background:#f0f0f0;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;width:100%;margin-top:8px;">+ Add Item</button>
                            </div>
                            
                            <div class="form-group" style="background:#f9f9f9;padding:12px;border-radius:8px;">
                                <div style="display:flex;justify-content:space-between;font-weight:600;">
                                    <span>Total:</span>
                                    <span id="edit-total">${formatNaira(inv.amount)}</span>
                                </div>
                            </div>
                            
                            <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="edit-due" value="${inv.due_date}"></div>
                            <button class="btn btn-danger" id="btn-delete-inv" style="margin-top:12px;">ðŸ—‘ï¸ Delete Invoice</button>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            
            // Add item button
            document.getElementById('btn-add-item').onclick = () => {
                const container = document.getElementById('line-items-container');
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                newItem.innerHTML = `
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                    <input type="number" class="form-input item-qty" placeholder="Qty" value="1" min="1" style="flex:0.5;text-align:center;">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                `;
                container.appendChild(newItem);
                attachEditItemListeners();
            };
            
            function attachEditItemListeners() {
                document.querySelectorAll('.btn-remove-item').forEach(btn => {
                    btn.onclick = (e) => {
                        const items = document.querySelectorAll('.line-item');
                        if (items.length > 1) {
                            e.target.closest('.line-item').remove();
                            updateEditTotal();
                        } else {
                            alert('At least one item required');
                        }
                    };
                });
                document.querySelectorAll('.item-qty, .item-price').forEach(input => {
                    input.oninput = updateEditTotal;
                });
            }
            
            function updateEditTotal() {
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    total += qty * price;
                });
                document.getElementById('edit-total').textContent = formatNaira(total);
            }
            
            attachEditItemListeners();
            
            document.getElementById('btn-delete-inv').onclick = async () => {
                if (confirm('Delete this invoice?')) {
                    if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                        await supabaseQuery('invoices', { method: 'DELETE', query: `id=eq.${invoiceId}` });
                    }
                    state.invoices = state.invoices.filter(i => i.id !== invoiceId);
                    closeModal(); render();
                }
            };
            
            document.getElementById('modal-save').onclick = async () => {
                const desc = document.getElementById('edit-desc').value.trim();
                const due = document.getElementById('edit-due').value;
                
                // Collect line items
                const newItems = [];
                let total = 0;
                document.querySelectorAll('.line-item').forEach(row => {
                    const name = row.querySelector('.item-name').value.trim();
                    const qty = parseFloat(row.querySelector('.item-qty').value) || 1;
                    const price = parseFloat(row.querySelector('.item-price').value) || 0;
                    if (name && price > 0) {
                        newItems.push({ name, qty, price });
                        total += qty * price;
                    }
                });
                
                if (!desc || newItems.length === 0 || !due) return alert('Please fill all fields');
                
                if (!(typeof DEV_MODE !== 'undefined' && DEV_MODE)) {
                    await supabaseQuery('invoices', { method: 'PATCH', query: `id=eq.${invoiceId}`, body: { description: desc, amount: total, due_date: due, items: newItems } });
                }
                const idx = state.invoices.findIndex(i => i.id === invoiceId);
                state.invoices[idx] = { ...state.invoices[idx], description: desc, amount: total, due_date: due, items: newItems };
                closeModal(); render();
            };
        }

        function showEditCustomerModal(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Customer<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="edit-name" value="${cust.name}"></div>
                            <div class="form-group"><label class="form-label">Phone</label><input type="text" class="form-input" id="edit-phone" value="${cust.phone}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('edit-name').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                if (!name || !phone) return alert('Please fill all fields');
                try {
                    await db.updateCustomer(customerId, { name, phone });
                    const idx = state.customers.findIndex(c => c.id === customerId);
                    state.customers[idx] = { ...state.customers[idx], name, phone };
                    closeModal(); 
                    showToast('Customer updated', 'success');
                    render();
                } catch (err) {
                    console.error('Update failed:', err);
                    showToast('Error updating customer', 'error');
                }
            };
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Delete customer and all their invoices?')) return;
            try {
                await db.deleteCustomer(customerId);
                state.customers = state.customers.filter(c => c.id !== customerId);
                state.invoices = state.invoices.filter(i => i.customer_id !== customerId);
                showToast('Customer deleted', 'success');
                render();
            } catch (err) {
                console.error('Delete failed:', err);
                showToast('Error deleting customer', 'error');
            }
        }

        function showRecurringModal() {
            if (state.customers.length === 0) { alert('Add a customer first!'); return; }
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">New Recurring<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Customer</label><select class="form-input" id="rec-cust">${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="rec-desc" placeholder="e.g. Monthly Retainer"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="rec-amt" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Frequency</label><select class="form-input" id="rec-freq"><option value="weekly">Weekly</option><option value="monthly" selected>Monthly</option><option value="quarterly">Quarterly</option></select></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Create</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const cust = document.getElementById('rec-cust').value;
                const desc = document.getElementById('rec-desc').value.trim();
                const amt = parseFloat(document.getElementById('rec-amt').value);
                const freq = document.getElementById('rec-freq').value;
                if (!desc || !amt) return alert('Please fill all fields');
                
                try {
                    const newTemplate = await db.createRecurringTemplate({
                        customer_id: cust || null,
                        description: desc,
                        amount: amt,
                        frequency: freq,
                        active: true
                    });
                    if (newTemplate) {
                        state.recurringTemplates.push({
                            id: newTemplate.id,
                            customerId: newTemplate.customer_id,
                            description: newTemplate.description,
                            amount: newTemplate.amount,
                            frequency: newTemplate.frequency,
                            active: newTemplate.active
                        });
                    }
                    closeModal(); render();
                    showToast('Recurring template added!', 'success');
                } catch (err) {
                    console.error('Create recurring template failed:', err);
                    showToast('Error adding template', 'error');
                }
            };
        }

        function showProductModal() {
            // Check plan limits
            if (!canDoAction('products')) {
                showUpgradeModal(`You've reached your product limit (${getPlanLimit('products')} products). Upgrade to add more!`);
                return;
            }
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Product/Service<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="prod-name" placeholder="e.g. Website Design"></div>
                            <div class="form-group"><label class="form-label">Price (â‚¦)</label><input type="number" class="form-input" id="prod-price" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Description (optional)</label><input type="text" class="form-input" id="prod-desc" placeholder="Brief description"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Product</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('prod-name').value.trim();
                const price = parseFloat(document.getElementById('prod-price').value);
                const description = document.getElementById('prod-desc').value.trim();
                if (!name || !price) return alert('Please enter name and price');
                try {
                    const newProduct = await db.createProduct({ name, price, description });
                    if (newProduct) {
                        state.products.push({ id: newProduct.id, name, price, description });
                    }
                    closeModal(); render();
                    showToast('Product added!', 'success');
                } catch (err) {
                    console.error('Create product failed:', err);
                    showToast('Error adding product', 'error');
                }
            };
        }

        function showEditProductModal(productId) {
            const prod = state.products.find(p => p.id === productId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Product<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="prod-name" value="${prod.name}"></div>
                            <div class="form-group"><label class="form-label">Price (â‚¦)</label><input type="number" class="form-input" id="prod-price" value="${prod.price}"></div>
                            <div class="form-group"><label class="form-label">Description (optional)</label><input type="text" class="form-input" id="prod-desc" value="${prod.description || ''}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const name = document.getElementById('prod-name').value.trim();
                const price = parseFloat(document.getElementById('prod-price').value);
                const description = document.getElementById('prod-desc').value.trim();
                if (!name || !price) return alert('Please enter name and price');
                try {
                    await db.updateProduct(productId, { name, price, description });
                    const idx = state.products.findIndex(p => p.id === productId);
                    state.products[idx] = { ...state.products[idx], name, price, description };
                    closeModal(); render();
                    showToast('Product updated!', 'success');
                } catch (err) {
                    console.error('Update product failed:', err);
                    showToast('Error updating product', 'error');
                }
            };
        }

        function showExpenseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Add Expense<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="exp-desc" placeholder="What was this expense for?"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="exp-amount" placeholder="0"></div>
                            <div class="form-group"><label class="form-label">Category</label>
                                <select class="form-input" id="exp-cat">
                                    <option value="Software">Software & Tools</option>
                                    <option value="Utilities">Utilities (Internet, Power)</option>
                                    <option value="Labor">Labor & Freelancers</option>
                                    <option value="Supplies">Office Supplies</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Marketing">Marketing & Ads</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="exp-date" value="${today}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Add Expense</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const description = document.getElementById('exp-desc').value.trim();
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-cat').value;
                const date = document.getElementById('exp-date').value;
                if (!description || !amount) return alert('Please enter description and amount');
                try {
                    const newExpense = await db.createExpense({ description, amount, category, date });
                    if (newExpense) {
                        state.expenses.push({ id: newExpense.id, description, amount, category, date });
                    }
                    closeModal(); render();
                    showToast('Expense added!', 'success');
                } catch (err) {
                    console.error('Create expense failed:', err);
                    showToast('Error adding expense', 'error');
                }
            };
        }

        function showEditExpenseModal(expenseId) {
            const exp = state.expenses.find(e => e.id === expenseId);
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">Edit Expense<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="exp-desc" value="${exp.description}"></div>
                            <div class="form-group"><label class="form-label">Amount (â‚¦)</label><input type="number" class="form-input" id="exp-amount" value="${exp.amount}"></div>
                            <div class="form-group"><label class="form-label">Category</label>
                                <select class="form-input" id="exp-cat">
                                    <option value="Software" ${exp.category === 'Software' ? 'selected' : ''}>Software & Tools</option>
                                    <option value="Utilities" ${exp.category === 'Utilities' ? 'selected' : ''}>Utilities (Internet, Power)</option>
                                    <option value="Labor" ${exp.category === 'Labor' ? 'selected' : ''}>Labor & Freelancers</option>
                                    <option value="Supplies" ${exp.category === 'Supplies' ? 'selected' : ''}>Office Supplies</option>
                                    <option value="Transport" ${exp.category === 'Transport' ? 'selected' : ''}>Transport</option>
                                    <option value="Marketing" ${exp.category === 'Marketing' ? 'selected' : ''}>Marketing & Ads</option>
                                    <option value="Other" ${exp.category === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="exp-date" value="${exp.date}"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                            <button class="btn btn-primary" id="modal-save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('modal-cancel').onclick = closeModal;
            document.getElementById('modal-save').onclick = async () => {
                const description = document.getElementById('exp-desc').value.trim();
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const category = document.getElementById('exp-cat').value;
                const date = document.getElementById('exp-date').value;
                if (!description || !amount) return alert('Please enter description and amount');
                try {
                    await db.updateExpense(expenseId, { description, amount, category, date });
                    const idx = state.expenses.findIndex(e => e.id === expenseId);
                    state.expenses[idx] = { ...state.expenses[idx], description, amount, category, date };
                    closeModal(); render();
                    showToast('Expense updated!', 'success');
                } catch (err) {
                    console.error('Update expense failed:', err);
                    showToast('Error updating expense', 'error');
                }
            };
        }

        async function generateRecurring(templateId) {
            const tmpl = state.recurringTemplates.find(t => t.id === templateId);
            if (!tmpl) return;
            const due = new Date();
            due.setDate(due.getDate() + 30);
            try {
                await addInvoice(tmpl.customerId, tmpl.description + ' (Auto)', tmpl.amount, due.toISOString().split('T')[0]);
                alert('Invoice generated! Number: ' + state.invoices[0].invoice_number);
                render();
            } catch (err) { alert('Error: ' + err.message); }
        }

        function showAIModal() {
            document.getElementById('modal-container').innerHTML = `
                <div class="modal ai-modal">
                    <div class="modal-box">
                        <div class="modal-header">ðŸ¤– AI Assistant<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="ai-messages" id="ai-messages">
                            <div class="ai-msg assistant"><div class="ai-bubble">How far! ðŸ‘‹ I be your business assistant. I fit help you with:<br><br>
                            ðŸ“„ <b>Invoice</b> - "Invoice Chidi â‚¦50k for website"<br>
                            ðŸ‘¤ <b>Customer</b> - "Add customer Bola 08012345678"<br>
                            ðŸ’° <b>Payment</b> - "Record â‚¦20k for INV-001"<br>
                            ðŸ“± <b>Reminder</b> - "Remind Amaka" or "Send all reminders"<br>
                            ðŸ“Š <b>Report</b> - "Who owes me?" or "Wetin be my total?"<br><br>
                            You fit talk English or Pidgin - I go understand! ðŸ‡³ðŸ‡¬</div></div>
                        </div>
                        <div class="ai-input-area">
                            <input type="text" class="ai-input" id="ai-input" placeholder="Try: Who dey owe me? ...">
                            <button class="ai-send" id="ai-send">âž¤</button>
                            <button class="ai-stop hidden" id="ai-stop" style="background:#ef4444;color:white;border:none;width:48px;height:48px;border-radius:50%;cursor:pointer;font-size:16px;">â¹</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('ai-send').onclick = sendAIMessage;
            document.getElementById('ai-stop').onclick = stopAIMessage;
            document.getElementById('ai-input').onkeypress = (e) => { if (e.key === 'Enter') sendAIMessage(); };
        }

        // Track last suggestion for context
        let lastAISuggestion = null;
        let aiProcessing = false;
        let aiAborted = false;

        function stopAIMessage() {
            aiAborted = true;
            aiProcessing = false;
            document.getElementById('typing')?.remove();
            document.getElementById('ai-send')?.classList.remove('hidden');
            document.getElementById('ai-stop')?.classList.add('hidden');
            
            const messages = document.getElementById('ai-messages');
            if (messages) {
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">â¹ Stopped. What else can I help with?</div></div>`;
                messages.scrollTop = messages.scrollHeight;
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const messages = document.getElementById('ai-messages');
            const userText = input.value.trim();
            if (!userText || aiProcessing) return;

            aiProcessing = true;
            aiAborted = false;
            
            // Show stop button, hide send
            document.getElementById('ai-send')?.classList.add('hidden');
            document.getElementById('ai-stop')?.classList.remove('hidden');

            messages.innerHTML += `<div class="ai-msg user"><div class="ai-bubble">${userText}</div></div>`;
            input.value = '';
            messages.innerHTML += `<div class="ai-msg assistant" id="typing"><div class="ai-bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>`;
            messages.scrollTop = messages.scrollHeight;

            try {
                // Process the command
                await new Promise(r => setTimeout(r, 300));
                
                if (aiAborted) return;
                
                const result = await processAICommand(userText);
                
                if (aiAborted) return;
                
                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">${result.replace(/\n/g, '<br>')}</div></div>`;
                messages.scrollTop = messages.scrollHeight;
                
                // Re-render if data changed
                if (result.includes('âœ…') || result.includes('Created') || result.includes('Recorded') || result.includes('Added') || result.includes('Sent')) {
                    render();
                }
            } catch (err) {
                document.getElementById('typing')?.remove();
                messages.innerHTML += `<div class="ai-msg assistant"><div class="ai-bubble">âŒ Error: ${err.message}</div></div>`;
                messages.scrollTop = messages.scrollHeight;
            } finally {
                aiProcessing = false;
                document.getElementById('ai-send')?.classList.remove('hidden');
                document.getElementById('ai-stop')?.classList.add('hidden');
            }
        }

        async function processAICommand(text) {
            const qLower = text.toLowerCase();
            
            // ============ HANDLE YES/NO/CONFIRMATION ============
            if (qLower.match(/^(yes|yeah|yep|sure|ok|okay|do it|go ahead|please|send it|confirm)$/i)) {
                if (lastAISuggestion) {
                    const suggestion = lastAISuggestion;
                    lastAISuggestion = null; // Clear it
                    return await processAICommand(suggestion);
                }
                return "What would you like me to do? Try: \"Who owes me?\" or \"Show summary\"";
            }
            
            if (qLower.match(/^(no|nope|nah|cancel|never mind|forget it)$/i)) {
                lastAISuggestion = null;
                return "No problem! What else can I help with?";
            }
            
            // ============ FIX COMMON TYPOS ============
            let fixedText = text
                .replace(/\bown\b/gi, 'owe')      // own â†’ owe
                .replace(/\bowns\b/gi, 'owes')    // owns â†’ owes
                .replace(/\bthey\b/gi, '')        // remove "they" 
                .replace(/\bweting\b/gi, 'wetin') // weting â†’ wetin
                .replace(/\bremid\b/gi, 'remind') // remid â†’ remind
                .replace(/\binvoic\b/gi, 'invoice'); // invoic â†’ invoice
            
            const qFixed = fixedText.toLowerCase().trim();
            
            // Check if user is speaking Pidgin
            const isPidgin = qFixed.match(/\b(wetin|abi|shey|abeg|dey|na|oga|madam|wahala|chop|japa|sabi|no be|e be like|how far|i wan|make i)\b/i);
            
            // Pidgin phrases helper
            const pidgin = {
                success: isPidgin ? 'E don work!' : 'âœ…',
                nobody: isPidgin ? 'Nobody dey owe you o! Na clean sheet! ðŸŽ‰' : 'Nobody owes you money! ðŸŽ‰ All invoices are paid.',
                remind: isPidgin ? 'Make I remind am?' : 'Want me to remind them?',
                error: isPidgin ? 'Wahala dey o!' : 'âŒ Error',
                noProblem: isPidgin ? 'No wahala! Wetin else?' : 'No problem! What else can I help with?',
                whatDo: isPidgin ? 'Wetin you wan make I do?' : 'What would you like me to do?',
                created: isPidgin ? 'E don create!' : 'Created!',
                sent: isPidgin ? 'E don send!' : 'Sent!',
                recorded: isPidgin ? 'E don enter book!' : 'Recorded!',
                looking: isPidgin ? 'E dey look fine!' : 'Looking good!',
                payLink: isPidgin ? 'You wan make I send payment link? Talk "yes"' : 'Want me to send a payment link? Say "yes"',
                receipt: isPidgin ? 'You wan receipt? Talk "yes"' : 'Want me to generate a receipt? Say "yes"',
                thanks: isPidgin ? 'Oya na! ' : '',
                greeting: isPidgin ? 'How far! ' : 'Hey! '
            };
            
            // Helper to check time filters
            const getTimeFilter = () => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(today); weekAgo.setDate(weekAgo.getDate() - 7);
                const monthAgo = new Date(today); monthAgo.setDate(monthAgo.getDate() - 30);
                
                if (qFixed.includes('today')) return { start: today, label: 'today' };
                if (qFixed.includes('this week') || qFixed.includes('week')) return { start: weekAgo, label: 'this week' };
                if (qFixed.includes('this month') || qFixed.includes('month')) return { start: monthAgo, label: 'this month' };
                return null;
            };
            
            // Helper to find customer by name (fuzzy)
            const findCustomer = (name) => {
                const n = name.toLowerCase().trim();
                return state.customers.find(c => 
                    c.name.toLowerCase().includes(n) || 
                    c.name.toLowerCase().split(' ').some(part => part.startsWith(n))
                );
            };
            
            // Helper to find invoice by number
            const findInvoice = (num) => {
                const n = num.toUpperCase().replace(/[^0-9A-Z]/g, '');
                return state.invoices.find(i => 
                    i.invoice_number?.toUpperCase().includes(n) ||
                    i.id.toUpperCase().includes(n)
                );
            };
            
            // Helper to parse amount
            const parseAmount = (text) => {
                const match = text.match(/â‚¦?\s*([\d,]+)\s*k?/i);
                if (match) {
                    let num = parseFloat(match[1].replace(/,/g, ''));
                    if (text.toLowerCase().includes('k')) num *= 1000;
                    return num;
                }
                return null;
            };

            // ============ CREATE INVOICE ============
            if (qFixed.includes('invoice') && (qFixed.includes('create') || qFixed.includes('new') || qFixed.includes('make') || qFixed.match(/invoice\s+\w+/))) {
                // Parse: "Invoice Chidi 50k for website design"
                // or: "Create invoice for Amaka â‚¦100,000 website"
                
                // Extract customer name (first capitalized word after invoice/for)
                const nameMatch = text.match(/(?:invoice|for)\s+([A-Z][a-z]+)/i);
                const customerName = nameMatch ? nameMatch[1] : null;
                
                if (!customerName) {
                    return "Who should I invoice? Try: \"Invoice Chidi â‚¦50k for website\"";
                }
                
                const customer = findCustomer(customerName);
                if (!customer) {
                    return `I don't know "${customerName}". Add them first:\n"Add customer ${customerName} 08012345678"`;
                }
                
                // Extract amount
                const amount = parseAmount(text);
                if (!amount) {
                    return `What's the amount? Try: "Invoice ${customer.name} â‚¦50k for website"`;
                }
                
                // Extract description (after "for")
                const descMatch = text.match(/for\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i) || text.match(/for\s+(.+)$/i);
                let description = descMatch ? descMatch[1].trim() : 'Services';
                description = description.charAt(0).toUpperCase() + description.slice(1);
                
                // Create invoice
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 14); // 2 weeks from now
                const dueDateStr = dueDate.toISOString().split('T')[0];
                
                try {
                    await addInvoice(customer.id, description, amount, dueDateStr, [{name: description, qty: 1, price: amount}]);
                    const invNumber = state.invoices[0].invoice_number;
                    // Set suggestion for follow-up
                    lastAISuggestion = `Payment link for ${customer.name}`;
                    
                    if (isPidgin) {
                        return `âœ… Invoice don create!\n\nðŸ“„ ${invNumber}\nðŸ‘¤ ${customer.name}\nðŸ’° â‚¦${amount.toLocaleString()}\nðŸ“ ${description}\nðŸ“… Due date: ${formatDate(dueDateStr)}\n\nMake I send payment link? Talk "yes" ðŸ“±`;
                    }
                    return `âœ… Invoice created!\n\nðŸ“„ ${invNumber}\nðŸ‘¤ ${customer.name}\nðŸ’° â‚¦${amount.toLocaleString()}\nðŸ“ ${description}\nðŸ“… Due: ${formatDate(dueDateStr)}\n\nWant me to send a payment link? Say "yes" ðŸ“±`;
                } catch (err) {
                    return isPidgin ? `âŒ Wahala dey: ${err.message}` : `âŒ Error creating invoice: ${err.message}`;
                }
            }
            
            // ============ ADD CUSTOMER ============
            if (qFixed.includes('add') && qFixed.includes('customer') || qFixed.includes('new customer')) {
                // Parse: "Add customer Bola 08012345678"
                const match = text.match(/customer\s+([A-Za-z]+(?:\s+[A-Za-z]+)?)\s*(0\d{10})?/i);
                
                if (!match || !match[1]) {
                    return "Please specify name and phone:\n\"Add customer Bola Ogunlade 08012345678\"";
                }
                
                const name = match[1].trim();
                const phone = match[2] || '';
                
                if (!phone) {
                    return `What's ${name}'s phone number?\n"Add customer ${name} 08012345678"`;
                }
                
                // Check if exists
                if (findCustomer(name)) {
                    return `${name} is already a customer!`;
                }
                
                try {
                    await addCustomer(name, phone);
                    lastAISuggestion = `Invoice ${name} â‚¦50000 for services`;
                    return `âœ… Customer added!\n\nðŸ‘¤ ${name}\nðŸ“± ${phone}\n\nWant to create an invoice for them? Say "yes" or tell me the amount ðŸ“„`;
                } catch (err) {
                    return `âŒ Error: ${err.message}`;
                }
            }
            
            // ============ RECORD PAYMENT ============
            if (qFixed.includes('record') && (qFixed.includes('payment') || qFixed.includes('â‚¦') || qFixed.match(/\d+k?\s/))) {
                // Parse: "Record â‚¦20k for INV-001" or "Record payment 50000 Chidi"
                const amount = parseAmount(text);
                
                if (!amount) {
                    return "What amount? Try: \"Record â‚¦20k for INV-001\"";
                }
                
                // Find invoice by number or customer name
                let invoice = null;
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    invoice = findInvoice(invMatch[0]);
                }
                
                if (!invoice) {
                    // Try to find by customer name
                    const nameMatch = text.match(/(?:for|from)\s+([A-Z][a-z]+)/i);
                    if (nameMatch) {
                        const customer = findCustomer(nameMatch[1]);
                        if (customer) {
                            // Find their unpaid invoice
                            invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                        }
                    }
                }
                
                if (!invoice) {
                    const unpaid = state.invoices.filter(i => getStatus(i) !== 'paid');
                    if (unpaid.length === 0) {
                        return "No unpaid invoices! ðŸŽ‰";
                    }
                    return `Which invoice? Unpaid ones:\n${unpaid.map(i => {
                        const c = state.customers.find(c => c.id === i.customer_id);
                        return `â€¢ ${i.invoice_number} - ${c?.name} (â‚¦${(i.amount - i.amount_paid).toLocaleString()})`;
                    }).join('\n')}\n\nTry: "Record â‚¦20k for ${unpaid[0].invoice_number}"`;
                }
                
                const cust = state.customers.find(c => c.id === invoice.customer_id);
                const owed = invoice.amount - invoice.amount_paid;
                const actualAmount = Math.min(amount, owed);
                
                try {
                    await recordPayment(invoice.id, actualAmount);
                    const newOwed = owed - actualAmount;
                    
                    if (newOwed <= 0) {
                        lastAISuggestion = `Receipt for ${invoice.invoice_number}`;
                        return `âœ… Payment recorded!\n\nðŸ’° â‚¦${actualAmount.toLocaleString()} from ${cust?.name}\nðŸ“„ ${invoice.invoice_number}\n\nðŸŽ‰ Invoice FULLY PAID!\n\nWant me to generate a receipt? Say "yes" ðŸ§¾`;
                    } else {
                        lastAISuggestion = `Remind ${cust?.name}`;
                        return `âœ… Payment recorded!\n\nðŸ’° â‚¦${actualAmount.toLocaleString()} from ${cust?.name}\nðŸ“„ ${invoice.invoice_number}\nðŸ’³ Balance: â‚¦${newOwed.toLocaleString()}\n\nWant me to send a reminder for the balance? Say "yes" ðŸ“±`;
                    }
                } catch (err) {
                    return `âŒ Error: ${err.message}`;
                }
            }
            
            // ============ SEND REMINDER TO SPECIFIC CUSTOMER ============
            if ((qFixed.includes('remind') || qFixed.includes('send') || qFixed.includes('message') || qFixed.includes('sms')) && !qFixed.includes('all')) {
                // Parse: "Remind Chidi" or "Send SMS to Amaka"
                const nameMatch = text.match(/(?:remind|to|sms)\s+([A-Z][a-z]+)/i);
                
                if (!nameMatch) {
                    return "Who should I remind? Try: \"Remind Chidi\" or \"Send all reminders\"";
                }
                
                const customer = findCustomer(nameMatch[1]);
                if (!customer) {
                    return `I don't know "${nameMatch[1]}". Check your customers in the Menu.`;
                }
                
                // Find their unpaid invoice
                const invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                if (!invoice) {
                    return `${customer.name} has no unpaid invoices! ðŸŽ‰`;
                }
                
                // Send SMS
                const owed = invoice.amount - invoice.amount_paid;
                const message = `Hi ${customer.name}, reminder: Your invoice of â‚¦${owed.toLocaleString()} for "${invoice.description}" is due ${formatDate(invoice.due_date)}. Please pay promptly. - ${state.businessProfile.name || 'Owo Mi'}`;
                
                if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                    await new Promise(r => setTimeout(r, 800));
                    lastAISuggestion = `Payment link for ${customer.name}`;
                    if (isPidgin) {
                        return `âœ… SMS don send to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’¬ "${message.slice(0, 60)}..."\n\nYou wan make I send payment link too? Talk "yes" ðŸ’³`;
                    }
                    return `âœ… SMS sent to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’¬ "${message.slice(0, 60)}..."\n\nWant to send a payment link too? Say "yes" ðŸ’³`;
                }
                
                try {
                    const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                        body: JSON.stringify({ phone: customer.phone, message })
                    });
                    const data = await res.json();
                    
                    if (data.code === 'ok' || data.message_id) {
                        lastAISuggestion = `Payment link for ${customer.name}`;
                        if (isPidgin) {
                            return `âœ… SMS don send to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’° E dey owe: â‚¦${owed.toLocaleString()}\n\nYou wan payment link too? Talk "yes" ðŸ’³`;
                        }
                        return `âœ… SMS sent to ${customer.name}!\n\nðŸ“± ${customer.phone}\nðŸ’° Owes: â‚¦${owed.toLocaleString()}\n\nWant to send a payment link too? Say "yes" ðŸ’³`;
                    } else {
                        throw new Error(data.message || 'Failed');
                    }
                } catch (err) {
                    return isPidgin ? `âŒ SMS no go through: ${err.message}\n\nMake we try WhatsApp?` : `âŒ SMS failed: ${err.message}\n\nTry WhatsApp instead? I'll open it for you.`;
                }
            }
            
            // ============ SEND ALL REMINDERS ============
            if (qFixed.includes('all') && (qFixed.includes('remind') || qFixed.includes('send') || qFixed.includes('overdue'))) {
                const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
                
                if (overdueInvoices.length === 0) {
                    return "No overdue invoices! Everyone is paying on time ðŸŽ‰";
                }
                
                let sent = 0, failed = 0;
                const results = [];
                
                for (const inv of overdueInvoices) {
                    const cust = state.customers.find(c => c.id === inv.customer_id);
                    if (!cust?.phone) { failed++; continue; }
                    
                    const owed = inv.amount - inv.amount_paid;
                    const message = `Hi ${cust.name}, reminder: Your invoice of â‚¦${owed.toLocaleString()} for "${inv.description}" is overdue. Please pay ASAP. - ${state.businessProfile.name || 'Owo Mi'}`;
                    
                    if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                        await new Promise(r => setTimeout(r, 300));
                        sent++;
                        results.push(`âœ“ ${cust.name}`);
                        continue;
                    }
                    
                    try {
                        const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${SUPABASE_KEY}` },
                            body: JSON.stringify({ phone: cust.phone, message })
                        });
                        const data = await res.json();
                        if (data.code === 'ok' || data.message_id) {
                            sent++;
                            results.push(`âœ“ ${cust.name}`);
                        } else {
                            failed++;
                            results.push(`âœ— ${cust.name}`);
                        }
                    } catch {
                        failed++;
                        results.push(`âœ— ${cust.name}`);
                    }
                }
                
                return `âœ… Bulk reminders sent!\n\nðŸ“± Sent: ${sent}\nâŒ Failed: ${failed}\n\n${results.join('\n')}`;
            }
            
            // ============ PAYMENT LINK ============
            if (qFixed.includes('payment link') || qFixed.includes('pay link') || qFixed.includes('paystack')) {
                const nameMatch = text.match(/(?:for|to)\s+([A-Z][a-z]+)/i);
                
                if (!nameMatch) {
                    const unpaid = state.invoices.filter(i => getStatus(i) !== 'paid');
                    if (unpaid.length === 0) return "No unpaid invoices!";
                    return `Who needs a payment link?\n${unpaid.map(i => {
                        const c = state.customers.find(c => c.id === i.customer_id);
                        return `â€¢ ${c?.name} - â‚¦${(i.amount - i.amount_paid).toLocaleString()}`;
                    }).join('\n')}\n\nTry: "Payment link for ${state.customers.find(c => c.id === unpaid[0].customer_id)?.name}"`;
                }
                
                const customer = findCustomer(nameMatch[1]);
                if (!customer) return `I don't know "${nameMatch[1]}"`;
                
                const invoice = state.invoices.find(i => i.customer_id === customer.id && getStatus(i) !== 'paid');
                if (!invoice) return `${customer.name} has no unpaid invoices!`;
                
                // Trigger the payment link function
                generatePaymentLink(invoice.id);
                return `âœ… Opening payment link for ${customer.name}...\n\nðŸ’° Amount: â‚¦${(invoice.amount - invoice.amount_paid).toLocaleString()}\n\nYou can share this with ${customer.name} via WhatsApp or SMS!`;
            }
            
            // ============ GENERATE PDF ============
            if (qFixed.includes('pdf') || qFixed.includes('download') || qFixed.includes('print')) {
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    const invoice = findInvoice(invMatch[0]);
                    if (invoice) {
                        generatePDF(invoice.id);
                        return `âœ… Opening PDF for ${invMatch[0]}...`;
                    }
                }
                
                const nameMatch = text.match(/(?:for|from)\s+([A-Z][a-z]+)/i);
                if (nameMatch) {
                    const customer = findCustomer(nameMatch[1]);
                    if (customer) {
                        const invoice = state.invoices.find(i => i.customer_id === customer.id);
                        if (invoice) {
                            generatePDF(invoice.id);
                            return `âœ… Opening PDF for ${customer.name}'s invoice...`;
                        }
                    }
                }
                
                return "Which invoice? Try: \"PDF for INV-001\" or \"PDF for Chidi\"";
            }
            
            // ============ GENERATE RECEIPT ============
            if (qFixed.includes('receipt')) {
                const invMatch = text.match(/INV[-\s]?(\d+)/i);
                if (invMatch) {
                    const invoice = findInvoice(invMatch[0]);
                    if (invoice) {
                        if (getStatus(invoice) !== 'paid') {
                            return `${invMatch[0]} is not fully paid yet. Record the remaining payment first.`;
                        }
                        generateReceipt(invoice.id);
                        return `âœ… Opening receipt for ${invMatch[0]}...`;
                    }
                }
                
                const paidInvoices = state.invoices.filter(i => getStatus(i) === 'paid');
                if (paidInvoices.length === 0) return "No paid invoices to generate receipts for.";
                
                return `Which invoice needs a receipt?\n${paidInvoices.slice(0, 5).map(i => {
                    const c = state.customers.find(c => c.id === i.customer_id);
                    return `â€¢ ${i.invoice_number} - ${c?.name}`;
                }).join('\n')}\n\nTry: "Receipt for ${paidInvoices[0].invoice_number}"`;
            }
            
            // ============ WHO OWES / DEBTORS ============
            if (qFixed.includes('owe') || qFixed.includes('owing') || qFixed.includes('debt') || qFixed.includes('outstanding') || qFixed.includes('unpaid') || qFixed.includes('most money') || qFixed.includes('more money')) {
                const timeFilter = getTimeFilter();
                
                const debtors = state.customers.map(c => {
                    let invoices = state.invoices.filter(i => i.customer_id === c.id);
                    
                    // Apply time filter if specified
                    if (timeFilter) {
                        invoices = invoices.filter(i => new Date(i.created_at) >= timeFilter.start);
                    }
                    
                    const owed = invoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                    return { name: c.name, phone: c.phone, owed };
                }).filter(c => c.owed > 0).sort((a, b) => b.owed - a.owed);
                
                if (debtors.length === 0) {
                    return timeFilter 
                        ? (isPidgin ? `Nobody dey owe you ${timeFilter.label} o! ðŸŽ‰` : `Nobody owes you money ${timeFilter.label}! ðŸŽ‰`)
                        : pidgin.nobody;
                }
                
                const total = debtors.reduce((s, d) => s + d.owed, 0);
                const timeLabel = timeFilter ? ` (${timeFilter.label})` : '';
                
                // Check if asking for top/most debtor specifically
                if (qFixed.includes('most') || qFixed.includes('top') || qFixed.includes('biggest') || qFixed.includes('highest') || qFixed.includes('more')) {
                    const top = debtors[0];
                    lastAISuggestion = `Remind ${top.name}`;
                    
                    if (isPidgin) {
                        return `ðŸ† ${top.name} na who dey owe you pass!\n\nðŸ’° E dey owe: â‚¦${top.owed.toLocaleString()}\nðŸ“± Phone: ${top.phone || 'No phone'}\n\nYou wan make I remind am? Talk "yes" ðŸ“±`;
                    }
                    return `ðŸ† ${top.name} owes you the most!\n\nðŸ’° Amount: â‚¦${top.owed.toLocaleString()}\nðŸ“± Phone: ${top.phone || 'No phone'}\n\nWant me to remind them? Say "yes" ðŸ“±`;
                }
                
                // Set suggestion for "yes" response
                lastAISuggestion = `Remind ${debtors[0].name}`;
                
                const header = isPidgin ? `ðŸ’° Dem dey owe you${timeLabel}: â‚¦${total.toLocaleString()}` : `ðŸ’° Outstanding${timeLabel}: â‚¦${total.toLocaleString()}`;
                const listIntro = isPidgin ? 'See who dey owe you:' : 'Who owes you:';
                const footer = isPidgin 
                    ? `\n\nMake I remind ${debtors[0].name}? Talk "yes" ðŸ“±` 
                    : `\n\nWant me to remind ${debtors[0].name}? Say "yes" ðŸ“±`;
                
                return `${header}\n\n${listIntro}\n${debtors.map((d, i) => `${i + 1}. ${d.name}: â‚¦${d.owed.toLocaleString()}`).join('\n')}${footer}`;
            }
            
            // ============ SUMMARY / TOTAL ============
            if (qFixed.includes('summary') || qFixed.includes('total') || qFixed.includes('overview') || qFixed.includes('wetin') || qFixed.includes('status') || qFixed.includes('how much')) {
                const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
                const overdue = state.invoices.filter(i => getStatus(i) === 'overdue').length;
                const pending = state.invoices.filter(i => getStatus(i) === 'pending').length;
                const expenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
                const profit = collected - expenses;
                
                if (isPidgin) {
                    return `ðŸ“Š Business Summary\n\nðŸ’° Wetin dem dey owe you: â‚¦${outstanding.toLocaleString()}\nâœ… Wetin don enter: â‚¦${collected.toLocaleString()}\nðŸ’¸ Wetin you spend: â‚¦${expenses.toLocaleString()}\n${profit >= 0 ? 'ðŸ“ˆ Gain' : 'ðŸ“‰ Loss'}: â‚¦${Math.abs(profit).toLocaleString()}\n\nðŸ‘¥ Customers: ${state.customers.length}\nðŸ“„ Invoices: ${state.invoices.length}\nâ° Pending: ${pending}\nðŸš¨ Overdue: ${overdue}\n\n${overdue > 0 ? `Omo you get ${overdue} wey don pass date! Talk "Send all reminders" make I pursue dem.` : 'E dey look fine! No wahala ðŸ‘'}`;
                }
                
                return `ðŸ“Š Business Summary\n\nðŸ’° Outstanding: â‚¦${outstanding.toLocaleString()}\nâœ… Collected: â‚¦${collected.toLocaleString()}\nðŸ’¸ Expenses: â‚¦${expenses.toLocaleString()}\n${profit >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'} Net Profit: â‚¦${profit.toLocaleString()}\n\nðŸ‘¥ Customers: ${state.customers.length}\nðŸ“„ Total Invoices: ${state.invoices.length}\nâ° Pending: ${pending}\nðŸš¨ Overdue: ${overdue}\n\n${overdue > 0 ? `You have ${overdue} overdue! Say "Send all reminders" to chase them.` : 'Looking good! No overdue invoices ðŸ‘'}`;
            }
            
            // ============ OVERDUE LIST ============
            if (qFixed.includes('overdue') || qFixed.includes('late')) {
                const overdueInvoices = state.invoices.filter(i => getStatus(i) === 'overdue');
                
                if (overdueInvoices.length === 0) {
                    return "No overdue invoices! ðŸŽ‰ Everyone is paying on time.";
                }
                
                return `ðŸš¨ ${overdueInvoices.length} Overdue Invoice(s)\n\n${overdueInvoices.map(i => {
                    const c = state.customers.find(c => c.id === i.customer_id);
                    const owed = i.amount - i.amount_paid;
                    const daysLate = Math.floor((new Date() - new Date(i.due_date)) / 86400000);
                    return `â€¢ ${i.invoice_number} - ${c?.name}\n  â‚¦${owed.toLocaleString()} â€¢ ${daysLate} days late`;
                }).join('\n\n')}\n\nSay "Send all reminders" to nudge them! ðŸ“±`;
            }
            
            // ============ ADD EXPENSE ============
            if (qFixed.includes('expense') && (qFixed.includes('add') || qFixed.includes('record') || qFixed.includes('spent'))) {
                const amount = parseAmount(text);
                if (!amount) {
                    return "What's the amount? Try: \"Add expense â‚¦5k for transport\"";
                }
                
                const descMatch = text.match(/(?:for|on)\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i) || text.match(/expense\s+(?:â‚¦[\d,]+k?\s+)?(.+)/i);
                const description = descMatch ? descMatch[1].trim() : 'Business expense';
                
                // Detect category
                let category = 'Other';
                if (qFixed.includes('internet') || qFixed.includes('light') || qFixed.includes('power') || qFixed.includes('electric')) category = 'Utilities';
                else if (qFixed.includes('transport') || qFixed.includes('fuel') || qFixed.includes('uber') || qFixed.includes('bolt')) category = 'Transport';
                else if (qFixed.includes('software') || qFixed.includes('domain') || qFixed.includes('hosting') || qFixed.includes('subscription')) category = 'Software';
                else if (qFixed.includes('salary') || qFixed.includes('freelancer') || qFixed.includes('staff') || qFixed.includes('pay')) category = 'Labor';
                else if (qFixed.includes('supply') || qFixed.includes('office') || qFixed.includes('equipment')) category = 'Supplies';
                else if (qFixed.includes('ads') || qFixed.includes('marketing') || qFixed.includes('advert')) category = 'Marketing';
                
                const expense = {
                    id: 'exp-' + Date.now(),
                    description: description.charAt(0).toUpperCase() + description.slice(1),
                    amount,
                    category,
                    date: new Date().toISOString().split('T')[0]
                };
                
                state.expenses.push(expense);
                localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                
                return `âœ… Expense recorded!\n\nðŸ’¸ â‚¦${amount.toLocaleString()}\nðŸ“ ${expense.description}\nðŸ·ï¸ ${category}\n\nYour expenses this month affect your profit. Check "Show summary" to see net profit.`;
            }
            
            // ============ ADD PRODUCT ============
            if (qFixed.includes('product') && (qFixed.includes('add') || qFixed.includes('new') || qFixed.includes('create'))) {
                const amount = parseAmount(text);
                const nameMatch = text.match(/product\s+(.+?)(?:\s+â‚¦|\s+\d|$)/i);
                
                if (!nameMatch || !amount) {
                    return "Try: \"Add product Website Design â‚¦150k\"";
                }
                
                const name = nameMatch[1].trim();
                const product = {
                    id: 'prod-' + Date.now(),
                    name: name.charAt(0).toUpperCase() + name.slice(1),
                    price: amount,
                    description: ''
                };
                
                state.products.push(product);
                localStorage.setItem('owomi_products', JSON.stringify(state.products));
                
                return `âœ… Product added!\n\nðŸ“¦ ${product.name}\nðŸ’° â‚¦${amount.toLocaleString()}\n\nNow you can quickly add this to invoices!`;
            }
            
            // ============ LIST CUSTOMERS ============
            if (qFixed.includes('customer') && (qFixed.includes('list') || qFixed.includes('show') || qFixed.includes('all'))) {
                if (state.customers.length === 0) {
                    return "No customers yet. Add one:\n\"Add customer Bola 08012345678\"";
                }
                
                return `ðŸ‘¥ Your Customers (${state.customers.length})\n\n${state.customers.map(c => {
                    const owed = state.invoices.filter(i => i.customer_id === c.id).reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                    return `â€¢ ${c.name} - ${c.phone}${owed > 0 ? ` (owes â‚¦${owed.toLocaleString()})` : ''}`;
                }).join('\n')}`;
            }
            
            // ============ INSIGHTS / TIPS ============
            if (qFixed.includes('insight') || qFixed.includes('tip') || qFixed.includes('advice') || qFixed.includes('help me')) {
                const outstanding = state.invoices.filter(i => getStatus(i) !== 'paid').reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                const overdue = state.invoices.filter(i => getStatus(i) === 'overdue');
                const collected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
                const expenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
                
                const tips = [];
                
                if (overdue.length > 0) {
                    const topDebtor = state.customers.find(c => c.id === overdue[0].customer_id);
                    tips.push(`ðŸš¨ You have ${overdue.length} overdue invoice(s). ${topDebtor?.name} is the biggest - send them a reminder!`);
                }
                
                if (outstanding > collected * 0.5) {
                    tips.push(`ðŸ’¡ Over half your money is still outstanding. Consider offering early payment discounts.`);
                }
                
                if (expenses > collected * 0.7) {
                    tips.push(`âš ï¸ Your expenses are ${Math.round(expenses/collected*100)}% of revenue. Look for ways to cut costs.`);
                }
                
                if (state.products.length === 0) {
                    tips.push(`ðŸ“¦ Add products to speed up invoicing: "Add product Website Design â‚¦150k"`);
                }
                
                if (tips.length === 0) {
                    tips.push(`ðŸ‘ Your business is looking healthy! Keep up the good work.`);
                    tips.push(`ðŸ’¡ Tip: Set up auto-reminders in Menu â†’ Settings to chase payments automatically.`);
                }
                
                return `ðŸ’¡ Business Insights\n\n${tips.join('\n\n')}`;
            }
            
            // ============ GREETING ============
            if (qFixed.match(/^(hi|hello|hey|good|morning|afternoon|evening|sup|wetin|how far|oga|madam)/)) {
                const hour = new Date().getHours();
                
                if (isPidgin || qFixed.match(/^(wetin|how far|oga|madam)/)) {
                    const greeting = hour < 12 ? 'Good morning o' : hour < 17 ? 'How you dey' : 'Good evening o';
                    return `${greeting}! ðŸ‘‹ Wetin I fit help you with today?\n\nTry:\nâ€¢ "Who dey owe me?"\nâ€¢ "Invoice Chidi â‚¦50k for design"\nâ€¢ "Wetin be my total?"`;
                }
                
                const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
                return `${greeting}! ðŸ‘‹ How can I help your business today?\n\nTry:\nâ€¢ "Who owes me money?"\nâ€¢ "Invoice Chidi â‚¦50k for design"\nâ€¢ "Show summary"`;
            }
            
            // ============ FALLBACK ============
            if (isPidgin) {
                return `I fit help you with:\n\nðŸ“„ <b>Invoice</b> - "Invoice Chidi â‚¦50k for website"\nðŸ‘¤ <b>Customer</b> - "Add customer Bola 08012345678"\nðŸ’° <b>Payment</b> - "Record â‚¦20k for INV-001"\nðŸ“± <b>Reminder</b> - "Remind Amaka" abi "Send all reminders"\nðŸ“Š <b>Report</b> - "Who dey owe me?" abi "Wetin be my total?"\nðŸ’¸ <b>Expense</b> - "Add expense â‚¦5k for transport"\n\nWetin you wan do?`;
            }
            return `I can help you with:\n\nðŸ“„ <b>Invoices</b> - "Invoice Chidi â‚¦50k for website"\nðŸ‘¤ <b>Customers</b> - "Add customer Bola 08012345678"\nðŸ’° <b>Payments</b> - "Record â‚¦20k for INV-001"\nðŸ“± <b>Reminders</b> - "Remind Amaka" or "Send all reminders"\nðŸ“Š <b>Reports</b> - "Who owes me?" or "Show summary"\nðŸ’¸ <b>Expenses</b> - "Add expense â‚¦5k for transport"\n\nWhat would you like to do?`;
        }

        // ========== UTILITIES ==========
        function generatePDF(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const status = getStatus(inv);
            const p = state.businessProfile;
            const t = state.invoiceTemplate || { color: '#3b82f6', style: 'modern' };
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 8).toUpperCase()}`;
            const brandColor = t.color || '#3b82f6';
            
            // Build items rows
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            const itemsRows = items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">${formatNaira(item.price)}</td>
                    <td style="text-align:right">${formatNaira(item.qty * item.price)}</td>
                </tr>
            `).join('');
            
            // Logo HTML
            const logoHtml = p.logo ? `<img src="${p.logo}" style="max-height:60px;max-width:150px;object-fit:contain;margin-bottom:10px;">` : '';
            
            // Style variations based on template
            const styleVariations = {
                modern: `
                    .header{text-align:center;border-bottom:3px solid ${brandColor};padding-bottom:20px;margin-bottom:30px}
                    .header h1{color:${brandColor};margin:0;font-size:28px}
                    th{background:${brandColor};color:white;padding:12px;text-align:left;font-size:13px}
                `,
                classic: `
                    .header{text-align:left;border-bottom:2px solid #333;padding-bottom:20px;margin-bottom:30px}
                    .header h1{color:#333;margin:0;font-size:24px}
                    th{background:#333;color:white;padding:12px;text-align:left;font-size:13px}
                    .inv-number{color:#333}
                `,
                bold: `
                    .header{text-align:center;background:${brandColor};color:white;padding:30px;margin:-40px -40px 30px -40px;border-radius:0}
                    .header h1{color:white;margin:0;font-size:32px}
                    .header p{color:rgba(255,255,255,0.9)}
                    th{background:${brandColor};color:white;padding:14px;text-align:left;font-size:14px}
                    .total-row.final{border-top:3px solid ${brandColor}}
                `,
                minimal: `
                    .header{text-align:left;padding-bottom:20px;margin-bottom:30px;border:none}
                    .header h1{color:#333;margin:0;font-size:22px;font-weight:400}
                    th{background:#f5f5f5;color:#333;padding:12px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:1px}
                    .box{background:transparent;border:1px solid #eee}
                    .inv-number{color:#666;font-size:18px}
                `
            };

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Invoice ${invNumber}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
                .header{text-align:center;border-bottom:3px solid ${brandColor};padding-bottom:20px;margin-bottom:30px}
                .header h1{color:${brandColor};margin:0}
                .details{display:flex;justify-content:space-between;margin-bottom:30px}
                .box{background:#f9f9f9;padding:15px;border-radius:8px;width:48%}
                .box h3{margin:0 0 10px;color:${brandColor};font-size:14px}
                table{width:100%;border-collapse:collapse;margin-bottom:30px}
                th{background:${brandColor};color:white;padding:12px;text-align:left;font-size:13px}
                td{padding:12px;border-bottom:1px solid #eee;font-size:13px}
                .total-section{background:#f9f9f9;padding:15px;border-radius:8px}
                .total-row{display:flex;justify-content:space-between;padding:8px 0}
                .total-row.final{border-top:2px solid ${brandColor};margin-top:8px;padding-top:12px;font-size:18px;font-weight:bold}
                .status{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold}
                .paid{background:#dcfce7;color:#166534}
                .pending{background:#fef3c7;color:#854d0e}
                .overdue{background:#fee2e2;color:#dc2626}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:40px}
                .inv-number{color:${brandColor};font-size:24px;font-weight:bold;margin-bottom:10px}
                @media print{body{padding:20px}}
                ${styleVariations[t.style] || styleVariations.modern}
            </style></head><body>
            <div class="header">
                ${logoHtml}
                <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                <p>${p.phone || ''} ${p.email ? 'â€¢ ' + p.email : ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
            </div>
            <div class="inv-number">${invNumber}</div>
            <h2>INVOICE <span class="status ${status}">${status.toUpperCase()}</span></h2>
            <div class="details">
                <div class="box">
                    <h3>BILL TO</h3>
                    <p><strong>${cust?.name || 'Customer'}</strong></p>
                    <p>${cust?.phone || ''}</p>
                </div>
                <div class="box">
                    <h3>DETAILS</h3>
                    <p>Invoice: ${invNumber}</p>
                    <p>Date: ${formatDate(inv.created_at)}</p>
                    <p>Due: ${formatDate(inv.due_date)}</p>
                </div>
            </div>
            ${p.bank || p.paymentQR ? `
                <div class="box" style="width:100%;margin-bottom:20px">
                    <h3>PAYMENT DETAILS</h3>
                    <div style="display:flex;gap:20px;align-items:flex-start;">
                        ${p.bank ? `<div style="flex:1;"><p style="white-space:pre-line">${p.bank}</p></div>` : ''}
                        ${p.paymentQR ? `<div style="text-align:center;"><img src="${p.paymentQR}" style="max-width:120px;max-height:120px;border:1px solid #ddd;border-radius:8px;"><p style="font-size:11px;color:#666;margin-top:4px;">Scan to Pay</p></div>` : ''}
                    </div>
                </div>
            ` : ''}
            
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th style="text-align:center">Qty</th>
                        <th style="text-align:right">Price</th>
                        <th style="text-align:right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsRows}
                </tbody>
            </table>
            
            <div class="total-section">
                <div class="total-row"><span>Subtotal</span><span>${formatNaira(inv.subtotal || inv.amount)}</span></div>
                ${inv.discount > 0 ? `<div class="total-row"><span>Discount${inv.discount_type === 'percent' ? ` (${inv.discount_value}%)` : ''}</span><span style="color:#dc2626">-${formatNaira(inv.discount)}</span></div>` : ''}
                ${inv.include_vat ? `<div class="total-row"><span>VAT (7.5%)</span><span>${formatNaira(inv.vat)}</span></div>` : ''}
                ${inv.shipping > 0 ? `<div class="total-row"><span>${inv.shipping_desc || 'Shipping/Delivery'}</span><span>${formatNaira(inv.shipping)}</span></div>` : ''}
                <div class="total-row"><span>Total</span><span>${formatNaira(inv.amount)}</span></div>
                <div class="total-row"><span>Amount Paid</span><span style="color:#16a34a">-${formatNaira(inv.amount_paid)}</span></div>
                <div class="total-row final"><span>Balance Due</span><span style="color:${inv.amount - inv.amount_paid > 0 ? '#dc2626' : '#16a34a'}">${formatNaira(inv.amount - inv.amount_paid)}</span></div>
            </div>
            
            ${inv.notes ? `
            <div class="box" style="width:100%;margin-top:20px">
                <h3>NOTES</h3>
                <p style="white-space:pre-line">${inv.notes}</p>
            </div>
            ` : ''}
            
            ${p.termsAndConditions ? `
            <div style="margin-top:20px;padding:15px;background:#f9f9f9;border-radius:8px;font-size:11px;color:#666;">
                <strong>Terms & Conditions:</strong>
                <p style="margin:8px 0 0;white-space:pre-line">${p.termsAndConditions}</p>
            </div>
            ` : ''}
            
            <div class="footer">
                <p>${p.footerNote || 'Thank you for your business!'}</p>
                <p style="margin-top:10px;font-size:11px;color:#bbb;">Powered by Owo Mi ðŸ’° | owomi.ng</p>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate PDF. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function generateReceipt(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const p = state.businessProfile;
            const invNumber = inv.invoice_number || `INV-${inv.id.slice(0, 8).toUpperCase()}`;
            const receiptNumber = 'RCT-' + Date.now().toString().slice(-8);
            
            // Get payment history for this invoice
            const payments = state.paymentHistory.filter(p => p.invoiceId === invoiceId);
            const lastPayment = payments[payments.length - 1];
            const paymentMethod = lastPayment?.method || 'transfer';
            const paymentDate = inv.paid_date || lastPayment?.date || new Date().toISOString();
            
            const methodLabels = {
                transfer: 'ðŸ¦ Bank Transfer',
                cash: 'ðŸ’µ Cash',
                card: 'ðŸ’³ Card/POS',
                paystack: 'ðŸ”— Paystack'
            };
            
            // Build items list
            const items = inv.items || [{name: inv.description, qty: 1, price: inv.amount}];
            const itemsList = items.map(item => `
                <div class="row"><span class="label">${item.name} ${item.qty > 1 ? 'Ã—' + item.qty : ''}</span><span class="value">${formatNaira(item.qty * item.price)}</span></div>
            `).join('');
            
            // Build payment history if multiple payments
            const paymentsList = payments.length > 1 ? `
                <div class="payments-section">
                    <div class="payments-title">Payment History</div>
                    ${payments.map((pay, i) => `
                        <div class="payment-row">
                            <span>${formatDate(pay.date)}</span>
                            <span>${formatNaira(pay.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Receipt ${receiptNumber}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:600px;margin:0 auto;background:#fff}
                .receipt{border:2px solid #16a34a;border-radius:12px;padding:30px}
                .header{text-align:center;border-bottom:2px dashed #16a34a;padding-bottom:20px;margin-bottom:20px}
                .header h1{color:#16a34a;margin:0 0 5px}
                .header p{color:#666;margin:0}
                .receipt-title{text-align:center;font-size:24px;color:#16a34a;margin-bottom:20px}
                .receipt-number{text-align:center;font-size:14px;color:#666;margin-bottom:20px}
                .details{margin-bottom:20px}
                .row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
                .row:last-child{border-bottom:none}
                .label{color:#666}
                .value{font-weight:600}
                .items-section{background:#f9f9f9;padding:15px;border-radius:8px;margin-bottom:20px}
                .items-title{font-weight:600;color:#16a34a;margin-bottom:10px;font-size:14px}
                .payments-section{background:#fff9e8;padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid #fbbf24}
                .payments-title{font-weight:600;color:#92400e;margin-bottom:10px;font-size:14px}
                .payment-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;color:#666}
                .total-row{background:#dcfce7;padding:15px;border-radius:8px;margin-top:20px;display:flex;justify-content:space-between}
                .total-row .label{font-weight:600;color:#166534}
                .total-row .value{font-size:20px;color:#166534}
                .payment-method{background:#e0e7ff;padding:12px;border-radius:8px;margin-top:15px;text-align:center;color:#4338ca;font-weight:500}
                .stamp{text-align:center;margin-top:30px;padding:15px;border:3px solid #16a34a;border-radius:50%;width:100px;height:100px;margin:30px auto;display:flex;align-items:center;justify-content:center}
                .stamp-text{color:#16a34a;font-weight:bold;font-size:18px}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:30px}
                @media print{body{padding:20px}.receipt{border:none}}
            </style></head><body>
            <div class="receipt">
                <div class="header">
                    ${p.logo ? `<img src="${p.logo}" style="max-height:50px;max-width:120px;object-fit:contain;margin-bottom:10px;">` : ''}
                    <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                    <p>${p.phone || ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
                </div>
                <div class="receipt-title">âœ“ PAYMENT RECEIPT</div>
                <div class="receipt-number">Receipt: ${receiptNumber}<br>Invoice: ${invNumber}</div>
                <div class="details">
                    <div class="row"><span class="label">Received From</span><span class="value">${cust?.name || 'Customer'}</span></div>
                    <div class="row"><span class="label">Phone</span><span class="value">${cust?.phone || '-'}</span></div>
                    <div class="row"><span class="label">Payment Date</span><span class="value">${formatDate(paymentDate)}</span></div>
                    <div class="row"><span class="label">Payment Method</span><span class="value">${methodLabels[paymentMethod] || paymentMethod}</span></div>
                </div>
                <div class="items-section">
                    <div class="items-title">Items/Services</div>
                    ${itemsList}
                </div>
                ${paymentsList}
                <div class="total-row">
                    <span class="label">TOTAL PAID</span>
                    <span class="value">${formatNaira(inv.amount_paid)}</span>
                </div>
                <div class="stamp"><span class="stamp-text">PAID âœ“</span></div>
                <div class="footer">
                    <p>Thank you for your payment!</p>
                    <p>Generated by Owo Mi â€¢ ${formatDate(new Date().toISOString())}</p>
                </div>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate Receipt. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function generateStatement(customerId) {
            const cust = state.customers.find(c => c.id === customerId);
            const custInvoices = state.invoices.filter(i => i.customer_id === customerId).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            const p = state.businessProfile;
            
            const totalInvoiced = custInvoices.reduce((s, i) => s + Number(i.amount), 0);
            const totalPaid = custInvoices.reduce((s, i) => s + Number(i.amount_paid), 0);
            const balance = totalInvoiced - totalPaid;

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Statement - ${cust?.name}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
                .header{text-align:center;border-bottom:3px solid #3b82f6;padding-bottom:20px;margin-bottom:30px}
                .header h1{color:#3b82f6;margin:0}
                .title{font-size:24px;font-weight:bold;margin-bottom:20px}
                .customer-box{background:#f9f9f9;padding:20px;border-radius:8px;margin-bottom:30px}
                .customer-name{font-size:18px;font-weight:bold}
                .customer-phone{color:#666}
                table{width:100%;border-collapse:collapse;margin-bottom:30px}
                th{background:#3b82f6;color:white;padding:12px;text-align:left;font-size:13px}
                td{padding:12px;border-bottom:1px solid #eee;font-size:13px}
                .status{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:bold}
                .paid{background:#dcfce7;color:#166534}
                .pending{background:#fef3c7;color:#854d0e}
                .overdue{background:#fee2e2;color:#dc2626}
                .summary{background:#f9f9f9;padding:20px;border-radius:8px}
                .summary-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
                .summary-row:last-child{border-bottom:none;font-weight:bold;font-size:18px}
                .summary-row.balance{color:${balance > 0 ? '#dc2626' : '#16a34a'}}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:40px}
                @media print{body{padding:20px}}
            </style></head><body>
            <div class="header">
                <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                <p>${p.phone || ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
            </div>
            <div class="title">CUSTOMER STATEMENT</div>
            <div class="customer-box">
                <div class="customer-name">${cust?.name || 'Customer'}</div>
                <div class="customer-phone">${cust?.phone || ''}</div>
                <div style="color:#666;font-size:13px;margin-top:8px;">Statement Date: ${formatDate(new Date().toISOString())}</div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Paid</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${custInvoices.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#999;">No invoices found</td></tr>' :
                    custInvoices.map(inv => {
                        const status = getStatus(inv);
                        return `
                            <tr>
                                <td>${inv.invoice_number || inv.id.slice(0, 8).toUpperCase()}</td>
                                <td>${formatDate(inv.created_at)}</td>
                                <td>${inv.description}</td>
                                <td>${formatNaira(inv.amount)}</td>
                                <td>${formatNaira(inv.amount_paid)}</td>
                                <td><span class="status ${status}">${status.toUpperCase()}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="summary">
                <div class="summary-row"><span>Total Invoiced</span><span>${formatNaira(totalInvoiced)}</span></div>
                <div class="summary-row"><span>Total Paid</span><span style="color:#16a34a">${formatNaira(totalPaid)}</span></div>
                <div class="summary-row balance"><span>Balance Due</span><span>${formatNaira(balance)}</span></div>
            </div>

            <div class="footer">
                <p>Thank you for your business!</p>
                <p>Generated by Owo Mi</p>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (!win) {
                alert('Please allow popups to generate Statement. Check your browser settings.');
                return;
            }
            win.document.write(html);
            win.document.close();
            setTimeout(() => win.print(), 500);
        }

        function sendWhatsApp(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            if (!inv) {
                showToast('Invoice not found', 'error');
                return;
            }
            const cust = state.customers.find(c => c.id === inv.customer_id);
            if (!cust) {
                showToast('Customer not found', 'error');
                return;
            }
            const p = state.businessProfile || {};
            const owed = inv.amount - (inv.amount_paid || 0);
            const invNumber = inv.invoice_number || `INV-${(inv.id || '').toString().slice(0, 8).toUpperCase()}`;
            const status = getStatus(inv);
            let phone = (cust.phone || '').replace(/\s/g, '');
            if (phone.startsWith('0')) phone = '234' + phone.slice(1);
            
            // Generate smart AI messages based on context
            let messages;
            try {
                messages = generateSmartMessages(inv, cust, p, owed, invNumber, status);
            } catch (err) {
                console.error('Error generating messages:', err);
                // Fallback to simple message
                messages = [{
                    label: 'ðŸ˜Š Friendly Reminder',
                    preview: `Hi ${cust.name}, just a reminder about your invoice...`,
                    full: `Hi ${cust.name},\n\nJust a friendly reminder about Invoice ${invNumber} for ${formatNaira(owed)}.\n\nPlease let me know if you have any questions.\n\nThank you!`
                }];
            }
            
            // Show message selection modal
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">
                            <span>ðŸ’¬ Smart Message</span>
                            <button class="modal-close" id="modal-close">Ã—</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom:16px;"><strong>${cust?.name}</strong> â€¢ ${formatNaira(owed)} ${status === 'overdue' ? '<span style="color:#dc2626;">(Overdue)</span>' : ''}</p>
                            
                            <div style="background:#ede9fe;padding:12px;border-radius:10px;margin-bottom:16px;">
                                <div style="display:flex;align-items:center;gap:8px;color:#6366f1;font-weight:600;margin-bottom:8px;">
                                    <span>ðŸ¤–</span> AI-Generated Messages
                                </div>
                                <p style="font-size:12px;color:#666;">Choose a tone that fits your relationship:</p>
                            </div>
                            
                            ${messages.map((m, i) => `
                                <div style="background:#f9f9f9;padding:16px;border-radius:12px;margin-bottom:12px;cursor:pointer;border:2px solid transparent;" 
                                     class="smart-msg-option" data-msg-index="${i}"
                                     onclick="selectSmartMessage(${i})">
                                    <div style="font-weight:600;color:#374151;margin-bottom:8px;">${m.label}</div>
                                    <div style="font-size:13px;color:#666;white-space:pre-line;line-height:1.5;">${m.preview}</div>
                                </div>
                            `).join('')}
                            
                            <div style="margin-top:16px;">
                                <button class="btn btn-primary" id="btn-send-smart" style="width:100%;background:linear-gradient(135deg,#25D366,#128C7E);">
                                    ðŸ’¬ Send via WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Store messages for selection
            window.smartMessages = messages;
            window.smartMessagePhone = phone;
            window.selectedMessageIndex = 0;
            
            // Highlight first option
            document.querySelector('.smart-msg-option')?.classList.add('selected');
            document.querySelector('.smart-msg-option')?.style.setProperty('border-color', '#8b5cf6');
            
            document.getElementById('modal-close').onclick = closeModal;
            document.getElementById('btn-send-smart').onclick = () => {
                const msg = window.smartMessages[window.selectedMessageIndex].full;
                window.open(`https://wa.me/${window.smartMessagePhone}?text=${encodeURIComponent(msg)}`, '_blank');
                closeModal();
            };
        }
        
        function selectSmartMessage(index) {
            window.selectedMessageIndex = index;
            document.querySelectorAll('.smart-msg-option').forEach((el, i) => {
                el.style.borderColor = i === index ? '#8b5cf6' : 'transparent';
                el.style.background = i === index ? '#ede9fe' : '#f9f9f9';
            });
        }
        window.selectSmartMessage = selectSmartMessage;
        
        function generateSmartMessages(inv, cust, p, owed, invNumber, status) {
            const customerName = cust?.name?.split(' ')[0] || 'Customer';
            const businessName = p.name || 'Owo Mi';
            const dueDate = formatDate(inv.due_date);
            const bankDetails = p.bank || '';
            
            // Calculate days overdue
            const today = new Date();
            const due = new Date(inv.due_date);
            const daysOverdue = Math.floor((today - due) / (1000 * 60 * 60 * 24));
            
            const messages = [];
            
            if (status === 'overdue') {
                // Firm but polite (overdue)
                messages.push({
                    label: 'ðŸ“‹ Professional Reminder',
                    preview: `Good day ${customerName}. Invoice ${invNumber} for ${formatNaira(owed)} was due ${daysOverdue} days ago...`,
                    full: `Good day ${customerName},\n\nI hope this message meets you well. This is a reminder that Invoice ${invNumber} for ${formatNaira(owed)} was due on ${dueDate} (${daysOverdue} days ago).\n\nKindly arrange payment at your earliest convenience.\n\n${bankDetails ? `ðŸ¦ Payment Details:\n${bankDetails}\n\n` : ''}Thank you for your prompt attention.\n\n${businessName}`
                });
                
                // Friendly nudge (Pidgin)
                messages.push({
                    label: 'ðŸ¤ Friendly Pidgin',
                    preview: `Hello ${customerName}! Hope you dey okay? Abeg I wan remind you about...`,
                    full: `Hello ${customerName}! ðŸ˜Š\n\nHope you dey okay? Abeg I wan remind you about the ${formatNaira(owed)} wey still dey for Invoice ${invNumber}.\n\nE don pass due date small, but no wahala - if you fit sort am this week, e go really help me.\n\n${bankDetails ? `ðŸ¦ Pay to:\n${bankDetails}\n\n` : ''}Make I hear from you soon!\n\n${businessName} ðŸ™`
                });
                
                // Urgent
                messages.push({
                    label: 'âš ï¸ Urgent Follow-up',
                    preview: `Dear ${customerName}, your invoice is now ${daysOverdue} days overdue...`,
                    full: `Dear ${customerName},\n\nYour invoice ${invNumber} for ${formatNaira(owed)} is now ${daysOverdue} days overdue.\n\nPlease treat this as urgent and make payment today to avoid any disruption to our business relationship.\n\n${bankDetails ? `ðŸ¦ Bank Details:\n${bankDetails}\n\n` : ''}Please confirm once paid.\n\nRegards,\n${businessName}`
                });
            } else {
                // Friendly first reminder
                messages.push({
                    label: 'ðŸ˜Š Friendly Reminder',
                    preview: `Hi ${customerName}! Just a gentle reminder about your invoice...`,
                    full: `Hi ${customerName}! ðŸ˜Š\n\nJust a gentle reminder about Invoice ${invNumber} for ${formatNaira(owed)}, due on ${dueDate}.\n\nNo rush if you've already sorted it - just ignore this message! ðŸ™\n\n${bankDetails ? `ðŸ¦ Payment Details:\n${bankDetails}\n\n` : ''}Thank you!\n${businessName}`
                });
                
                // Professional
                messages.push({
                    label: 'ðŸ“‹ Professional',
                    preview: `Good day ${customerName}. Please find details of your outstanding invoice...`,
                    full: `Good day ${customerName},\n\nPlease find details of your outstanding invoice:\n\nðŸ“„ Invoice: ${invNumber}\nðŸ’° Amount: ${formatNaira(owed)}\nðŸ“… Due Date: ${dueDate}\n\n${bankDetails ? `ðŸ¦ Payment Details:\n${bankDetails}\n\n` : ''}Please let me know if you have any questions.\n\nBest regards,\n${businessName}`
                });
                
                // Pidgin casual
                messages.push({
                    label: 'ðŸ‡³ðŸ‡¬ Pidgin Style',
                    preview: `Hello ${customerName}! How far? I just wan drop this invoice gist...`,
                    full: `Hello ${customerName}! How far? ðŸ‘‹\n\nI just wan drop reminder about Invoice ${invNumber} - na ${formatNaira(owed)} wey still dey.\n\nDue date na ${dueDate}.\n\n${bankDetails ? `ðŸ¦ You fit pay to:\n${bankDetails}\n\n` : ''}Anything wey you need, just holla!\n\n${businessName} âœŒï¸`
                });
            }
            
            return messages;
        }

        async function sendSMS(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const owed = inv.amount - inv.amount_paid;

            let phone = cust?.phone?.replace(/\s/g, '') || '';
            if (phone.startsWith('0')) phone = '234' + phone.slice(1);
            if (!phone.startsWith('234')) phone = '234' + phone;

            const message = `Hi ${cust?.name}, reminder: Your invoice of ${formatNaira(owed)} for "${inv.description}" is due ${formatDate(inv.due_date)}. Please pay promptly. - ${state.businessProfile.name || 'Owo Mi'}`;

            // DEV_MODE: Show mock success
            if (typeof DEV_MODE !== 'undefined' && DEV_MODE) {
                const btn = document.querySelector(`[data-sms="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ SMS';
                await new Promise(r => setTimeout(r, 1000));
                showToast(`SMS sent to ${cust?.name}!`, 'success');
                render();
                return;
            }

            try {
                const btn = document.querySelector(`[data-sms="${invoiceId}"]`);
                if (btn) btn.innerHTML = 'â³ SMS';

                const res = await fetch('https://djqmtzqnwklwnvlqlejj.supabase.co/functions/v1/send-sms', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ phone, message })
                });

                const data = await res.json();
                
                if (data.code === 'ok' || data.message_id) {
                    showToast(`SMS sent to ${cust?.name}!`, 'success');
                } else {
                    throw new Error(data.message || 'SMS failed');
                }
            } catch (err) {
                alert('âŒ SMS Error: ' + err.message);
            }
            render();
        }

        async function generatePaymentLink(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const p = state.businessProfile;
            const owed = inv.amount - inv.amount_paid;

            // Check if Paystack is configured
            if (!p.paystackEnabled || !p.paystackPublicKey) {
                // Show setup prompt
                document.getElementById('modal-container').innerHTML = `
                    <div class="modal">
                        <div class="modal-box">
                            <div class="modal-header">ðŸ’³ Setup Paystack<button class="modal-close" id="modal-close">Ã—</button></div>
                            <div class="modal-body">
                                <div style="text-align:center;margin-bottom:20px;">
                                    <div style="font-size:48px;margin-bottom:12px;">ðŸ”‘</div>
                                    <p style="color:#666;">To accept online payments, connect your Paystack account.</p>
                                </div>
                                <div style="background:#e0f2fe;padding:16px;border-radius:12px;margin-bottom:20px;">
                                    <p style="font-size:13px;color:#0369a1;"><strong>Why Paystack?</strong></p>
                                    <ul style="font-size:12px;color:#0369a1;margin:8px 0 0 16px;">
                                        <li>Accept card & bank payments</li>
                                        <li>Money goes directly to YOUR account</li>
                                        <li>Only needs your Public Key (secure!)</li>
                                    </ul>
                                </div>
                                <button class="btn btn-primary" id="btn-goto-settings" style="width:100%;">âš™ï¸ Go to Settings</button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('modal-close').onclick = closeModal;
                document.getElementById('btn-goto-settings').onclick = () => {
                    closeModal();
                    state.menuPage = 'settings';
                    render();
                };
                return;
            }

            // Open Paystack popup directly
            openPaystackPopup(invoiceId);
        }
        
        function openPaystackPopup(invoiceId) {
            const inv = state.invoices.find(i => i.id === invoiceId);
            const cust = state.customers.find(c => c.id === inv.customer_id);
            const p = state.businessProfile;
            const owed = inv.amount - inv.amount_paid;
            
            // Create email from phone or use placeholder
            const email = cust?.email || `${(cust?.phone || 'customer').replace(/\D/g, '')}@customer.owomi.app`;
            
            const handler = PaystackPop.setup({
                key: p.paystackPublicKey,
                email: email,
                amount: Math.round(owed * 100), // Paystack uses kobo
                currency: 'NGN',
                ref: `owomi_${inv.id}_${Date.now()}`,
                metadata: {
                    invoice_id: inv.id,
                    invoice_number: inv.invoice_number,
                    customer_name: cust?.name,
                    custom_fields: [
                        { display_name: "Invoice", variable_name: "invoice", value: inv.invoice_number || inv.id },
                        { display_name: "Customer", variable_name: "customer", value: cust?.name || 'Customer' }
                    ]
                },
                callback: function(response) {
                    // Payment successful!
                    console.log('Payment success:', response);
                    
                    // Update invoice as paid
                    inv.amount_paid = inv.amount;
                    inv.paid_date = new Date().toISOString();
                    localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                    
                    // Record payment in history
                    state.paymentHistory.push({
                        id: 'pay-' + Date.now(),
                        invoiceId: inv.id,
                        amount: owed,
                        method: 'paystack',
                        reference: response.reference,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
                    
                    showToast(`âœ… Payment of ${formatNaira(owed)} received!`, 'success');
                    render();
                },
                onClose: function() {
                    showToast('Payment cancelled', 'info');
                }
            });
            
            handler.openIframe();
        }

        function showPaymentLinkModal(url, customerName, amount, phone, invoiceId) {
            const whatsappMsg = `Hi ${customerName}! Here's your payment link for ${formatNaira(amount)}:\n\n${url}\n\nClick to pay securely with card or bank transfer. Thank you!\n- ${state.businessProfile.name || 'Owo Mi'}`;
            let formattedPhone = phone?.replace(/\s/g, '') || '';
            if (formattedPhone.startsWith('0')) formattedPhone = '234' + formattedPhone.slice(1);

            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box">
                        <div class="modal-header">ðŸ’³ Payment Link Created<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <p style="margin-bottom:16px;color:#16a34a;font-weight:600;">âœ… Payment link ready for ${customerName}!</p>
                            <p style="margin-bottom:12px;color:#666;">Amount: <strong>${formatNaira(amount)}</strong></p>
                            
                            <div style="background:#f5f5f5;padding:12px;border-radius:8px;margin-bottom:16px;word-break:break-all;font-size:13px;">
                                ${url}
                            </div>

                            <button class="btn btn-primary" id="btn-copy-link" style="margin-bottom:12px;">ðŸ“‹ Copy Link</button>
                            <button class="btn btn-whatsapp-send" id="btn-send-whatsapp" style="background:#25D366;color:white;width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;">ðŸ’¬ Send via WhatsApp</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = () => { closeModal(); render(); };
            document.getElementById('btn-copy-link').onclick = () => {
                navigator.clipboard.writeText(url).then(() => {
                    document.getElementById('btn-copy-link').textContent = 'âœ… Copied!';
                    setTimeout(() => { document.getElementById('btn-copy-link').textContent = 'ðŸ“‹ Copy Link'; }, 2000);
                });
            };
            document.getElementById('btn-send-whatsapp').onclick = () => {
                window.open(`https://wa.me/${formattedPhone}?text=${encodeURIComponent(whatsappMsg)}`, '_blank');
            };
        }

        // ========== QUOTES ==========
        function showQuoteModal() {
            const customerOptions = state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const productOptions = state.products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} - ${formatNaira(p.price)}</option>`).join('');
            
            document.getElementById('modal-container').innerHTML = `
                <div class="modal">
                    <div class="modal-box" style="max-height:90vh;overflow-y:auto;">
                        <div class="modal-header">ðŸ“ New Quote<button class="modal-close" id="modal-close">Ã—</button></div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select class="form-input" id="quote-customer">
                                    <option value="">Select customer...</option>
                                    ${customerOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-input" id="quote-desc" placeholder="Website Design Project">
                            </div>
                            
                            ${state.products.length > 0 ? `
                                <div class="form-group">
                                    <label class="form-label">Quick Add Product</label>
                                    <select class="form-input" id="quote-product-select">
                                        <option value="">Select product to add...</option>
                                        ${productOptions}
                                    </select>
                                </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label class="form-label">Line Items</label>
                                <div id="quote-items">
                                    <div class="line-item" style="display:flex;gap:8px;margin-bottom:8px;align-items:center;">
                                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                                        <input type="number" class="form-input item-qty" placeholder="Qty" min="1" value="1" style="flex:0.5;text-align:center;">
                                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" id="add-quote-item" style="margin-top:8px;padding:8px 16px;font-size:13px;">+ Add Item</button>
                            </div>

                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div class="form-group">
                                    <label class="form-label">Valid For (Days)</label>
                                    <input type="number" class="form-input" id="quote-valid" value="30" min="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display:flex;align-items:center;gap:8px;">
                                        <input type="checkbox" id="quote-vat" style="width:18px;height:18px;"> Add VAT (7.5%)
                                    </label>
                                </div>
                            </div>

                            <div id="quote-total-display" style="background:#f0f9ff;padding:16px;border-radius:12px;margin-top:16px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                    <span>Subtotal:</span><span id="quote-subtotal">â‚¦0</span>
                                </div>
                                <div id="quote-vat-row" style="display:none;justify-content:space-between;margin-bottom:8px;">
                                    <span>VAT (7.5%):</span><span id="quote-vat-amount">â‚¦0</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-weight:700;font-size:18px;border-top:2px solid #3b82f6;padding-top:8px;">
                                    <span>Total:</span><span id="quote-total">â‚¦0</span>
                                </div>
                            </div>

                            <button class="btn btn-primary" id="modal-save" style="margin-top:20px;">ðŸ“ Create Quote</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').onclick = closeModal;
            
            // Calculate totals
            function calculateQuoteTotal() {
                const items = document.querySelectorAll('#quote-items .line-item');
                let subtotal = 0;
                items.forEach(item => {
                    const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(item.querySelector('.item-price').value) || 0;
                    subtotal += qty * price;
                });
                const includeVat = document.getElementById('quote-vat').checked;
                const vat = includeVat ? subtotal * 0.075 : 0;
                const total = subtotal + vat;
                
                document.getElementById('quote-subtotal').textContent = formatNaira(subtotal);
                document.getElementById('quote-vat-amount').textContent = formatNaira(vat);
                document.getElementById('quote-vat-row').style.display = includeVat ? 'flex' : 'none';
                document.getElementById('quote-total').textContent = formatNaira(total);
            }
            
            // Listen for changes
            document.getElementById('quote-items').addEventListener('input', calculateQuoteTotal);
            document.getElementById('quote-vat').addEventListener('change', calculateQuoteTotal);
            
            // Quick add product
            document.getElementById('quote-product-select')?.addEventListener('change', function() {
                if (!this.value) return;
                const product = state.products.find(p => p.id === this.value);
                if (product) {
                    const itemsContainer = document.getElementById('quote-items');
                    const newItem = document.createElement('div');
                    newItem.className = 'line-item';
                    newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                    newItem.innerHTML = `
                        <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;" value="${product.name}">
                        <input type="number" class="form-input item-qty" placeholder="Qty" min="1" value="1" style="flex:0.5;text-align:center;">
                        <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;" value="${product.price}">
                        <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                    `;
                    itemsContainer.appendChild(newItem);
                    newItem.querySelector('.btn-remove-item').onclick = () => { newItem.remove(); calculateQuoteTotal(); };
                    this.value = '';
                    calculateQuoteTotal();
                }
            });
            
            // Add item button
            document.getElementById('add-quote-item').onclick = () => {
                const itemsContainer = document.getElementById('quote-items');
                const newItem = document.createElement('div');
                newItem.className = 'line-item';
                newItem.style = 'display:flex;gap:8px;margin-bottom:8px;align-items:center;';
                newItem.innerHTML = `
                    <input type="text" class="form-input item-name" placeholder="Item name" style="flex:2;">
                    <input type="number" class="form-input item-qty" placeholder="Qty" min="1" value="1" style="flex:0.5;text-align:center;">
                    <input type="number" class="form-input item-price" placeholder="Price" style="flex:1;">
                    <button type="button" class="btn-remove-item" style="background:#fee2e2;color:#dc2626;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ã—</button>
                `;
                itemsContainer.appendChild(newItem);
                newItem.querySelector('.btn-remove-item').onclick = () => { newItem.remove(); calculateQuoteTotal(); };
            };
            
            // Save quote
            document.getElementById('modal-save').onclick = () => {
                const customerId = document.getElementById('quote-customer').value;
                const description = document.getElementById('quote-desc').value.trim();
                const validDays = parseInt(document.getElementById('quote-valid').value) || 30;
                const includeVat = document.getElementById('quote-vat').checked;
                
                if (!customerId) { showToast('Please select a customer', 'error'); return; }
                if (!description) { showToast('Please enter a description', 'error'); return; }
                
                // Get items
                const items = [];
                document.querySelectorAll('#quote-items .line-item').forEach(item => {
                    const name = item.querySelector('.item-name').value.trim();
                    const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
                    const price = parseFloat(item.querySelector('.item-price').value) || 0;
                    if (name && price > 0) items.push({ name, qty, price });
                });
                
                if (items.length === 0) { showToast('Please add at least one item', 'error'); return; }
                
                const subtotal = items.reduce((s, i) => s + (i.qty * i.price), 0);
                const vat = includeVat ? subtotal * 0.075 : 0;
                const total = subtotal + vat;
                
                const quote = {
                    id: 'quote-' + Date.now(),
                    customer_id: customerId,
                    description,
                    items,
                    subtotal,
                    vat,
                    amount: total,
                    include_vat: includeVat,
                    valid_days: validDays,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                state.quotes.push(quote);
                localStorage.setItem('owomi_quotes', JSON.stringify(state.quotes));
                closeModal();
                showToast('Quote created!', 'success');
                render();
            };
        }

        function generateQuotePDF(quoteId) {
            const quote = state.quotes.find(q => q.id === quoteId);
            const cust = state.customers.find(c => c.id === quote.customer_id);
            const p = state.businessProfile;
            const t = state.invoiceTemplate || { color: '#3b82f6', style: 'modern' };
            const brandColor = t.color || '#3b82f6';
            const quoteNumber = 'QT-' + quote.id.slice(-8).toUpperCase();
            
            const itemsRows = quote.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td style="text-align:center">${item.qty}</td>
                    <td style="text-align:right">${formatNaira(item.price)}</td>
                    <td style="text-align:right">${formatNaira(item.qty * item.price)}</td>
                </tr>
            `).join('');

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Quote ${quoteNumber}</title>
            <style>
                body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto}
                .header{text-align:center;border-bottom:3px solid ${brandColor};padding-bottom:20px;margin-bottom:30px}
                .header h1{color:${brandColor};margin:0}
                .quote-badge{display:inline-block;background:${brandColor};color:white;padding:8px 20px;border-radius:20px;font-size:14px;font-weight:bold;margin-bottom:20px}
                .details{display:flex;justify-content:space-between;margin-bottom:30px}
                .box{background:#f9f9f9;padding:15px;border-radius:8px;width:48%}
                .box h3{margin:0 0 10px;color:${brandColor};font-size:14px}
                table{width:100%;border-collapse:collapse;margin-bottom:30px}
                th{background:${brandColor};color:white;padding:12px;text-align:left;font-size:13px}
                td{padding:12px;border-bottom:1px solid #eee;font-size:13px}
                .total-section{background:#f9f9f9;padding:15px;border-radius:8px}
                .total-row{display:flex;justify-content:space-between;padding:8px 0}
                .total-row.final{border-top:2px solid ${brandColor};margin-top:8px;padding-top:12px;font-size:18px;font-weight:bold}
                .footer{text-align:center;color:#999;font-size:12px;margin-top:40px}
                .valid{background:#fef3c7;padding:12px;border-radius:8px;text-align:center;color:#92400e;margin-top:20px}
                @media print{body{padding:20px}}
            </style></head><body>
            <div class="header">
                ${p.logo ? `<img src="${p.logo}" style="max-height:60px;max-width:150px;object-fit:contain;margin-bottom:10px;">` : ''}
                <h1>${p.name || 'Owo Mi ðŸ’°'}</h1>
                <p>${p.phone || ''} ${p.email ? 'â€¢ ' + p.email : ''} ${p.address ? 'â€¢ ' + p.address : ''}</p>
            </div>
            <div style="text-align:center;"><span class="quote-badge">ðŸ“ QUOTE</span></div>
            <div style="text-align:center;color:${brandColor};font-size:20px;font-weight:bold;margin-bottom:20px;">${quoteNumber}</div>
            <div class="details">
                <div class="box">
                    <h3>PREPARED FOR</h3>
                    <p><strong>${cust?.name || 'Customer'}</strong></p>
                    <p>${cust?.phone || ''}</p>
                </div>
                <div class="box">
                    <h3>DETAILS</h3>
                    <p>Quote: ${quoteNumber}</p>
                    <p>Date: ${formatDate(quote.created_at)}</p>
                </div>
            </div>
            <table>
                <thead><tr><th>Description</th><th style="text-align:center">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Total</th></tr></thead>
                <tbody>${itemsRows}</tbody>
            </table>
            <div class="total-section">
                <div class="total-row"><span>Subtotal</span><span>${formatNaira(quote.subtotal)}</span></div>
                ${quote.include_vat ? `<div class="total-row"><span>VAT (7.5%)</span><span>${formatNaira(quote.vat)}</span></div>` : ''}
                <div class="total-row final"><span>Total</span><span style="color:${brandColor}">${formatNaira(quote.amount)}</span></div>
            </div>
            <div class="valid">â° This quote is valid for ${quote.valid_days} days from ${formatDate(quote.created_at)}</div>
            <div class="footer">
                <p>${p.footerNote || 'Thank you for your interest!'}</p>
                <p style="margin-top:10px;font-size:11px;color:#bbb;">Powered by Owo Mi ðŸ’°</p>
            </div>
            </body></html>`;

            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                setTimeout(() => win.print(), 500);
            }
        }

        function convertQuoteToInvoice(quoteId) {
            const quote = state.quotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            if (confirm(`Convert this quote to an invoice?\n\nCustomer: ${state.customers.find(c => c.id === quote.customer_id)?.name}\nAmount: ${formatNaira(quote.amount)}`)) {
                const invoiceNumber = 'INV-' + String(state.invoices.length + 1).padStart(4, '0');
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 14); // 14 days from now
                
                const invoice = {
                    id: 'inv-' + Date.now(),
                    invoice_number: invoiceNumber,
                    customer_id: quote.customer_id,
                    description: quote.description,
                    items: quote.items,
                    amount: quote.amount,
                    amount_paid: 0,
                    include_vat: quote.include_vat,
                    vat: quote.vat,
                    subtotal: quote.subtotal,
                    due_date: dueDate.toISOString().split('T')[0],
                    created_at: new Date().toISOString()
                };
                
                state.invoices.push(invoice);
                localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                
                quote.status = 'converted';
                localStorage.setItem('owomi_quotes', JSON.stringify(state.quotes));
                
                showToast('Quote converted to invoice!', 'success');
                state.menuPage = null;
                state.activeTab = 'invoices';
                render();
            }
        }

        // ========== BACKUP & RESTORE ==========
        function downloadBackup() {
            const backup = {
                version: '1.0.0',
                date: new Date().toISOString(),
                data: {
                    customers: state.customers,
                    invoices: state.invoices,
                    quotes: state.quotes,
                    products: state.products,
                    expenses: state.expenses,
                    businessProfile: state.businessProfile,
                    paymentHistory: state.paymentHistory,
                    recurringTemplates: state.recurringTemplates,
                    reminderSettings: state.reminderSettings,
                    invoiceTemplate: state.invoiceTemplate
                }
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `owomi-backup-${dateStr}.json`;
            a.click();
            
            showToast('Backup downloaded! Save it somewhere safe ðŸ’¾', 'success');
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.data || !backup.version) {
                        throw new Error('Invalid backup file');
                    }
                    
                    if (!confirm(`Restore backup from ${formatDate(backup.date)}?\n\nThis will REPLACE all your current data:\nâ€¢ ${backup.data.customers?.length || 0} customers\nâ€¢ ${backup.data.invoices?.length || 0} invoices\nâ€¢ ${backup.data.quotes?.length || 0} quotes\nâ€¢ ${backup.data.products?.length || 0} products\nâ€¢ ${backup.data.expenses?.length || 0} expenses\n\nThis cannot be undone!`)) {
                        return;
                    }
                    
                    // Restore all data
                    if (backup.data.customers) {
                        state.customers = backup.data.customers;
                        localStorage.setItem('owomi_customers', JSON.stringify(state.customers));
                    }
                    if (backup.data.invoices) {
                        state.invoices = backup.data.invoices;
                        localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
                    }
                    if (backup.data.quotes) {
                        state.quotes = backup.data.quotes;
                        localStorage.setItem('owomi_quotes', JSON.stringify(state.quotes));
                    }
                    if (backup.data.products) {
                        state.products = backup.data.products;
                        localStorage.setItem('owomi_products', JSON.stringify(state.products));
                    }
                    if (backup.data.expenses) {
                        state.expenses = backup.data.expenses;
                        localStorage.setItem('owomi_expenses', JSON.stringify(state.expenses));
                    }
                    if (backup.data.businessProfile) {
                        state.businessProfile = backup.data.businessProfile;
                        localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
                    }
                    if (backup.data.paymentHistory) {
                        state.paymentHistory = backup.data.paymentHistory;
                        localStorage.setItem('owomi_payments', JSON.stringify(state.paymentHistory));
                    }
                    if (backup.data.recurringTemplates) {
                        state.recurringTemplates = backup.data.recurringTemplates;
                        localStorage.setItem('owomi_recurring', JSON.stringify(state.recurringTemplates));
                    }
                    if (backup.data.reminderSettings) {
                        state.reminderSettings = backup.data.reminderSettings;
                        localStorage.setItem('owomi_reminders', JSON.stringify(state.reminderSettings));
                    }
                    if (backup.data.invoiceTemplate) {
                        state.invoiceTemplate = backup.data.invoiceTemplate;
                        localStorage.setItem('owomi_template', JSON.stringify(state.invoiceTemplate));
                    }
                    
                    showToast('Backup restored successfully! ðŸŽ‰', 'success');
                    render();
                } catch (err) {
                    showToast('Invalid backup file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // ========== AI ASSISTANT ==========
        let aiChatHistory = [];
        let isAiProcessing = false;
        
        function openAIAssistant() {
            aiChatHistory = [];
            
            const modal = document.createElement('div');
            modal.id = 'ai-chat-modal';
            modal.className = 'ai-chat-modal';
            modal.innerHTML = `
                <div class="ai-chat-box">
                    <div class="ai-chat-header">
                        <div class="ai-chat-title">ðŸ¤– AI Assistant</div>
                        <button class="ai-chat-close" onclick="closeAIAssistant()">Ã—</button>
                    </div>
                    <div class="ai-chat-messages" id="ai-messages">
                        <div class="ai-message assistant">
                            <div class="ai-message-avatar">ðŸ¤–</div>
                            <div class="ai-message-bubble">
                                Hello! I'm your AI assistant. I can help you:
                                <br><br>
                                ðŸ“„ <strong>Create invoices</strong> - Just tell me the details!<br>
                                ðŸ’¬ <strong>Answer questions</strong> - Ask about your business<br>
                                ðŸ“Š <strong>Give insights</strong> - Analyze your data
                                <br><br>
                                Try saying: <em>"Create invoice for Alhaji Musa, 500k for generator repair"</em>
                            </div>
                        </div>
                    </div>
                    <div class="ai-suggestions" id="ai-suggestions">
                        <button class="ai-suggestion" onclick="sendAIMessage('Create a new invoice')">ðŸ“„ New Invoice</button>
                        <button class="ai-suggestion" onclick="sendAIMessage('How much am I owed?')">ðŸ’° Total Owed</button>
                        <button class="ai-suggestion" onclick="sendAIMessage('Who owes me money?')">ðŸ‘¥ Debtors</button>
                        <button class="ai-suggestion" onclick="sendAIMessage('How is my business doing?')">ðŸ“Š Overview</button>
                    </div>
                    <div class="ai-chat-input-area">
                        <button class="ai-voice-btn" id="ai-voice-btn" onclick="toggleVoiceInput()">ðŸŽ¤</button>
                        <input type="text" class="ai-chat-input" id="ai-input" placeholder="Type or speak..." onkeypress="if(event.key==='Enter')sendAIMessage()">
                        <button class="ai-chat-send" id="ai-send-btn" onclick="sendAIMessage()">âž¤</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('ai-input').focus();
        }
        
        function closeAIAssistant() {
            document.getElementById('ai-chat-modal')?.remove();
            if (window.recognition) {
                window.recognition.stop();
            }
        }
        window.closeAIAssistant = closeAIAssistant;
        
        function toggleVoiceInput() {
            const btn = document.getElementById('ai-voice-btn');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Voice input not supported in this browser', 'error');
                return;
            }
            
            if (window.recognition && window.isRecording) {
                window.recognition.stop();
                window.isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'ðŸŽ¤';
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            window.recognition = new SpeechRecognition();
            window.recognition.lang = 'en-NG';
            window.recognition.continuous = false;
            window.recognition.interimResults = false;
            
            window.recognition.onstart = () => {
                window.isRecording = true;
                btn.classList.add('recording');
                btn.textContent = 'â¹ï¸';
            };
            
            window.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('ai-input').value = transcript;
                sendAIMessage(transcript);
            };
            
            window.recognition.onerror = (event) => {
                console.error('Speech error:', event.error);
                showToast('Voice error: ' + event.error, 'error');
            };
            
            window.recognition.onend = () => {
                window.isRecording = false;
                btn.classList.remove('recording');
                btn.textContent = 'ðŸŽ¤';
            };
            
            window.recognition.start();
        }
        
        async function sendAIMessage(text) {
            const input = document.getElementById('ai-input');
            const message = text || input.value.trim();
            if (!message || isAiProcessing) return;
            
            input.value = '';
            isAiProcessing = true;
            document.getElementById('ai-send-btn').disabled = true;
            document.getElementById('ai-suggestions').style.display = 'none';
            
            // Add user message
            addAIChatMessage('user', message);
            aiChatHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            const typingId = showAITyping();
            
            try {
                // Process with AI
                const response = await processAIQuery(message);
                
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                // Add assistant response
                addAIChatMessage('assistant', response.text, response.invoicePreview);
                aiChatHistory.push({ role: 'assistant', content: response.text });
                
            } catch (err) {
                document.getElementById(typingId)?.remove();
                addAIChatMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
            
            isAiProcessing = false;
            document.getElementById('ai-send-btn').disabled = false;
        }
        
        function addAIChatMessage(role, text, invoicePreview = null) {
            const messagesDiv = document.getElementById('ai-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `ai-message ${role}`;
            
            let extraHtml = '';
            if (invoicePreview) {
                extraHtml = `
                    <div class="ai-invoice-preview">
                        <h4>ðŸ“„ Invoice Preview</h4>
                        <div class="ai-invoice-row"><span>Customer:</span><span>${invoicePreview.customerName}</span></div>
                        <div class="ai-invoice-row"><span>Description:</span><span>${invoicePreview.description}</span></div>
                        <div class="ai-invoice-row"><span>Amount:</span><span><strong>${formatNaira(invoicePreview.amount)}</strong></span></div>
                        <div class="ai-invoice-row"><span>Due Date:</span><span>${invoicePreview.dueDate}</span></div>
                        <div class="ai-invoice-actions">
                            <button class="ai-btn-edit" onclick="closeAIAssistant(); showInvoiceModal();">âœï¸ Edit</button>
                            <button class="ai-btn-create" onclick="createInvoiceFromAI('${invoicePreview.customerId}', '${invoicePreview.description}', ${invoicePreview.amount}, '${invoicePreview.dueDateRaw}')">âœ… Create Invoice</button>
                        </div>
                    </div>
                `;
            }
            
            msgDiv.innerHTML = `
                <div class="ai-message-avatar">${role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}</div>
                <div class="ai-message-bubble">${text}${extraHtml}</div>
            `;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showAITyping() {
            const messagesDiv = document.getElementById('ai-messages');
            const typingId = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.id = typingId;
            typingDiv.className = 'ai-message assistant';
            typingDiv.innerHTML = `
                <div class="ai-message-avatar">ðŸ¤–</div>
                <div class="ai-message-bubble">
                    <div class="ai-typing"><span></span><span></span><span></span></div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return typingId;
        }
        
        async function processAIQuery(query) {
            const lowerQuery = query.toLowerCase();
            
            // Invoice creation intent
            if (lowerQuery.includes('invoice') && (lowerQuery.includes('create') || lowerQuery.includes('make') || lowerQuery.includes('new') || lowerQuery.includes('for '))) {
                return parseInvoiceFromText(query);
            }
            
            // Business questions
            if (lowerQuery.includes('how much') && (lowerQuery.includes('owe') || lowerQuery.includes('outstanding'))) {
                const outstanding = state.invoices.reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                return { text: `You're owed a total of <strong>${formatNaira(outstanding)}</strong> across ${state.invoices.filter(i => i.amount > i.amount_paid).length} unpaid invoices.` };
            }
            
            if (lowerQuery.includes('who') && lowerQuery.includes('owe')) {
                const debtors = state.customers.map(c => {
                    const owed = state.invoices.filter(i => i.customer_id === c.id).reduce((s, i) => s + (i.amount - i.amount_paid), 0);
                    return { name: c.name, owed };
                }).filter(d => d.owed > 0).sort((a, b) => b.owed - a.owed).slice(0, 5);
                
                if (debtors.length === 0) {
                    return { text: "ðŸŽ‰ Great news! No one owes you money - all invoices are paid!" };
                }
                
                let response = "Here are your top debtors:\n\n";
                debtors.forEach((d, i) => {
                    response += `${i + 1}. <strong>${d.name}</strong>: ${formatNaira(d.owed)}\n`;
                });
                return { text: response };
            }
            
            if (lowerQuery.includes('how') && (lowerQuery.includes('business') || lowerQuery.includes('doing') || lowerQuery.includes('overview'))) {
                const totalInvoiced = state.invoices.reduce((s, i) => s + Number(i.amount), 0);
                const totalCollected = state.invoices.reduce((s, i) => s + Number(i.amount_paid), 0);
                const totalExpenses = state.expenses.reduce((s, e) => s + Number(e.amount), 0);
                const profit = totalCollected - totalExpenses;
                const collectionRate = totalInvoiced > 0 ? ((totalCollected / totalInvoiced) * 100).toFixed(0) : 0;
                const overdue = state.invoices.filter(i => getStatus(i) === 'overdue').length;
                
                let response = `ðŸ“Š <strong>Business Overview</strong>\n\n`;
                response += `ðŸ’° Total Invoiced: ${formatNaira(totalInvoiced)}\n`;
                response += `âœ… Collected: ${formatNaira(totalCollected)} (${collectionRate}%)\n`;
                response += `ðŸ’¸ Expenses: ${formatNaira(totalExpenses)}\n`;
                response += `ðŸ“ˆ Profit: <strong style="color:${profit >= 0 ? '#16a34a' : '#dc2626'}">${profit >= 0 ? '+' : ''}${formatNaira(profit)}</strong>\n\n`;
                
                if (overdue > 0) {
                    response += `âš ï¸ You have ${overdue} overdue invoice${overdue > 1 ? 's' : ''} - follow up today!`;
                } else {
                    response += `ðŸŽ‰ No overdue invoices - great job!`;
                }
                
                return { text: response };
            }
            
            if (lowerQuery.includes('customer') && (lowerQuery.includes('best') || lowerQuery.includes('top'))) {
                const customerTotals = state.customers.map(c => {
                    const total = state.invoices.filter(i => i.customer_id === c.id).reduce((s, i) => s + Number(i.amount_paid), 0);
                    return { name: c.name, total };
                }).filter(c => c.total > 0).sort((a, b) => b.total - a.total).slice(0, 5);
                
                if (customerTotals.length === 0) {
                    return { text: "No payment data yet. Your best customers will appear here once you receive payments!" };
                }
                
                let response = "â­ <strong>Your Best Customers:</strong>\n\n";
                customerTotals.forEach((c, i) => {
                    response += `${i + 1}. ${c.name}: ${formatNaira(c.total)}\n`;
                });
                return { text: response };
            }
            
            // Default helpful response
            return { 
                text: `I can help you with:\n\n` +
                    `ðŸ“„ <strong>"Create invoice for [customer], [amount] for [description]"</strong>\n` +
                    `ðŸ’° <strong>"How much am I owed?"</strong>\n` +
                    `ðŸ‘¥ <strong>"Who owes me money?"</strong>\n` +
                    `ðŸ“Š <strong>"How is my business doing?"</strong>\n` +
                    `â­ <strong>"Who are my best customers?"</strong>\n\n` +
                    `Try one of these!`
            };
        }
        
        function parseInvoiceFromText(text) {
            const lowerText = text.toLowerCase();
            
            // Try to extract customer name
            let customerName = null;
            let customerId = null;
            
            // Look for customer by name
            for (const cust of state.customers) {
                if (lowerText.includes(cust.name.toLowerCase())) {
                    customerName = cust.name;
                    customerId = cust.id;
                    break;
                }
            }
            
            // If no customer found, try to extract name after "for"
            if (!customerName) {
                const forMatch = text.match(/for\s+([A-Za-z]+(?:\s+[A-Za-z]+)?)/i);
                if (forMatch) {
                    customerName = forMatch[1];
                }
            }
            
            // Extract amount
            let amount = 0;
            const amountPatterns = [
                /(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*(?:naira|ngn|â‚¦)/i,
                /(?:naira|ngn|â‚¦)\s*(\d{1,3}(?:,\d{3})*(?:\.\d{2})?)/i,
                /(\d+(?:\.\d+)?)\s*k\b/i,
                /(\d+(?:\.\d+)?)\s*m\b/i,
                /(\d{1,3}(?:,\d{3})+)/,
                /(\d{4,})/
            ];
            
            for (const pattern of amountPatterns) {
                const match = text.match(pattern);
                if (match) {
                    let value = match[1].replace(/,/g, '');
                    if (text.toLowerCase().includes(match[1].toLowerCase() + 'k') || lowerText.includes(value + ' k') || lowerText.includes(value + 'k')) {
                        amount = parseFloat(value) * 1000;
                    } else if (text.toLowerCase().includes(match[1].toLowerCase() + 'm') || lowerText.includes(value + ' m') || lowerText.includes(value + 'm')) {
                        amount = parseFloat(value) * 1000000;
                    } else {
                        amount = parseFloat(value);
                    }
                    break;
                }
            }
            
            // Specific check for "500k" pattern
            const kMatch = text.match(/(\d+(?:\.\d+)?)\s*k/i);
            if (kMatch) {
                amount = parseFloat(kMatch[1]) * 1000;
            }
            
            // Extract description
            let description = '';
            const forPatterns = [
                /for\s+(?:the\s+)?(.+?)(?:\s+(?:due|by|before|on|\d))/i,
                /for\s+(?:the\s+)?(.+?)$/i
            ];
            
            for (const pattern of forPatterns) {
                const match = text.match(pattern);
                if (match) {
                    description = match[1].trim();
                    // Clean up description - remove amount and customer references
                    description = description.replace(/\d+k?/gi, '').replace(/naira|ngn|â‚¦/gi, '').trim();
                    if (customerName) {
                        description = description.replace(new RegExp(customerName, 'gi'), '').trim();
                    }
                    // Remove trailing commas and clean up
                    description = description.replace(/^[,\s]+|[,\s]+$/g, '').trim();
                    if (description.length > 3) break;
                }
            }
            
            // Extract due date
            let dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14); // Default 2 weeks
            
            if (lowerText.includes('tomorrow')) {
                dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 1);
            } else if (lowerText.includes('next week')) {
                dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 7);
            } else if (lowerText.includes('next friday')) {
                dueDate = getNextDayOfWeek(5);
            } else if (lowerText.includes('next monday')) {
                dueDate = getNextDayOfWeek(1);
            } else if (lowerText.includes('end of month') || lowerText.includes('month end')) {
                dueDate = new Date();
                dueDate.setMonth(dueDate.getMonth() + 1);
                dueDate.setDate(0);
            }
            
            const dueDateStr = dueDate.toISOString().split('T')[0];
            
            // Validate
            if (!customerName || !customerId) {
                if (state.customers.length === 0) {
                    return { text: "You don't have any customers yet. Please add a customer first, then I can create an invoice for them!" };
                }
                return { 
                    text: `I couldn't identify the customer. Your customers are:\n\n${state.customers.map(c => `â€¢ ${c.name}`).join('\n')}\n\nPlease include one of these names in your request.`
                };
            }
            
            if (!amount || amount < 100) {
                return { text: "I couldn't understand the amount. Please include the amount like:\n\nâ€¢ \"500k\" or \"500,000\"\nâ€¢ \"50000 naira\"\nâ€¢ \"â‚¦100,000\"" };
            }
            
            if (!description || description.length < 3) {
                description = 'Services rendered';
            }
            
            // Clean up description
            description = description.charAt(0).toUpperCase() + description.slice(1);
            
            return {
                text: `I'll create this invoice for you:`,
                invoicePreview: {
                    customerId,
                    customerName,
                    description,
                    amount,
                    dueDate: formatDate(dueDateStr),
                    dueDateRaw: dueDateStr
                }
            };
        }
        
        function getNextDayOfWeek(dayOfWeek) {
            const date = new Date();
            const diff = dayOfWeek - date.getDay();
            date.setDate(date.getDate() + (diff <= 0 ? diff + 7 : diff));
            return date;
        }
        
        function createInvoiceFromAI(customerId, description, amount, dueDate) {
            const invoiceNumber = 'INV-' + String(state.invoices.length + 1).padStart(4, '0');
            const invoice = {
                id: 'inv-' + Date.now(),
                invoice_number: invoiceNumber,
                customer_id: customerId,
                description: description,
                items: [{ name: description, qty: 1, price: amount }],
                amount: amount,
                amount_paid: 0,
                due_date: dueDate,
                created_at: new Date().toISOString()
            };
            
            state.invoices.unshift(invoice);
            localStorage.setItem('owomi_invoices', JSON.stringify(state.invoices));
            
            closeAIAssistant();
            showToast(`âœ… Invoice ${invoiceNumber} created!`, 'success');
            state.activeTab = 'invoices';
            render();
        }
        window.createInvoiceFromAI = createInvoiceFromAI;

        function exportCSV() {
            let csv = 'Customer,Phone,Description,Amount,Paid,Outstanding,Status,Due Date\n';
            state.invoices.forEach(inv => {
                const cust = state.customers.find(c => c.id === inv.customer_id);
                csv += `"${cust?.name || ''}","${cust?.phone || ''}","${inv.description}",${inv.amount},${inv.amount_paid},${inv.amount - inv.amount_paid},${getStatus(inv)},"${inv.due_date}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'owo-mi-invoices.csv';
            a.click();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('owomi_dark', document.body.classList.contains('dark') ? '1' : '0');
            render();
        }

        async function saveSettings() {
            // Keep existing logo and QR if present
            const existingLogo = state.businessProfile.logo;
            const existingQR = state.businessProfile.paymentQR;
            
            state.businessProfile = {
                ...state.businessProfile,
                name: document.getElementById('set-name').value.trim(),
                phone: document.getElementById('set-phone').value.trim(),
                email: document.getElementById('set-email')?.value.trim() || '',
                address: document.getElementById('set-address').value.trim(),
                bank: document.getElementById('set-bank').value.trim(),
                footerNote: document.getElementById('set-footer')?.value.trim() || '',
                logo: existingLogo,
                paymentQR: existingQR
            };
            
            try {
                await db.updateBusiness({
                    name: state.businessProfile.name,
                    phone: state.businessProfile.phone,
                    email: state.businessProfile.email,
                    address: state.businessProfile.address,
                    bank_details: state.businessProfile.bank,
                    footer_note: state.businessProfile.footerNote,
                    logo_url: state.businessProfile.logo,
                    qr_code_url: state.businessProfile.paymentQR
                });
                showToast('Business settings saved!', 'success');
            } catch (err) {
                console.error('Save failed:', err);
                showToast('Error saving settings', 'error');
            }
        }
        
        async function saveTemplateSettings() {
            // Save footer note and terms with business profile
            state.businessProfile.footerNote = document.getElementById('set-footer')?.value.trim() || '';
            state.businessProfile.termsAndConditions = document.getElementById('set-terms')?.value.trim() || '';
            
            try {
                await db.updateBusiness({
                    footer_note: state.businessProfile.footerNote,
                    terms_and_conditions: state.businessProfile.termsAndConditions,
                    invoice_color: state.invoiceTemplate.color,
                    invoice_style: state.invoiceTemplate.style
                });
                showToast('Template settings saved!', 'success');
            } catch (err) {
                console.error('Save failed:', err);
                showToast('Error saving settings', 'error');
            }
        }
        
        function savePaystackSettings() {
            const publicKey = document.getElementById('set-paystack-public')?.value.trim() || '';
            
            // Validate key
            if (state.businessProfile.paystackEnabled && publicKey) {
                if (!publicKey.startsWith('pk_')) {
                    showToast('Invalid Public Key - should start with pk_', 'error');
                    return;
                }
            }
            
            state.businessProfile.paystackPublicKey = publicKey;
            localStorage.setItem('owomi_business', JSON.stringify(state.businessProfile));
            
            showToast('Paystack settings saved!', 'success');
        }
        
        function generatePDFWithTemplate(invoice, customer) {
            // Use template settings
            const t = state.invoiceTemplate || { color: '#3b82f6', style: 'modern' };
            const b = state.businessProfile;
            
            // Generate PDF with template
            generatePDF(invoice.id);
        }

        // ========== INIT ==========
        const DEV_MODE = true; // Set to false when done testing
        
        // iOS Standalone Mode Detection
        const isIOSPWA = window.navigator.standalone === true;
        const isAndroidPWA = window.matchMedia('(display-mode: standalone)').matches;
        const isPWA = isIOSPWA || isAndroidPWA;

        async function init() {
            // Add iOS PWA class for specific styling
            if (isIOSPWA) {
                document.body.classList.add('ios-pwa');
            }
            if (isPWA) {
                document.body.classList.add('standalone');
            }
            
            if (localStorage.getItem('owomi_dark') === '1') document.body.classList.add('dark');
            
            // Check for customer portal mode via URL hash
            const hash = window.location.hash;
            if (hash.startsWith('#portal/')) {
                const customerId = hash.replace('#portal/', '');
                state.portalMode = true;
                state.portalCustomerId = customerId;
                
                // Load data for portal
                state.businessProfile = JSON.parse(localStorage.getItem('owomi_business') || '{"name":"Business Name","phone":""}');
                state.customers = JSON.parse(localStorage.getItem('owomi_customers') || '[]');
                state.invoices = JSON.parse(localStorage.getItem('owomi_invoices') || '[]');
                
                state.loading = false;
                renderPortal();
                return;
            }
            
            // Check for OAuth callback (access_token in URL hash)
            if (hash && hash.includes('access_token')) {
                await handleAuthCallback();
                return;
            }
            
            // Check for existing session
            const session = getSession();
            
            if (session && session.access_token) {
                try {
                    // Verify session is still valid
                    const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    });
                    
                    if (res.ok) {
                        const user = await res.json();
                        state.user = user;
                        
                        // Load all data from database
                        await db.loadAllData();
                        
                        state.loading = false;
                        render();
                        
                        // Check auto reminders after render
                        setTimeout(checkAutoReminders, 1500);
                        return;
                    } else {
                        // Session expired, clear it
                        localStorage.removeItem('owomi_session');
                    }
                } catch (err) {
                    console.error('Session check error:', err);
                    localStorage.removeItem('owomi_session');
                }
            }
            
            // No valid session - show landing page
            state.currentSection = 'landing';
            state.loading = false;
            render();
        }

        init();
        
        // Handle hash changes for portal navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (hash.startsWith('#portal/')) {
                const customerId = hash.replace('#portal/', '');
                state.portalMode = true;
                state.portalCustomerId = customerId;
                renderPortal();
            } else if (state.portalMode) {
                // Exiting portal mode
                state.portalMode = false;
                state.portalCustomerId = null;
                window.location.reload();
            }
        });

        // ========== PWA ==========
        let deferredPrompt;
        
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'owomi-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', e => {
                    e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', e => {
                    e.waitUntil(caches.keys().then(keys => 
                        Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
                    ));
                });
                
                self.addEventListener('fetch', e => {
                    e.respondWith(
                        fetch(e.request)
                            .then(res => {
                                const clone = res.clone();
                                caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
                                return res;
                            })
                            .catch(() => caches.match(e.request))
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(reg => {
                console.log('SW registered:', reg.scope);
            }).catch(err => {
                console.log('SW registration failed:', err);
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!localStorage.getItem('owomi_installed')) {
                setTimeout(showInstallPrompt, 3000);
            }
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;
            
            const prompt = document.createElement('div');
            prompt.className = 'install-prompt';
            prompt.innerHTML = `
                <div class="install-prompt-icon">ðŸ’°</div>
                <div class="install-prompt-text">
                    <div class="install-prompt-title">Install Owo Mi</div>
                    <div class="install-prompt-desc">Add to home screen for quick access</div>
                </div>
                <button class="install-prompt-btn" id="install-btn">Install</button>
                <button class="install-prompt-close" id="install-close">Ã—</button>
            `;
            document.body.appendChild(prompt);

            document.getElementById('install-btn').onclick = async () => {
                prompt.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    localStorage.setItem('owomi_installed', '1');
                }
                deferredPrompt = null;
            };

            document.getElementById('install-close').onclick = () => {
                prompt.remove();
                localStorage.setItem('owomi_installed', '1');
            };
        }

        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Running as PWA');
        }
        
        // Export functions for inline onclick handlers
        window.showInvoiceModal = showInvoiceModal;
        
        // Global click handler for dynamically rendered elements
        document.addEventListener('click', function(e) {
            // Run Onboarding button
            if (e.target.closest('#btn-run-onboarding')) {
                e.preventDefault();
                if (confirm('Run the setup guide again? This will walk you through the app setup.')) {
                    state.onboardingStep = 1;
                    state.currentSection = 'onboarding';
                    render();
                }
            }
        });
    </script>
</body>
    </html>
